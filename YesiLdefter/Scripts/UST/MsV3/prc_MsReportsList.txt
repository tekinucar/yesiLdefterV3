/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MsReportsList] (@ReportCode varchar(50))  
AS BEGIN

 --declare @ReportCode varchar(50)
 --set @ReportCode = ''--'DNM'

 if (@ReportCode = 'null') 
     set @ReportCode = ''

 ;WITH CTE
     AS  (
 
    Select mr.ReportCode, mr.ReportCode as Cte_Code
    from MsReports as mr
    Where mr.ParentCode = @ReportCode
 
    union all

    Select mr.ReportCode, mr.ReportCode as Cte_Code
    from MsReports as mr
    Where mr.ReportCode = @ReportCode

    union all

    Select c.Cte_Code , mr.ReportCode
    from CTE as c
        Join MsReports as mr ON ( c.Cte_Code = mr.ParentCode )
  ) 
Select distinct
   mr.*

From CTE as c
   left outer join MsReports as mr on ( c.Cte_Code = mr.ReportCode )

where mr.ReportCode <> @ReportCode

END -- prc_

/*CreateProcedureEnd*/


