
/*CreateTable*/

begin transaction

 create table OnmOdemePlani
 (
   Id                Int IDENTITY(1,1) not null, 
   FirmId            Int       not null,
   IsActive          Bit       not null, /* default : 1 = active, 0 = not active */ 
   DonemTipiId       Int           null,  /* borcun oluştuğu YılAy */
   UcretTipiId       SmallInt      null,  /* 1. MtskAday tablosu, 2. yeni eklenecek borçlandırma sebepleri olacak   */
   CariId            Int           null,  /* MtskAday.Id     */

   TaksitTipiId      SmallInt      null,  /* 1. Peşinat, 2. Taksit, 3. Tek Borç  */
   TaksitNo          Numeric(3)    null, 
   VadeTarihi        Date          null,
   VadeYil           SmallInt      null,
   VadeAy            SmallInt      null,
   VadeGun           SmallInt      null,
   TaksitTutari      Numeric(22,8) null, 
   IsPaid            Bit       not null, /* default : 0 = ödenmedi,  1 = Ödendi */  
   TahsilTarihi      Date          null,

   YedekTaksitTutari   Numeric(22,8) null, /* taksit tutarı eksik tahsil edildiği zaman ( YedekTaksitTutari = TaksitTutari, TaksitTutari = EksikTahsilTutarı ) şeklinde işleniyor */
   BelgeMakbuzId       Int         null,
   PatchBelgeMakbuzId  Int         null, /* eksik tahsil edildiğinde yeni oluşturulan satıra hangi BelgeMakbuzId den dolayı oluşturulduğunun işareti */
   BelgeStokBId        Int         null, /* Fatura için : BelgeStokB.Id  : BelgeStokB başlık tablosu */
   SourceTypeId        SmallInt    null, /* 0. manuel giriş, 1. Tabim Transfer */      
   SourceId            Int         null, /* Tabim CariAlt.Ulas */

   constraint		pk_OnmOdemePlani primary key (Id)
 )
  
 grant select, insert, update, delete on OnmOdemePlani to public

  create index X_OnmOdemePlani01 on OnmOdemePlani (UcretTipiId)
  create index X_OnmOdemePlani02 on OnmOdemePlani (CariId)
  create index X_OnmOdemePlani03 on OnmOdemePlani (VadeTarihi)
  create index X_OnmOdemePlani04 on OnmOdemePlani (TahsilTarihi)
  create index X_OnmOdemePlani05 on OnmOdemePlani (DonemTipiId)
 
commit transaction

/*CreateTableEnd*/

/*CreateLkpTable*/

begin transaction

-- ------------------------------------------------------- 
-- UcretTipiId
-- ------------------------------------------------------- 
create table [Lkp].[OnmOdemePlaniUcretTipi]
(
   Id               Int Unique not null, 
   UcretTipi         nVarchar(50)   null,
   
   constraint  pk_OnmOdemePlaniUcretTipi primary key (Id)
)

Delete from [Lkp].[OnmOdemePlaniUcretTipi]
INSERT INTO [Lkp].[OnmOdemePlaniUcretTipi] (Id, UcretTipi)
 VALUES 
  ( 0,    N''),
  ( 1000,    N'ÖnMuhasebe Modülü'),
  ( 2000,    N'Eğitim Modülü'),
  ( 2100,    N'Mtsk Modülü'),
  ( 2110,    N'Mtsk Sertifika Ücreti'),   -- join = MtskAday tablosu
  ( 2111,    N'Mtsk Teorik Sınav Ücreti'),
  ( 2112,    N'Mtsk Uygulama Sınav Ücreti'),
  ( 2113,    N'Mtsk Özel Teorik Ders Ücreti'),
  ( 2114,    N'Mtsk Özel Uygulama Ders Ücreti')
  
-- ------------------------------------------------------- 
-- TaksitTipiId
-- ------------------------------------------------------- 
create table [Lkp].[OnmOdemePlaniTaksitTipi]
(
   Id               Int Unique not null, 
   TaksitTipi       nVarchar(20)   null,
   
   constraint  pk_OnmOdemePlaniTaksitTipi primary key (Id)
)

Delete from [Lkp].[OnmOdemePlaniTaksitTipi]
INSERT INTO [Lkp].[OnmOdemePlaniTaksitTipi] (Id, TaksitTipi)
 VALUES 
  ( 0,    N''),
  ( 1,    N'Peşinat'),
  ( 2,    N'Taksit'),
  ( 3,    N'Tek Ödeme')
    

commit transaction

/*CreateLkpTableEnd*/


/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_OnmOdemePlani] on [dbo].[OnmOdemePlani]
AFTER INSERT, UPDATE
AS BEGIN

    declare odemePlaniCursor cursor for select Id from Inserted
    declare @Id bigint
	declare @FirmId int
	declare @ItemTypeId smallInt

    OPEN odemePlaniCursor

    FETCH NEXT FROM odemePlaniCursor INTO @Id --@curId

    WHILE @@FETCH_STATUS = 0
    BEGIN
        Select 
            @FirmId = ins.FirmId
           ,@ItemTypeId = ins.UcretTipiId
        From inserted ins
        Where ins.Id = @Id

      FETCH NEXT FROM odemePlaniCursor INTO @Id
    END -- While

    CLOSE odemePlaniCursor
    DEALLOCATE odemePlaniCursor   

    EXECUTE [dbo].[prc_OnmToplamBekleyenGelirler] @FirmId

END -- create trigger

/*CreateTriggerEnd*/


/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_OnmOdemePlaniDelete] on [dbo].[OnmOdemePlani]
FOR DELETE
AS BEGIN

    declare cursor_odemePlaniDlt cursor for select Id from deleted
    declare @curId bigint
	declare @FirmId int
	declare @ItemTypeId smallInt
	
	OPEN cursor_odemePlaniDlt

    FETCH NEXT FROM cursor_odemePlaniDlt INTO @curId

    WHILE @@FETCH_STATUS = 0
    BEGIN
        Select 
            @FirmId = dlt.FirmId
           ,@ItemTypeId = dlt.UcretTipiId
        From deleted dlt
        Where dlt.Id = @curId


      FETCH NEXT FROM cursor_odemePlaniDlt INTO @curId
    END

    CLOSE cursor_odemePlaniDlt
    DEALLOCATE cursor_odemePlaniDlt

    EXECUTE [dbo].[prc_OnmToplamBekleyenGelirler] @FirmId

END

/*CreateTriggerEnd*/




