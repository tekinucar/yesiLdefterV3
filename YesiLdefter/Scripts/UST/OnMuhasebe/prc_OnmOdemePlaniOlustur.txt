/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_OnmOdemePlaniOlustur] (@firmId int, @ucretTipiId smallInt, @cariId int)  
AS BEGIN
  /* 
  declare @firmId int
  -- Kaynak : OnmOdemePlaniCariTipi tablosu
  declare @ucretTipiId smallInt
  declare @cariId int 
  
  set @firmId = 2
  set @ucretTipiId = 2110
  set @cariId = 1566
  */
  
  declare @IslemSonucu nvarchar(100) = ''
  declare @mevcut int = 0
    
  Select @mevcut = count(Id)
  From [dbo].[OnmOdemePlani]
  Where FirmId = @firmId
  and   UcretTipiId = @ucretTipiId
  and   CariId = @cariId
  and   (IsPaid = 1      -- ödendi
    or BelgeMakbuzId > 0 -- tahsilat makbuzu varsa
	or BelgeStokBId > 0) -- fatura kesilmişse

  if (@mevcut > 0) 
  begin
     set @IslemSonucu = 'DİKKAT : Tahsilat işlemi veya fatura kesildiği için işlem yapılamıyor...'
     return @IslemSonucu
  end

  declare @AdayKayitTarihi     date = null
  declare @IsUcretli           bit = 0
  declare @SertifikaUcreti     numeric(22,8) = 0
  declare @AnlasilanUcret      numeric(22,8) = 0
  declare @DonemTipiId         int = 0
  declare @IskontoOrani        numeric(12,8) = 0
  declare @TaksitSayisiTipiId  smallInt = 0
  declare @PesinatTutari       numeric(22,8) = 0
  declare @KalanUcret          numeric(22,8) = 0 
  declare @ESinavUcreti        numeric(22,8) = 0
  declare @UygulamaSinavUcreti numeric(22,8) = 0
  declare @SertifikaVeSinavUcreti  numeric(22,8) = 0
  declare @IsSinavUcretiTaksitli   bit = 0

  declare @OdemeTipiId         smallInt = 0
  declare @IsPaymentDate       date = null
  declare @OdemeBaslamaTarihi1  date = null 
  declare @OdemeBaslamaTarihi2  date = null 

  declare @sayac int = 1
  declare @aylikUcret numeric(22,8) = 0
    
  -- tahsilat veya fatura yok ise işlemi gerçekleştir
  --
  if (@mevcut = 0)
  begin
     -- Mevcut Odeme Planını sil
	 --
	 Delete
     From [dbo].[OnmOdemePlani]
     Where FirmId = @firmId
     and   UcretTipiId = @ucretTipiId
     and   CariId = @cariId
	 and   IsPaid = 0

	 -- Adayın Ödeme Plan Beyanı okunuyor
	 --
	 Select 
        @AdayKayitTarihi = isnull([AdayKayitTarihi], getdate())
	   ,@IsUcretli = [IsUcretli]
       ,@SertifikaUcreti = [SertifikaUcreti]
       ,@AnlasilanUcret = [AnlasilanUcret]
       ,@DonemTipiId = [DonemTipiId]
       ,@IskontoOrani = [IskontoOrani]
       ,@TaksitSayisiTipiId = [TaksitSayisiTipiId]
       ,@PesinatTutari = [PesinatTutari]
       ,@KalanUcret = [KalanUcret]
       ,@ESinavUcreti = [ESinavUcreti]
       ,@UygulamaSinavUcreti = [UygulamaSinavUcreti]
       ,@SertifikaVeSinavUcreti = [SertifikaVeSinavUcreti]
       ,@IsSinavUcretiTaksitli = [IsSinavUcretiTaksitli]
       ,@OdemeTipiId = [OdemeTipiId]
       ,@OdemeBaslamaTarihi1 = isnull([OdemeBaslamaTarihi],getdate())
     From [dbo].[MtskAday]
     Where Id = @cariId
	 	
	 set @OdemeBaslamaTarihi2 = @OdemeBaslamaTarihi1
	 
	 -- PeşinatTutari varsa onun kaydını oluştur
	 --
	 if (@PesinatTutari > 0)
	 begin
	    INSERT INTO [dbo].[OnmOdemePlani]
           ([FirmId]
           ,[DonemTipiId]
           ,[UcretTipiId]
           ,[CariId]
		   ,[TaksitTipiId]
           ,[TaksitNo]
           ,[VadeTarihi]
           ,[VadeYil]
           ,[VadeAy]
           ,[VadeGun]
           ,[TaksitTutari]
           ,[IsPaid]
           ,[BelgeMakbuzId]
           ,[BelgeStokBId])
        VALUES
           (@firmId
           ,@DonemTipiId
           ,@ucretTipiId
           ,@cariId
           ,1                       --<TaksitTipiId, smallint,>
		   ,0                       --<TaksitNo, numeric(3,0),> 
           ,@AdayKayitTarihi        --<VadeTarihi, date,>
           ,YEAR(@AdayKayitTarihi)  --<VadeYil, smallint,>
           ,MONTH(@AdayKayitTarihi) --<VadeAy, smallint,>
           ,DAY(@AdayKayitTarihi)   --<VadeGun, smallint,>
           ,@PesinatTutari          --<TaksitTutari, numeric(22,8),>
           ,0  --<IsPaid, bit,>
           ,0  --<BelgeMakbuzId, int,>
           ,0) --<BelgeStokBId, int,>)
        
	 end -- @PesinatTutari

	 if (@TaksitSayisiTipiId <= 0) set @TaksitSayisiTipiId = 1

	 -- Aylık ücret hesaplanıyor
	 -- 
     set @aylikUcret = @KalanUcret / @TaksitSayisiTipiId
     
     if (@IsSinavUcretiTaksitli = 1)
         set @aylikUcret = (@SertifikaVeSinavUcreti - @PesinatTutari) / @TaksitSayisiTipiId

	 -- Yeni Ödeme Planını oluştur
	 --
     while (@sayac <= @TaksitSayisiTipiId)
     begin
        INSERT INTO [dbo].[OnmOdemePlani]
           ([FirmId]
           ,[DonemTipiId]
           ,[UcretTipiId]
           ,[CariId]
		   ,[TaksitTipiId]
           ,[TaksitNo]
           ,[VadeTarihi]
           ,[VadeYil]
           ,[VadeAy]
           ,[VadeGun]
           ,[TaksitTutari]
           ,[IsPaid]
           ,[BelgeMakbuzId]
           ,[BelgeStokBId])
       VALUES
           (@firmId
           ,@DonemTipiId
           ,@ucretTipiId
           ,@cariId
           ,2                          --<TaksitTipiId, smallint,>
		   ,@sayac                     --<TaksitNo, numeric(3,0),> 
           ,@OdemeBaslamaTarihi1        --<VadeTarihi, date,>
           ,YEAR(@OdemeBaslamaTarihi1)  --<VadeYil, smallint,>
           ,MONTH(@OdemeBaslamaTarihi1) --<VadeAy, smallint,>
           ,DAY(@OdemeBaslamaTarihi1)   --<VadeGun, smallint,>
           ,@aylikUcret                --<TaksitTutari, numeric(22,8),>
           ,0 --<IsPaid, bit,>
           ,0 --<BelgeMakbuzId, int,>
           ,0) --<BelgeStokBId, int,>)
            
        set @OdemeBaslamaTarihi1 = DATEADD(MONTH, 1, @OdemeBaslamaTarihi1)
	    set @sayac = @sayac + 1 
     end -- while
  
     if (@IsSinavUcretiTaksitli = 0) and
	    (@ESinavUcreti > 0)
     begin
	    Delete From [dbo].[OnmOdemePlani]
        Where FirmId = @firmId
        and   UcretTipiId = 2111
        and   CariId = @cariId
	    and   IsPaid = 0
				
		INSERT INTO [dbo].[OnmOdemePlani]
           ([FirmId]
           ,[DonemTipiId]
           ,[UcretTipiId]
           ,[CariId]
		   ,[TaksitTipiId]
           ,[TaksitNo]
           ,[VadeTarihi]
           ,[VadeYil]
           ,[VadeAy]
           ,[VadeGun]
           ,[TaksitTutari]
           ,[IsPaid]
           ,[BelgeMakbuzId]
           ,[BelgeStokBId])
        VALUES
           (@firmId
           ,@DonemTipiId
           ,2111 --@ucretTipiId      -- Mtsk Teorik Sınav Ücreti 
           ,@cariId
           ,3                       --<TaksitTipiId, smallint,>
		   ,1                       --<TaksitNo, numeric(3,0),> 
           ,@OdemeBaslamaTarihi2        --<VadeTarihi, date,>
           ,YEAR(@OdemeBaslamaTarihi2)  --<VadeYil, smallint,>
           ,MONTH(@OdemeBaslamaTarihi2) --<VadeAy, smallint,>
           ,DAY(@OdemeBaslamaTarihi2)   --<VadeGun, smallint,>
           ,@ESinavUcreti               --<TaksitTutari, numeric(22,8),>
           ,0  --<IsPaid, bit,>
           ,0  --<BelgeMakbuzId, int,>
           ,0) --<BelgeStokBId, int,>)
     end
     
     if (@IsSinavUcretiTaksitli = 0) and
	    (@UygulamaSinavUcreti > 0)
     begin
	    Delete From [dbo].[OnmOdemePlani]
        Where FirmId = @firmId
        and   UcretTipiId = 2112
        and   CariId = @cariId
	    and   IsPaid = 0

	    INSERT INTO [dbo].[OnmOdemePlani]
           ([FirmId]
           ,[DonemTipiId]
           ,[UcretTipiId]
           ,[CariId]
		   ,[TaksitTipiId]
           ,[TaksitNo]
           ,[VadeTarihi]
           ,[VadeYil]
           ,[VadeAy]
           ,[VadeGun]
           ,[TaksitTutari]
           ,[IsPaid]
           ,[BelgeMakbuzId]
           ,[BelgeStokBId])
        VALUES
           (@firmId
           ,@DonemTipiId
           ,2112 --@ucretTipiId      -- 'Mtsk Uygulama Sınav Ücreti 
           ,@cariId
           ,3                       --<TaksitTipiId, smallint,>
		   ,1                       --<TaksitNo, numeric(3,0),> 
           ,@OdemeBaslamaTarihi2        --<VadeTarihi, date,>
           ,YEAR(@OdemeBaslamaTarihi2)  --<VadeYil, smallint,>
           ,MONTH(@OdemeBaslamaTarihi2) --<VadeAy, smallint,>
           ,DAY(@OdemeBaslamaTarihi2)   --<VadeGun, smallint,>
           ,@UygulamaSinavUcreti        --<TaksitTutari, numeric(22,8),>
           ,0  --<IsPaid, bit,>
           ,0  --<BelgeMakbuzId, int,>
           ,0) --<BelgeStokBId, int,>)
     end

  end --if

  -- Bunu kapatma veya silme. 
  -- Bu sonuca kodun içinde kontrol ediliyor
  Select @IslemSonucu as IslemSonucu

END -- procedure

/*CreateProcedureEnd*/
