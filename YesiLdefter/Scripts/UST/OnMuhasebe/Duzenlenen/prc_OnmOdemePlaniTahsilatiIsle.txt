/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_OnmOdemePlaniTahsilatiIsle] (@dekontId int)  
AS BEGIN 

--declare @dekontId int
--set @dekontId = 15

  declare @BelgeTarihi datetime
  declare @AHesapTipiId int 
  declare @BelgeTutari numeric(22,5)
  declare @SourceTypeId smallInt
  declare @talepId int -- = SourceId

  declare @odemePlaniId int
  declare @TaksitTutari numeric(22,5)
  declare @KalanTutar numeric(22,5)

  set @BelgeTutari = 0
  select 
       @BelgeTarihi = ins.BelgeTarihi
     , @AHesapTipiId = isnull(ins.AHesapTipiId,0) 
     , @BelgeTutari = round(isnull(ins.BelgeTutari,0),2)
     , @SourceTypeId = ins.SourceTypeId
     , @talepId = ins.SourceId 
   from OnmBelgeDekont as ins
   where ins.IsActive = 1
   and   isnull(ins.IsIptal,0) = 0 
   and   ins.Id = @dekontId 

   set @KalanTutar = @BelgeTutari 

   while ((@KalanTutar > 0) and (@BelgeTutari > 0))
   begin

       Select top 1 @odemePlaniId = Id, @TaksitTutari = TaksitTutari from OnmOdemePlani 
       Where IsActive = 1
       and IsPaid = 0
       and TalepId = @TalepId
       and UcretTipiId = @AHesapTipiId -- Hangi ücret türü
       order by VadeTarihi, Id
  
       -- @KalanTutar - eksiye düşüyorsa
       if (@KalanTutar < @TaksitTutari)
       begin
           --print 'eksik para'
	
           -- Ödeme planını eksik ödeme yapınca
           Update dbo.OnmOdemePlani set
               YedekTaksitTutari = TaksitTutari
             , TaksitTutari = @KalanTutar
             , TahsilTarihi = @BelgeTarihi
             , IsPaid = 1
             , BelgeDekontId = @dekontId 
           Where Id = @odemePlaniId

           -- Kalan TaksitTutarı için yeni satır oluştur
           Insert into dbo.OnmOdemePlani
               ( FirmId, IsActive, DonemTipiId, TalepId, TalepTipiId, UcretTipiId, CariId, TaksitTipiId
                ,TaksitNo, VadeTarihi 
                ,TaksitTutari, IsPaid
                ,YedekTaksitTutari, BelgeDekontId, PatchBelgeDekontId, BelgeStokBId )
                Select 
                 FirmId,        1, DonemTipiId, TalepId, TalepTipiId, UcretTipiId, CariId, TaksitTipiId
                ,TaksitNo, VadeTarihi 
                ,@TaksitTutari - @KalanTutar  -- eksik olan tutar
                ,0      --IsPaid
                ,null   --YedekTaksitTutari
                ,null   --BelgeDekontId
                ,@dekontId  --PatchBelgeDekontId ? bu Id sayesinde hangi tahsilat makbuzu yüzünden (eksik tahsilat) oluştuğu bulunuyor, yani sebep olan OnmBelgeDekont.Id
                ,null   --BelgeStokBId
               from dbo.OnmOdemePlani
	           where Id = @odemePlaniId
       end -- @KalanTutar < @TaksitTutari

       -- @KalanTutar + fazla geliyorsa
       if (@KalanTutar >= @TaksitTutari)
       begin
           --print 'fazla para'
           Update dbo.OnmOdemePlani set
               IsPaid = 1
             , TahsilTarihi = @BelgeTarihi
             , BelgeDekontId = @dekontId 
           Where Id = @odemePlaniId
       end

       set @KalanTutar = @KalanTutar - @TaksitTutari

       --print @BelgeTutari
       --print @TaksitTutari
       --print @KalanTutar
   end -- While

END -- prc_

/*CreateProcedureEnd*/