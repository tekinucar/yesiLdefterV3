
/*CreateTable*/

begin transaction

 create table OnmOdemePlani
 (
   Id                  Int IDENTITY(1,1) not null, 
   OdmemePlaniGUID     uniqueidentifier  null,
   FirmId              Int       not null,
   IsActive            Bit       not null, /* default : 1 = active, 0 = not active */ 
   DonemTipiId         Int           null, /* borcun oluştuğu YılAy ? neden kullanıldım, gereksizse sil */
   TalepId             Int           null, /* = MtskAdayTalep.Id */
   TalepTipiId         SmallInt      null, /* = MtskAdayTalep.TalepTipi */
   CariId              Int           null, /* = MtskAdayTalep.AdayId    */
   -- 20
   TaksitTipiId        SmallInt      null,  /* 1. Peşinat, 2. Taksit, 3. Tek Borç  */
   TaksitNo            Numeric(3)    null, 
   VadeTarihi          Date          null,
   TaksitTutari        Numeric(22,5) null, 
   IsPaid              Bit       not null, /* default : 0 = ödenmedi,  1 = Ödendi */  
   TahsilTarihi        Date          null,
   -- 30
   YedekTaksitTutari   Numeric(22,5) null, /* taksit tutarı eksik tahsil edildiği zaman ( YedekTaksitTutari = TaksitTutari, TaksitTutari = EksikTahsilTutarı ) şeklinde işleniyor */
   BelgeDekontId       Int           null, /* OnmBelgeDekont.Id */
   PatchBelgeDekontId  Int           null, /* eksik tahsil edildiğinde yeni oluşturulan satıra hangi BelgeDekontId den dolayı oluşturulduğunun işareti */
   BelgeStokBId        Int           null, /* Fatura için : BelgeStokB.Id  : BelgeStokB başlık tablosu */
   -- 40
   SourceTypeId        SmallInt      null, /* 0. manuel giriş, 1. Tabim Transfer */      
   SourceId            Int           null, /* Tabim CariAlt.Ulas */

   constraint		pk_OnmOdemePlani primary key (Id)
 )
  
 grant select, insert, update, delete on OnmOdemePlani to public

  create index X_OnmOdemePlani01 on OnmOdemePlani (TalepTipiId)
  create index X_OnmOdemePlani02 on OnmOdemePlani (CariId)
  create index X_OnmOdemePlani03 on OnmOdemePlani (VadeTarihi)
  create index X_OnmOdemePlani04 on OnmOdemePlani (TahsilTarihi)
  create index X_OnmOdemePlani05 on OnmOdemePlani (DonemTipiId)
 
commit transaction

/*CreateTableEnd*/

/*CreateLkpTable*/

begin transaction

-- ------------------------------------------------------- 
-- UcretTipiId
-- ------------------------------------------------------- 
create table [Lkp].[OnmOdemePlaniTalepTipi]
(
   Id                Int Unique not null, 
   TalepTipi         nVarchar(50)   null,
   
   constraint  pk_OnmOdemePlaniTalepTipi primary key (Id)
)

Delete from [Lkp].[OnmOdemePlaniTalepTipi]
INSERT INTO [Lkp].[OnmOdemePlaniTalepTipi] (Id, TalepTipi)
 VALUES 
  ( 0,        N''),
  ( 1000,     N'ÖnMuhasebe Modülü'),
  ( 21101,    N'Sertifika'),
  ( 21102,    N'2.+4 hak'),
  ( 21103,    N'Nakil 2.+4 hak'),
  ( 21104,    N'100 Ceza'),
  ( 21105,    N'Özel direksiyon ders (Aday değil)'),
  ( 21106,    N'Özel teorik ders'),
  ( 21111,    N'e-Sınav ücreti'),
  ( 21112,    N'Uygulama sınav ücreti'),
  ( 21113,    N'Başarısız eğitim ücreti')
  
-- ------------------------------------------------------- 
-- TaksitTipiId
-- ------------------------------------------------------- 
create table [Lkp].[OnmOdemePlaniTaksitTipi]
(
   Id               Int Unique not null, 
   TaksitTipi       nVarchar(20)   null,
   
   constraint  pk_OnmOdemePlaniTaksitTipi primary key (Id)
)

Delete from [Lkp].[OnmOdemePlaniTaksitTipi]
INSERT INTO [Lkp].[OnmOdemePlaniTaksitTipi] (Id, TaksitTipi)
 VALUES 
  ( 0,    N''),
  ( 1,    N'Peşinat'),
  ( 2,    N'Taksit'),
  ( 3,    N'Tek Ödeme')
    

-- ------------------------------------------------------- 
-- SourceTypeId
-- ------------------------------------------------------- 
create table [Lkp].[OnmOdemePlaniSourceType]
(
   Id               Int Unique not null, 
   SourceType       nVarchar(50)   null,
   
   constraint  pk_OnmOdemePlaniSourceType primary key (Id)
)

Delete from [Lkp].[OnmOdemePlaniSourceType]
INSERT INTO [Lkp].[OnmOdemePlaniSourceType] (Id, SourceType)
 VALUES 
  ( 0,     N''),
  ( 2100,  N'Mtsk Modülü - Kullanıcı girişi'),
  ( 2103,  N'Mtsk Veri Transferi - Giderler'),
  ( 2104,  N'Mtsk Veri Transferi - CariAlt'),
  ( 2105,  N'Mtsk Veri Transferi - Kurharc')

commit transaction

/*CreateLkpTableEnd*/


/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_OnmOdemePlani] on [dbo].[OnmOdemePlani]
AFTER INSERT, UPDATE
AS BEGIN

    declare odemePlaniCursor cursor for select Id from Inserted
    declare @Id bigint
	declare @FirmId int
	declare @ItemTypeId smallInt

    OPEN odemePlaniCursor

    FETCH NEXT FROM odemePlaniCursor INTO @Id --@curId

    WHILE @@FETCH_STATUS = 0
    BEGIN
        Select 
            @FirmId = ins.FirmId
           ,@ItemTypeId = ins.UcretTipiId
        From inserted ins
        Where ins.Id = @Id

      FETCH NEXT FROM odemePlaniCursor INTO @Id
    END -- While

    CLOSE odemePlaniCursor
    DEALLOCATE odemePlaniCursor   

    EXECUTE [dbo].[prc_OnmToplamBekleyenGelirler] @FirmId

END -- create trigger

/*CreateTriggerEnd*/


/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_OnmOdemePlaniDelete] on [dbo].[OnmOdemePlani]
FOR DELETE
AS BEGIN

    declare cursor_odemePlaniDlt cursor for select Id from deleted
    declare @curId bigint
	declare @FirmId int
	declare @ItemTypeId smallInt
	
	OPEN cursor_odemePlaniDlt

    FETCH NEXT FROM cursor_odemePlaniDlt INTO @curId

    WHILE @@FETCH_STATUS = 0
    BEGIN
        Select 
            @FirmId = dlt.FirmId
           ,@ItemTypeId = dlt.UcretTipiId
        From deleted dlt
        Where dlt.Id = @curId


      FETCH NEXT FROM cursor_odemePlaniDlt INTO @curId
    END

    CLOSE cursor_odemePlaniDlt
    DEALLOCATE cursor_odemePlaniDlt

    EXECUTE [dbo].[prc_OnmToplamBekleyenGelirler] @FirmId

END

/*CreateTriggerEnd*/




