/*
   İşletmenin eline geçen
   fatura, parekende fişi, kontrat vb... lere dayalı olarak bir ödeme emri belgesi oluşturulur.
   Zamanı gelince OnmBelgeDekont aracılığıylada bu belge ödenmiş olur. 
   IsPaid = 1 olunca görevi biter.
*/

/*CreateTable*/

begin transaction

-- Maliyet Belgeler hakkında detay

 create table OnmBelgeMaliyet
 (

   Id                 Int IDENTITY(1,1) NOT NULL, 
   ParentId           Int       not null, /* default 0 */
   FirmId             Int       not null,
   IsActive           Bit       not null, /* default : 1 = active, 0 = not active */  
   IsPaid             Bit       not null, /* default : 0 = ödenmedi, 1 = ödendi */  
   IsCommit           Bit       not null, /* default : 0 = muh. işlenmedi, 1 = muh. İşlendi */  
  
   BelgeTipiId        SmallInt      null, /* fatura, öck, parek.fişi, ...*/
   KaynakTipiId       SmallInt      null, /* 1. kağıt, 2. elektronik belge */
   
   -- 10 Belge Hakkında
   BelgeTarihi        Date          null,
   BelgeSaati         VarChar(8)    null,
   --BelgeYil           Smallint      null, 
   --BelgeAy            Smallint      null, 
   --BelgeGun           Smallint      null,
   BelgeSeri          nVarChar(10)  null,
   BelgeNo            nVarChar(50)  null,
   BelgeDonemTipiId   Int           null,

   -- 20 vadeler
   VadeGun            SmallInt      null,  
   SonOdemeTarihi     Date          null, 
   GecerlilikTarihi   Date          null, /* sigortanın son tarihi */
   
   -- 30
   CariId             Int           null,
   CariUnvan          nVarChar(200) null, /* cari hesabı yok ise */
   MaliyetId          Int           null, /* maliyet muhasebe hesap Id */
   VarlikId           Int           null, /* varlıkların (bina taşıt telekom vb ) */
   AboneId            Int           null, /* aylık abonelik faturaların işareti */
   ProjeId            Int           null, /* proje için takip */
   MaliyetKdvOrani    SmallInt      null, /* maliyet hesabında tanımlı olan kdv oranı */

   -- 40
   KdvOrani1          SmallInt      null,
   KdvMatrahi1        Numeric(22,5) null,
   KdvTutari1         Numeric(22,5) null,
   KdvliToplam1       Numeric(22,5) null,
   -- 50
   KdvOrani2          SmallInt      null,
   KdvMatrahi2        Numeric(22,5) null,
   KdvTutari2         Numeric(22,5) null,
   KdvliToplam2       Numeric(22,5) null,
   -- 60
   KdvOrani3          SmallInt      null,
   KdvMatrahi3        Numeric(22,5) null,
   KdvTutari3         Numeric(22,5) null,
   KdvliToplam3       Numeric(22,5) null,
   -- 70 Kdvsiz matrah
   KdvOrani0          SmallInt      null,
   KdvMatrahi0        Numeric(22,5) null,
   KdvTutari0         Numeric(22,5) null,
   KdvliToplam0       Numeric(22,5) null,
   -- 80
   KdvMatrahToplami   Numeric(22,5) null,
   KdvTutariToplami   Numeric(22,5) null,
   KdvliToplam        Numeric(22,5) null,

   -- 100
   BelgeTutari        Numeric(22,5) null, /* belgenin kdvli toplam tutarı */
   IndirimTutari      Numeric(22,5) null,
   GenelToplam        Numeric(22,5) null,
   MinOdemeTutari     Numeric(22,5) null,

   VergiVeFonlar      Numeric(22,5) null,    
   MasrafMiktari      Numeric(22,5) null,    
   
   -- 110 Döviz bilgileri 
   ParaTipiId1        nVarChar(3)   null,
   DovizYeriId1       SmallInt      null,
   DovizKuru1         Numeric(12,8) null,
   DovizTutari1       Numeric(22,8) null,
   -- 120 Döviz bilgileri 
   ParaTipiId2        nVarChar(3)   null,
   DovizYeriId2       SmallInt      null,
   DovizKuru2         Numeric(12,8) null,
   DovizTutari2       Numeric(22,8) null,

   -- 130
   -- İşlendi : bu belge ödendi tahsil edildi vb... 
   Aciklama           nVarchar(200) null, 

   -- 140
   KayitTarihi        DateTime      null, 
   BelgeDekontId      Int           null, /* OnmBelgeDekont.Id = Ödeme yapan belge ıd */  
   CommitTable        Int           null, /* ilgili table */
   CommitId           Int           null, /* ilgili table ref Id */

   constraint		pk_OnmBelgeMaliyet primary key (Id)
 )

 create index X_OnmBelgeMaliyet01 on OnmBelgeMaliyet (FirmId)
 create index X_OnmBelgeMaliyet02 on OnmBelgeMaliyet (BelgeTipiId)
 create index X_OnmBelgeMaliyet03 on OnmBelgeMaliyet (KayitTarihi)
 create index X_OnmBelgeMaliyet04 on OnmBelgeMaliyet (BelgeTarihi)
 create index X_OnmBelgeMaliyet05 on OnmBelgeMaliyet (SonOdemeTarihi)
 create index X_OnmBelgeMaliyet06 on OnmBelgeMaliyet (GecerlilikTarihi)
 
 create index X_OnmBelgeMaliyet07 on OnmBelgeMaliyet (CariId)
 create index X_OnmBelgeMaliyet08 on OnmBelgeMaliyet (MaliyetId)
 create index X_OnmBelgeMaliyet09 on OnmBelgeMaliyet (VarlikId)
 create index X_OnmBelgeMaliyet10 on OnmBelgeMaliyet (AboneId)

 grant select, insert, update, delete on OnmBelgeMaliyet to public

 commit transaction

 /*CreateTableEnd*/


 /*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_OnmBelgeMaliyet] on [dbo].[OnmBelgeMaliyet] 
AFTER INSERT, UPDATE
AS BEGIN

    declare cursor_BMaliyet cursor for select Id from Inserted
    declare @curId bigint
    
    declare @FirmId int
    declare @BelgeTarihi date
    declare @SonOdemeTarihi date
    declare @Yil varchar(4)
	declare @Ay varchar(2)
	--declare @BelgeTutari numeric(22,8)

    declare @yKdvOrani1    smallInt
	declare @yKdvOrani2    smallInt
    declare @yKdvOrani3    smallInt

    declare @yKdvMatrahi1  numeric(22,8)
    declare @yKdvMatrahi2  numeric(22,8)
    declare @yKdvMatrahi3  numeric(22,8)
    declare @yKdvMatrahi0  numeric(22,8)
    declare @yMaliyetKdvOrani  smallInt

	declare @yKayitTarihi date 
    declare @KdvOranSayisi smallInt
    
	OPEN cursor_BMaliyet

    FETCH NEXT FROM cursor_BMaliyet INTO @curId

    WHILE @@FETCH_STATUS = 0
    BEGIN
      select 
	      @FirmId = ins.FirmId
		 ,@BelgeTarihi = ins.BelgeTarihi
	     ,@SonOdemeTarihi = ins.SonOdemeTarihi
	     --,@BelgeTutari = ins.BelgeTutari
	     ,@yMaliyetKdvOrani = ins.MaliyetKdvOrani

	     ,@yKdvOrani1 = ins.KdvOrani1
	     ,@yKdvOrani2 = ins.KdvOrani2
	     ,@yKdvOrani3 = ins.KdvOrani3

	     ,@yKdvMatrahi1 = isnull(ins.KdvMatrahi1,0)
	     ,@yKdvMatrahi2 = isnull(ins.KdvMatrahi2,0)
	     ,@yKdvMatrahi3 = isnull(ins.KdvMatrahi3,0)
	     ,@yKdvMatrahi0 = isnull(ins.KdvMatrahi0,0)

         ,@yKayitTarihi = ins.KayitTarihi  
      from Inserted ins
      where ins.Id = @curId
	  
	  if (@SonOdemeTarihi is null) or
	     (@SonOdemeTarihi < @BelgeTarihi)
	  begin
	    update OnmBelgeMaliyet set 
		  SonOdemeTarihi = @BelgeTarihi
		where Id = @curId
	  end

	  if (@yKdvOrani1 = 0) update OnmBelgeMaliyet set KdvliToplam1 = 0 where Id = @curId
	  if (@yKdvOrani2 = 0) update OnmBelgeMaliyet set KdvliToplam2 = 0 where Id = @curId
	  if (@yKdvOrani3 = 0) update OnmBelgeMaliyet set KdvliToplam3 = 0 where Id = @curId

	  -- birden fazla kdv oranı varmı kontrol ediliyor 
      set @KdvOranSayisi = 0
      
      if (@yKdvMatrahi1 > 0) set @KdvOranSayisi = @KdvOranSayisi + 1
      if (@yKdvMatrahi2 > 0) set @KdvOranSayisi = @KdvOranSayisi + 1
      if (@yKdvMatrahi3 > 0) set @KdvOranSayisi = @KdvOranSayisi + 1
      if (@yKdvMatrahi0 > 0) set @KdvOranSayisi = @KdvOranSayisi + 1

      -- birdern fazla kdv oranı var ise 
      -- Karma Kdv mevcut işaretini koy
      if (@KdvOranSayisi > 1)
      begin
	    update OnmBelgeMaliyet set 
		  MaliyetKdvOrani = -1 
		where Id = @curId
      end

	  if (@yKayitTarihi is null)
	  begin
	    update OnmBelgeMaliyet set 
		  KayitTarihi = GETDATE()
        where Id = @curId
	  end
	  	
      set @Yil = convert(varchar(4), YEAR(@BelgeTarihi))
      set @Ay = convert(varchar(2), MONTH(@BelgeTarihi)) 		
	  if (len(@Ay) = 1) set @Ay = '0' + @Ay

	  update OnmBelgeMaliyet set BelgeDonemTipiId = convert(int, (@Yil + @Ay))
	  where Id = @curId
	  
      FETCH NEXT FROM cursor_BMaliyet INTO @curId
    END

    CLOSE cursor_BMaliyet
    DEALLOCATE cursor_BMaliyet

	--EXECUTE [dbo].[prc_OnmToplamBekleyenOdemeler] @FirmId
	   
END

 /*CreateTriggerEnd*/


 /*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_OnmBelgeMaliyetDelete] on [dbo].[OnmBelgeMaliyet]
FOR DELETE
AS BEGIN

    declare cursor_belgeMaliyetDlt cursor for select Id from deleted
    declare @curId bigint
	declare @FirmId int
	
	OPEN cursor_belgeMaliyetDlt

    FETCH NEXT FROM cursor_belgeMaliyetDlt INTO @curId

    WHILE @@FETCH_STATUS = 0
    BEGIN
        Select 
            @FirmId = dlt.FirmId
        From deleted dlt
        Where dlt.Id = @curId


      FETCH NEXT FROM cursor_belgeMaliyetDlt INTO @curId
    END

    CLOSE cursor_belgeMaliyetDlt
    DEALLOCATE cursor_belgeMaliyetDlt

	EXECUTE [dbo].[prc_OnmToplamBekleyenOdemeler] @FirmId 

END

 /*CreateTriggerEnd*/


 /*CreateLkpTable*/

 begin transaction

-- ------------------------------------------------------- 
-- BelgeTipiId
-- ------------------------------------------------------- 
create table [Lkp].[OnmBelgeMaliyetBelgeTipi]
(
   Id           Int Unique Not Null,
   BelgeTipi    nVarchar(50),
   GrupTipiId   SmallInt Null,

   constraint  pk_OnmBelgeMaliyetBelgeTipi primary key (Id)
)

delete from [Lkp].[OnmBelgeMaliyetBelgeTipi]
INSERT INTO [Lkp].[OnmBelgeMaliyetBelgeTipi] (Id, BelgeTipi, GrupTipiId)
 VALUES 
  (0,   N'Tanımsız', 0),
  (1,   N'Fatura', 1),
  (2,   N'ÖKC Fişi', 1),
  (3,   N'Perakende Satış Belgesi', 1),
  (4,   N'Gider Pusulası', 1),
  (5,   N'Müstahsil Makbuzu', 1),
  (6,   N'Serbest Meslek Makbuzu', 1),
  (7,   N'Tevsiki Zaruri Olmayan', 1),
  (8,   N'Yapay Belge', 1),
  (21,  N'Muhasebe Dekontu', 1),
  (22,  N'Hesap Extresi', 1)


-- ------------------------------------------------------- 
-- KaynakTipiId
-- ------------------------------------------------------- 
create table [Lkp].[OnmBelgeMaliyetKaynakTipi]
(
   Id           Int Unique Not Null,
   KaynakTipi   nVarchar(50),
   GrupTipiId   SmallInt Null,

   constraint  pk_OnmBelgeMaliyetKaynakTipi primary key (Id)
)

delete from [Lkp].[OnmBelgeMaliyetKaynakTipi]
INSERT INTO [Lkp].[OnmBelgeMaliyetKaynakTipi] (Id, KaynakTipi, GrupTipiId)
 VALUES 
  (0,   N'Tanımsız', 0),
  (1,   N'e-devlet', 1), 
  (2,   N'e-fatura', 1),
  (3,   N'e-belge', 1),
  (4,   N'Kağıt', 1),
  (5,   N'Sms', 1),
  (6,   N'Fax', 1),
  (7,   N'Telefon', 1),
  (8,   N'Diğer', 1)


 commit transaction

 /*CreateLkpTableEnd*/



 /*
 +Fatura

Faturayı tamamlayan veya fatura düzenlenmesini gerektiren belgeler
Sevk İrsaliyesi
Taşıma İrsaliyesi
Yolcu Listeleri
Günlük Müşteri Listeleri
Adisyonlar
Hak Ediş Belgesi

Fatura yerine geçen belgeler
+Perakende Satış Belgeleri
+Gider Pusulası
+Müstahsil Makbuzu
+Serbest Meslek Makbuzu
+Yapay Belgeler
+Muhasebe Dekontu (vergi, sgk... ödeme emirleri)

Alınan belge türü
----------------------------
Fatura
Perakende Satış Belgeleri
Gider Pusulası
Müstahsil Makbuzu
Serbest Meslek Makbuzu
Yapay Belgeler
Muhasebe Dekontu





    declare @yKdvOrani1    smallInt
    //declare @yKdvMatrahi1  numeric(22,8)
    //declare @yKdvTutari1   numeric(22,8)
    //declare @yKdvliToplam1 numeric(22,8)

	declare @yKdvOrani2    smallInt
    //declare @yKdvMatrahi2  numeric(22,8)
    //declare @yKdvTutari2   numeric(22,8)
    //declare @yKdvliToplam2 numeric(22,8)

    declare @yKdvOrani3    smallInt
    //declare @yKdvMatrahi3  numeric(22,8)
    //declare @yKdvTutari3   numeric(22,8)
    //declare @yKdvliToplam3 numeric(22,8)

    declare @yKdvOrani0    smallInt
    //declare @yKdvMatrahi0  numeric(22,8)
    //declare @yKdvTutari0   numeric(22,8)
    //declare @yKdvliToplam0 numeric(22,8)

	     ,@yKdvOrani1 = ins.KdvOrani1
	     //,@yKdvMatrahi1 = isnull(ins.KdvMatrahi1,0)
         //,@yKdvTutari1 = isnull(ins.KdvTutari1,0)
         //,@yKdvliToplam1 = isnull(ins.KdvliToplam1,0)

	     ,@yKdvOrani2 = ins.KdvOrani2
	     //,@yKdvMatrahi2 = isnull(ins.KdvMatrahi2,0)
         //,@yKdvTutari2 = isnull(ins.KdvTutari2,0)
         //,@yKdvliToplam2 = isnull(ins.KdvliToplam2,0)

	     ,@yKdvOrani3 = ins.KdvOrani3
	     //,@yKdvMatrahi3 = isnull(ins.KdvMatrahi3,0)
         //,@yKdvTutari3 = isnull(ins.KdvTutari3,0)
         //,@yKdvliToplam3 = isnull(ins.KdvliToplam3,0)

	     ,@yKdvOrani0 = ins.KdvOrani0
	     //,@yKdvMatrahi0 = isnull(ins.KdvMatrahi0,0)
         //,@yKdvTutari0 = isnull(ins.KdvTutari0,0)
         //,@yKdvliToplam0 = isnull(ins.KdvliToplam0,0)


*/