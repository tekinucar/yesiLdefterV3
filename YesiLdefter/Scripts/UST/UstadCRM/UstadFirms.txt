USE [UstadCRM]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


begin transaction
 create table UstadFirms
 (
    FirmId          Int IDENTITY(1,1) not null,
	ParentFirmId    Int               null,
	IsActive        Bit               not null,
	FirmTypeId      SmallInt          null, /* 1.Merkez, 2.Şube, 3.GrupFirma  */ 
	FirmGUID        uniqueidentifier  null,

	SectorTypeId    SmallInt          null, /* 1.ÖnMuhasebe, 2.MaliMüşavir, 3.Bordro,  21. mtsk, 22. src, 23. işmak, 24. ? */ 
	FirmCode        nVarchar(50)      null, /* Mebbis Kodu */
	FirmLongName    nVarchar(150)     null,
	FirmShortName   nVarchar(50)      null,
	FirmPhone       Varchar(15)       null,  
	WebPage         nVarchar(50)      null,
	EMail           nVarchar(50)      null,
	Address1        nVarchar(200)     null,
	Address2        nVarchar(200)     null,
	AddressCode     varchar(20)       null,
	DistrictTypeId  int               null, /* İlçe */
	CityTypeId      int               null, /* İl */ 
	FirmOpenDate    Date              null, /* Kuruluş Tarihi */
	FounderName     nVarchar(100)     null, /* Kurucu Adı */
	FounderPhone    nVarchar(15)      null, /* Kurucu Tel */
	ManagerName     nVarchar(100)     null, /* Müdür Adı */
	ManagerPhone    nVarchar(15)      null, /* Müdür Tel */
	
	MenuCode        nVarchar(50)      null, /* çalıştığı paketin ana menüsü */
	ServerNameIP    nVarchar(50)      null, /* database nin olduğu ip */
	DatabaseName    nVarchar(50)      null,
	DbLoginName     nVarchar(30)      null, 
	DbPass          nVarchar(30)      null,
	DbTypeId        SmallInt          null, /* üstad firması çalışanları için databaselerin amaçları */  
	RecordDate      SmallDatetime     null,

	/* Bu tür bilgiler artınca UstadFirms tablasuna bağlı ikinci tablo oluştur */
    MebbisCode      nVarchar(30)      null,
    MebbisPass      nVarchar(30)      null, 

	/* firmanın aktarılacak database bilgisi */
	SourceFirmTypeId      SmallInt          null, /* hangi firmadan aktarılıyor */
	SourceDataTypeId      SmallInt          null, /* 1. Mebbisden alınacak, 2. MSSQL Database */
	SourceServerNameIP    nVarchar(50)      null, /* database nin olduğu ip */
	SourceDatabaseName    nVarchar(50)      null,
	SourceDbLoginName     nVarchar(30)      null, 
	SourceDbPass          nVarchar(30)      null,
	

   Constraint pk_UstadFirms primary key (FirmId)
 )

 create index X_UstadFirms_00 on UstadFirms (ParentFirmId)
 create index X_UstadFirms_01 on UstadFirms (FirmGUID)
 create index X_UstadFirms_02 on UstadFirms (FirmLongName)
 create index X_UstadFirms_03 on UstadFirms (FirmShortName)
 create index X_UstadFirms_04 on UstadFirms (CityTypeId,DistrictTypeId)
 create index X_UstadFirms_05 on UstadFirms (SectorTypeId)

 grant select, insert, update, delete on UstadFirms to public

commit transaction


create trigger [dbo].[trg_UstadFirms] on [dbo].[UstadFirms]
after insert, update
as begin

    declare cursor_UstadFirms cursor for select FirmId from Inserted
    declare @curId bigint

    OPEN cursor_UstadFirms

    FETCH NEXT FROM cursor_UstadFirms INTO @curId

    declare @SectorTypeId smallInt = 0
	declare @FirmGUID VarChar(50) = ''
	
	declare @DatabaseName nvarchar(50) = ''
	declare @RecordDate smalldatetime 
	declare @dbNameKunye varchar(10) = ''

	declare @Id varchar(8) = ''
	declare @Length smallInt = 8
	declare @PaddingChar char(1) = '0'

    WHILE @@FETCH_STATUS = 0
    BEGIN
		Select 
		  @SectorTypeId = isnull(ins.SectorTypeId, 0) 
		, @FirmGUID = ins.FirmGUID
		, @DatabaseName = isnull(ins.DatabaseName,'')
		, @RecordDate = ins.RecordDate
    	From Inserted ins
    	Where ins.FirmId = @curId

	    if ((@FirmGUID = '') or 
		    (@FirmGUID is null))
    	begin
    	  Update UstadFirms set 
            FirmGUID = NEWID()
          where FirmId = @curId 
    	end

		if (@DatabaseName = '')
		begin
          if (@SectorTypeId = 1) set @dbNameKunye = 'OnMuh'
          if (@SectorTypeId = 2) set @dbNameKunye = 'MaliM'
          if (@SectorTypeId = 3) set @dbNameKunye = 'ResMuh'
          if (@SectorTypeId = 4) set @dbNameKunye = 'Bordro'
          if (@SectorTypeId = 5) set @dbNameKunye = 'Crm'
		  if (@SectorTypeId = 201) set @dbNameKunye = 'Mtsk'
		  if (@SectorTypeId = 202) set @dbNameKunye = 'Ismak'
		  if (@SectorTypeId = 203) set @dbNameKunye = 'Src'

		  set @Id = CONVERT(varchar(8), @curId)
          
		  set @DatabaseName = @dbNameKunye + RIGHT(Replicate(@PaddingChar, @Length) + @Id, @Length)

		  Update UstadFirms set 
            DatabaseName = @DatabaseName
          where FirmId = @curId 

		end
		
		if (@RecordDate is null)
		begin
    	  Update UstadFirms set 
            RecordDate = GETDATE()
          where FirmId = @curId 
		end

    	FETCH NEXT FROM cursor_UstadFirms INTO @curId
    end -- While

    CLOSE cursor_UstadFirms
    DEALLOCATE cursor_UstadFirms  
	
end -- trigger


alter table [dbo].[UstadFirms] ENABLE TRIGGER [trg_UstadFirms]
GO

-- ------------------------------------------------------- 
-- SectorType
-- ------------------------------------------------------- 
create table [Lkp].[UstadFirmsSectorType]
(
   Id               Int Unique not null, 
   SectorType       nVarchar(20)   null,
   
   constraint  pk_UstadFirmsSectorType primary key (Id)
)

Delete from [Lkp].[UstadFirmsSectorType]
INSERT INTO [Lkp].[UstadFirmsSectorType] (Id, SectorType)
 VALUES 
  ( 0,    N''),
  ( 1,    N'Ön Muhasebe'),
  ( 2,    N'Mali Müşavir'),
  ( 3,    N'Resmi Muhasebe'),
  ( 4,    N'Bordro'),
  ( 5,    N'Ustad Crm'),
  ( 201,  N'Mtsk'),
  ( 202,  N'İşmak'),
  ( 203,  N'SRC'),
  ( 211,  N'TabimMtsk')


-- ------------------------------------------------------- 
-- FirmType
-- ------------------------------------------------------- 
create table [Lkp].[UstadFirmsFirmType]
(
   Id               Int Unique not null, 
   FirmType         nVarchar(20)   null,
   
   constraint  pk_UstadFirmsFirmType primary key (Id)
)

Delete from [Lkp].[UstadFirmsFirmType]
INSERT INTO [Lkp].[UstadFirmsFirmType] (Id, FirmType)
 VALUES 
  ( 0,    N''),
  ( 1,    N'Merkez'),
  ( 2,    N'Şube'),
  ( 3,    N'Grup Firma')


/* üstad firması çalışanları için databaselerin amaçları */  
-- ------------------------------------------------------- 
-- DbTypeId
-- ------------------------------------------------------- 
create table [Lkp].[UstadFirmsDbType]
(
   Id               Int Unique not null, 
   DbType           nVarchar(100)   null,
   
   constraint  pk_UstadFirmsDbType primary key (Id)
)

Delete from [Lkp].[UstadFirmsDbType]
INSERT INTO [Lkp].[UstadFirmsDbType] (Id, DbType)
 VALUES 
  ( 0,    N''),
  ( 1,    N'Yazılım database (Yazılım bölümü çalışmaları)'),
  ( 2,    N'Abone database (Ustad yazılım müşterileri)'),
  ( 3,    N'Ustad CRM database (Ustad CRM datası)'),
  ( 4,    N'Muhasebe database (Ustad şirket muhasebesi)')
	


/* kaynak firma : müşteri daha önce hangi programı kullanıyordu */
-- ------------------------------------------------------- 
-- SourceFirmTypeId
-- ------------------------------------------------------- 
create table [Lkp].[UstadFirmsSourceFirmType]
(
   Id               Int Unique not null, 
   SourceFirmType   nVarchar(50)   null,
   
   constraint  pk_UstadFirmsSourceFirmType primary key (Id)
)

Delete from [Lkp].[UstadFirmsSourceFirmType]
INSERT INTO [Lkp].[UstadFirmsSourceFirmType] (Id, SourceFirmType)
 VALUES 
  ( 0,    N'Firma belli değil'),
  ( 11,   N'Yeni Mtsk'),
  ( 12,   N'Tabim'),
  ( 13,   N'Akınsoft'),
  ( 14,   N'GoldenNet'),
  ( 15,   N'WennTec'),
  ( 16,   N'Ths'),
  ( 17,   N'Çizgisoft')


/* firmanın aktarılacak datası nereden alındı */
-- ------------------------------------------------------- 
-- SourceDataTypeId
-- ------------------------------------------------------- 
create table [Lkp].[UstadFirmsSourceDataType]
(
   Id               Int Unique not null, 
   SourceDataType   nVarchar(50)   null,
   
   constraint  pk_UstadFirmsSourceDataType primary key (Id)
)

Delete from [Lkp].[UstadFirmsSourceDataType]
INSERT INTO [Lkp].[UstadFirmsSourceDataType] (Id, SourceDataType)
 VALUES 
  ( 0,   N'Veri kaynağı belli değil'),
  ( 1,   N'Mebbis'),
  ( 2,   N'MSSQL Database')



