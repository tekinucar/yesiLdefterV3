
/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayTalepYasiniHesapla] (@TalepId int)  
AS BEGIN

  --declare @TalepId int
  --set @TalepId = 315

  declare @AdayId int
  declare @yTalepTipiId smallint = 0
  declare @yDogumTarihi date 
  declare @yMevcutSertifikaTipiId smallInt = 0
  declare @yIstenenSertifikaTipiId smallint = 0
  declare @yIsMuafiyetiVar bit = 0
  declare @YasSiniri smallint = 0

  declare @yasOnayiTipiId smallint = 0
  declare @yasHazirTarihi date = null

  print '    prc_MtskAdayTalepYasiniHesapla başladı'

  -- [Lkp].[MtskAdayTakipYasOnayiTipi]
  -- 0,  'Yaşı tutuyor'
  -- 1,  'Yaşı tutmuyor'
  -- 2,  'Yaş için bekleme süresi doldu'
  -- 3,  'Muhafiyetle onaylı'
  -- 4,  'Doğum tarihi yok, belirsiz'
  -- 5,  'Yaş kontrolü yok'

  Select 
    @yDogumTarihi = aday.DogumTarihi
   ,@yTalepTipiId = isnull(ins.TalepTipiId,0)
   ,@yMevcutSertifikaTipiId = isnull(ins.MevcutSertifikaTipiId,0)
   ,@yIstenenSertifikaTipiId = isnull(ins.IstenenSertifikaTipiId,0)
   ,@yIsMuafiyetiVar = isnull(ins.IsMuafiyetiVar,0)	
  From  MtskAdayTalep as ins, MtskAday as aday
  Where ins.AdayId = aday.Id
  and ins.Id = @TalepId

  -- Talep tipi
  if (@yTalepTipiId = 4 or -- 100 ceza ise
      @yTalepTipiId = 5 or -- özel uygulama ise
      @yTalepTipiId = 6)   -- özel test ise
	  set @yIstenenSertifikaTipiId = @yMevcutSertifikaTipiId

  Select top 1 @YasSiniri = isnull(saat.YasSiniri,0)
  From MtskSaatUygulama as saat
       left outer join GecerlilikTarihi as gt on ( saat.GecerlilikTarihiId = gt.Id )
  Where saat.IstenenSertifikaTipiId = @yIstenenSertifikaTipiId
  and   gt.KonuTipiId = 21102 -- Uygulama saatleri
  order by gt.Tarih desc

  -- Yaş için muhafiyeti var ise 2 yıl daha sınırı aşağıya çek
  if (@yIsMuafiyetiVar = 1)
      set @YasSiniri = @YasSiniri - 2 

  --print @YasSiniri

  -- Yas Onayi
  if (@yDogumTarihi is not null)
  begin
      --declare @yDogumTarihi date = convert(date, '29.05.2003', 103)
	  set @yasOnayiTipiId = 0 -- yaşı tutuyor
	  set @yasHazirTarihi = null

      declare @bugun date = convert(date,GETDATE(),103)
      declare @Yasi int = 0
      declare @YilFarki int = 0
      declare @AyFarki int = 0

      if (@YasSiniri > 0)
      begin
          set @Yasi = DATEDIFF(YEAR, @yDogumTarihi, @bugun) 
          set @YilFarki = @Yasi - @YasSiniri 
          set @yasHazirTarihi = DATEADD(YEAR, @YasSiniri, @yDogumTarihi) 
          set @AyFarki = DATEDIFF(MONTH, @yasHazirTarihi, @bugun) 

          if (@bugun < @yasHazirTarihi) set @yasOnayiTipiId = 1 -- yaşı tutmuyor
          if (@bugun >= @yasHazirTarihi and @YilFarki = 0 and (@AyFarki >= 0 and @AyFarki < 4) ) set @yasOnayiTipiId = 2 -- üç aydır yaşı tutuyor
      end else
      begin
          set @yasOnayiTipiId = 5 -- yaş kontrolü yok
          set @yasHazirTarihi = null 
      end
  end else  
  begin
      set @yasOnayiTipiId = 4 -- belirsiz
  end

  -- (  yaşı tutuyor     veya yaşını doldurmuş ise) ve   Muhafiyeti var ise
  if ((@yasOnayiTipiId = 0 or @yasOnayiTipiId = 2) and @yIsMuafiyetiVar = 1) 
      set @yasOnayiTipiId = 3 -- yaş muafiyeti var

  -- Tespitleri kaydet
  Update MtskAdayTakip set
    SertifikaYasSiniri = @YasSiniri
  , YasOnayiTipiId = @yasOnayiTipiId
  , YasHazirTarihi = @yasHazirTarihi
  Where TalepId = @TalepId

  print '    prc_MtskAdayTalepYasiniHesapla bitti'

END -- procedure

/*CreateProcedureEnd*/
