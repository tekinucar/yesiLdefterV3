/*CreateTable*/

begin transaction

 create table MtskAdaySertifika
 (
   Id                    Int IDENTITY(1,1) not null, 
   FirmId                Int       not null, -- 2
   TalepId               Int       not null, -- 4
   AdayId                Int       not null, -- 5
   TcNo                  Varchar(11)   null, -- 6
   DonemTipiId           Int           null, -- 7
   VeriKaynakId          Int           null, /* Veri transferi edildiği tablodaki Id . Sorun olduğunda bilginin nereden geldiğine referans olsun */
  
   --10 sertifika aşaması
   SertifikaAlmayiHakKazandi Bit           null, -- hak kazandı   : false/true
   SertifikaTarihi           Date          null, --
   SertifikaTeslimEdildi     Bit           null, -- teslim edildi : false/true =  
   SertifikaTeslimTarihi     Date          null, --
   SertifikayiTeslimAlanKisi nVarchar(50)  null, --
   SertifikaSeri             nVarchar(10)  null,
   SertifikaNo               nVarchar(20)  null, 
   SertifikaDonemTipiId      Int           null,
   SertifikaBaskiAdedi       SmallInt      null,
   SertifikayiVerenKurum     nVarchar(100) null, 
   DuzenlemeTarihi           Date          null,

   constraint		pk_MtskAdaySertifika primary key (Id)
 )
  
 grant select, insert, update, delete on MtskAdaySertifika to public

 create index X_MtskAdaySertifika01 on MtskAdaySertifika (TalepId)
 create index X_MtskAdaySertifika02 on MtskAdaySertifika (AdayId)
 create index X_MtskAdaySertifika03 on MtskAdaySertifika (TcNo)
 create index X_MtskAdaySertifika04 on MtskAdaySertifika (DuzenlemeTarihi)
   
commit transaction

/*CreateTableEnd*/


/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_MtskAdaySertifika] on [dbo].[MtskAdaySertifika] 
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE sertifikaCursor cursor local for select Id from Inserted 
    DECLARE @sertifikaId bigint

    OPEN sertifikaCursor
    FETCH NEXT FROM sertifikaCursor INTO @sertifikaId
 
    -- Veri Transferi başladımı
    declare @DbUpdatesIsActive Bit = 0
    set @DbUpdatesIsActive = [dbo].[fnc_getIsDbUpdate] (13)
	
    declare @eTalepId int = 0
	declare @eAdayId int = 0
	declare @eTcNo varchar(11) = ''
	declare @eSertifikaNo varchar(20)

	declare @yFirmId int = 0
	declare @yTalepId int = 0
	declare @yAdayId int = 0
	declare @VeriKaynakId int
	declare @yTcNo varchar(11) = ''
	declare @ySertifikaAlmayiHakKazandi bit  = 0
	declare @ySertifikaTarihi date = null
	declare @ySertifikaNo varchar(20)
	declare @ySertifikaDonemTipiId int = 0
	declare @yDuzenlemeTarihi date = null
	
    WHILE @@FETCH_STATUS = 0
    BEGIN
	    
		select
		  @eTalepId = isnull(dlt.talepId,0)
    	, @eAdayId = isnull(dlt.AdayId,0)
	    , @eTcNo = isnull(dlt.TcNo,'')
		from deleted dlt
    	where dlt.Id = @sertifikaId

        select 
            @yFirmId = ins.FirmId
          , @yTalepId = ins.TalepId
    	  , @yAdayId = isnull(ins.AdayId,0)
		  , @VeriKaynakId = ins.VeriKaynakId
	      , @yTcNo = isnull(ins.TcNo,'')
		  , @ySertifikaAlmayiHakKazandi = isnull(ins.SertifikaAlmayiHakKazandi,0)
		  , @ySertifikaTarihi = ins.SertifikaTarihi
		  , @ySertifikaNo = ins.SertifikaNo
		  , @yDuzenlemeTarihi = ins.DuzenlemeTarihi
		from inserted ins
    	where ins.Id = @sertifikaId

        if (@VeriKaynakId > 0 and (@yTalepId = 0 or @yAdayId = 0))
        begin
            Update dbo.MtskAdaySertifika set
                TalepId = t.Id  
               ,AdayId  = t.AdayId 
            From dbo.MtskAdaySertifika as a,
                 dbo.MtskAdayTalep as t
            Where a.VeriKaynakId = t.VeriKaynakId				 
            and   a.Id = @sertifikaId

            Select
                @yTalepId = t.Id  
               ,@yAdayId  = t.AdayId 
            From dbo.MtskAdaySertifika as a,
                 dbo.MtskAdayTalep as t
            Where a.VeriKaynakId = t.VeriKaynakId				 
            and   a.Id = @sertifikaId
        end

		-- Sertifikanın hangi dönemde verildiği tespit ediliyor
		if (MONTH(@ySertifikaTarihi) < 10)
               set @ySertifikaDonemTipiId = convert(int, convert(varchar(5), YEAR(@ySertifikaTarihi)) + '0' + convert(varchar(3), MONTH(@ySertifikaTarihi)))
          else set @ySertifikaDonemTipiId = convert(int, convert(varchar(5), YEAR(@ySertifikaTarihi)) + convert(varchar(3), MONTH(@ySertifikaTarihi)))


        -- Buraya gerek kalmadı sanki  
        /*
		if (@yTalepId = 0 and @yTcNo <> '')
		begin
           Select top 1 @yTalepId = Id 
           From MtskAdayTalep
           Where TcNo = @yTcNo
           and   DonemTipiId <= @ySertifikaDonemTipiId
           order by DonemTipiId desc
		end
        if (@yAdayId = 0)
		begin
		    Select @yAdayId = Id from MtskAday 
			Where TcNo = @yTcNo
		end
        */
        -- ----------------------
		
		if ((@eSertifikaNo <> @ySertifikaNo) and
		    (@ySertifikaNo <> '') and
		    (@yDuzenlemeTarihi is null)) set @yDuzenlemeTarihi = getdate()

		if ((@eSertifikaNo <> @ySertifikaNo) and
		    (@ySertifikaNo = '') and
		    (@yDuzenlemeTarihi is not null)) set @yDuzenlemeTarihi = null

		if ((@eTalepId <> @yTalepId) or
		    (@eAdayId <> @yAdayId) or
		    (@eTcNo <> @yTcNo))
        begin 
		   Update MtskAdaySertifika set
		     TalepId = @yTalepId
           , AdayId = @yAdayId
           , TcNo = @yTcNo 
		   , DuzenlemeTarihi = @yDuzenlemeTarihi
		   Where Id = @sertifikaId
		end
		if ((@yTalepId > 0) and 
		    (@ySertifikaAlmayiHakKazandi = 1) and
			(@DbUpdatesIsActive = 0))
        begin
           Update MtskAdayTalep 
		   set KayitTipiId = 4 -- Sertifikayı hak kazandı
		   Where Id = @yTalepId
		end

        -- Data transferi oldu fakat daha önce bu talep için boş kayıt oluşturulmuş ise onu sil
        if (@VeriKaynakId > 0)
        begin
		    Delete From dbo.MtskAdaySertifika
            Where TalepId = @yTalepId
            and   isnull(VeriKaynakId,0) = 0
        end

        FETCH NEXT FROM sertifikaCursor INTO @sertifikaId
    END

	--EXECUTE [dbo].[prc_MtskAdayTakip] 2 @yFirmId

    CLOSE sertifikaCursor
    DEALLOCATE sertifikaCursor


END --- trg_

/*CreateTriggerEnd*/

