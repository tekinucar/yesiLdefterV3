/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskGrupSubesiTakipSet] (@FirmId int, @DonemTipiId int, @GrupTipiId smallint, @SubeTipiId smallint)  
AS BEGIN

  /*
  declare @FirmId int
  declare @DonemTipiId int = 0
  declare @GrupTipiId  smallint = 0
  declare @SubeTipiId  smallint = 0

  set @FirmId = 30
  set @DonemTipiId = 202407
  set @GrupTipiId = 1
  set @SubeTipiId = 1
  */
  declare @BugunDonemTipiId int = 0
  declare @DersSayisiTrf smallInt = 0
  declare @DersSayisiIlk smallInt = 0
  declare @DersSayisiTek smallInt = 0
  declare @DersSayisiAdb smallInt = 0
  declare @DersSayisiToplami smallInt = 0

  -- Bugün hangi dönem ?  tespit ediliyor
  if (MONTH(getdate()) < 10)
       set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + '0' + convert(varchar(3), MONTH(getdate())))
  else set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + convert(varchar(3), MONTH(getdate())))

  -- ---------------------------------------------------------------------
  -- Teorik ders sayıları
  -- ---------------------------------------------------------------------
  SELECT TOP 1
       @DersSayisiTrf = saat.[TrafikVeCevreDersSaati]
      ,@DersSayisiIlk = saat.[IlkYardimDersSaati]
      ,@DersSayisiTek = saat.[AracTeknigiDersSaati]
      ,@DersSayisiAdb = saat.[TrafikAdabiDersSaati]
  FROM dbo.MtskSaatTeorik as saat
       left outer join GecerlilikTarihi as trh on (saat.GecerlilikTarihiId = trh.Id )
  Where trh.Tarih <= GETDATE()

  Set @DersSayisiToplami = @DersSayisiTrf + @DersSayisiIlk + @DersSayisiTek + @DersSayisiAdb

  UPDATE dbo.MtskGrupSubesi
     SET TakipTipiId = x.TakipTipiId
  
  From dbo.MtskGrupSubesi as gs, (
    Select sube.Id,
     ( case 

	   --when ( (sube.DonemTipiId >= @BugunDonemTipiId) and (sube.GrupBitisTarihi < getdate())) then 17 -- tamamlandı
	   --when ( (sube.DonemTipiId >= @BugunDonemTipiId) and (sube.GrupBaslamaTarihi <= getdate()) and (sube.GrupBitisTarihi >= getdate()) ) then 16 -- başladı 
	   --when ( (sube.DonemTipiId >= @BugunDonemTipiId) and (sube.GrupBaslamaTarihi > getdate()) and (sube.TDersIsUploaded = 1) ) then 15 -- başlamadı

	   when ( (sube.DonemTipiId >= @BugunDonemTipiId) and (sube.GrupBaslamaTarihi is not null) and (sube.TDersIsUploaded = 1) and
	          (isnull(sube.ToplamDersSayisi,0) = @DersSayisiToplami) ) then 14

	   when ( (sube.DonemTipiId >= @BugunDonemTipiId) and (sube.GrupBaslamaTarihi is not null) and (sube.TDersIsUploaded = 0) and
	          (isnull(sube.ToplamDersSayisi,0) = @DersSayisiToplami) ) then 13

	   when ( (sube.DonemTipiId >= @BugunDonemTipiId) and (sube.GrupBaslamaTarihi is not null) and
	          (isnull(sube.ToplamDersSayisi,0) < @DersSayisiToplami) ) then 12

	   when ( (sube.DonemTipiId >= @BugunDonemTipiId) and (sube.GrupBaslamaTarihi is null)) then 11

	   -- gelecek 
       when ( (sube.GrupBaslamaTarihi > getdate()) and (( isnull(sube.TrafikDersSayisi,0) + isnull(sube.IlkYardimDersSayisi,0) + isnull(sube.AracTeknigiDersSayisi,0) + isnull(sube.AdapDersSayisi,0) ) = 0 )) then 1 
	   when ( (sube.GrupBaslamaTarihi > getdate()) and (( sube.TrafikDersSayisi + sube.IlkYardimDersSayisi + sube.AracTeknigiDersSayisi + sube.AdapDersSayisi ) < @DersSayisiToplami )) then 2 
	   when ( (sube.GrupBaslamaTarihi > convert(date, getdate(),103)) and (( sube.TrafikDersSayisi + sube.IlkYardimDersSayisi + sube.AracTeknigiDersSayisi + sube.AdapDersSayisi ) = @DersSayisiToplami )) then 3 

       -- Geçmiş dönemler için
       when ( (isnull(sube.GrupBaslamaTarihi, getdate()) <= getdate()) and ( isnull(sube.ToplamDersSayisi,0) = 0 )) then 1 -- Teorik ders planı yok
       when ( (isnull(sube.GrupBaslamaTarihi, getdate()) <= getdate()) and ( isnull(sube.ToplamDersSayisi,0) < @DersSayisiToplami )) then 2 -- Teorik ders planı eksik
       when ( sube.GrupBaslamaTarihi > getdate() and ( isnull(sube.ToplamDersSayisi,0) = @DersSayisiToplami )) then 3 -- Teorik ders planı mevcut << bu gereksiz, 15 var

       when ( (sube.GrupBaslamaTarihi < getdate() and sube.GrupBitisTarihi < getdate()) and ( isnull(sube.ToplamDersSayisi,0) = @DersSayisiToplami ) ) then 17 -- Teorik dersler tamamlandı
       when ( (sube.GrupBaslamaTarihi < getdate() and sube.GrupBitisTarihi > getdate()) and ( isnull(sube.ToplamDersSayisi,0) = @DersSayisiToplami ) ) then 16 -- Teorik dersler başladı
       when ( (sube.GrupBaslamaTarihi > getdate() and sube.GrupBitisTarihi > getdate()) and ( isnull(sube.ToplamDersSayisi,0) = @DersSayisiToplami ) ) then 15 -- Teorik dersler başlamadı

       end
     ) as TakipTipiId
	 , sube.GrupBaslamaTarihi
    From MtskGrupSubesi as sube
    Where sube.FirmId = @FirmId
    and   sube.DonemTipiId = @DonemTipiId
    and   sube.GrupTipiId  = @GrupTipiId
    and   sube.SubeTipiId  = @SubeTipiId 
  ) as x
  Where gs.Id = x.Id 

  /*
  ( 1,  N'Teorik ders planı yok'),
  ( 2,  N'Teorik ders planı eksik'),
  ( 3,  N'Teorik ders planı mevcut'),

  ( 11, N'Grup başlangıç tarihi belli değil'),
  ( 12, N'Teorik dersler planlanacak'),
  ( 13, N'Teorik dersler planlandı, Mebbise aktarılacak'),
  ( 14, N'Teorik dersler Mebbise aktarıldı'),
  ( 15, N'Teorik dersler başlamadı'),
  ( 16, N'Teorik dersler başladı'),
  ( 17, N'Teorik dersler tamamlandı')
  */

END -- procedure

/*CreateProcedureEnd*/