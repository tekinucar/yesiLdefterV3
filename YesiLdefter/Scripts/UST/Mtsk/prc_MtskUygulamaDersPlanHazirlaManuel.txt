
/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskUygulamaDersPlanHazirlaManuel] (@Id int)  
AS BEGIN

  --Declare @Id int = 2

  declare @FirmId int
  declare @TalepId int
  declare @AdayId int
  declare @EgitimTarihi date
  declare @EgitimTipiId smallInt
  declare @DersTercihiTipiId smallInt
  declare @IzinGunuTipiId smallInt
  declare @SaatSayisiTipiId smallInt
  declare @SimulatorDersSayisi smallInt
  declare @EgitimAlaniDersSayisi smallInt
  declare @AkanTrafikDersSayisi smallInt
  declare @TelafiDersSayisi smallint
  declare @BasarisizDersSayisi smallint
  declare @PersonelId varchar(50)
  declare @SimulatorId varchar(50)
  declare @EgitimAraciId varchar(50)

  declare @mevcutToplamDersSayisi smallInt
  declare @toplamDersSayisi smallInt
  declare @mevcutBugunDersSayisi_ smallInt
  declare @bugunDersSayisi smallInt
  declare @bugunDersSayisi_ smallInt
  declare @gunNo smallInt = 1

  declare @EgitimYeriTipiId_ smallint
  declare @EgitimAraciId_ varchar(50)
  declare @DersTarihi_ date
  declare @gunTipiId_ smallInt 
  declare @saatSiraNo_ smallInt
  declare @dersSaatiTipiId_ smallInt

  declare @MevcutSertifikaTipiId smallInt
  declare @IstenenSertifikaTipiId smallInt
  declare @MtskSaatUygulamaSaati  smallInt 
  
  -- DbUpdate aktif olsun ki trigger ve bu procedure birbirini tetiklmesin
--print 'Execute [dbo].[prc_setIsDbUpdateActive] 13, 1'
  Execute [dbo].[prc_setIsDbUpdateActive] 13, 1
--print 'prc_MtskUygulamaDersPlanHazirlaManuel start'
  Select
       @FirmId = FirmId
      ,@TalepId = isnull(TalepId,0)
      ,@AdayId = isnull(AdayId,0)
      ,@EgitimTarihi = EgitimTarihi
      ,@EgitimTipiId = EgitimTipiId
      ,@DersTercihiTipiId = DersTercihiTipiId
      ,@IzinGunuTipiId = IzinGunuTipiId
      ,@SaatSayisiTipiId = SaatSayisiTipiId
      ,@SimulatorDersSayisi = SimulatorDersSayisi
      ,@EgitimAlaniDersSayisi = EgitimAlaniDersSayisi
      ,@AkanTrafikDersSayisi = AkanTrafikDersSayisi
      ,@TelafiDersSayisi = TelafiDersSayisi
      ,@BasarisizDersSayisi = BasarisizDersSayisi
      ,@PersonelId = isnull(PersonelId,'')
      ,@SimulatorId = SimulatorId
      ,@EgitimAraciId = isnull(EgitimAraciId,'')
  From dbo.MtskSablonUygulamaM 
  Where Id = @Id

  if (@TalepId <= 0
   or @AdayId <= 0
   or @PersonelId = ''
   or @EgitimAraciId = ''
  ) return;

  Select @mevcutToplamDersSayisi = count(Id) 
  From  dbo.MtskUygulamaliDers
  Where FirmId = @FirmId
  and   TalepId = @TalepId
  
  -- @EgitimTipiId
  -- 1, 'Normal Eğitim'
  -- 2, 'Telafi Eğitim(Ön Sınav )'
  -- 3, '2.Direksiyon Eğitimi'
  -- 4, 'Başarısız Aday Eğitimi'
 
  -- @DersTercihiTipiId
  -- 1, 'Simülatör + Akan Trafik'
  -- 2, 'Eğitim Alanı + Akan Trafik'
  -- 3, 'Akan Trafik'  
  
  --set @EgitimTipiId = 3 test için
  --print '@EgitimTipiId'
  --print @EgitimTipiId

  if (@EgitimTipiId = 1)
  begin
      if (@DersTercihiTipiId = 1) Set @toplamDersSayisi = @SimulatorDersSayisi + @AkanTrafikDersSayisi
      if (@DersTercihiTipiId = 2) Set @toplamDersSayisi = @EgitimAlaniDersSayisi + @AkanTrafikDersSayisi
      if (@DersTercihiTipiId = 3) Set @toplamDersSayisi = @AkanTrafikDersSayisi
  end 

  -- 2.Direksiyon Eğitimi ise
  if (@EgitimTipiId = 3) Set @toplamDersSayisi = @AkanTrafikDersSayisi
  -- Telafi Eğitim ise
  if (@EgitimTipiId = 2) Set @toplamDersSayisi = @TelafiDersSayisi
  -- Başarısız Aday Eğitimi ise
  if (@EgitimTipiId = 4) Set @toplamDersSayisi = @BasarisizDersSayisi
  
  if (@SaatSayisiTipiId = 0) Set @SaatSayisiTipiId = 2

  --print '@toplamDersSayisi'
  --print @toplamDersSayisi
  --print '@mevcutToplamDersSayisi'
  --print @mevcutToplamDersSayisi

  set @toplamDersSayisi = @toplamDersSayisi - @mevcutToplamDersSayisi

  while (@toplamDersSayisi > 0)
  begin
	  Set @bugunDersSayisi = @SaatSayisiTipiId
      
	  --  @EgitimTipiId = Normal eğitim ve    @DersTercihiTipiId = Akan trafik değilse birinci gün sadece Simülatör veya Eğitim pisti 2 saat olsun
	  -- if (@EgitimTipiId = 1 and @gunNo = 1 and @DersTercihiTipiId <> 3) Set @bugunDersSayisi = 2 

	  --  @EgitimTipiId = Telafi Eğitim veya Başarısız Aday Eğitimi
	  if (@EgitimTipiId = 2) Set @bugunDersSayisi = 2 
	  if (@EgitimTipiId = 4) Set @bugunDersSayisi = 2 

	  if (@toplamDersSayisi < @bugunDersSayisi) Set @bugunDersSayisi = @toplamDersSayisi

      --print '@gunNo : ' + Convert(varchar(2) , @gunNo)
	  --print '@bugunDersSayisi : '  + Convert(varchar(2) , @bugunDersSayisi)

      --Id  MtskUygulamaliDers.EgitimYeriTipiId
      -- 1  Direksiyon Eğitim Alanı
      -- 2  Akan Trafik
      -- 3  Simülatör  
      Set @EgitimYeriTipiId_ = 2 
	  if (@EgitimTipiId = 1 and @DersTercihiTipiId = 1 and @gunNo = 1 and @SimulatorDersSayisi > 0) Set @EgitimYeriTipiId_ = 3
      if (@EgitimTipiId = 1 and @DersTercihiTipiId = 2 and @gunNo = 1 and @EgitimAlaniDersSayisi > 0) Set @EgitimYeriTipiId_ = 1

	  Set @EgitimAraciId_ = @EgitimAraciId
	  if (@EgitimTipiId = 1 and @DersTercihiTipiId = 1 and @gunNo = 1and @SimulatorDersSayisi > 0) Set @EgitimAraciId_ = @SimulatorId

      -- @IzinGunuTipiId
      -- 1, 'Personel izin tablosu geçerli'
      -- 2, 'Ctesi ve Pazar günü eğitim yok'
      -- 3, 'Pazar günü eğitim yok'

      -- @gunTipiId 
      -- 1.  5 iş günü, 2 gün izin 
      -- 2.  6 iş günü, 1 gün izin 
	  if (@IzinGunuTipiId = 1) Set @gunTipiId_ = 1 -- şimdilik c ve p izinli uygula, personele göre olacak
	  if (@IzinGunuTipiId = 2) Set @gunTipiId_ = 1
	  if (@IzinGunuTipiId = 3) Set @gunTipiId_ = 2
	  
	  Set @DersTarihi_ = [dbo].fnc_IsGununuBul(@EgitimTarihi, @gunNo, @gunTipiId_, 107) --s.SaatTipiId)

	  --print '@DersTarihi_ = ' + convert(varchar(10),@DersTarihi_,103)

	  select @mevcutBugunDersSayisi_ = count(Id) 
      From  dbo.MtskUygulamaliDers
      Where FirmId = @FirmId
      and   TalepId = @TalepId
	  and   DersTarihi = @DersTarihi_

	  Set @bugunDersSayisi_ = @bugunDersSayisi - @mevcutBugunDersSayisi_
	  Set @saatSiraNo_ = 1
	  
	  if (@SaatSayisiTipiId = 2) Set @dersSaatiTipiId_ = -3
	  if (@SaatSayisiTipiId = 4) Set @dersSaatiTipiId_ = -5
	  
	  while (@bugunDersSayisi_ > 0)
      begin
          --print '    @saatSiraNo_ : '  + Convert(varchar(2) , @saatSiraNo_)
          --print '    @@dersSaatiTipiId_ : '  + Convert(varchar(2) , @dersSaatiTipiId_)
		  --print '     prc_MtskUygulamaDersInsert çalıştı.'
          Execute [dbo].[prc_MtskUygulamaDersInsert]   
           @FirmId
          ,@TalepId
          ,@AdayId
          ,@EgitimYeriTipiId_
          ,@EgitimAraciId_
          ,@DersTarihi_
          ,@dersSaatiTipiId_
          ,@PersonelId
          ,@EgitimTipiId
          ,@saatSiraNo_

          Set @saatSiraNo_ += 1
          Set @dersSaatiTipiId_ += 1
          Set @bugunDersSayisi_ -= 1
		  Set @toplamDersSayisi -= 1
      end -- while 2 
	  	  
	  Set @gunNo += 1
  end -- While 1

  --print 'prc_MtskUygulamaDersPlanHazirlaManuel stop'

  Execute dbo.prc_MtskAdayTakip @FirmId

  --print 'Execute [dbo].[prc_setIsDbUpdateActive] 13, 0'
  Execute [dbo].[prc_setIsDbUpdateActive] 13, 0	


END -- procedure 

/*CreateProcedureEnd*/
