/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayBorclandirESinav] (@FirmId int)
AS BEGIN  

  --declare @FirmId Int  = 11
  declare @BugunDonemTipiId int = 0
  declare @BorclandirmaUcreti numeric(22,5)
  declare @UcretTipiId Int  = 21111

   if (MONTH(getdate()) < 10)
       set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + '0' + convert(varchar(3), MONTH(getdate())))
  else set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + convert(varchar(3), MONTH(getdate())))
  
  -- e-Sınav ücreti
  Select Top 1  @BorclandirmaUcreti = ucret.[ESinavUcreti]
  From [dbo].[MtskUcretSinav] as ucret,
       [dbo].[GecerlilikTarihi] as tarih
  Where ucret.FirmId = @FirmId
  and   ucret.IsActive = 1
  and   ucret.GecerlilikTarihiId = tarih.Id
  and   convert(date,tarih.Tarih,103) <= convert(date, GETDATE(), 103) 
  order by tarih.Tarih desc
  /*
  -- Uygulama sınav ücreti
  Select Top 1  @BorclandirmaUcreti = ucret.[UygulamaSinavUcreti]
  From [dbo].[MtskUcretSinav] as ucret,
       [dbo].[GecerlilikTarihi] as tarih
  Where ucret.FirmId = @FirmId
  and   ucret.IsActive = 1
  and   ucret.GecerlilikTarihiId = tarih.Id
  and   convert(date,tarih.Tarih,103) <= convert(date, GETDATE(), 103) 
  order by tarih.Tarih desc
  */
  
  Insert into [dbo].[OnmOdemePlani]
           ([OdmemePlaniGUID]
           ,[FirmId]
           ,[IsActive]
           ,[DonemTipiId]
           ,[TalepId]
           ,[TalepTipiId]
           ,[UcretTipiId]
           ,[CariId]
           ,[TaksitTipiId]
           ,[TaksitNo]
           ,[VadeTarihi]
           ,[TaksitTutari]
           ,[OdemeTipiId]
           ,[IsPaid]
           ,[TahsilTarihi]
           ,[YedekTaksitTutari]
           ,[BelgeDekontId]
           ,[PatchBelgeDekontId]
           ,[BelgeStokBId]
           ,[SourceTypeId]
           ,[SourceId]
           ,[VeriKaynakId])
  Select 
            NEWID()
           ,@FirmId
           ,1 --IsActive
           ,@BugunDonemTipiId -- DonemTipiId
           ,takip.TalepId
           ,talep.TalepTipiId -- TalepTipiId
           ,@UcretTipiId
           ,talep.AdayId -- CariId
           ,3 -- TaksitTipiId : 3 = Tek Ödeme
           ,takip.eSinavNo -- TaksitNo -- Gireceği sınav no
           ,getdate() -- VadeTarihi == Bu kayıt oluşurken sınavın hangi tarihte olacağı bilinmiyor
           ,@BorclandirmaUcreti -- TaksitTutari
           ,2    -- OdemeTipiId   Nakit
           ,0    -- IsPaid
           ,null -- TahsilTarihi
           ,null -- YedekTaksitTutari
           ,null -- BelgeDekontId
           ,null -- PatchBelgeDekontId
           ,null -- BelgeStokBId
           ,2101 -- SourceTypeId -- Mtsk Modülü - Otomatik, kullanıcı onaylı
           ,null -- SourceId
           ,null -- VeriKaynakId
  From dbo.MtskAdayTakip as takip
       left outer join dbo.MtskAdayTalep as talep on ( takip.TalepId = talep.Id )
	   left outer join dbo.OnmOdemePlani as odeme on ( odeme.FirmId = @FirmId
	      and odeme.TalepId = takip.TalepId
		  and odeme.TaksitNo = takip.eSinavNo
          and odeme.UcretTipiId = @UcretTipiId
	   )
  Where talep.FirmId = @FirmId 
  and   takip.FirmId = @FirmId
  and   takip.eSinavDurumTipiId = 2
  and   takip.eSinavUcretTipiId = 1
  and   odeme.Id is null


/*
  declare @UcretTipiId Int  = 21111
  declare @TalepId int

  -- Döngüye alınacak Select cümlesi
  declare myCursor CURSOR local FOR 

  Select TalepId From dbo.MtskAdayTakip
  Where  eSinavDurumTipiId = 2
  and    FirmId = @FirmId

  OPEN myCursor; 
  
  FETCH NEXT FROM myCursor INTO @TalepId

  print 'e-Sınav için prc_MtskAdayBorclandir başladı'
  
  WHILE @@FETCH_STATUS = 0 
  BEGIN -- İşlemler burada yapılır 
  
     PRINT '@TalepId: ' + CAST(@TalepId AS NVARCHAR) + ', @UcretTipiId: ' + CAST(@UcretTipiId AS NVARCHAR); 
  
	 Execute [dbo].[prc_MtskAdayBorclandir] @TalepId, @UcretTipiId 

     FETCH NEXT FROM myCursor INTO @TalepId; 
  END; 
  
  CLOSE myCursor;

  print 'e-Sınav için prc_MtskAdayBorclandir bitti'
  */

END -- procedure

/*CreateProcedureEnd*/