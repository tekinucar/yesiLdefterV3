/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayBorclandirESinav] (@FirmId int)
AS BEGIN  

  --declare @FirmId Int  = 11
  declare @BugunDonemTipiId int = 0
  declare @BorclandirmaUcreti numeric(22,5)
  declare @ReelBorclandirmaUcreti numeric(22,5)
  declare @UcretTipiId Int  = 21111

   if (MONTH(getdate()) < 10)
       set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + '0' + convert(varchar(3), MONTH(getdate())))
  else set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + convert(varchar(3), MONTH(getdate())))
  
  -- e-Sınav ücreti
  Select Top 1  
      @BorclandirmaUcreti = isnull(ucret.[ESinavUcreti],0)
    , @ReelBorclandirmaUcreti = isnull(ucret.[ReelESinavUcreti],0)
  From [dbo].[MtskUcretSinav] as ucret,
       [dbo].[GecerlilikTarihi] as tarih
  Where ucret.FirmId = @FirmId
  and   ucret.IsActive = 1
  and   ucret.GecerlilikTarihiId = dbo.fnc_getGecerlilikTarihiId(@FirmId, 21103, getdate())
  
  -- Reel ücret varsa onu uygulasın
  if (@ReelBorclandirmaUcreti > 0)
      Set @BorclandirmaUcreti = @ReelBorclandirmaUcreti

  Insert into [dbo].[OnmOdemePlani]
           ([OdmemePlaniGUID]
           ,[FirmId]
           ,[IsActive]
           ,[DonemTipiId]
           ,[TalepId]
           ,[TalepTipiId]
           ,[UcretTipiId]
           ,[CariId]
           ,[TaksitTipiId]
           ,[TaksitNo]
           ,[VadeTarihi]
           ,[TaksitTutari]
           ,[OdemeTipiId]
           ,[IsPaid]
           ,[TahsilTarihi]
           ,[YedekTaksitTutari]
           ,[BelgeDekontId]
           ,[PatchBelgeDekontId]
           ,[BelgeStokBId]
           ,[SourceTypeId]
           ,[SourceId]
           ,[VeriKaynakId])
  Select 
            NEWID()
           ,@FirmId
           ,1 --IsActive
           ,@BugunDonemTipiId -- DonemTipiId
           ,takip.TalepId
           ,talep.TalepTipiId -- TalepTipiId
           ,@UcretTipiId
           ,talep.AdayId -- CariId
           ,3 -- TaksitTipiId : 3 = Tek Ödeme
           ,takip.eSinavNo -- TaksitNo -- Gireceği sınav no
           ,(case 
		       when isnull(takip.eSinavPlanTarihi,getdate()) > getdate() then takip.eSinavPlanTarihi -- varsa plan tarihi
               when isnull(takip.eSinavBasariTarihi,getdate()) < getdate() then takip.eSinavBasariTarihi -- son sınav tarihi varsa onu
			   else getdate() end )  -- VadeTarihi == hiç biri yoksa bugun olsun
           ,@BorclandirmaUcreti -- TaksitTutari
           ,2    -- OdemeTipiId   Nakit
           ,0    -- IsPaid
           ,null -- TahsilTarihi
           ,null -- YedekTaksitTutari
           ,null -- BelgeDekontId
           ,null -- PatchBelgeDekontId
           ,null -- BelgeStokBId
           ,2101 -- SourceTypeId -- Mtsk Modülü - Otomatik, kullanıcı onaylı
           ,null -- SourceId
           ,null -- VeriKaynakId
  From dbo.MtskAdayTakip as takip
       left outer join dbo.MtskAdayTalep as talep on ( takip.TalepId = talep.Id )
	   left outer join dbo.OnmOdemePlani as odeme on ( odeme.FirmId = @FirmId
	      and odeme.TalepId = takip.TalepId
		  and odeme.TaksitNo = takip.eSinavNo
          and odeme.UcretTipiId = @UcretTipiId
	   )
  Where talep.FirmId = @FirmId 
  and   takip.FirmId = @FirmId
  and ( takip.eSinavDurumTipiId >= 2 or takip.eSinavDurumTipiId <= 5 )
  and   takip.eSinavUcretTipiId = 1
  and   odeme.Id is null

END -- procedure

/*CreateProcedureEnd*/