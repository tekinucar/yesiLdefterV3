/*CreateTable*/

begin transaction

 create table MtskGrupSubesi
 (
   Id                   Int IDENTITY(1,1) not null, 
   ParentId             Int       not null, /* default 0 */
   FirmId               Int       not null,
   IsActive             Bit       not null, /* default : 1 = active, 0 = not active */  

   DonemTipiId          Int           null,
   GrupTipiId           SmallInt      null,
   SubeTipiId           SmallInt      null,
   GrupBaslamaTarihi    Date          null,
   SubeAdaySayisi       SmallInt      null,
   KurumOnayTipiId      SmallInt      null, /* 1-Onaylandı */		
      
   constraint		pk_MtskGrupSubesi primary key (Id)
 )
  
 grant select, insert, update, delete on MtskGrupSubesi to public

commit transaction

/*CreateTableEnd*/

/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_MtskGrupSubesi] on [dbo].[MtskGrupSubesi] 
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE mgSubesiCursor cursor for select Id from Inserted
    DECLARE @curId bigint

    OPEN mgSubesiCursor

    FETCH NEXT FROM mgSubesiCursor INTO @curId
   
    declare @MtskDonemiId int 
    declare @FirmId int
    declare @DonemTipiId int
    declare @GrupTipiId smallint
    declare @SubeTipiId smallint
    declare @GrupBaslamaTarihi date
    declare @KurumOnayTipiId smallint

    WHILE @@FETCH_STATUS = 0
    BEGIN

      Select
         @FirmId = FirmId
        ,@DonemTipiId = DonemTipiId
        ,@GrupTipiId = GrupTipiId
        ,@SubeTipiId = SubeTipiId
        ,@GrupBaslamaTarihi = GrupBaslamaTarihi
        ,@KurumOnayTipiId = KurumOnayTipiId

      From inserted ins
	  Where ins.Id = @curId

      set @MtskDonemiId = 0

      -- MtskDonemi tablosunda gerekli olan satır mevcut mu ?
      Select @MtskDonemiId = isnull(Id, 0)
      From dbo.MtskDonemi
      Where FirmId = @FirmId
      and DonemTipiId = @DonemTipiId
      and GrupTipiId = @GrupTipiId

	  -- Sube belli olduktan sonra SubeTipiId = 0 olanlanlar silinsin
      if (@DonemTipiId > 0) and  
         (@GrupTipiId > 0) and 
         (@SubeTipiId > 0)
      begin
         Delete From dbo.MtskGrupSubesi
         Where FirmId = @FirmId
         and DonemTipiId = @DonemTipiId
         and GrupTipiId = @GrupTipiId
		 and SubeTipiId <= 0
	  end
    
      /*
      if (@MtskDonemiId = 0)
      begin
         INSERT INTO [dbo].[MtskDonemi]
           ([ParentId]
           ,[FirmId]
           ,[IsActive]
           ,[DonemTipiId]
           ,[GrupTipiId]
           ,[GrupBaslamaTarihi]
           ,[GrupSubeSayisi]
           ,[AdaySayisi]
           ,[TeorikDersSayisi]
           ,[UygulamaDersSayisi]
           ,[KurumOnayTipiId]
           ,[GrupAdaySayisi])
         VALUES
           (0
           ,@FirmId
           ,1
           ,@DonemTipiId
           ,@GrupTipiId
           ,@GrupBaslamaTarihi
           ,0 --GrupSubeSayisi
           ,0 --AdaySayisi
           ,0 --TeorikDersSayisi
           ,0 --UygulamaDersSayisi
           ,@KurumOnayTipiId
           ,0 --GrupAdaySayisi
           )
      end
      */

      FETCH NEXT FROM mgSubesiCursor INTO @curId
    END

    CLOSE mgSubesiCursor
    DEALLOCATE mgSubesiCursor   
        

END

/*CreateTriggerEnd*/



