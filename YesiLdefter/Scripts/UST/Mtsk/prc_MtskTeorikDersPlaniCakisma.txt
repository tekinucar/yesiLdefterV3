/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskTeorikDersPlaniCakisma] (@DonemTipiId int, @SablonTeorikBId int)  
AS BEGIN

/* Yeni planla çakışan varsa getirecek */ 

  --declare @DonemTipiId int
  --declare @TaslakTeorikBId int
  declare @FirmId int
  declare @BaslangicTarihi date
  set @BaslangicTarihi = getdate()

  -- Ders programını uygulamak için 
  -- Hangi dönem
  -- Hangi TaslakTeorikB.Id uygulandı
  --set @DonemTipiId = 202101
  --set @TaslakTeorikBId = 1
    
  Select 
    @FirmId = FirmId
  , @BaslangicTarihi = isnull(BaslangicTarihi, getdate())
  From [dbo].[MtskSablonTeorikF]
  Where DonemTipiId = @DonemTipiId
  and   SablonTeorikBId = @SablonTeorikBId

  Select td.* From ( 
    Select 
    @FirmId as FirmId
  , 1 as IsActive
  , @DonemTipiId as DonemTipiId
  , s.GrupTipiId
  , s.SubeTipiId
  , s.DerslikTipiId
  , s.DerslikAdiTipiId
  
  ,[dbo].fnc_IsGununuBul(@BaslangicTarihi, s.GunId, b.GunTipiId) as DersTarihi

  , (Case s.SaatTipiId 
     When 107 then 0 -- 07:00 - 07:50
     When 108 then 1 -- 08:00 - 08:50
     When 109 then 2 -- 09:00 - 09:50
     When 110 then 3 -- 10:00 - 10:50 
     When 111 then 4 -- 11:00 - 11:50
     When 112 then 5 -- 12:00 - 12:50
     When 113 then 6 -- 13:00 - 13:50
     When 114 then 7 -- 14:00 - 14:50
     When 115 then 8 -- 15:00 - 15:50
     When 116 then 9 -- 16:00 - 16:50
     When 117 then 10 -- 17:00 - 17:50
     When 118 then 11 -- 18:00 - 18:50
     When 119 then 12 -- 19:00 - 19:50
     When 120 then 13 -- 20:00 - 20:50
     When 121 then 14 -- 21:00 - 21:50
     When 122 then 15 -- 22:00 - 22:50
     else -1 end) as DersSaatiTipiId
	 
  , (Case s.DerslikTipiId 
    When 1 then f.TrafikOgreticiId
    When 2 then f.IlkYardimOgreticiId
	When 3 then f.AracTeknigiOgreticiId
	When 5 then f.TrafikAdabiOgreticiId
    else '' end) as PersonelId
	
  , s.EgitimTipiId
  , null BaslamaSaati
  , null BitisSaati
  , 0 TDersIsUploaded
  , s.SablonTeorikBId
 
  from MtskSablonTeorikS as s 
     left outer join MtskSablonTeorikB as b on ( s.SablonTeorikBId = b.Id )
     left outer join MtskSablonTeorikF as f on ( s.SablonTeorikBId = f.SablonTeorikBId 
        and s.GrupTipiId = f.GrupTipiId
        and s.SubeTipiId = f.SubeTipiId
        and f.DonemTipiId = @DonemTipiId
   )
   Where s.IsActive = 1
   and s.SablonTeorikBId = @SablonTeorikBId

   ) as x, [dbo].[MtskTeorikDers] as td 
  Where 0 = 0 
  and td.DersSaatiTipiId = x.DersSaatiTipiId
  and td.DersTarihi = x.DersTarihi
  
  and ( td.DerslikAdiTipiId = x.DerslikAdiTipiId 
  or  td.PersonelId = x.PersonelId )
  
  and (td.DonemTipiId <> x.DonemTipiId
  or   td.GrupTipiId <> x.GrupTipiId
  or   td.SubeTipiId <> x.SubeTipiId
  or   td.DerslikTipiId <> x.DerslikTipiId
  or   td.DerslikAdiTipiId <> x.DerslikAdiTipiId -- personelin başka sınıfta dersi varsa
  or   td.PersonelId <> x.PersonelId -- derslikte başka hoca varsa
  )

  order by td.DersTarihi, td.DersSaatiTipiId

END -- procedure

/*CreateProcedureEnd*/

