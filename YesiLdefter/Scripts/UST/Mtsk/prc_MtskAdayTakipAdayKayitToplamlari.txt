/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayTakipAdayKayitToplamlari] (@FirmId int, @DonemTipiId int)  
AS BEGIN

-- SertifikaTipi
Select 
   tip.Id as KonuId
 , 'Serftikalar' as KonuCaption   
 , tip.SertifikaTipi as KonuAciklama
 , '' as Islem
 , count(talep.Id) as AdaySayisi 

From MtskAdayTalep as talep
     left outer join Lkp.MtskSertifikaTipi as tip on 
	   ( talep.IstenenSertifikaTipiId = tip.Id )
Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId

Group by 
   tip.Id
 , tip.SertifikaTipi
 , tip.SiraNo 
 
--order by tip.SiraNo;

union all

-- TalepTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.TalepTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(talep.Id) as AdaySayisi 

From MtskAdayTalep as talep
     left outer join Lkp.MtskAdayTakipTalepTipi as tip on 
	   ( talep.TalepTipiId = tip.Id )
Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.TalepTipi
 , tip.FormCaption 
 
union all

-- KayitTipi = 1, 2, 3 
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.KayitTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(talep.Id) as AdaySayisi 

From MtskAdayTalep as talep
     left outer join Lkp.MtskAdayTakipKayitTipi as tip on 
	   ( talep.KayitTipiId = tip.Id )
Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.KayitTipi
 , tip.FormCaption 

union all

-- Belgeleri eksik olanlar
Select 
   tip.KonuId 
 , tip.KonuCaption
 , tip.BelgelerTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipBelgelerTipi as tip on ( tip.KonuId = 1261 )

Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId
and   takip.BelgelerGeldi = 0 
and  (takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 

group by tip.KonuId 
       , tip.KonuCaption
       , tip.BelgelerTipi
	   , tip.FormCaption

union all

-- Belgeleri taranmayanlar
Select 
   tip.KonuId 
 , tip.KonuCaption
 , tip.BelgelerTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipBelgelerTipi as tip on ( tip.KonuId = 1262 )

Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId
and   takip.BelgelerTarandi = 0 
and  (takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 

group by tip.KonuId 
       , tip.KonuCaption
       , tip.BelgelerTipi
	   , tip.FormCaption

union all

-- Belgeleri yüklenmeyenler
Select 
   tip.KonuId 
 , tip.KonuCaption
 , tip.BelgelerTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipBelgelerTipi as tip on ( tip.KonuId = 1263 )

Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId
and   takip.BelgelerYuklendi = 0 
and  (takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 

group by tip.KonuId 
       , tip.KonuCaption
       , tip.BelgelerTipi
	   , tip.FormCaption

union all

-- MebbisKurumOnayi yok
Select 
   tip.KonuId 
 , tip.KonuCaption
 , tip.MebbisOnayiTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(talep.Id) as AdaySayisi 

From MtskAdayTalep as talep
     left outer join Lkp.MtskAdayTakipMebbisOnayiTipi as tip on ( talep.MebbisKurumOnayi = tip.Id )

Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId

group by tip.KonuId 
       , tip.KonuCaption
       , tip.MebbisOnayiTipi
	   , tip.FormCaption

union all

-- ZamanlamaTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.ZamanlamaTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipZamanlamaTipi as tip on 
	   ( takip.ZamanlamaTipiId = tip.Id )
Where FirmId = @FirmId
--and   DonemTipiId = @DonemTipiId
--and   takip.ZamanlamaTipiId <> 5

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.ZamanlamaTipi
 , tip.FormCaption 


union all
/*
-- ZamanlamaTipi : 5	Sertifikasını hak etmiş
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.ZamanlamaTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipZamanlamaTipi as tip on 
	   ( takip.ZamanlamaTipiId = tip.Id )
Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId
and   takip.ZamanlamaTipiId = 5 

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.ZamanlamaTipi
 , tip.FormCaption 

union all
*/
-- IsGrupSubeYok
Select 
   tip.KonuId 
 , tip.KonuCaption
 , tip.GrupSubeTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipGrupSubeTipi as tip on ( tip.KonuId = 1141 )

Where FirmId = @FirmId
-- and   DonemTipiId = @DonemTipiId : kontrol olmaması gerekiyor
and   IsGrupSubeYok = 1

group by tip.KonuId 
       , tip.KonuCaption
       , tip.GrupSubeTipi
	   , tip.FormCaption

union all

-- YasOnayiTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.YasOnayiTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipYasOnayiTipi as tip on 
	   ( takip.YasOnayiTipiId = tip.Id )
Where FirmId = @FirmId
--and   DonemTipiId = @DonemTipiId : kontrol olmaması gerekiyor
and   takip.YasOnayiTipiId >= 1 -- Yaşı tutmuyor
and   takip.YasOnayiTipiId <= 4 -- Doğum tarihi yok

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.YasOnayiTipi
 , tip.FormCaption 

union all

-- YasOnayiTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.YasOnayiTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipYasOnayiTipi as tip on 
	   ( takip.YasOnayiTipiId = tip.Id )
Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId 
and   takip.YasOnayiTipiId = 5 -- Yaşı tutuyor

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.YasOnayiTipi
 , tip.FormCaption 

union all

-- DeneyimSartiTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.DeneyimSartiTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipDeneyimSartiTipi as tip on 
	   ( takip.DeneyimSartiTipiId = tip.Id )
Where FirmId = @FirmId
--and   DonemTipiId = @DonemTipiId : kontrol olmaması gerekiyor
and   takip.DeneyimSartiTipiId = 3 -- Uygun değil

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.DeneyimSartiTipi
 , tip.FormCaption 

union all
/*
-- Sağlık, OzurDurumTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzurDurumuTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipOzurDurumuTipi as tip on 
	   ( takip.OzurDurumuTipiId = tip.Id )
Where takip.FirmId = @FirmId
and   takip.DonemTipiId = @DonemTipiId
and   takip.OzurDurumuTipiId > 0

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzurDurumuTipi
 , tip.FormCaption

union all
*/

-- ---------------------------------------------------------------------------------
-- DİKKAT : Özel durumdakilerin toplam sayıları için ayrı ayrı sql ile hesaplanıyor
-- ---------------------------------------------------------------------------------

-- OzelDurumuTipi -- özürlü sayısı
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(saglik.Id) as AdaySayisi 

From MtskAdaySaglik as saglik
     left outer join Lkp.MtskAdayTakipOzelDurumuTipi as tip on 
	   ( tip.Id = 1)
Where saglik.FirmId = @FirmId
and   saglik.DonemTipiId = @DonemTipiId
and   saglik.OzurDurumuTipiId > 1

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi
 , tip.FormCaption

union all

-- OzelDurumuTipi -- okutmanlı sayısı
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(saglik.Id) as AdaySayisi 

From MtskAdaySaglik as saglik
     left outer join Lkp.MtskAdayTakipOzelDurumuTipi as tip on 
	   ( tip.Id = 2)
Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId
and   saglik.OkutmanTalebi = 1

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi
 , tip.FormCaption


union all

-- OzelDurumuTipi -- TercumanTalebi sayısı
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(saglik.Id) as AdaySayisi 

From MtskAdaySaglik as saglik
     left outer join Lkp.MtskAdayTakipOzelDurumuTipi as tip on 
	   ( tip.Id = 3)
Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId
and   saglik.TercumanTalebi = 1

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi
 , tip.FormCaption

union all

-- OzelDurumuTipi -- YabanciDilTipiId sayısı
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(saglik.Id) as AdaySayisi 

From MtskAdaySaglik as saglik
     left outer join Lkp.MtskAdayTakipOzelDurumuTipi as tip on 
	   ( tip.Id = 4)
Where FirmId = @FirmId
and   DonemTipiId = @DonemTipiId
and   saglik.YabanciDilTipiId > 0

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi
 , tip.FormCaption

union all

-- OzelDurumuTipi -- Yabanci uyruklar sayısı
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(talep.Id) as AdaySayisi 

From dbo.MtskAdayTalep as talep, dbo.MtskAday as aday
     left outer join Lkp.MtskAdayTakipOzelDurumuTipi as tip on 
	   ( tip.Id = 5)
Where talep.FirmId = @FirmId
and   talep.DonemTipiId = @DonemTipiId
and   talep.AdayId = aday.Id
and   aday.UlkeTipiId <> 1000

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi
 , tip.FormCaption

union all

-- OzelDurumuTipi -- Etiketli sayısı
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(talep.Id) as AdaySayisi 

From dbo.MtskAdayTalep as talep
     left outer join Lkp.MtskAdayTakipOzelDurumuTipi as tip on 
	   ( tip.Id = 6)
Where talep.FirmId = @FirmId
and   talep.DonemTipiId = @DonemTipiId
and   talep.EtiketTipiId > 0

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi
 , tip.FormCaption

union all

-- OzelDurumuTipi -- Kontejanlı sayısı
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From dbo.MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipOzelDurumuTipi as tip on 
	   ( tip.Id = 7)
Where takip.FirmId = @FirmId
and   takip.DonemTipiId = @DonemTipiId
and   takip.IsKontejan = 1

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.OzelDurumuTipi
 , tip.FormCaption


END -- procedure

/*CreateProcedureEnd*/