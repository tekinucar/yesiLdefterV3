/*CreateTable*/

begin transaction

 create table MtskAdayImza
 (
   Id                    Int IDENTITY(1,1) not null, 
   FirmId                Int       not null,
   TalepId               Int       not null, 
   AdayId                Int       not null, 
   TcNo                  Varchar(11)   null,
   DonemTipiId           Int           null,
   VeriKaynakId          Int           null, /* Veri transferi edildiği tablodaki Id . Sorun olduğunda bilginin nereden geldiğine referans olsun */

   ImzaResim             VarBinary(max) null,
   ImzaResimSmall        VarBinary(max) null,

   constraint		pk_MtskAdayImza primary key (Id)
 )
  
 grant select, insert, update, delete on MtskAdayImza to public

  create index X_MtskAdayImza01 on MtskAdayImza (TalepId)
  create index X_MtskAdayImza02 on MtskAdayImza (AdayId)
  create index X_MtskAdayImza03 on MtskAdayImza (TcNo)
  create index X_MtskAdayImza04 on MtskAdayImza (DonemTipiId)

commit transaction

/*CreateTableEnd*/


/*CreateTrigger*/

CREATE TRIGGER dbo.trg_MtskAdayImza on dbo.MtskAdayImza
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE imzaCursor cursor local for select Id from Inserted
    DECLARE @imzaId bigint

    Declare @TalepId int = 0

    OPEN imzaCursor

    FETCH NEXT FROM imzaCursor INTO @imzaId

    WHILE @@FETCH_STATUS = 0
    BEGIN

        select 
           @TalepId = ins.TalepId
		from inserted ins
    	where ins.Id = @imzaId

		-- MtskAdayTalep tablosunu işaretle
		Update MtskAdayTalep set
        ImzaAlindi = x.Sonuc
        From MtskAdayTalep a, 
        (
            Select count(Id) as Sonuc
            From MtskAdayImza
            Where 0 = 0
            and ImzaResim is not null
            and TalepId = @TalepId
        ) as x
        Where a.Id = @TalepId


		-- MtskAdayBelgeler tablosunu işaretle
		Update MtskAdayBelgeler set
        ImzaTarandi = x.Sonuc
        From MtskAdayBelgeler a, 
        (
            Select count(Id) as Sonuc
            From MtskAdayImza
            Where 0 = 0
            and ImzaResim is not null
            and TalepId = @TalepId
        ) as x
        Where a.TalepId = @TalepId

        -- Data transferi oldu fakat daha önce bu talep için boş kayıt oluşturulmuş ise onu sil
        if (@VeriKaynakId > 0)
        begin
		    Delete From dbo.MtskAdayImza
            Where TalepId = @TalepId
            and   isnull(VeriKaynakId,0) = 0
        end

      FETCH NEXT FROM imzaCursor INTO @imzaId
    END -- While

    CLOSE imzaCursor
    DEALLOCATE imzaCursor   

END -- create trigger

ALTER TABLE dbo.MtskAdayImza ENABLE TRIGGER trg_MtskAdayImza

/*CreateTriggerEnd*/


