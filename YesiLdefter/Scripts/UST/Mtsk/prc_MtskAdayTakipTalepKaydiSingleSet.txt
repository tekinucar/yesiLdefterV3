/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayTakipTalepKaydiSingleSet] (@TalepId int)  
AS BEGIN

  --declare @TalepId int
  --set @TalepId = 310

  -- Variables
  declare @GelecekAy Datetime
  declare @BugunDonemTipiId int = 0
  declare @GelecekDonemTipiId int = 0

  declare @zamanlamaTipiId int = 0
  declare @isGrupSubeYok bit = 0
  declare @YasSiniri smallint = 0
  declare @yasOnayiTipiId smallint = 0
  declare @yasHazirTarihi date = null
  declare @deneyimSartiTipiId smallInt = 0

  -- MtskAdayTalep
  declare @yFirmId Int 
  declare @yTalepTipiId SmallInt 
  declare @yKayitTipiId SmallInt 
  declare @yMebbisKurumOnayi Bit 
  declare @yMebbisDurumTipiId SmallInt
  declare @yMevcutSertifikaTipiId smallInt = 0
  declare @yIstenenSertifikaTipiId smallInt = 0
  declare @yDonemTipiId int = 0
  declare @yGrupTipiId smallint = 0
  declare @ySubeTipiId smallint = 0
  declare @yBelgelerGeldi bit = 0

  set @GelecekAy = DATEADD(month, 1, getdate());
	
  -- Bugün hangi dönem ?  tespit ediliyor
  if (MONTH(getdate()) < 10)
       set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + '0' + convert(varchar(3), MONTH(getdate())))
  else set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + convert(varchar(3), MONTH(getdate())))

  if (MONTH(@GelecekAy) < 10)
       set @GelecekDonemTipiId = convert(int, convert(varchar(5), YEAR(@GelecekAy)) + '0' + convert(varchar(3), MONTH(@GelecekAy)))
  else set @GelecekDonemTipiId = convert(int, convert(varchar(5), YEAR(@GelecekAy)) + convert(varchar(3), MONTH(@GelecekAy)))

  Select 
       @yFirmId = ins.FirmId
      ,@yTalepTipiId = isnull(ins.TalepTipiId,0)
      ,@yKayitTipiId = isnull(ins.KayitTipiId,0)
      ,@yMebbisKurumOnayi = isnull(ins.MebbisKurumOnayi,0)
      ,@yMebbisDurumTipiId = isnull(ins.MebbisDurumTipiId,0)
	  ,@yMevcutSertifikaTipiId = isnull(ins.MevcutSertifikaTipiId,0)
      ,@yIstenenSertifikaTipiId = isnull(ins.IstenenSertifikaTipiId,0)
      ,@yDonemTipiId = isnull(ins.DonemTipiId,0)
      ,@yGrupTipiId = isnull(ins.GrupTipiId,0)
      ,@ySubeTipiId = isnull(ins.SubeTipiId,0)
      ,@yBelgelerGeldi = isnull(ins.BelgelerGeldi,0)
  From  dbo.MtskAdayTalep as ins, dbo.MtskAday as aday
  Where ins.AdayId = aday.Id
  and   ins.Id = @TalepId
     


  -- ----------------------------------------------------------------------------------
  -- Aday kayıt aşaması
  -- ----------------------------------------------------------------------------------

  -- ZamanlamaTipiId 
  -- Aktif eğitim süreci devam edenler için geçerli
  -- eğitimi bitenleri -1 yapacağız
  if (@yDonemTipiId < @BugunDonemTipiId) set @zamanlamaTipiId = 1
  if (@yDonemTipiId = @BugunDonemTipiId) set @zamanlamaTipiId = 2
  if (@yDonemTipiId = @GelecekDonemTipiId) set @zamanlamaTipiId = 3
  if (@yDonemTipiId > @GelecekDonemTipiId) set @zamanlamaTipiId = 4
  if (@yDonemTipiId = 0) set @zamanlamaTipiId = 0
  -- 

  -- IsGrupSubeYok 
  if (@yGrupTipiId = 0 or @ySubeTipiId = 0)
      set @isGrupSubeYok = 1
  
  -- DeneyimSartiTipiId
  declare @isEnAz bit
  declare @deneyimSertifikaTipiId smallInt = 0

  Select top 1 @isEnAz = isnull(saat.IsEnAz,0), @deneyimSertifikaTipiId = isnull(saat.DeneyimSertifikaTipiId,0) 
  From MtskSaatUygulama as saat
       left outer join GecerlilikTarihi as gt on ( saat.GecerlilikTarihiId = gt.Id )
  Where saat.IstenenSertifikaTipiId = @yIstenenSertifikaTipiId
  and   gt.KonuTipiId = 21102 -- Uygulama saatleri
  order by gt.Tarih desc
  
  set @deneyimSartiTipiId = [dbo].[fnc_getSertifikaDeneyimSarti] ( @TalepId )

  -- ----------------------------------------------------------------------------------
  -- Teorik Dersler aşaması
  -- TeorikBaslamaTarihi    
  -- ToerikBitisTarihi      
  -- TeorikDersTipiId       
  -- ----------------------------------------------------------------------------------

  declare @TeorikBaslamaTarihi date   
  declare @TeorikBitisTarihi date
  declare @TeorikDersTakipTipi smallInt 
  
  Select 
      @TeorikBaslamaTarihi = gs.GrupBaslamaTarihi
    , @TeorikBitisTarihi   = gs.GrupBitisTarihi
    , @TeorikDersTakipTipi = gs.TakipTipiId
  From MtskGrupSubesi as gs
  Where gs.FirmId      = @yFirmId
  and   gs.DonemTipiId = @yDonemTipiId
  and   gs.GrupTipiId  = @yGrupTipiId
  and   gs.SubeTipiId  = @ySubeTipiId

  -- Mevcut ehliyeti var ise
  -- Talep tipi Sertifika değil ise
  if (@yMevcutSertifikaTipiId > 0) or
     (@yTalepTipiId <> 1)
  begin
      set @TeorikBaslamaTarihi = null
      set @TeorikBitisTarihi   = null
      set @TeorikDersTakipTipi = 6 -- Muaf işareti
  end


  -- Tespitleri kaydet
  Update MtskAdayTakip set
     -- Kayıt takibi
       TalepTipiId            = @yTalepTipiId  
     , DonemTipiId            = @yDonemTipiId
     , GrupTipiId             = @yGrupTipiId
     , SubeTipiId            = @ySubeTipiId
     , KayitTipiId            = @yKayitTipiId
     , ZamanlamaTipiId        = @zamanlamaTipiId
     , IsGrupSubeYok          = @isGrupSubeYok
     , MebbisKurumOnayi       = @yMebbisKurumOnayi
     , MebbisDurumTipiId      = @yMebbisDurumTipiId
     , DeneyimSartiTipiId     = @deneyimSartiTipiId
     , IsDeneyimEnAz          = @isEnAz
     , DeneyimSertifikaTipiId = @deneyimSertifikaTipiId
	 , BelgelerGeldi          = @yBelgelerGeldi
	 -- Teorik ders takibi
     , TeorikBaslamaTarihi = @TeorikBaslamaTarihi
     , TeorikBitisTarihi   = @TeorikBitisTarihi  
     , TeorikDersTipiId    = @TeorikDersTakipTipi 
  Where TalepId = @TalepId


END -- procedure

/*CreateProcedureEnd*/
