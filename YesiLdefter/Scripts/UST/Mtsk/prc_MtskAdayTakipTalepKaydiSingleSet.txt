/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayTakipTalepKaydiSingleSet] (@TalepId int)  
AS BEGIN

  --declare @TalepId int
  --set @TalepId = 310

  -- Variables
  declare @GelecekAy Datetime
  declare @BugunDonemTipiId int = 0
  declare @GelecekDonemTipiId int = 0
  declare @bugun smalldatetime = getdate()

  declare @zamanlamaTipiId int = 0
  declare @isGrupSubeYok bit = 0
  declare @YasSiniri smallint = 0
  declare @yasOnayiTipiId smallint = 0
  declare @yasHazirTarihi date = null
  declare @deneyimSartiTipiId smallInt = 0
  declare @sertifikaTeslimEdildi bit = 0

  -- MtskAdayTalep
  declare @yFirmId Int 
  declare @yTalepTipiId SmallInt 
  declare @yKayitTipiId SmallInt 
  declare @yMebbisKurumOnayi Bit 
  declare @yMebbisDurumTipiId SmallInt
  declare @yMevcutSertifikaTipiId smallInt = 0
  declare @yIstenenSertifikaTipiId smallInt = 0
  declare @yDonemTipiId int = 0
  declare @yGrupTipiId smallint = 0
  declare @ySubeTipiId smallint = 0
  declare @yBelgelerGeldi bit = 0

  set @GelecekAy = DATEADD(month, 1, getdate());
	
  -- Bugün hangi dönem ?  tespit ediliyor
  if (MONTH(getdate()) < 10)
       set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + '0' + convert(varchar(3), MONTH(getdate())))
  else set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + convert(varchar(3), MONTH(getdate())))

  if (MONTH(@GelecekAy) < 10)
       set @GelecekDonemTipiId = convert(int, convert(varchar(5), YEAR(@GelecekAy)) + '0' + convert(varchar(3), MONTH(@GelecekAy)))
  else set @GelecekDonemTipiId = convert(int, convert(varchar(5), YEAR(@GelecekAy)) + convert(varchar(3), MONTH(@GelecekAy)))

  Select 
       @yFirmId = ins.FirmId
      ,@yTalepTipiId = isnull(ins.TalepTipiId,0)
      ,@yKayitTipiId = isnull(ins.KayitTipiId,0)
      ,@yMebbisKurumOnayi = isnull(ins.MebbisKurumOnayi,0)
      ,@yMebbisDurumTipiId = isnull(ins.MebbisDurumTipiId,0)
	  ,@yMevcutSertifikaTipiId = isnull(ins.MevcutSertifikaTipiId,0)
      ,@yIstenenSertifikaTipiId = isnull(ins.IstenenSertifikaTipiId,0)
      ,@yDonemTipiId = isnull(ins.DonemTipiId,0)
      ,@yGrupTipiId = isnull(ins.GrupTipiId,0)
      ,@ySubeTipiId = isnull(ins.SubeTipiId,0)
      ,@yBelgelerGeldi = isnull(ins.BelgelerGeldi,0)
  From  dbo.MtskAdayTalep as ins, dbo.MtskAday as aday
  Where ins.AdayId = aday.Id
  and   ins.Id = @TalepId
     


  -- ----------------------------------------------------------------------------------
  -- Aday kayıt aşaması
  -- ----------------------------------------------------------------------------------
  Select @sertifikaTeslimEdildi = isnull(sertifika.SertifikaTeslimEdildi,0)
  From dbo.MtskAdaySertifika as sertifika
  Where sertifika.TalepId = @TalepId

  -- ZamanlamaTipiId 
  -- Aktif eğitim süreci devam edenler için geçerli
  -- eğitimi bitenleri -1 yapacağız
  if (@yDonemTipiId = @BugunDonemTipiId) set @zamanlamaTipiId = 2
  if (@yDonemTipiId = @GelecekDonemTipiId) set @zamanlamaTipiId = 3
  if (@yDonemTipiId > @GelecekDonemTipiId) set @zamanlamaTipiId = 4
  if (@yDonemTipiId = 0) set @zamanlamaTipiId = 0
  if (@yDonemTipiId < @BugunDonemTipiId and @sertifikaTeslimEdildi = 0) set @zamanlamaTipiId = 1
  if (@yDonemTipiId < @BugunDonemTipiId and @sertifikaTeslimEdildi = 1) set @zamanlamaTipiId = 5
  -- 

  -- IsGrupSubeYok 
  if (@yGrupTipiId = 0 or @ySubeTipiId = 0)
      set @isGrupSubeYok = 1
  
  -- DeneyimSartiTipiId
  declare @isEnAz bit
  declare @deneyimSertifikaTipiId smallInt = 0

  Select top 1 @isEnAz = isnull(saat.IsEnAz,0), @deneyimSertifikaTipiId = isnull(saat.DeneyimSertifikaTipiId,0) 
  From MtskSaatUygulama as saat
       left outer join GecerlilikTarihi as gt on ( saat.GecerlilikTarihiId = gt.Id )
  Where saat.IstenenSertifikaTipiId = @yIstenenSertifikaTipiId
  and   gt.KonuTipiId = 21102 -- Uygulama saatleri
  order by gt.Tarih desc
  
  set @deneyimSartiTipiId = [dbo].[fnc_getSertifikaDeneyimSarti] ( @TalepId )

  -- ----------------------------------------------------------------------------------
  -- Teorik Dersler aşaması
  -- TeorikBaslamaTarihi    
  -- ToerikBitisTarihi      
  -- TeorikDersTipiId       
  -- ----------------------------------------------------------------------------------

  declare @TeorikBaslamaTarihi date   
  declare @TeorikBitisTarihi date
  declare @TeorikDersTakipTipi smallInt 
  
  Select 
      @TeorikBaslamaTarihi = gs.GrupBaslamaTarihi
    , @TeorikBitisTarihi   = gs.GrupBitisTarihi
    , @TeorikDersTakipTipi = gs.TakipTipiId
  From MtskGrupSubesi as gs
  Where gs.FirmId      = @yFirmId
  and   gs.DonemTipiId = @yDonemTipiId
  and   gs.GrupTipiId  = @yGrupTipiId
  and   gs.SubeTipiId  = @ySubeTipiId

  -- Mevcut ehliyeti var ise
  -- Talep tipi Sertifika değil ise
  if (@yMevcutSertifikaTipiId > 0) or
     (@yTalepTipiId <> 1)
  begin
      set @TeorikBaslamaTarihi = null
      set @TeorikBitisTarihi   = null
      set @TeorikDersTakipTipi = 6 -- Muaf işareti
  end


  -- Tespitleri kaydet
  Update MtskAdayTakip set
     -- Kayıt takibi
       TalepTipiId            = @yTalepTipiId  
     , DonemTipiId            = @yDonemTipiId
     , GrupTipiId             = @yGrupTipiId
     , SubeTipiId            = @ySubeTipiId
     , KayitTipiId            = @yKayitTipiId
     , ZamanlamaTipiId        = @zamanlamaTipiId
     , IsGrupSubeYok          = @isGrupSubeYok
     , MebbisKurumOnayi       = @yMebbisKurumOnayi
     , MebbisDurumTipiId      = @yMebbisDurumTipiId
     , DeneyimSartiTipiId     = @deneyimSartiTipiId
     , IsDeneyimEnAz          = @isEnAz
     , DeneyimSertifikaTipiId = @deneyimSertifikaTipiId
	 , BelgelerGeldi          = @yBelgelerGeldi
	 -- Teorik ders takibi
     , TeorikBaslamaTarihi = @TeorikBaslamaTarihi
     , TeorikBitisTarihi   = @TeorikBitisTarihi  
     , TeorikDersTipiId    = @TeorikDersTakipTipi 
  Where TalepId = @TalepId

    -- -------------------------------------------------------------------------
    -- eSinav sonuçları
    -- -------------------------------------------------------------------------
    -- DİKKAT : Aynı kod prc_MtskAdayTakip içinde var	
    ----------------------------------------------------------------------------
    update MtskAdayTakip set
	  eSinavNo = x.SinavNoYeni
    , eSinavDurumTipiId = x.eSinavDurumTipiId
    , eSinavNoGirdigi = x.SinavNoGirdigi
    , eSinavSonucTipiId = x.DurumuTipiId
    , eSinavSonrasiTipiId = x.eSinavSonrasiTipiId
    , eSinavMuracatTarihi = x.eSinavMuracatTarihi
	, eSinavDetayId = x.sinavId
	, eSinavBasariTarihi = x.SinavTarihi
	, UygulamaliDersTipiId = x.UygulamaliDersTipiId
    from MtskAdayTakip a, 
    (
	Select 
	       eSinav.Id as sinavId
	     , eSinav.FirmId
         , eSinav.TalepId
	     , eSinav.AdayId 
	     , eSinav.SinavNo as SinavNoGirdigi
         , eSinav.DurumuTipiId
		 , convert(date, eSinav.SinavTarihi, 103) as SinavTarihi

    -- eSinavDurumTipiId
    --   0 : ''
    --   1 : e-Sınav için hazır değil
    --   2 : e-Sınav başvurusu yapılacak
    --   3 : e-Sınav başvurusu yapıldı
    --   4 : e-Sınav sonucu okunacak
    --   5 : e-Sınav sonucu okundu
	--   6 : Muaf

	--   eSinav.DurumuTipi
	--   1   Başarılı
	--   2   Başarısız
	--   3   Girmedi
	--   4   Raporlu
	--   5   İptal Edildi(Sınav Yasaklı)

	     , case
             when (eSinav.DurumuTipiId = 0 and convert(date, @bugun,103) <  convert(date, eSinav.SinavTarihi, 103)) then 3 -- e-Sınav başvurusu yapıldı
             when (eSinav.DurumuTipiId = 0 and convert(date, @bugun,103) >= convert(date, eSinav.SinavTarihi, 103)) then 4 -- e-Sınav sonucu okunacak
	         when (eSinav.DurumuTipiId = 1) then 5 -- e-Sınav sonucu okundu < sınav başarılıysa
	         when (eSinav.DurumuTipiId > 1 and eSinav.SinavNo < 4) then 2 -- e-Sınav başvurusu yapılacak < 1,2,3 sınavlarda başarılı değilse 
	         when (eSinav.DurumuTipiId > 1 and eSinav.SinavNo = 4) then 5 -- e-Sınav sonucu okundu       < 4. sınavda başarılı değilse
           end as eSinavDurumTipiId
	     , case
	         when (eSinav.DurumuTipiId = 1) then 0 -- < sınav başarılıysa
	         when (eSinav.DurumuTipiId > 1 and eSinav.SinavNo < 4) then (eSinav.SinavNo + 1) --  < 1,2,3 sınavlarda başarılı değilse
	         when (eSinav.DurumuTipiId > 1 and eSinav.SinavNo = 4) then 0 --  < 4. sınavda başarılı değilse
           end as SinavNoYeni
         , case
	         when (eSinav.DurumuTipiId = 1) then 2 -- Uygulama aşamasına geçti
             when (eSinav.DurumuTipiId > 1) and (eSinav.SinavNo < 4 ) then 1  -- Tekrar sınava girecek
             when (eSinav.DurumuTipiId > 1) and (eSinav.SinavNo >= 4 ) then 3 -- Tüm e-Sınav hakkı bitti
           end as eSinavSonrasiTipiId
         , case 
	         when (eSinav.DurumuTipiId > 1) and (eSinav.SinavNo < 4 ) then (
                  case when DAY(eSinav.SinavTarihi) >= 1 and DAY(eSinav.SinavTarihi) <= 15 then DATEADD(DAY, 16 - DAY(eSinav.SinavTarihi), eSinav.SinavTarihi)
                  else DATEADD(DAY, 1, EOMONTH(eSinav.SinavTarihi)) end
			 )
             else null
	       end as eSinavMuracatTarihi
         , case
	         when (eSinav.DurumuTipiId = 1 ) then 1   -- eSinav.Başarılı ise Uygulamalı dersler planlanacak
             when (eSinav.DurumuTipiId <> 1) then 0   -- boşluk
           end as UygulamaliDersTipiId

         from MtskSinavETeorik as eSinav,
	     (     -- Adayların son sınavlarını buluyor
	           Select TalepId, AdayId
			   , max(convert(smallDatetime,SinavTarihi,103)) as SinavTarihi
               from MtskSinavETeorik
		       Where FirmId = @yFirmId
			   and IsActive = 1
               -- ----------------------------------------
			   and TalepId = @TalepId -- Bu procedure özel
               -- ----------------------------------------
               group by TalepId, AdayId
         ) as aday
	     Where eSinav.TalepId = aday.TalepId
		 and   eSinav.AdayId = aday.AdayId
	     and   convert(smallDatetime,eSinav.SinavTarihi,103) = aday.SinavTarihi
    ) as x
    Where a.FirmId  = x.FirmId
    and   a.TalepId = x.TalepId
	and   a.AdayId  = x.AdayId 


	-- ---------------------------------------------------
    -- eSınavlar tamamen silinmiş olabilir
	-- ---------------------------------------------------
	
	update MtskAdayTakip set
      eSinavDurumTipiId = x.eSinavDurumTipiId
    , eSinavNo = 1
    , eSinavNoGirdigi = 0
    , eSinavSonucTipiId = 0
    , eSinavSonrasiTipiId = 0
    , eSinavMuracatTarihi = null
	, eSinavDetayId = 0
	, eSinavBasariTarihi = null
	, UygulamaliDersTipiId = 0
    from MtskAdayTakip a, 
    (
		 Select takip.Id as TakipId
        ,(case  
          when takip.TeorikDersTipiId = 17 then 2 -- e-Sınav başvurusu yapılacak
          else 1 end ) as eSinavDurumTipiId       -- e-Sınav için hazır değil
		 from dbo.MtskAdayTakip as takip
		     left outer join dbo.MtskSinavETeorik as sinav on ( 
			          takip.TalepId = sinav.TalepId 
			      and sinav.IsActive = 1 )
         Where takip.FirmId = @yFirmId
         and   takip.eSinavDurumTipiId > 0  
         and   takip.eSinavDurumTipiId <> 6 -- Muaf değilse
		 -- ----------------------------------------
         and takip.TalepId = @TalepId -- Bu procedure özel
         -- ----------------------------------------
		 Group by takip.Id
		        , takip.TeorikDersTipiId
		 Having COUNT(sinav.Id) = 0
     ) as x
	 Where a.Id = x.TakipId 



END -- procedure

/*CreateProcedureEnd*/
