/*CreateTable*/

begin transaction

 create table MtskAdayTalep
 (
   Id                    Int IDENTITY(1,1) not null, /* Id = AdayTalepId */
   TalepGUID             uniqueidentifier  null,
   FirmId                Int       not null,
   AdayId                Int       not null,
   IsActive              Bit       not null, 
   TalepKayitTarihi      Date          null, 
   ParentId              Int           null, /* 2.+4 hakkın bağlı olduğu sertifika talep Id si */
   AdayNo                Int           null,

   -- 20
   /* buradaki kimlik bilgileri sadece ilk data transferinde dolduruluyor */
   TcNo                  Varchar(11)   null, 
   KimlikSeriNo          Varchar(10)   null, 
   TamAdiSoyadi          nVarchar(100) null, 
   Adi                   nVarchar(50)  null,
   Soyadi                nVarchar(50)  null,
   DogumTarihi           Date          null,
   BabaAdi               nVarchar(50)  null,
   CinsiyetTipiId        SmallInt      null, /* SİLİNEBİLİR */ 
   CepTelefonu           Varchar(15)   null,
   Eposta                Varchar(98)   null, 
   /* buradaki kimlik bilgileri sadece ilk data transferinde dolduruluyor SON */

   -- 30
   /* Talep bilgileri */
   TalepTipiId             SmallInt      null,
   -- 31
   MevcutSertifikaTipiId   SmallInt      null,
   MevcutSurucuBelgeTarihi Date          null, 
   MevcutSurucuBelgeNo     nVarchar(30)  null,
   IsMevcutOtomatik        Bit           null, /* 0 = Manuel vites, 1 = Otomatik vites */
   IsMevcut2016Oncesi      Bit           null, 
   IsMevcut125ccAlti       Bit           null,
   -- 41
   IstenenSertifikaTipiId  SmallInt      null,
   IsOtomatik              Bit           null, /* 0 = Manuel vites, 1 = Otomatik vites */
   IsEngelli               Bit           null, /* 0 = yok, 1 = var */
   Is125ccAlti             Bit           null,

   -- 50
   -- Ders veya yaş için muafiyeti var
   IsMuafiyetiVar          Bit           null, /* 0 = yok, 1 = var */  
   MuafiyetAciklmasi       nVarchar(50)  null, 

   Ceza100BelgeTarihi      Date          null,
   Ceza100BelgeNo          nVarchar(50)  null, 
   
   OzelDersSaatSayisi      SmallInt      null, /* hem teo için hem uygulama için geçerli */
   BirSaatOzelDersUcreti   Numeric(22,5) null, /* hem teo için hem uygulama için geçerli */ 
   OzelDersUcretToplami    Numeric(22,5) null, /* hem teo için hem uygulama için geçerli */ 

   UygulamaPersonelId      Int           null, /* aday direk bir personeli isteyebilir   */
   UygPersCinsiyetTipiId   SmallInt      null, /* aday personelin cinsiyetini belirtebilir */

   -- 60
   /* Dönem bilgileri */
   /* mebbisden Nakil için kayıt olduğu dönem bilgisi isteyebilir */ 
   DonemTipiId             Int           null,
   GrupTipiId              SmallInt      null,
   SubeTipiId              SmallInt      null,
      
   MebbisKurumOnayi        Bit           null, /* 0-Onaysız, 1-Onaylandı */		
   
   SmallInt      null,
   MebbisDurumOkundu       Bit           null,
   KayitTipiId             SmallInt      null, /* 1.'Ön kayıt', 2.'Kayıt aşamasında', 3.'Kesin kayıt' ... */
   VeriKaynakTipiId        SmallInt      null, /* 1. Kullanıcı Manuel, 2. Mebbis Dönem Aday Onaylama, 3. Mebbis Uygulama Sınav Listesi, 4. Mebbis Aday Durum Bilgileri  */
   /* Dönem bilgileri SON */

   -- 70
   BasvuruResim            VarBinary(max) null,
   BasvuruResimSmall       VarBinary(max) null,
  
   -- 80 
   EtiketTipiId            SmallInt       null,
   KullaniciUyarilari      nVarchar(200)  null,
   SistemUyarilari         nVarchar(200)  null,

   -- 90
   KimlikGeldi             Bit            null,
   BiyometrikGeldi         Bit            null,
   BasvuruFotoCekildi      Bit            null,  
   OgrenimGeldi            Bit            null,
   SaglikGeldi             Bit            null,
   AdliSicilGeldi          Bit            null,
   ImzaAlindi              Bit            null,
   SozlesmeYapildi         Bit            null,
   AdresAlindi             Bit            null,
   BelgelerGeldi           Bit            null,
         
   constraint		pk_MtskAdayTalep primary key (Id)
 )
  
 grant select, insert, update, delete on MtskAdayTalep to public

  create index X_MtskAdayTalep01 on MtskAdayTalep (TcNo)
  create index X_MtskAdayTalep02 on MtskAdayTalep (TamAdiSoyadi)
  create index X_MtskAdayTalep03 on MtskAdayTalep (AdayId)
  create index X_MtskAdayTalep04 on MtskAdayTalep (DonemTipiId,GrupTipiId,SubeTipiId)

commit transaction

/*CreateTableEnd*/

/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_MtskAdayTalep] on [dbo].[MtskAdayTalep]
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE talepCursor cursor for select Id from Inserted
    --DECLARE @curId bigint
    declare @TalepId bigint

    OPEN talepCursor

    FETCH NEXT FROM talepCursor INTO @TalepId --@curId

    declare @mevcutAdayId int = 0
    declare @yAdayId int = 0
    declare @eAdayId int = 0
    declare @yFirmId int = 0
    declare @eIsActive bit = null
    declare @yIsActive bit = null

    declare @yTcNo varchar(11) = null
    declare @yTamAdi varchar(100) = null
    declare @eTamAdi varchar(100) = null
    declare @newTamAdi varchar(100) = null
    declare @yAdi varchar(50) = null
    declare @ySoyadi varchar(50) = null
	
    declare @eMevcutSertifikaTipiId smallInt = 0
    declare @eIstenenSertifikaTipiId smallInt = 0
    declare @yMevcutSertifikaTipiId smallInt = 0
    declare @yIstenenSertifikaTipiId smallInt = 0

    declare @eIsMevcutOtomatik bit = null
    declare @yIsMevcutOtomatik bit = null
    declare @eIsMevcut2016Oncesi bit = null
    declare @yIsMevcut2016Oncesi bit = null
    declare @eIsMevcut125ccAlti bit = null
    declare @yIsMevcut125ccAlti bit = null

    declare @eIsOtomatik bit = null
    declare @yIsOtomatik bit = null
    declare @eIsEngelli bit = null
    declare @yIsEngelli bit = null
    declare @eIs125ccAlti bit = null
    declare @yIs125ccAlti bit = null

    declare @eDurumTipiId int = 0
    declare @yDonemTipiId int = 0
    declare @yGrupTipiId smallInt = 0
    declare @ySubeTipiId smallInt = 0

    declare @eKayitTipiId smallInt = 0
    declare @yKayitTipiId smallInt = 0
    declare @yMebbisKurumOnayi bit = null
    declare @yMebbisDurumTipiId smallInt = 0

    declare @eKimlikGeldi bit = null
    declare @eBiyometrikGeldi bit = null
    declare @eBasvuruFotoCekildi bit = null  
    declare @eOgrenimGeldi bit = null
    declare @eSaglikGeldi bit = null
    declare @eAdliSicilGeldi bit = null
    declare @eImzaAlindi bit = null
    declare @eSozlesmeYapildi bit = null
    declare @eAdresAlindi bit = null
    declare @eBelgelerGeldi bit = null

    declare @yKimlikGeldi bit = null
    declare @yBiyometrikGeldi bit = null
    declare @yBasvuruFotoCekildi bit = null  
    declare @yOgrenimGeldi bit = null
    declare @ySaglikGeldi bit = null
    declare @yAdliSicilGeldi bit = null
    declare @yImzaAlindi bit = null
    declare @ySozlesmeYapildi bit = null
    declare @yAdresAlindi bit = null
    declare @yBelgelerGeldi bit = null

    declare @SertifikaAlmayiHakKazandi bit  = 0
    declare @SertifikaTarihi date = null

    declare @BugunDonemTipiId int = 0
	declare @DbUpdatesIsActive Bit = 0
	
    -- Bugün hangi dönem ?  tespit ediliyor
    if (MONTH(getdate()) < 10)
         set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + '0' + convert(varchar(3), MONTH(getdate())))
    else set @BugunDonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + convert(varchar(3), MONTH(getdate())))

	-- Veri Transferi başladımı
    Select @DbUpdatesIsActive = u.IsActive
    from [dbo].[DbUpdates] as u
    Where u.MsDbUpdateId = -1
    and   u.UpdateTypeId = 13
    and   u.DBaseNoTypeId = 6


    WHILE @@FETCH_STATUS = 0
    BEGIN
        set @newTamAdi = ''

        Select 
            @eAdayId = isnull(dlt.AdayId,0)
           ,@eIsActive = isnull(dlt.IsActive,0)
           ,@eTamAdi = isnull(dlt.TamAdiSoyadi,'')

           ,@eMevcutSertifikaTipiId = isnull(dlt.MevcutSertifikaTipiId,0)
           ,@eIstenenSertifikaTipiId = isnull(dlt.IstenenSertifikaTipiId,0)

           ,@eIsMevcutOtomatik = isnull(dlt.IsMevcutOtomatik,0)
           ,@eIsMevcut2016Oncesi = isnull(dlt.IsMevcut2016Oncesi,0)
           ,@eIsMevcut125ccAlti = isnull(dlt.IsMevcut125ccAlti,0)

           ,@eIsOtomatik = isnull(dlt.IsOtomatik,0)
           ,@eIsEngelli = isnull(dlt.IsEngelli,0)
           ,@eIs125ccAlti = isnull(dlt.Is125ccAlti,0)

           ,@eKimlikGeldi = isnull(dlt.KimlikGeldi,0)
           ,@eBiyometrikGeldi = isnull(dlt.BiyometrikGeldi,0)
           ,@eBasvuruFotoCekildi = isnull(dlt.BasvuruFotoCekildi,0)
           ,@eOgrenimGeldi = isnull(dlt.OgrenimGeldi,0)
           ,@eSaglikGeldi = isnull(dlt.SaglikGeldi,0)
           ,@eAdliSicilGeldi = isnull(dlt.AdliSicilGeldi,0)
           ,@eImzaAlindi = isnull(dlt.ImzaAlindi,0)
           ,@eSozlesmeYapildi = isnull(dlt.SozlesmeYapildi,0)
           ,@eAdresAlindi = isnull(dlt.AdresAlindi,0)
           ,@eBelgelerGeldi = isnull(dlt.BelgelerGeldi,0) 

        From deleted dlt
        Where dlt.Id = @TalepId
			   
        Select 
            @yFirmId = ins.FirmId
           ,@yAdayId = isnull(ins.AdayId, 0) 
           ,@yIsActive = isnull(ins.IsActive,0)
           ,@yTcNo = isnull(ins.TcNo,'')
           ,@yTamAdi = isnull(ins.TamAdiSoyadi, '')
           ,@yAdi = isnull(ins.Adi,'')
           ,@ySoyadi = isnull(ins.Soyadi,'')

           ,@yMevcutSertifikaTipiId = isnull(ins.MevcutSertifikaTipiId,0)
           ,@yIstenenSertifikaTipiId = isnull(ins.IstenenSertifikaTipiId,0)

           ,@yIsMevcutOtomatik = isnull(ins.IsMevcutOtomatik,0)
           ,@yIsMevcut2016Oncesi = isnull(ins.IsMevcut2016Oncesi,0)
           ,@yIsMevcut125ccAlti = isnull(ins.IsMevcut125ccAlti,0)

           ,@yIsOtomatik = isnull(ins.IsOtomatik,0)
           ,@yIsEngelli = isnull(ins.IsEngelli,0)
           ,@yIs125ccAlti = isnull(ins.Is125ccAlti,0)

           ,@yDonemTipiId = isnull(ins.DonemTipiId,0)
           ,@yGrupTipiId = isnull(ins.GrupTipiId,0)
           ,@ySubeTipiId = isnull(ins.SubeTipiId,0)

           ,@yKayitTipiId = isnull(ins.KayitTipiId,0)
           ,@yMebbisKurumOnayi = isnull(ins.MebbisKurumOnayi,0)
           ,@yMebbisDurumTipiId = isnull(ins.MebbisDurumTipiId,0)

           ,@yKimlikGeldi = isnull(ins.KimlikGeldi,0)
           ,@yBiyometrikGeldi = isnull(ins.BiyometrikGeldi,0)
           ,@yBasvuruFotoCekildi = isnull(ins.BasvuruFotoCekildi,0)
           ,@yOgrenimGeldi = isnull(ins.OgrenimGeldi,0)
           ,@ySaglikGeldi = isnull(ins.SaglikGeldi,0)
           ,@yAdliSicilGeldi = isnull(ins.AdliSicilGeldi,0)
           ,@yImzaAlindi = isnull(ins.ImzaAlindi,0)
           ,@ySozlesmeYapildi = isnull(ins.SozlesmeYapildi,0)
           ,@yAdresAlindi = isnull(ins.AdresAlindi,0)
           ,@yBelgelerGeldi = isnull(ins.BelgelerGeldi,0)

        From inserted ins
        Where ins.Id = @TalepId
     	   	
        -- TamAdiSoyadi var ise Adi ve Soyadi tespit ediliyor 
        if ((@yTamAdi <> '') and
            (@yAdi = '') and
            (@ySoyadi = ''))
        begin
            declare @i1 int = 0
            declare @i2 int = 0

            set @i1 = CHARINDEX(' ', @yTamAdi, 0)
            set @i2 = CHARINDEX(' ', @yTamAdi, @i1+1)

            if (@i2 > 0) set @i1 = @i2

            set @yAdi = SUBSTRING(@yTamAdi, 0, @i1)
            set @ySoyadi = SUBSTRING(@yTamAdi, @i1+1, 100)
            set @eTamAdi = ''

            Update MtskAdayTalep set 
             Adi = RTRIM(LTRIM(@yAdi))
            ,Soyadi = RTRIM(LTRIM(@ySoyadi))
            Where Id = @TalepId
        end
		
    	set @newTamAdi = @yAdi + ' ' +  @ySoyadi

		if (@yMevcutSertifikaTipiId < 0)
            set @yMevcutSertifikaTipiId = 0

        -- MtskAday tablosu
        if ((@yAdayId = 0) and (@yTcNo <> ''))
        begin
            set @mevcutAdayId = 0
            Select @mevcutAdayId = isnull(Id, 0) from MtskAday 
            Where TcNo = @yTcNo
            
            if (@mevcutAdayId = 0)
            begin
                INSERT INTO [dbo].[MtskAday]
                 (  [AdayGUID]
                    ,[FirmId]
                    ,[IsActive]
                    ,[TcNo]
                    ,[TamAdiSoyadi]
                    ,[Adi]
                    ,[Soyadi] )
                VALUES
                   (  NEWID
                    , @yFirmId
                    , 1 
                    , @yTcNo
                    , @newTamAdi 
                    , @yAdi 
                    , @ySoyadi )
                
                -- Yeni @mevcutAdayId ye kavuştuk
                Select @yAdayId = Id from MtskAday
                Where TcNo = @yTcNo

            end else 
              set @yAdayId = @mevcutAdayId
        end

        -- Mevcut ehliyetler
		if (@yMevcutSertifikaTipiId = 9010) -- A Manuel işareti varsa
        begin
            set @yIsMevcutOtomatik = 0 -- Manuel
            set @yMevcutSertifikaTipiId = 2514
        end

        if ((@yMevcutSertifikaTipiId = 9020) or -- A1 Manuel işareti varsa
            (@yMevcutSertifikaTipiId = 9021) or -- A1 Otomatik işareti varsa
            (@yMevcutSertifikaTipiId = 9022))   -- 125 cc altı
        begin
            if (@yMevcutSertifikaTipiId = 9020) set @yIsMevcutOtomatik = 0 -- Manuel
            if (@yMevcutSertifikaTipiId = 9021) set @yIsMevcutOtomatik = 1 -- Otomatik
            if (@yMevcutSertifikaTipiId = 9022) set @yIsMevcut125ccAlti = 1
            set @yMevcutSertifikaTipiId = 2502
        end
        
        if ((@yMevcutSertifikaTipiId = 9030) or -- A2 Manuel işareti varsa
            (@yMevcutSertifikaTipiId = 9031))   -- A2 Otomatik işareti varsa
        begin
            if (@yMevcutSertifikaTipiId = 9030) set @yIsMevcutOtomatik = 0 -- Manuel
            if (@yMevcutSertifikaTipiId = 9031) set @yIsMevcutOtomatik = 1 -- Otomatik
            set @yMevcutSertifikaTipiId = 2503
        end

        if ((@yMevcutSertifikaTipiId = 9040) or -- B Manuel işareti varsa
            (@yMevcutSertifikaTipiId = 9041))   -- B Otomatik işareti varsa
        begin
            if (@yMevcutSertifikaTipiId = 9040) set @yIsMevcutOtomatik = 0 -- Manuel
            if (@yMevcutSertifikaTipiId = 9041) set @yIsMevcutOtomatik = 1 -- Otomatik
            set @yMevcutSertifikaTipiId = 2504
        end

        if ((@yMevcutSertifikaTipiId = 9050) or -- C Manuel işareti varsa
            (@yMevcutSertifikaTipiId = 9051))   -- C Otomatik işareti varsa
        begin
            if (@yMevcutSertifikaTipiId = 9050) set @yIsMevcutOtomatik = 0 -- Manuel
            if (@yMevcutSertifikaTipiId = 9051) set @yIsMevcutOtomatik = 1 -- Otomatik
            set @yMevcutSertifikaTipiId = 2505
        end

        if ((@yMevcutSertifikaTipiId = 9060) or -- D Manuel işareti varsa
            (@yMevcutSertifikaTipiId = 9061))   -- D Otomatik işareti varsa
        begin
            if (@yMevcutSertifikaTipiId = 9060) set @yIsMevcutOtomatik = 0 -- Manuel
            if (@yMevcutSertifikaTipiId = 9061) set @yIsMevcutOtomatik = 1 -- Otomatik
            set @yMevcutSertifikaTipiId = 2506
        end

        if ((@yMevcutSertifikaTipiId = 9070) or -- E Manuel işareti varsa
            (@yMevcutSertifikaTipiId = 9071))   -- E Otomatik işareti varsa
        begin
            if (@yMevcutSertifikaTipiId = 9070) set @yIsMevcutOtomatik = 0 -- Manuel
            if (@yMevcutSertifikaTipiId = 9071) set @yIsMevcutOtomatik = 1 -- Otomatik
            set @yMevcutSertifikaTipiId = 2507
        end

        -- İstenen sertifikalar

        if ((@yIstenenSertifikaTipiId = 9020) or -- A1 Manuel işareti varsa
            (@yIstenenSertifikaTipiId = 9021) or -- A1 Otomatik işareti varsa
            (@yIstenenSertifikaTipiId = 9022))   -- 125 cc altı
        begin
            if (@yIstenenSertifikaTipiId = 9020) set @yIsOtomatik = 0 -- Manuel
            if (@yIstenenSertifikaTipiId = 9021) set @yIsOtomatik = 1 -- Otomatik
            if (@yIstenenSertifikaTipiId = 9022) set @yIs125ccAlti = 1
            set @yIstenenSertifikaTipiId = 2502
        end

        if ((@yIstenenSertifikaTipiId = 9030) or -- A2 Manuel işareti varsa
            (@yIstenenSertifikaTipiId = 9031))   -- A2 Otomatik işareti varsa
        begin
            if (@yIstenenSertifikaTipiId = 9030) set @yIsOtomatik = 0 -- Manuel
            if (@yIstenenSertifikaTipiId = 9031) set @yIsOtomatik = 1 -- Otomatik
            set @yIstenenSertifikaTipiId = 2503
        end

        if ((@yIstenenSertifikaTipiId = 9040) or -- B Manuel işareti varsa
            (@yIstenenSertifikaTipiId = 9041))   -- B Otomatik işareti varsa
        begin
            if (@yIstenenSertifikaTipiId = 9040) set @yIsOtomatik = 0 -- Manuel
            if (@yIstenenSertifikaTipiId = 9041) set @yIsOtomatik = 1 -- Otomatik
            set @yIstenenSertifikaTipiId = 2504
        end

        if ((@yIstenenSertifikaTipiId = 9050) or -- C Manuel işareti varsa
            (@yIstenenSertifikaTipiId = 9051))   -- C Otomatik işareti varsa
        begin
            if (@yIstenenSertifikaTipiId = 9050) set @yIsOtomatik = 0 -- Manuel
            if (@yIstenenSertifikaTipiId = 9051) set @yIsOtomatik = 1 -- Otomatik
            set @yIstenenSertifikaTipiId = 2505
        end

        if ((@yIstenenSertifikaTipiId = 9060) or -- D Manuel işareti varsa
            (@yIstenenSertifikaTipiId = 9061))   -- D Otomatik işareti varsa
        begin
            if (@yIstenenSertifikaTipiId = 9060) set @yIsOtomatik = 0 -- Manuel
            if (@yIstenenSertifikaTipiId = 9061) set @yIsOtomatik = 1 -- Otomatik
            set @yIstenenSertifikaTipiId = 2506
        end

        if ((@yIstenenSertifikaTipiId = 9070) or -- E Manuel işareti varsa
            (@yIstenenSertifikaTipiId = 9071))   -- E Otomatik işareti varsa
        begin
            if (@yIstenenSertifikaTipiId = 9070) set @yIsOtomatik = 0 -- Manuel
            if (@yIstenenSertifikaTipiId = 9071) set @yIsOtomatik = 1 -- Otomatik
            set @yIstenenSertifikaTipiId = 2507
        end

        if ((@yIstenenSertifikaTipiId = 9201) or -- 100 Ceza Manuel işareti varsa
            (@yIstenenSertifikaTipiId = 9202))   -- 100 Ceza Otomatik işareti varsa
        begin
            if (@yIstenenSertifikaTipiId = 9201) set @yIsOtomatik = 0 -- Manuel
            if (@yIstenenSertifikaTipiId = 9202) set @yIsOtomatik = 1 -- Otomatik
            set @yIstenenSertifikaTipiId = 2200
        end
		
        -- IsUcretli
        if (@yAnlasilanUcret > 0) 
        begin
            set @yIsUcretli = 1
            set @yIsUcretsiz = 0
        end else
        begin
            set @yIsUcretli = 0
            set @yIsUcretsiz = 1
            set @SertifikaUcretTipiId = 4 -- Ücretsiz
        end

        /* yeni dönem geldi ve herhangi bir geldiyse onu Kayıt aşaması na alıyoruz */

        if (@yKayitTipiId = 1) and
           (@BugunDonemTipiId = @yDonemTipiId) and
            ((@yKimlikGeldi = 1) or
            (@yBiyometrikGeldi = 1) or
            (@yBasvuruFotoCekildi = 1) or
            (@yOgrenimGeldi = 1) or
            (@ySaglikGeldi = 1) or
            (@yAdliSicilGeldi = 1) or
            (@yImzaAlindi = 1) or
            (@ySozlesmeYapildi = 1)) 
        begin
            set @yMebbisDurumTipiId = 0
            set @yKayitTipiId = 2
        end
		
        if (@yKayitTipiId <> 1) and
            (@yKayitTipiId <> 6) and 
            (@yKayitTipiId <> 7) 
        begin
            if (@yMebbisDurumTipiId = 0) set @yKayitTipiId = 2
		
            if (@yMebbisDurumTipiId = 1) or
                (@yMebbisDurumTipiId = 2) or
                (@yMebbisDurumTipiId = 7) or
                (@yMebbisDurumTipiId = 8) or
                (@yMebbisDurumTipiId = 9) or
                (@yMebbisDurumTipiId = 12) or
                (@yMebbisDurumTipiId = 13) or 
                (@yMebbisDurumTipiId = 22) set @yKayitTipiId = 3

            if (@yMebbisDurumTipiId = 5) and (@yKayitTipiId <> 5) 
                set @yKayitTipiId = 4
		
            if (@yMebbisDurumTipiId = 3) or
                (@yMebbisDurumTipiId = 4) or
                (@yMebbisDurumTipiId = 6) or
                (@yMebbisDurumTipiId = 10) or
                (@yMebbisDurumTipiId = 11) or
                (@yMebbisDurumTipiId = 14) set @yKayitTipiId = 6
	      
            -- Sertifikası var ise
            Select @SertifikaAlmayiHakKazandi = isnull(SertifikaAlmayiHakKazandi,0) 
                , @SertifikaTarihi = SertifikaTarihi
            From MtskAdaySertifika
            Where FirmId = @yFirmId
            and   AdayId = @AdayId
            and   TalepId = @TalepId

            if (@SertifikaAlmayiHakKazandi = 1)
                set @yKayitTipiId = 4
        
        end -- @yKayitTipiId <> 7

        if (@yKayitTipiId = 0) or
            (@yKayitTipiId = 1) or
            (@yKayitTipiId = 2) or
            (@yKayitTipiId = 3) set @yIsActive = 1

        if (@yKayitTipiId = 4) or
            (@yKayitTipiId = 5) or
            (@yKayitTipiId = 6) or
            (@yKayitTipiId = 7) set @yIsActive = 0

        if ((@yKimlikGeldi = 1) and
            (@yBiyometrikGeldi = 1) and
            (@yBasvuruFotoCekildi = 1) and
            (@yOgrenimGeldi = 1) and
            (@ySaglikGeldi = 1) and
            (@yAdliSicilGeldi = 1) and
            (@yImzaAlindi = 1) and
            (@ySozlesmeYapildi = 1) and
            (@yAdresAlindi = 1)) 
             set @yBelgelerGeldi = 1
        else set @yBelgelerGeldi = 0

        if ((@newTamAdi <> @eTamAdi) or 
            (@eTamAdi = '') or
            (@yTamAdi = '') or

            (@eAdayId <> @yAdayId) or
            (@eMevcutSertifikaTipiId <> @yMevcutSertifikaTipiId) or
            (@eIstenenSertifikaTipiId <> @yIstenenSertifikaTipiId) or

            (@eIsMevcutOtomatik = @yIsMevcutOtomatik) or
            (@eIsMevcut2016Oncesi = @yIsMevcut2016Oncesi) or
            (@eIsMevcut125ccAlti = @yIsMevcut125ccAlti) or

            (@eIsOtomatik = @yIsOtomatik) or
            (@eIsEngelli = @yIsEngelli) or
            (@eIs125ccAlti = @yIs125ccAlti) or

            (@eKayitTipiId <> @yKayitTipiId) or
            (@eIsActive <> @yIsActive) or
            (@eBelgelerGeldi <> @yBelgelerGeldi))  
    	begin
    	    update MtskAdayTalep set 
              AdayId = @yAdayId 
            , IsActive = @yIsActive 
            , TamAdiSoyadi = RTRIM(LTRIM(@newTamAdi))

            , MevcutSertifikaTipiId = @yMevcutSertifikaTipiId
            , IsMevcutOtomatik = @yIsMevcutOtomatik
            , IsMevcut2016Oncesi = @yIsMevcut2016Oncesi
            , IsMevcut125ccAlti = @yIsMevcut125ccAlti

            , IstenenSertifikaTipiId = @yIstenenSertifikaTipiId
            , IsOtomatik = @yIsOtomatik
            , IsEngelli = @yIsEngelli
            , Is125ccAlti = @yIs125ccAlti

            , KayitTipiId = @yKayitTipiId
            , BelgelerGeldi = @yBelgelerGeldi
            where Id = @TalepId 
    	end

        -- MtskAdayBelgeler Insert
        if ( Select count(*) ADET from dbo.MtskAdayBelgeler 
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            insert into dbo.MtskAdayBelgeler (
              FirmId , IsActive  , TalepId , AdayId , TcNo , DonemTipiId 
            , BiyometrikTarandi  , BasvuruFotoTarandi  , OgrenimTarandi  , SaglikTarandi  , AdliSicilTarandi  , ImzaTarandi  , Sozlesme1Tarandi  , Sozlesme2Tarandi  , BelgelerTarandi  , AdayKaydiYapildi 
            , BiyometrikYuklendi , BasvuruFotoYuklendi , OgrenimYuklendi , SaglikYuklendi , AdliSicilYuklendi , ImzaYuklendi , Sozlesme1Yuklendi , Sozlesme2Yuklendi , BelgelerYuklendi 
            , IsSertifikaUcreti  , SertifikaUcretiIsPaid , IsUcretsiz , IsFatura ) values
            ( @yFirmId, 1,  @TalepId, @yAdayId, @yTcNo,  0,
                0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
                0,  0,  0,  0,  0,  0,  0,  0,  0,
                0,  0,  0,  0 ) 
        end -- MtskAdayBelgeler
        
        -- MtskAdayAdliSicil Insert
        if ( Select count(*) ADET from dbo.MtskAdayAdliSicil
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            Insert into [dbo].[MtskAdayAdliSicil]
            (FirmId, IsActive, TalepId, AdayId) VALUES (@yFirmId, 1, @TalepId, @yAdayId )
        end

        -- MtskAdayAdres Insert
        if ( Select count(*) ADET from dbo.MtskAdayAdres
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            Insert into [dbo].[MtskAdayAdres]
            (FirmId, IsActive, TalepId, AdayId) VALUES (@yFirmId, 1, @TalepId, @yAdayId )
        end

        -- MtskAdayImza Insert
        if ( Select count(*) ADET from dbo.MtskAdayImza
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            INSERT INTO [dbo].[MtskAdayImza]
            (FirmId, IsActive, TalepId, AdayId) VALUES (@yFirmId, 1, @TalepId, @yAdayId )
        end

        -- MtskAdayOgrenim Insert
        if ( Select count(*) ADET from dbo.MtskAdayOgrenim
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            INSERT INTO [dbo].[MtskAdayOgrenim]
            (FirmId, IsActive, TalepId, AdayId) VALUES (@yFirmId, 1, @TalepId, @yAdayId )
        end

        -- MtskAdaySaglik Insert
        if ( Select count(*) ADET from dbo.MtskAdaySaglik
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            INSERT INTO [dbo].[MtskAdaySaglik]
            (FirmId, IsActive, TalepId, AdayId) VALUES (@yFirmId, 1, @TalepId, @yAdayId )
        end

        -- MtskAdaySertifika Insert
        if ( Select count(*) ADET from dbo.MtskAdaySertifika
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            INSERT INTO [dbo].[MtskAdaySertifika]
            (FirmId, TalepId, AdayId) VALUES (@yFirmId, @TalepId, @yAdayId )
        end

        -- MtskAdaySozlesme Insert
        if ( Select count(*) ADET from dbo.MtskAdaySozlesme
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            INSERT INTO [dbo].[MtskAdaySozlesme]
            ([AdayId],[FirmId],[IsActive]) VALUES (@AdayId, @yFirmId, 1)
        end

        -- MtskAdayTakip Insert
        if ( Select count(*) ADET from dbo.[MtskAdayTakip] 
             where FirmId = @yFirmId
             and   TalepId = @TalepId 
             and   AdayId = @yAdayId 
           ) = 0 
        begin 
            insert into dbo.[MtskAdayTakip] ( 
                 [FirmId],[IsActive],[TalepId],[AdayId],[TcNo]
                ,[DonemTipiId],[GrupTipiId],[SubeTipiId]
                ,[KayitTipiId],[MebbisKurumOnayi],[MebbisDurumTipiId]
                ,[YasOnayiTipiId],[OzurDurumTipiId],[BorcDurumuTipiId] -- değişti [SertifikaUcretTipiId]
                ,[TeorikBaslamaTarihi],[ToerikBitisTarihi],[TeorikDersToplami],[TeorikDersTipiId]
                ,[eSinavNo],[eSinavDurumTipiId],[eSinavSonucTipiId],[eSinavSonrasiTipiId],[OnBesGunBitisTarihi],[eSinavUcretTipiId],[eSinavDetayId],[eSinavBasariTarihi]
                ,[UygulamaBaslamaTarihi],[UygulamaBitisTarihi],[SimulatorDersToplami],[AkanTrafikDersToplami],[UygulamaliDersToplami],[UygulamaliDersTipiId]
                ,[BasarisizBaslamaTarihi],[BasarisizBitisTarihi],[BasarisizDersToplami],[BasarisizDersTipiId]
                ,[Arti4BaslamaTarihi],[Arti4BitisTarihi],[Arti4DersToplami],[Arti4DersTipiId]
                ,[uSinavaKatilabilir], [uRandevuMebbisAktarildi] 
                ,[uSinavNo],[uSinavDurumTipiId],[uSinavSonucTipiId],[uSinavSonrasiTipiId],[uSinavUcretTipiId],[uSinavDetayId],[uSinavBasariTarihi]
                ,[SertifikaDurumTipiId],[SertifikaTarihi],[DosyaYakti]
                ) values
            ( @yFirmId,  1,  @TalepId, @yAdayId,  null,   
              @yDonemTipiId,  @yGrupTipiId,  @ySubeTipiId, 
              0,  0,  @yMebbisDurumTipiId,  -- KayitTipiId
              0,  0,  0,  -- YasOnayiTipiId       
              null, null, 0,  0,  -- [TeorikBaslamaTarihi]
              0,  0,  0,  0,  null,  0,  0,  null, -- [eSinavNo]
              null, null, 0,  0,  0,  0,  -- [UygulamaBaslamaTarihi]
              null, null, 0,  0, -- [BasarisizBaslamaTarihi]
              null, null, 0,  0, -- [Arti4BaslamaTarihi]
              0,  0,             -- [uSinavaKatilabilir]
              0,  0,  0,  0,  0,  0,  null, -- [uSinavNo]
              0,  null,   0 -- SertifikaurumTipiId
            ) 
        end -- MtskAdayBelgeler


        -- MtskAdayBelgeler tablosunu işaretle
        Update MtskAdayBelgeler set
           BiyometrikTarandi = x.Sonuc 
        From MtskAdayBelgeler a, 
        (
            Select isnull(count(Id),0) as Sonuc
            From MtskAday
            Where BiyometrikResim is not null
            and Id = @AdayId
        ) as x
        Where a.FirmId = @yFirmId
        and a.TalepId = @TalepId
        and a.AdayId = @yAdayId
		
        Update MtskAdayBelgeler set
           BasvuruFotoTarandi = x.Sonuc 
        From MtskAdayBelgeler a, 
        (
            Select isnull(count(Id),0) as Sonuc
            From MtskAdayTalep
            Where BasvuruResim is not null
            and Id = @TalepId
        ) as x
        Where a.FirmId = @yFirmId
        and a.TalepId = @TalepId
        and a.AdayId = @yAdayId


        Update MtskAdayTalep set
           BiyometrikGeldi = x.Sonuc 
        From MtskAdayTalep a, 
        (
            Select isnull(count(Id),0) as Sonuc
            From MtskAday
            Where BiyometrikResim is not null
            and Id = @AdayId
        ) as x
        Where a.Id = @TalepId
		and   isnull(a.BiyometrikGeldi,0) = 0

        Update MtskAdayTalep set
           BasvuruResmiCekildi = x.Sonuc 
        From MtskAdayTalep a, 
        (
            Select isnull(count(Id),0) as Sonuc
            From MtskAdayTalep
            Where BasvuruResim is not null
            and Id = @TalepId
        ) as x
        Where a.Id = @TalepId
		and   isnull(a.BasvuruResmiCekildi,0) = 0


		
        -- MtskAdayTakip YORUMLARI 

        -- @SertifikaUcretTipiId kontrolü tahsilatlar ile gerçekleşecek

        -- MtskAdayTakip
        Update MtskAdayTakip set
          IsActive = @yIsActive
        , DonemTipiId = @yDonemTipiId
        , GrupTipiId = @yGrupTipiId
        , SubeTipiId = @ySubeTipiId
        , KayitTipiId = @yKayitTipiId
        , MebbisKurumOnayi = @yMebbisKurumOnayi
        , MebbisDurumTipiId = @yMebbisDurumTipiId
        --, SertifikaDurumTipiId = @SertifikaAlmayiHakKazandi
        , SertifikaTarihi = SertifikaTarihi
        From MtskAdayTakip as takip
        Where takip.TalepId = @TalepId


        -- Bildirim gönderme varsa BildirimXXXX tablolarını çalıştır
		/*
        if ((@eSMSGonder <> @ySMSGonder) or
            ((@yMesajTipiId > 0) and
             ((@eKimlikGeldi = @yKimlikGeldi ) or
              (@eBiyometrikGeldi = @yBiyometrikGeldi ) or
              (@eOgrenimGeldi = @yOgrenimGeldi ) or
              (@eSaglikGeldi = @ySaglikGeldi ) or
              (@eAdliSicilGeldi = @yAdliSicilGeldi ) or
              (@eImzaAlindi = @yImzaAlindi ) or
              (@eSozlesmeYapildi = @ySozlesmeYapildi ) or
              (@eBelgelerGeldi = @yBelgelerGeldi ))))
        begin
            EXECUTE [dbo].[prc_BildirimSMS] @yFirmId, 1, @AdayId, @ySMSGonder, @yMesajTipiId 
        end
		*/


      FETCH NEXT FROM talepCursor INTO @TalepId
    END -- While

	-- Veri transferi yapılmıyorsa 
	if (@DbUpdatesIsActive = 0)
	begin
       -- MtskDonemKontrolu
       --EXECUTE [dbo].[prc_MtskDonemKontrolu] @yFirmId 
       --EXECUTE [dbo].[prc_MtskAdayTakip] @yFirmId
    end

    CLOSE talepCursor
    DEALLOCATE talepCursor   

END -- create trigger


/*CreateTriggerEnd*/

/*CreateLkpTable*/

begin transaction

-- TalepTipiId
-- KayitTipiId
-- MebbisDurumTipiId
-- VeriKaynakTipiId

-- MevcutSertifikaTipiId ve
-- IsteneSertifikaTipiId için
-- [Lkp].[MtskSertifikaTipi]  tablosuna bak

-- ------------------------------------------------------- 
-- TalepTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'MtskAdayTalepTalepTipi')
drop table [Lkp].[MtskAdayTalepTalepTipi]

create table [Lkp].[MtskAdayTalepTalepTipi]
(
   Id               Int Unique not null, 
   TalepTipi        nVarchar(50)   null,
   IsActive         Bit            null,
   
   constraint  pk_MtskAdayTalepTalepTipi primary key (Id)
)

Delete from [Lkp].[MtskAdayTalepTalepTipi]
INSERT INTO [Lkp].[MtskAdayTalepTalepTipi] (Id, TalepTipi, IsActive)
 VALUES 
  ( 0,    N'Seçiniz', 1),
  ( 1,    N'Sertifika', 1),
  ( 2,    N'2.+4 hak ', 1),
  ( 3,    N'Nakil 2.+4 hak', 1),
  ( 4,    N'100 Ceza', 1),
  ( 5,    N'Özel direksiyon ders (Aday değil)', 1),
  ( 6,    N'Özel teorik ders', 1)


-- ------------------------------------------------------- 
-- KayitTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'MtskAdayTalepKayitTipi')
drop table [Lkp].[MtskAdayTalepKayitTipi]

create table [Lkp].[MtskAdayTalepKayitTipi]
(
   Id               Int Unique not null, 
   KayitTipi        nVarchar(30)   null,
   ChartCaption     nVarchar(20)   null,
   FormCaption      nVarchar(15)   null,

   constraint  pk_MtskAdayTalepKayitTipi primary key (Id)
)

Delete from [Lkp].[MtskAdayTalepKayitTipi]
INSERT INTO [Lkp].[MtskAdayTalepKayitTipi] (Id, KayitTipi, ChartCaption, FormCaption)
 VALUES 
  ( 0,    N'', '', ''),
  ( 1,    N'Ön kayıt',                  'Ön kayıt',     'Yeni Aday' ),
  ( 2,    N'Kayıt aşamasında',          'K.Aşamasında', 'Mebbis' ),
  ( 3,    N'Kesin kayıt',               'Kesin kay.', '' ),
  ( 4,    N'Sertifikayı hak kazandı',   '', '' ),
  ( 5,    N'Sertifikası teslim edildi', '', '' ),
  ( 6,    N'Diğerleri',                 '', '' ),
  ( 7,    N'Dosya kapandı',             '', '' )


-- ------------------------------------------------------- 
-- MebbisDurumTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'MtskAdayTalepMebbisDurumTipi')
drop table [Lkp].[MtskAdayTalepMebbisDurumTipi]

create table [Lkp].[MtskAdayTalepMebbisDurumTipi]
(
   Id                Int Unique not null, 
   MebbisDurumTipi   nVarchar(70)   null
   
   constraint  pk_MtskAdayTalepMebbisDurumTipi primary key (Id)
)

Delete from [Lkp].[MtskAdayTalepMebbisDurumTipi]
INSERT INTO [Lkp].[MtskAdayTalepMebbisDurumTipi] (Id, MebbisDurumTipi)
 VALUES 
  (-1,  N'' ),
  ( 0,  N'Kursa Başvuru Aşamasında' ),
  ( 1,  N'Teorik Sınav Aşamasında' ),
  ( 2,  N'Uygulama Sınav Aşamasında' ),
  ( 3,  N'Teorik Sınav Hakkı Doldu' ),
  ( 4,  N'Uygulama Sınav Hakkı Doldu' ),
  ( 5,  N'Sertifika Almaya Hak Kazandı' ),
  ( 6,  N'Sertifikası İptal Edildi' ),
  ( 7,  N'e-Sınav Aşamasında' ),
  ( 8,  N'e-Sınav Test Aşamasında' ),
  ( 9,  N'e-Sınavdan Başarısız Oldu' ),
  ( 10,  N'e-Sınav Hakkı Doldu' ),
  ( 11,  N'Kaydı Silindi' ),
  ( 12,  N'Ceza Kaydı Var' ),
  ( 13,  N'Teorik Dersten Muaf' ),
  ( 14,  N'Adli Sicil Kaydı Uygun Olmadığından Dönem Kaydı Durdurulmuştur.' ),
  ( 22,  N'2.Direksiyon Aşamasında' )


-- ------------------------------------------------------- 
-- VeriKaynakTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'MtskAdayTalepVeriKaynakTipi')
drop table [Lkp].[MtskAdayTalepVeriKaynakTipi]

create table [Lkp].[MtskAdayTalepVeriKaynakTipi]
(
   Id                Int Unique not null, 
   VeriKaynakTipi   nVarchar(50)   null
   
   constraint  pk_MtskAdayTalepVeriKaynakTipi primary key (Id)
)

Delete from [Lkp].[MtskAdayTalepVeriKaynakTipi]
INSERT INTO [Lkp].[MtskAdayTalepVeriKaynakTipi] (Id, VeriKaynakTipi)
 VALUES 
  ( 0,  N'' ),
  ( 1,  N'Kullanıcı girişi, kaydı' ),
  ( 2,  N'Mebbis dönem aday onaylama listesi' ),
  ( 3,  N'Mebbis uygulama sınav listesi' ),
  ( 4,  N'Mebbis aday durum bilgileri' ),
  ( 5,  N'Veri aktarımı' ),
  ( 6,  N'2.+4 hak için veri aktarımı' )


commit transaction

/*CreateLkpTableEnd*/




/*
-- ------------------------------------------------------- 
-- EtiketTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'MtskSaatUygulamaEtiketTipi')
drop table [Lkp].[MtskSaatUygulamaEtiketTipi]

create table [Lkp].[MtskSaatUygulamaEtiketTipi]
(
   Id               Int Unique not null, 
   EtiketTipi       nVarchar(50)   null,
   GrupTipiId       SmallInt       null,
   
   constraint  pk_MtskSaatUygulamaEtiketTipi primary key (Id)
)

Delete from [Lkp].[MtskSaatUygulamaEtiketTipi]
INSERT INTO [Lkp].[MtskSaatUygulamaetiketTipi] (Id, EtiketTipi, GrupTipiId)
 VALUES 
  ( 0,    N'Normal',0),
  ( 125,  N'A1 125 CC altı', 0)


  */


  /*
-- ------------------------------------------------------- 
-- MesajTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'MtskAdayTalepMesajTipi')
drop table [Lkp].[MtskAdayTalepMesajTipi]

create table [Lkp].[MtskAdayTalepMesajTipi]
(
   Id                Int Unique not null, 
   MesajTipi         nVarchar(50)   null
   
   constraint  pk_MtskAdayTalepMesajTipi primary key (Id)
)

Delete from [Lkp].[MtskAdayTalepMesajTipi]
INSERT INTO [Lkp].[MtskAdayTalepMesajTipi] (Id, MesajTipi)
 VALUES 
  ( 0,  N'' ),
  ( 1,  N'Gerekli Belgeler' ),
  ( 2,  N'Eksik Belgeler' )
*/

/*

           ,[KimlikSeriNo]
           ,[IlkKayitTarihi]
           ,[DogumTarihi]
           ,[BabaAdi]
           ,[AnneAdi]
           ,[CinsiyetTipiId]
           ,[CepTelefonu]
           ,[CepTelefonu2]
           ,[Eposta]
           ,[MesajTipiId]
           ,[SMSGonder]
           ,[EpostaGonder]
           ,[WhatsAppGonder]
           ,[KullaniciUyarilari]
           ,[BiyometrikResim]
           ,[BiyometrikResimSmall])

           ,<IlkKayitTarihi, date,>
           ,<KimlikSeriNo, varchar(10),>
           ,<DogumTarihi, date,>
           ,<BabaAdi, nvarchar(50),>
           ,<AnneAdi, nvarchar(50),>
           ,<CinsiyetTipiId, smallint,>
           ,<CepTelefonu, varchar(15),>
           ,<CepTelefonu2, varchar(15),>
           ,<Eposta, varchar(98),>
           ,<MesajTipiId, smallint,>
           ,<SMSGonder, bit,>
           ,<EpostaGonder, bit,>
           ,<WhatsAppGonder, bit,>
           ,<KullaniciUyarilari, nvarchar(200),>
           ,<BiyometrikResim, varbinary(max),>
           ,<BiyometrikResimSmall, varbinary(max),>)



*/