/*CreateTable*/

begin transaction

 create table MtskAdayAdliSicil
 (
   Id                    Int IDENTITY(1,1) not null, 
   FirmId                Int       not null,
   TalepId               Int       not null, 
   AdayId                Int       not null, 
   TcNo                  Varchar(11)   null,
   DonemTipiId           Int           null,

   SavcilikBelgesiVerenKurum   nVarchar(200)  null,
   SavcilikBelgesiTarihi       Date           null,
   SavcilikBelgesiSayisi       nVarchar(30)   null,
   SavcilikBelgesiResim        VarBinary(max) null,
   SavcilikBelgesiResimSmall   VarBinary(max) null,

   constraint		pk_MtskAdayAdliSicil primary key (Id)
 )
  
 grant select, insert, update, delete on MtskAdayAdliSicil to public

  create index X_MtskAdayAdliSicil01 on MtskAdayAdliSicil (TalepId)
  create index X_MtskAdayAdliSicil02 on MtskAdayAdliSicil (AdayId)
  create index X_MtskAdayAdliSicil03 on MtskAdayAdliSicil (TcNo)
  create index X_MtskAdayAdliSicil04 on MtskAdayAdliSicil (DonemTipiId)

commit transaction

/*CreateTableEnd*/

/*CreateTrigger*/

CREATE TRIGGER dbo.trg_MtskAdayAdliSicil on dbo.MtskAdayAdliSicil
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE myCursor cursor for select Id from Inserted
    DECLARE @curId bigint

    Declare @TalepId int = 0

    OPEN myCursor

    FETCH NEXT FROM myCursor INTO @curId

    WHILE @@FETCH_STATUS = 0
    BEGIN

        select 
           @TalepId = ins.TalepId
		from inserted ins
    	where ins.Id = @curId

		-- MtskAdayTalep tablosunu işaretle
		Update MtskAdayTalep set
        AdliSicilGeldi = x.Sonuc
        From MtskAdayTalep a, 
        (
            Select count(Id) as Sonuc
            From MtskAdayAdliSicil
            Where 0 = 0
            and SavcilikBelgesiResim is not null
            and TalepId = @TalepId
        ) as x
        Where a.Id = @TalepId

		Update MtskAdayBelgeler set
        AdliSicilTarandi = x.Sonuc
        From MtskAdayBelgeler a, 
        (
            Select count(Id) as Sonuc
            From MtskAdayAdliSicil
            Where 0 = 0
            and SavcilikBelgesiResim is not null
            and TalepId = @TalepId
        ) as x
        Where a.TalepId = @TalepId

      FETCH NEXT FROM myCursor INTO @curId
    END -- While

    CLOSE myCursor
    DEALLOCATE myCursor   

END -- create trigger

/*CreateTriggerEnd*/

ALTER TABLE dbo.MtskAdayAdliSicil ENABLE TRIGGER trg_MtskAdayAdliSicil

