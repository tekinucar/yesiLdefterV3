/*CreateTable*/

begin transaction

 create table MtskAdaySaglik
 (
   Id                    Int IDENTITY(1,1) not null, 
   FirmId                Int       not null,
   TalepId               Int       not null, 
   AdayId                Int       not null, 
   TcNo                  Varchar(11)   null,
   DonemTipiId           Int           null,

   RaporReferansNo             nVarchar(50)   null,
   SaglikRaprunuVerenKurum     nVarchar(200)  null,
   SaglikRaporuSonuc           nVarchar(30)   null,
   SaglikRaporuTarihi          Date           null,
   SaglikRaporuSayisi          nVarchar(30)   null,
   OzurDurumuTipiId            SmallInt       null,
   OkutmanTalebi               Bit            null,
   TercumanTalebi              Bit            null,
   YabanciDilTipiId            SmallInt       null,
   SaglikRaporuResim           VarBinary(max) null,
   SaglikRaporuResimSmall      VarBinary(max) null,

   constraint		pk_MtskAdaySaglik primary key (Id)
 )
  
 grant select, insert, update, delete on MtskAdaySaglik to public

  create index X_MtskAdaySaglik01 on MtskAdaySaglik (TalepId)
  create index X_MtskAdaySaglik02 on MtskAdaySaglik (AdayId)
  create index X_MtskAdaySaglik03 on MtskAdaySaglik (TcNo)
  create index X_MtskAdaySaglik04 on MtskAdaySaglik (DonemTipiId)

commit transaction

/*CreateTableEnd*/


/*CreateTrigger*/

CREATE TRIGGER dbo.trg_MtskAdaySaglik on dbo.MtskAdaySaglik
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE myCursor cursor for select Id from Inserted
    DECLARE @curId bigint

    Declare @TalepId int = 0

    OPEN myCursor

    FETCH NEXT FROM myCursor INTO @curId

    WHILE @@FETCH_STATUS = 0
    BEGIN

        select 
           @TalepId = ins.TalepId
		from inserted ins
    	where ins.Id = @curId

		-- MtskAdayTalep tablosunu işaretle
		Update MtskAdayTalep set
        SaglikGeldi = x.Sonuc
        From MtskAdayTalep a, 
        (
            Select count(Id) as Sonuc
            From MtskAdaySaglik
            Where 0 = 0
            and (
			   SaglikRaporuResim is not null 
			or Len(isnull(RaporReferansNo,'')) > 0
			)
            and TalepId = @TalepId
        ) as x
        Where a.Id = @TalepId

		-- MtskAdayBelgeler tablosunu işaretle
		Update MtskAdayBelgeler set
        SaglikTarandi = x.Sonuc
        From MtskAdayBelgeler a, 
        (
            Select count(Id) as Sonuc
            From MtskAdaySaglik
            Where 0 = 0
            and (
			   SaglikRaporuResim is not null 
			or Len(isnull(RaporReferansNo,'')) > 0
			)
            and TalepId = @TalepId
        ) as x
        Where a.TalepId = @TalepId

      FETCH NEXT FROM myCursor INTO @curId
    END -- While

    CLOSE myCursor
    DEALLOCATE myCursor   

END -- create trigger

/*CreateTriggerEnd*/

ALTER TABLE dbo.MtskAdaySaglik ENABLE TRIGGER trg_MtskAdaySaglik


/*CreateLkpTable*/

begin transaction

-- ------------------------------------------------------- 
-- OzurDurumuTipiId
-- ------------------------------------------------------- 
create table [Lkp].[MtskAdaySaglikOzurDurumuTipi]
(
   Id               Int Unique Not    null,
   OzurDurumuTipi   nVarchar(60)   null

   constraint  pk_MtskAdaySaglikOzurDurumuTipi primary key (Id)
)

Delete from [Lkp].[MtskAdaySaglikOzurDurumuTipi]
INSERT INTO [Lkp].[MtskAdaySaglikOzurDurumuTipi] (Id, OzurDurumuTipi)
 VALUES 
  ( -1, N'--Seçiniz--'),
  (  1, N'Engeli Yok'),
  (100, N'Ortopedik Engelli (Ellerini ve/veya Kollarını Kullanamıyor)'),
  (110, N'Ortopedik Engelli (Yürüyemiyor)'),
  (120, N'İşitme, Dil veya Konuşma Engelli'),
  (140, N'Görme Engelli (Bir Gözü Görmüyor)'),
  (150, N'Görme Engelli (Büyüteç Yardımı İle Görebiliyor)'),
  (160, N'Süreğen hastalığı var.')



-- ------------------------------------------------------- 
-- YabanciDilTipiId
-- ------------------------------------------------------- 
create table [Lkp].[MtskAdaySaglikYabanciDilTipi]
(
   Id               Int Unique Not    null,
   YabanciDilTipi   nVarchar(60)   null

   constraint  pk_MtskAdaySaglikYabanciDilTipi primary key (Id)
)

Delete from [Lkp].[MtskAdaySaglikYabanciDilTipi]
INSERT INTO [Lkp].[MtskAdaySaglikYabanciDilTipi] (Id, YabanciDilTipi)
 VALUES 
  ( -1, N'Yabancı Dil Seçiniz'),
  (  1, N'Arapça'),
  (  2, N'Çince'),
  (  3, N'İngilizce'),
  (  4, N'Almanca'),
  (  5, N'Fransızca'),
  (  6, N'Farsça'),
  (  7, N'Rusça')



commit transaction

/*CreateLkpTableEnd*/