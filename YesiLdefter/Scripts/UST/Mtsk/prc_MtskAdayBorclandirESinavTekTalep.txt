/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayBorclandirESinavTekTalep] (@FirmId int, @TalepId int)
AS BEGIN  

  --declare @FirmId Int  = 11

  declare @settings1SinavIcinBorclandirma bit = 0
  set @settings1SinavIcinBorclandirma = dbo.fnc_getSettingsBool(@FirmId, 2010, 113)
  if (@settings1SinavIcinBorclandirma = 1)
  begin
      declare @girecegiSinavNo int = 0
      Select @girecegiSinavNo = isnull(eSinavNo,0)
      From dbo.MtskAdayTakip as takip
      Where takip.FirmId = @FirmId
      and   takip.TalepId = @TalepId

     -- Birinci sınava giriyorsa atama yapma 
     if (@girecegiSinavNo <= 1) return;
  end

  declare @settingsPlanTarihiniKullan bit = 0
  declare @settingsSonSinavTarihiniKullan bit = 0

  set @settingsPlanTarihiniKullan = dbo.fnc_getSettingsBool(@FirmId, 2010, 111);
  set @settingsSonSinavTarihiniKullan = dbo.fnc_getSettingsBool(@FirmId, 2010, 112);

  declare @BugunDonemTipiId int = 0
  declare @BorclandirmaUcreti numeric(22,5)
  declare @ReelBorclandirmaUcreti numeric(22,5)
  declare @UcretTipiId Int  = 21111

  set @BugunDonemTipiId = dbo.fnc_getDonemTipiId('BUGUN',null);
  
  -- e-Sınav ücreti
  Select Top 1  
      @BorclandirmaUcreti = isnull(ucret.[ESinavUcreti],0)
    , @ReelBorclandirmaUcreti = isnull(ucret.[ReelESinavUcreti],0)
  From [dbo].[MtskUcretSinav] as ucret,
       [dbo].[GecerlilikTarihi] as tarih
  Where ucret.FirmId = @FirmId
  and   ucret.IsActive = 1
  and   ucret.GecerlilikTarihiId = dbo.fnc_getGecerlilikTarihiId(@FirmId, 21103, getdate())
  
  -- Reel ücret varsa onu uygulasın
  if (@ReelBorclandirmaUcreti > 0)
      Set @BorclandirmaUcreti = @ReelBorclandirmaUcreti

  Insert into [dbo].[OnmOdemePlani]
           ([OdmemePlaniGUID]
           ,[FirmId]
           ,[IsActive]
           ,[DonemTipiId]
           ,[TalepId]
           ,[TalepTipiId]
           ,[UcretTipiId]
           ,[CariId]
           ,[TaksitTipiId]
           ,[TaksitNo]
           ,[VadeTarihi]
           ,[TaksitTutari]
           ,[OdemeTipiId]
           ,[IsPaid]
           ,[TahsilTarihi]
           ,[YedekTaksitTutari]
           ,[BelgeDekontId]
           ,[PatchBelgeDekontId]
           ,[BelgeStokBId]
           ,[SourceTypeId]
           ,[SourceId]
           ,[VeriKaynakId])
  Select 
            NEWID()
           ,@FirmId
           ,1 --IsActive
           ,@BugunDonemTipiId -- DonemTipiId
           ,takip.TalepId
           ,talep.TalepTipiId -- TalepTipiId
           ,@UcretTipiId
           ,talep.AdayId -- CariId
           ,3 -- TaksitTipiId : 3 = Tek Ödeme
           ,takip.eSinavNo -- TaksitNo -- Gireceği sınav no

           ,(case
               when @settingsSonSinavTarihiniKullan = 1 and takip.eSinavBasariTarihi is not null then takip.eSinavBasariTarihi
               when @settingsPlanTarihiniKullan = 1 and takip.eSinavPlanTarihi is not null then takip.eSinavPlanTarihi
               when @settingsSonSinavTarihiniKullan = 0 and -- hiçbiri seçilmemişse
                    @settingsPlanTarihiniKullan = 0 and takip.eSinavPlanTarihi is not null then takip.eSinavPlanTarihi
               else GETDATE() end ) -- VadeTarihi

           ,@BorclandirmaUcreti -- TaksitTutari
           ,2    -- OdemeTipiId   Nakit
           ,0    -- IsPaid
           ,null -- TahsilTarihi
           ,null -- YedekTaksitTutari
           ,null -- BelgeDekontId
           ,null -- PatchBelgeDekontId
           ,null -- BelgeStokBId
           ,2101 -- SourceTypeId -- Mtsk Modülü - Otomatik, kullanıcı onaylı
           ,null -- SourceId
           ,null -- VeriKaynakId
  From dbo.MtskAdayTakip as takip
       left outer join dbo.MtskAdayTalep as talep on ( takip.TalepId = talep.Id )
	   left outer join dbo.OnmOdemePlani as odeme on ( odeme.FirmId = @FirmId
	      and odeme.TalepId = takip.TalepId
		  and odeme.TaksitNo = takip.eSinavNo
          and odeme.UcretTipiId = @UcretTipiId
	   )
  Where talep.FirmId = @FirmId 
  and   takip.FirmId = @FirmId
  and   talep.Id = @TalepId
  and   takip.TalepId = @TalepId
  and ( takip.eSinavDurumTipiId >= 2 or takip.eSinavDurumTipiId <= 5 )
  and   isnull(takip.eSinavUcretTipiId,0) <> 2 -- kendisi yatıracaksa yapmasın
  and   odeme.Id is null

  --- Eğer biz yatıracağı işaretli değilse
  Update dbo.MtskAdayTakip Set
    eSinavUcretTipiId = 1
  From dbo.MtskAdayTakip as takip
  Where takip.FirmId = @FirmId
  and   takip.TalepId = @TalepId
  and   isnull(takip.eSinavUcretTipiId,0) = 0

END -- procedure

/*CreateProcedureEnd*/

