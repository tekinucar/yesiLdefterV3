/*CreateFunction*/

ALTER FUNCTION [dbo].[fnc_getSertifikaKayitTipi]( @talepId int)  
RETURNS smallint
AS   
BEGIN 
  declare @response smallint

  --[Lkp].[MtskAdayTalepKayitTipi]
  -- 0,  ''
  -- 1,  'Ön kayıt'
  -- 2,  'Kayıt aşamasında'
  -- 3,  'Kesin kayıt'

  declare @yKayitTipiId smallInt = 0
  declare @yMebbisKurumOnayi bit = null
  declare @yMebbisDurumTipiId smallInt = 0
  declare @yBelgelerGeldi bit = null

  Select 
       @yKayitTipiId = isnull(ins.KayitTipiId,0)
      ,@yMebbisKurumOnayi = isnull(ins.MebbisKurumOnayi,0)
      ,@yMebbisDurumTipiId = isnull(ins.MebbisDurumTipiId,0)
      ,@yBelgelerGeldi = isnull(ins.BelgelerGeldi,0)
  From MtskAdayTalep as ins
  Where ins.Id = @talepId
      
  if (@yMebbisDurumTipiId = 0) 
      set @yKayitTipiId = 2 -- 'Kayıt aşamasında'

  -- Belgeler geldiyse ön kayıttan > kayıt aşamasına geç
  if (@yKayitTipiId = 1 and @yBelgelerGeldi = 1) 
      set @yKayitTipiId = 2  -- 'Kayıt aşamasında'

  if (@yMebbisDurumTipiId = 1) or
     (@yMebbisDurumTipiId = 2) or
     (@yMebbisDurumTipiId = 7) or
     (@yMebbisDurumTipiId = 8) or
     (@yMebbisDurumTipiId = 9) or
     (@yMebbisDurumTipiId = 12) or
     (@yMebbisDurumTipiId = 13) or 
     (@yMebbisDurumTipiId = 22) set @yKayitTipiId = 3 -- 'Kesin kayıt'

  set @response = @yKayitTipiId

  RETURN @response;
END; -- function

/*CreateFunctionEnd*/