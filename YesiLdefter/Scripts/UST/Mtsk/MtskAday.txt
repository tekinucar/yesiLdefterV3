/*CreateTable*/

begin transaction

 create table MtskAday
 (
   Id                    Int IDENTITY(1,1) not null, /* Id = AdayId */
   AdayGUID              uniqueidentifier  null,
   FirmId                Int       not null,
   IsActive              Bit       not null, 
   IlkKayitTarihi        Date          null, 

   -- 20
   TcNo                  Varchar(11)   null, 
   KimlikSeriNo          Varchar(10)   null, 
   TamAdiSoyadi          nVarchar(100) null, 
   Adi                   nVarchar(50)  null,
   Soyadi                nVarchar(50)  null,
   DogumTarihi           Date          null,
   BabaAdi               nVarchar(50)  null,
   AnneAdi               nVarchar(50)  null,
   CinsiyetTipiId        SmallInt      null,
   CepTelefonu           Varchar(15)   null,
   CepTelefonu2          Varchar(15)   null,
   Eposta                Varchar(98)   null, 
   -- 40
   MesajTipiId             SmallInt       null,
   SMSGonder               Bit            null,
   EpostaGonder            Bit            null,
   WhatsAppGonder          Bit            null,
   -- 50
   KullaniciUyarilari    nVarchar(200)  null,

   -- 90
   BiyometrikResim         VarBinary(max) null,
   BiyometrikResimSmall    VarBinary(max) null,
      
   constraint		pk_MtskAday primary key (Id)
 )
  
 grant select, insert, update, delete on MtskAday to public

  create index X_MtskAday01 on MtskAday (TcNo)
  create index X_MtskAday02 on MtskAday (TamAdiSoyadi)

commit transaction

/*CreateTableEnd*/

/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_MtskAday] on [dbo].[MtskAday]
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE adayCursor cursor for select Id from Inserted
    --DECLARE @curId bigint
    declare @adayId bigint

    OPEN adayCursor

    FETCH NEXT FROM adayCursor INTO @adayId --@curId

    declare @yAdayId int = 0
    declare @eAdayId int = 0
    declare @yFirmId int = 0
    declare @eIsActive bit = null
    declare @yIsActive bit = null

    declare @yTcNo varchar(11) = null
    declare @yTamAdi varchar(100) = null
    declare @eTamAdi varchar(100) = null
    declare @newTamAdi varchar(100) = null
    declare @yAdi varchar(50) = null
    declare @ySoyadi varchar(50) = null

	-- Veri Transferi başladımı
    --Select @DbUpdatesIsActive = u.IsActive
    --from [dbo].[DbUpdates] as u
    --Where u.MsDbUpdateId = -1
    --and   u.UpdateTypeId = 13
    --and   u.DBaseNoTypeId = 6

    WHILE @@FETCH_STATUS = 0
    BEGIN
        set @newTamAdi = ''

        Select 
            @eAdayId = isnull(dlt.AdayId,0)
           ,@eIsActive = isnull(dlt.IsActive,0)
           ,@eTamAdi = isnull(dlt.TamAdiSoyadi,'')

           ,@eSMSGonder = isnull(dlt.SMSGonder,0)
           ,@eEpostaGonder = isnull(dlt.EpostaGonder,0)
           ,@eWhatsAppGonder = isnull(dlt.WhatsAppGonder,0)

        From deleted dlt
        Where dlt.Id = @TalepId
			   
        Select 
            @yFirmId = ins.FirmId
           ,@yIsActive = isnull(ins.IsActive,0)
           ,@yTcNo = isnull(ins.TcNo,'')
           ,@yTamAdi = isnull(ins.TamAdiSoyadi, '')
           ,@yAdi = isnull(ins.Adi,'')
           ,@ySoyadi = isnull(ins.Soyadi,'')
           ,@ySMSGonder = isnull(ins.SMSGonder,0)
           ,@yEpostaGonder = isnull(ins.EpostaGonder,0)
           ,@yWhatsAppGonder = isnull(ins.WhatsAppGonder,0)

        From inserted ins
        Where ins.Id = @TalepId
     	   	
        -- TamAdiSoyadi var ise Adi ve Soyadi tespit ediliyor 
        if ((@yTamAdi <> '') and
            (@yAdi = '') and
            (@ySoyadi = ''))
        begin
            declare @i1 int = 0
            declare @i2 int = 0

            set @i1 = CHARINDEX(' ', @yTamAdi, 0)
            set @i2 = CHARINDEX(' ', @yTamAdi, @i1+1)

            if (@i2 > 0) set @i1 = @i2

            set @yAdi = SUBSTRING(@yTamAdi, 0, @i1)
            set @ySoyadi = SUBSTRING(@yTamAdi, @i1+1, 100)
            set @eTamAdi = ''

            Update MtskAday set 
             Adi = RTRIM(LTRIM(@yAdi))
            ,Soyadi = RTRIM(LTRIM(@ySoyadi))
            Where Id = @TalepId
        end
		
    	set @newTamAdi = @yAdi + ' ' +  @ySoyadi

        if ((@newTamAdi <> @eTamAdi) or 
            (@eTamAdi = '') or
            (@yTamAdi = '') or
            (@eAdayId <> @yAdayId) 
            )  
    	begin
    	    update MtskAday set 
              AdayId = @yAdayId 
            , IsActive = @yIsActive 
            , TamAdiSoyadi = RTRIM(LTRIM(@newTamAdi))

            where Id = @AdayId 
    	end

        -- MtskAdayBelgeler tablosunu işaretle
        Update MtskAdayBelgeler set
           BiyometrikTarandi = x.Sonuc 
        From MtskAdayBelgeler a, 
        (
            Select isnull(count(Id),0) as Sonuc
            From MtskAday
            Where BiyometrikResim is not null
            and Id = @AdayId
        ) as x
        Where a.FirmId = @yFirmId
        and a.AdayId = @yAdayId

        Update MtskAday set
           BiyometrikGeldi = x.Sonuc 
        From MtskAday a, 
        (
            Select isnull(count(Id),0) as Sonuc
            From MtskAday
            Where BiyometrikResim is not null
            and Id = @TalepId
        ) as x
        Where a.Id = @AdayId
		and   isnull(a.BiyometrikGeldi,0) = 0

        --  @eEpostaGonder <> @yEpostaGonder
        --  @eWhatsAppGonder <> @yWhatsAppGonder

      FETCH NEXT FROM talepCursor INTO @TalepId
    END -- While

	-- Veri transferi yapılmıyorsa 
	--if (@DbUpdatesIsActive = 0)
	--begin
       -- MtskDonemKontrolu
       --EXECUTE [dbo].[prc_MtskDonemKontrolu] @yFirmId 
       --EXECUTE [dbo].[prc_MtskAdayTakip] @yFirmId
    --end

    CLOSE adayCursor
    DEALLOCATE adayCursor   

END -- create trigger


/*CreateTriggerEnd*/



