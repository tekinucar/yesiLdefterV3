/*CreateTable*/

begin transaction

 create table MtskAdayOgrenim
 (
   Id                    Int IDENTITY(1,1) not null, 
   AdayId                Int       not null, /* default 0 */
   FirmId                Int       not null,
   IsActive              Bit       not null, /* default : 1 = active, 0 = not active */  
   TcNo                  Varchar(11)   null,
   DonemTipiId           Int           null,

   OgrenimBelgesiniVerenKurum  nVarchar(200)  null,
   OgrenimBelgesiTipiId        SmallInt       null,
   OgrenimBelgesiTarihi        Date           null,
   OgrenimBelgesiSayisi        nVarchar(20)   null,
   OgrenimBelgesiResim         VarBinary(max) null,
   OgrenimBelgesiResimSmall    VarBinary(max) null,

   constraint		pk_MtskAdayOgrenim primary key (Id)
 )
  
 grant select, insert, update, delete on MtskAdayOgrenim to public

  create index X_MtskAdayOgrenim01 on MtskAdayOgrenim (AdayId)
  create index X_MtskAdayOgrenim02 on MtskAdayOgrenim (TcNo)
  create index X_MtskAdayOgrenim03 on MtskAdayOgrenim (DonemTipiId)

commit transaction

/*CreateTableEnd*/

/*CreateTrigger*/

CREATE TRIGGER dbo.trg_MtskAdayOgrenim on dbo.MtskAdayOgrenim
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE myCursor cursor for select Id from Inserted
    DECLARE @curId bigint

    Declare @AdayId int = 0
    Declare @FirmId int = 0

    OPEN myCursor

    FETCH NEXT FROM myCursor INTO @curId

    WHILE @@FETCH_STATUS = 0
    BEGIN

        select 
           @AdayId = ins.AdayId
          ,@FirmId = ins.FirmId
		from inserted ins
    	where ins.Id = @curId

		-- MtskAdayBelgeler tablosunu işaretle
		Update MtskAdayBelgeler set
        OgrenimTarandi = x.Sonuc
        From MtskAdayBelgeler a, 
        (
            Select count(Id) as Sonuc
            From MtskAdayOgrenim
            Where 0 = 0
            and OgrenimBelgesiResim is not null
            and AdayId = @AdayId
            and FirmId = @FirmId
        ) as x
        Where a.AdayId = @AdayId
        and   a.FirmId = @FirmId

      FETCH NEXT FROM myCursor INTO @curId
    END -- While

    CLOSE myCursor
    DEALLOCATE myCursor   

END -- create trigger

/*CreateTriggerEnd*/

ALTER TABLE dbo.MtskAdayOgrenim ENABLE TRIGGER trg_MtskAdayOgrenim


/*CreateLkpTable*/

begin transaction

-- ------------------------------------------------------- 
-- OgrenimBelgesiTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'MtskAdayOgrenimOgrenimBelgesiTipi')
drop table [Lkp].[MtskAdayOgrenimOgrenimBelgesiTipi]

create table [Lkp].[MtskAdayOgrenimOgrenimBelgesiTipi]
(
   Id               Int Unique Not    null,
   OgrenimBelgesiTipi  nVarchar(60)   null

   constraint  pk_MtskAdayOgrenimOgrenimBelgesiTipi primary key (Id)
)

Delete from [Lkp].[MtskAdayOgrenimOgrenimBelgesiTipi]
INSERT INTO [Lkp].[MtskAdayOgrenimOgrenimBelgesiTipi] (Id, OgrenimBelgesiTipi)
 VALUES 
  ( -1, N''),
  (  0, N'Tanımsız'),
  (  1, N'II. Kademe Okur Yazarlık Belgesi'),
  (  2, N'İlkokul Diploma'),
  (  3, N'İlköğretim Diploma'),
  (  4, N'İlköğretim Tasdikname'),
  (  5, N'Açık İlköğretim Öğrenci Belgesi'),
  (  6, N'Ortaokul Diploma'),
  (  7, N'Ortaokul Tasdikname'),
  (  8, N'Lise Diploma'),
  (  9, N'Lise Tasdikname'),
  ( 10, N'Lise Öğrenci Belgesi'),
  ( 11, N'Üniversite Öğrenci Belgesi'),
  ( 12, N'Üniversite Diploma'),
  ( 13, N'Üniversite Geçici Mezuniyet Belgesi'),
  ( 14, N'Denklik/Öğrenim Belgesinin Noter Tasdikli Türkçe Tercümesi')

commit transaction

/*CreateLkpTableEnd*/