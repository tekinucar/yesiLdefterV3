/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskUygulamaDersPlaniElemanaOzel] (
   @DersDonemTipiId int
  ,@EgitimAraciId varchar(30)
  ,@PersonelId varchar(30)
  ,@AdayId Int 
  ,@ElemanGrubu varchar(30))  
AS BEGIN

/* 
 declare @DersDonemTipiId Int 
 declare @AdayId Int 
 declare @EgitimAraciId varchar(30)
 declare @PersonelId varchar(30)
 declare @ElemanGrubu varchar(30)
 
 set @DersDonemTipiId = 202202
*/ 
 /*
 if (@DonemTipiId <= 0)
 begin
   if (MONTH(getdate()) < 10)
        set @DonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + '0' + convert(varchar(3), MONTH(getdate())))
   else set @DonemTipiId = convert(int, convert(varchar(5), YEAR(getdate())) + convert(varchar(3), MONTH(getdate())))
 end

 declare @EgitimBaslangicTarihi date
 declare @EgitimBitisTarihi date
  
 set @EgitimBaslangicTarihi = dbo.fnc_MtskDonemDersBasBitTarihiniBul(@DonemTipiId, 0, 1, 1, 0)
 set @EgitimBitisTarihi = dbo.fnc_MtskDonemDersBasBitTarihiniBul(@DonemTipiId, 0, 1, 0, 1)
 
 print @EgitimBaslangicTarihi
 print @EgitimBitisTarihi
 */

 declare @sql nvarchar(max)
 declare @sqlWhere nvarchar(500)
 declare @sqlOrderBy nvarchar(100)

 set @sql = '
 Select [MtskUygulamaliDers].* 
 , [MtskAday].TamAdiSoyadi  as  Lkp_AdayTamAdiSoyadi
 , [MtskAday].TcNo  as  Lkp_AdayTcNo
 , [MtskPersoneli].TamAdiSoyadi as  Lkp_PersonelTamAdiSoyadi
 , [MtskPersoneli].TcVkNo  as  Lkp_PersonelTcNo

 , FNo9.EgitimYeriTipi  as  Lkp_EgitimYeriTipi
 , FNo12.DersSaatiTipi  as  Lkp_DersSaatiTipi
 , FNo14.EgitimTipi  as  Lkp_EgitimTipi

 , FNo5.DonemTipi  as  Lkp_DonemTipi
 , FNo6.GrupTipi   as  Lkp_GrupTipi
 , FNo7.SubeTipi   as  Lkp_SubeTipi

 , FNo9.EgitimYeriTipi + '' : '' + [MtskUygulamaliDers].EgitimAraciId as Lkp_AracVeEgitimYeri
 , FNo5.DonemTipi + '' : '' + FNo6.GrupTipi + '' : '' + FNo7.SubeTipi as Lkp_DonemTipiGrupTipiSubeTipi
 , [MtskEgitimAraci].PlakaNumarasi + '' : '' + [MtskPersoneli].TamAdiSoyadi as Lkp_AracVePersonel
 
 from MtskUygulamaliDers as [MtskUygulamaliDers]
   left outer join MtskAday [MtskAday] on ( [MtskUygulamaliDers].AdayId = [MtskAday].Id  ) 
   left outer join MtskPersoneli [MtskPersoneli] on ( [MtskUygulamaliDers].PersonelId = [MtskPersoneli].TcNoCalismaIzniNo  ) 
   left outer join MtskEgitimAraci [MtskEgitimAraci] on ( [MtskUygulamaliDers].EgitimAraciId = [MtskEgitimAraci].PlakaNumarasi ) 
 
   left outer join Lkp.MtskUygulamaliDersEgitimYeriTipi as FNo9 on ( MtskUygulamaliDers.EgitimYeriTipiId = FNo9.Id ) 
   left outer join Lkp.MtskUygulamaliDersDersSaatiTipi as FNo12 on ( MtskUygulamaliDers.DersSaatiTipiId = FNo12.Id ) 
   left outer join Lkp.MtskUygulamaliDersEgitimTipi as FNo14 on ( MtskUygulamaliDers.EgitimTipiId = FNo14.Id ) 

   left outer join Lkp.MtskDonemTipi as FNo5 on ( MtskUygulamaliDers.DonemTipiId = FNo5.Id ) 
   left outer join Lkp.MtskGrupTipi  as FNo6 on ( MtskUygulamaliDers.GrupTipiId = FNo6.Id ) 
   left outer join Lkp.MtskSubeTipi  as FNo7 on ( MtskUygulamaliDers.SubeTipiId = FNo7.Id ) 

 Where 0 = 0
 '
 set @sqlOrderBy = ' Order by DersTarihi, DersSaatiTipiId '
 
 set @sqlWhere = ' and [MtskUygulamaliDers].DersDonemTipiId = ' + Convert(varchar(20), @DersDonemTipiId) 

 --set @EgitimAraciId = ''--'0149207'
 --set @PersonelId = ''--'205013645624899268'
 --set @AdayId = 1454
 
 --set @ElemanGrubu = 'Eğitim Aracı'
 --set @ElemanGrubu = 'Usta Eğitici'
 --set @ElemanGrubu = 'Aday'
 
 if ((@AdayId > 0) and (@ElemanGrubu = 'Aday'))
   set @sqlWhere = @sqlWhere +
   '  and [MtskUygulamaliDers].AdayId = ' + Convert(varchar(30), @AdayId)

 if (@ElemanGrubu = 'Eğitim Aracı')
   set @sqlWhere = @sqlWhere +
   '  and [MtskUygulamaliDers].EgitimYeriTipiId = 2 ' + 
   '  and [MtskUygulamaliDers].EgitimAraciId = ''' + @EgitimAraciId + ''''

 if (@ElemanGrubu = 'Simülatör')
   set @sqlWhere = @sqlWhere +
   '  and [MtskUygulamaliDers].EgitimYeriTipiId = 3 ' + 
   '  and [MtskUygulamaliDers].EgitimAraciId = ''' + @EgitimAraciId + ''''


 if ((@PersonelId <> '') and (@ElemanGrubu = 'Usta Eğitici')) 
   set @sqlWhere = @sqlWhere +
   '  and [MtskUygulamaliDers].PersonelId = ''' + @PersonelId + ''''

 set @sql = @sql + @sqlWhere + @sqlOrderBy

 --print @sql
 EXEC sp_executesql @sql
  
END -- procedure
  

/*CreateProcedureEnd*/
