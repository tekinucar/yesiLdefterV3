
/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayBorclandirUygulamaSinaviTekTalep] (@FirmId int, @TalepId int, @UcretTipiId Int)
AS BEGIN  

  --declare @FirmId Int  = 11
  --declare @UcretTipiId Int  = 21112  --- u-sınav 
  --declare @UcretTipiId Int  = 21113  --- başarasız ücreti
  --declare @UcretTipiId Int  = 21114  --- u-sınav + başarasız ücreti

  declare @settings1SinavIcinBorclandirma bit = 0
  set @settings1SinavIcinBorclandirma = dbo.fnc_getSettingsBool(@FirmId, 2010, 116)
  if (@settings1SinavIcinBorclandirma = 1)
  begin
      declare @girecegiSinavNo int = 0
      Select @girecegiSinavNo = isnull(uSinavNo,0)
      From dbo.MtskAdayTakip as takip
      Where takip.FirmId = @FirmId
      and   takip.TalepId = @TalepId

     -- Birinci sınava giriyorsa atama yapma 
     if (@girecegiSinavNo <= 1) return;
  end

  declare @settingsPlanTarihiniKullan bit = 0
  declare @settingsSonSinavTarihiniKullan bit = 0

  set @settingsPlanTarihiniKullan = dbo.fnc_getSettingsBool(@FirmId, 2010, 114);
  set @settingsSonSinavTarihiniKullan = dbo.fnc_getSettingsBool(@FirmId, 2010, 115);

  declare @BugunDonemTipiId int = 0
  declare @UygSinavUcreti numeric(22,5)
  declare @Id int = dbo.fnc_getGecerlilikTarihiId(@FirmId, 21104, getdate())

  set @BugunDonemTipiId = dbo.fnc_getDonemTipiId('BUGUN',null);

  -- Uygulama sınav ücreti
  Select Top 1  @UygSinavUcreti = ucret.[UygulamaSinavUcreti]
  From [dbo].[MtskUcretSinav] as ucret,
       [dbo].[GecerlilikTarihi] as tarih
  Where ucret.FirmId = @FirmId
  and   ucret.IsActive = 1
  and   ucret.GecerlilikTarihiId = dbo.fnc_getGecerlilikTarihiId(@FirmId, 21103, getdate())
  
  Insert into [dbo].[OnmOdemePlani]
           ([OdmemePlaniGUID]
           ,[FirmId]
           ,[IsActive]
           ,[DonemTipiId]
           ,[TalepId]
           ,[TalepTipiId]
           ,[UcretTipiId]
           ,[CariId]
           ,[TaksitTipiId]
           ,[TaksitNo]
           ,[VadeTarihi]
           ,[TaksitTutari]
           ,[OdemeTipiId]
           ,[IsPaid]
           ,[TahsilTarihi]
           ,[YedekTaksitTutari]
           ,[BelgeDekontId]
           ,[PatchBelgeDekontId]
           ,[BelgeStokBId]
           ,[SourceTypeId]
           ,[SourceId]
           ,[VeriKaynakId])
           
  Select 
            NEWID()
           ,@FirmId
           ,1 --IsActive
           ,@BugunDonemTipiId -- DonemTipiId
           ,takip.TalepId
           ,talep.TalepTipiId -- TalepTipiId
           ,@UcretTipiId
           ,talep.AdayId -- CariId
           ,3 -- TaksitTipiId : 3 = Tek Ödeme
           ,takip.uSinavNo -- TaksitNo
           
           ,(case
               when @settingsSonSinavTarihiniKullan = 1 and takip.uSinavBasariTarihi is not null then takip.uSinavBasariTarihi
               when @settingsPlanTarihiniKullan = 1 and takip.uSinavPlanTarihi is not null then takip.uSinavPlanTarihi
               when @settingsSonSinavTarihiniKullan = 0 and -- hiçbiri seçilmemişse
                    @settingsPlanTarihiniKullan = 0 and takip.uSinavPlanTarihi is not null then takip.uSinavPlanTarihi
               else GETDATE() end ) -- VadeTarihi
               
           ,(case  
               -- sadece uyg sınav ücreti
               when @UcretTipiId = 21112 then @UygSinavUcreti 
               -- başarısız aday Ücreti
               when @UcretTipiId = 21113 and isnull(uygUcreti.BirSaatBasarisizDersUcretiReel,0) > 0 then (isnull(uygUcreti.BirSaatBasarisizDersUcretiReel,0) * 2)  -- reel ücret x 2 saat
               when @UcretTipiId = 21113 and isnull(uygUcreti.BirSaatBasarisizDersUcretiReel,0) = 0 then (isnull(uygUcreti.BirSaatBasarisizDersUcreti,0) * 2) -- Mebbis ücreti x 2 saat
               -- başarısız aday + sinavÜcreti
               when @UcretTipiId = 21114 and isnull(uygUcreti.BirSaatBasarisizDersUcretiReel,0) > 0 then (isnull(uygUcreti.BirSaatBasarisizDersUcretiReel,0) * 2) + @UygSinavUcreti  -- reel ücret x 2 saat
               when @UcretTipiId = 21114 and isnull(uygUcreti.BirSaatBasarisizDersUcretiReel,0) = 0 then (isnull(uygUcreti.BirSaatBasarisizDersUcreti,0) * 2) + @UygSinavUcreti  -- Mebbis ücreti x 2 saat
               end )

           ,2    -- OdemeTipiId   Nakit
           ,0    -- IsPaid
           ,null -- TahsilTarihi
           ,null -- YedekTaksitTutari
           ,null -- BelgeDekontId
           ,null -- PatchBelgeDekontId
           ,null -- BelgeStokBId
           ,2101 -- SourceTypeId -- Mtsk Modülü - Otomatik, kullanıcı onaylı
           ,null -- SourceId
           ,null -- VeriKaynakId
  From dbo.MtskAdayTakip as takip
       left outer join dbo.MtskAdayTalep as talep on ( takip.TalepId = talep.Id )
	   left outer join dbo.OnmOdemePlani as odeme on ( odeme.FirmId = @FirmId
	      and odeme.TalepId = takip.TalepId
		  and odeme.TaksitNo = takip.uSinavNo
          --and odeme.UcretTipiId = @UcretTipiId
          and ( odeme.UcretTipiId = 21112 or odeme.UcretTipiId = 21113 or odeme.UcretTipiId = 21114 )
	   )
       left outer join dbo.MtskUcretUygulama as uygUcreti on ( 
              talep.MevcutSertifikaTipiId = uygUcreti.MevcutSertifikaTipiId
          and talep.IstenenSertifikaTipiId = uygUcreti.IstenenSertifikaTipiId 
       )
  Where talep.FirmId = @FirmId 
  and   takip.FirmId = @FirmId
  and   talep.Id = @TalepId
  and   takip.TalepId = @TalepId
  and ( takip.uSinavDurumTipiId = 5 or takip.uSinavDurumTipiId = 6 or takip.uSinavDurumTipiId = 8)
  and   isnull(takip.uSinavUcretTipiId,0) <> 2 --  aday kendisi yatıracaksa yapmasın
  and   uygUcreti.GecerlilikTarihiId = dbo.fnc_getGecerlilikTarihiId(@FirmId, 21104, getdate())
  and   odeme.Id is null

  --- Eğer biz yatıracağı işaretli değilse
  Update dbo.MtskAdayTakip Set
    uSinavUcretTipiId = 1
  From dbo.MtskAdayTakip as takip
  Where takip.FirmId = @FirmId
  and   takip.TalepId = @TalepId
  and   isnull(takip.uSinavUcretTipiId,0) = 0

END -- procedure

/*CreateProcedureEnd*/

