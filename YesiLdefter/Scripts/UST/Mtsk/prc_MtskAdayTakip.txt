USE [Mtsk00000011]
GO
/****** Object:  StoredProcedure [dbo].[prc_MtskAdayTakip]    Script Date: 26.11.2024 19:46:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*CreateProcedure*/

ALTER PROCEDURE [dbo].[prc_MtskAdayTakip] (@FirmId int)  
AS BEGIN
   
   declare @bugun smalldatetime = getdate() 

   -- -------------------------------------------------------------------
   -- BelgelerGeldi, BelgelerTarandi, BelgelerYuklendi
   -- -------------------------------------------------------------------

   update MtskAdayTakip set
      BelgelerGeldi = x.BelgelerGeldi
   from MtskAdayTakip a, 
   (
       Select FirmId, Id as TalepId
	   , case 
	     when ( KimlikGeldi = 1 
            and BiyometrikGeldi = 1
            and BasvuruFotoCekildi = 1
            and OgrenimGeldi = 1
            and SaglikGeldi = 1
            and AdliSicilGeldi = 1
            and ImzaAlindi = 1
            and SozlesmeYapildi = 1 
            and AdresAlindi = 1) then 1 else 0 end as BelgelerGeldi
	   From MtskAdayTalep	   
	   Where FirmId = @FirmId
   ) as x
   Where a.FirmId = x.FirmId
   and   a.TalepId = x.TalepId 

   update MtskAdayTakip set
      BelgelerTarandi = x.BelgelerTarandi
   from MtskAdayTakip a, 
   (
       Select FirmId, TalepId
	   , case 
	     when ( BiyometrikTarandi = 1
            and BasvuruFotoTarandi = 1 
            and OgrenimTarandi = 1
            and SaglikTarandi = 1 
            and AdliSicilTarandi = 1
            and ImzaTarandi = 1 
            and Sozlesme1Tarandi = 1
            and Sozlesme2Tarandi = 1 
            and AdresKodlandi = 1) then 1 else 0 end as BelgelerTarandi
	   From MtskAdayBelgeler	   
	   Where FirmId = @FirmId
   ) as x
   Where a.FirmId = x.FirmId
   and   a.TalepId = x.TalepId 

   update MtskAdayTakip set
      BelgelerYuklendi = x.BelgelerYuklendi
   from MtskAdayTakip a, 
   (
       Select FirmId, TalepId
	   , case 
	     when ( AdayKaydiYapildi = 1
            and BiyometrikYuklendi = 1
            and BasvuruFotoYuklendi = 1
            and OgrenimYuklendi = 1
            and SaglikYuklendi = 1
            and AdliSicilYuklendi = 1
            and ImzaYuklendi = 1
            and Sozlesme1Yuklendi = 1
            and Sozlesme2Yuklendi = 1 
            and AdresYuklendi = 1 ) then 1 else 0 end as BelgelerYuklendi
	   From MtskAdayBelgeler	   
	   Where FirmId = @FirmId
   ) as x
   Where a.FirmId = x.FirmId
   and   a.TalepId = x.TalepId 

   -- -------------------------------------------------------------------
   -- TeorikDersTipiId
   -- -------------------------------------------------------------------

   Update dbo.MtskAdayTakip set
       TeorikBaslamaTarihi = x.GrupBaslamaTarihi 
      ,TeorikBitisTarihi   = x.GrupBitisTarihi
      ,TeorikDersTipiId    = x.TeorikDersTipiId 
   From dbo.MtskAdayTakip a, 
   (
      Select 
          takip.Id as TakipId
        , gs.GrupBaslamaTarihi
        , gs.GrupBitisTarihi
        , (case  -- Sertifika talebi ve mevcut ehliyeti yok ise / değilse Muaf
           when (talep.TalepTipiId = 1 and isnull(talep.MevcutSertifikaTipiId,0) = 0) then gs.TakipTipiId
           else 6 end ) as TeorikDersTipiId      
      From MtskAdayTakip as takip
         , MtskAdayTalep as talep
         , MtskGrupSubesi as gs
      Where takip.TalepId     = talep.Id
      and   takip.FirmId      = gs.FirmId
      and   takip.DonemTipiId = gs.DonemTipiId
      and   takip.GrupTipiId  = gs.GrupTipiId
      and   takip.SubeTipiId  = gs.SubeTipiId
   ) as x
   Where a.Id = x.TakipId

   -- eSinavDurumTipiId = 
   -- e-Sınav için hazır değil 
   -- e-Sınav başvurusu yapılacak
   -- Muaf işareti
   --
   Update dbo.MtskAdayTakip set
       eSinavDurumTipiId = x.eSinavDurumTipiId
   From dbo.MtskAdayTakip a, 
   (
      Select 
          takip.Id as TakipId
        ,(case  
          when takip.TeorikDersTipiId = 6  then 6 -- Muaf
          when takip.TeorikDersTipiId = 17 then 2 -- e-Sınav başvurusu yapılacak
          else 1 end ) as eSinavDurumTipiId       -- e-Sınav için hazır değil
      From MtskAdayTakip as takip
      Where takip.eSinavDurumTipiId = 0 -- Tanımsız ise
   ) as x
   Where a.Id = x.TakipId


    -- eSinavDurumTipiId
    --   0 : ''
    --   1 : e-Sınav için hazır değil
    --   2 : e-Sınav başvurusu yapılacak
    --   3 : e-Sınav başvurusu yapıldı
    --   4 : e-Sınav sonucu okunacak
    --   5 : e-Sınav sonucu okundu
	--   6 : Muaf
    -- eSinavSonrasiTipiId
    --   1, Tekrar sınava girecek
    --   2, Uygulama aşamasına geçti
    --   3, Tüm e-Sınav hakkı bitti
    --
	-- eSinavMuracatTarihi 
    --
	-- UygulamaliDersTipiId
    --   1, Uygulamalı dersler planlanacak
	--   2, Uygulamalı dersler planlandı
    --   3, Uygulamalı ders alıyor
    --   4, Uygulamalı dersleri tamamladı


    -- -----------------------------------------------------------------------
    -- DİKKAT : Aynı kod prc_MtskAdayTakipTalepKaydiSingleSet içinde var	
    -- -----------------------------------------------------------------------

    update MtskAdayTakip set
      eSinavNo = x.SinavNo
    , eSinavDurumTipiId = x.eSinavDurumTipiId
    , eSinavSonucTipiId = x.DurumuTipiId
    , eSinavSonrasiTipiId = x.eSinavSonrasiTipiId
    , eSinavMuracatTarihi = x.eSinavMuracatTarihi
	, eSinavDetayId = x.sinavId
	, eSinavBasariTarihi = x.SinavTarihi
	, UygulamaliDersTipiId = x.UygulamaliDersTipiId
    from MtskAdayTakip a, 
    (
	Select 
	       eSinav.Id as sinavId
	     , eSinav.FirmId
         , eSinav.TalepId
	     , eSinav.AdayId 
	     , eSinav.SinavNo
         , eSinav.DurumuTipiId
		 , convert(date, eSinav.SinavTarihi, 103) as SinavTarihi
	     , case
             when (eSinav.DurumuTipiId = 0 and convert(date, @bugun,103) <  convert(date, eSinav.SinavTarihi, 103)) then 3 -- e-Sınav başvurusu yapıldı
             when (eSinav.DurumuTipiId = 0 and convert(date, @bugun,103) >= convert(date, eSinav.SinavTarihi, 103)) then 4 -- e-Sınav sonucu okunacak
	         when (eSinav.DurumuTipiId > 0) then 5 -- e-Sınav sonucu okundu
           end as eSinavDurumTipiId
         , case
	         when (eSinav.DurumuTipiId = 1) then 2 -- Uygulama aşamasına geçti
             when (eSinav.DurumuTipiId > 1) and (eSinav.SinavNo < 4 ) then 1  -- Tekrar sınava girecek
             when (eSinav.DurumuTipiId > 1) and (eSinav.SinavNo >= 4 ) then 3 -- Tüm e-Sınav hakkı bitti
           end as eSinavSonrasiTipiId
         , case 
	         when (eSinav.DurumuTipiId > 1) and (eSinav.SinavNo < 4 ) then (
                  case when DAY(eSinav.SinavTarihi) >= 1 and DAY(eSinav.SinavTarihi) <= 15 then DATEADD(DAY, 16 - DAY(eSinav.SinavTarihi), eSinav.SinavTarihi)
                  else DATEADD(DAY, 1, EOMONTH(eSinav.SinavTarihi)) end
			 )
             else null
	       end as eSinavMuracatTarihi
         , case
	         when (eSinav.DurumuTipiId = 1 ) then 1   -- eSinav.Başarılı ise Uygulamalı dersler planlanacak
             when (eSinav.DurumuTipiId <> 1) then 0   -- boşluk
           end as UygulamaliDersTipiId

         from MtskSinavETeorik as eSinav,
	     (     -- Adayların son sınavlarını buluyor
	           Select TalepId, AdayId
			   , max(convert(smallDatetime,SinavTarihi,103)) as SinavTarihi
               from MtskSinavETeorik
		       Where FirmId = @FirmId
			   and IsActive = 1
               group by TalepId, AdayId
         ) as aday
	     Where eSinav.TalepId = aday.TalepId
		 and   eSinav.AdayId = aday.AdayId
	     and   convert(smallDatetime,eSinav.SinavTarihi,103) = aday.SinavTarihi
    ) as x
    Where a.FirmId  = x.FirmId
    and   a.TalepId = x.TalepId
	and   a.AdayId  = x.AdayId 
    	   
    -- -----------------------------------------------------------------------
    -- DİKKAT : Aynı kod prc_MtskAdayTakipTalepKaydiSingleSet içinde var	
    -- -----------------------------------------------------------------------

	-- ---------------------------------------------------
    -- eSınavlar tamamen silinmiş olabilir
	-- ---------------------------------------------------
	
	update MtskAdayTakip set
      eSinavNo = 0
    , eSinavDurumTipiId = x.eSinavDurumTipiId
    , eSinavSonucTipiId = 0
    , eSinavSonrasiTipiId = 0
    , eSinavMuracatTarihi = null
	, eSinavDetayId = 0
	, eSinavBasariTarihi = null
	, UygulamaliDersTipiId = 0
    from MtskAdayTakip a, 
    (
		 Select takip.Id as TakipId
        ,(case  
          when takip.TeorikDersTipiId = 17 then 2 -- e-Sınav başvurusu yapılacak
          else 1 end ) as eSinavDurumTipiId       -- e-Sınav için hazır değil
		 from dbo.MtskAdayTakip as takip
		     left outer join dbo.MtskSinavETeorik as sinav on ( 
			          takip.TalepId = sinav.TalepId 
			      and sinav.IsActive = 1 )
         Where takip.FirmId = @FirmId
         and   takip.eSinavDurumTipiId > 0  
         and   takip.eSinavDurumTipiId <> 6 -- Muaf değilse

		 Group by takip.Id
		        , takip.TeorikDersTipiId
		 Having COUNT(sinav.Id) = 0
     ) as x
	 Where a.Id = x.TakipId 



    -- Tekrar sınava girecek için bekleme süresi bitince
    -- eSinavDurumTipiId = e-Sınav başvurusu yapılacak
	-- eSinavSonrasiTipiId = boşluk  
    update MtskAdayTakip set
      eSinavDurumTipiId = 2
	, eSinavSonrasiTipiId = 0
    from MtskAdayTakip
    Where FirmId = @FirmId
	and   eSinavSonrasiTipiId = 1 -- Tekrar sınava girecek
    and   eSinavNo > 0
	and   eSinavMuracatTarihi < @bugun
	

    -- Teorikten Muaf'sa Uygulamalı dersler planlanacak
    update MtskAdayTakip set
       UygulamaliDersTipiId = 1 -- Uygulamalı dersler planlanacak
    from MtskAdayTakip as takip
    Where takip.FirmId = @FirmId
	and   takip.UygulamaliDersTipiId = 0  -- Tanımsız
	and   ( takip.TeorikDersTipiId = 6    -- Muaf
         or takip.eSinavSonucTipiId = 1 ) -- Başarılı


   -- -------------------------------------------------------------------
   -- UygulamaliDersTipiId : Uygulamalı Ders Durumu
   -- -------------------------------------------------------------------

   -- MtskAdayTakip.UygulamaDersTipiId 
   -- 0,    Tanımsız
   -- 1,    Uygulamalı dersler planlanacak
   -- 2,    Uygulamalı dersler planlandı, Mebbise aktarılacak
   -- 3,    Uygulamalı dersler Mebbise aktarıldı
   -- 4,    Uygulamalı dersleri başladı 
   -- 5,    Uygulamalı dersleri tamamladı 
    
   Update dbo.MtskAdayTakip set
       UygulamaliDersTipiId = x.UygulamaliDersTipiId
   From dbo.MtskAdayTakip a, 
   ( 
         Select takip.Id as TakipId
		 , ( case
			 when takip.UygulamaliDersTipiId < 5 and takip.IsUygulamaDersMebbis = 1 and takip.UygulamaBaslamaTarihi <= @bugun and takip.UygulamaBitisTarihi < @bugun then 5 -- Uygulamalı dersleri tamamladı
			 when takip.UygulamaliDersTipiId < 4 and takip.IsUygulamaDersMebbis = 1 and takip.UygulamaBaslamaTarihi <= @bugun and takip.UygulamaBitisTarihi > @bugun then 4 -- Uygulamalı dersleri başladı
			 when takip.UygulamaliDersTipiId < 3 and takip.IsUygulamaDersMebbis = 1 and takip.UygulamaBaslamaTarihi <  @bugun then 3 -- Uygulamalı dersler Mebbise aktarıldı
		     when takip.UygulamaliDersTipiId = 1 and takip.IsUygulamaDersMebbis = 0 and takip.UygulamaBaslamaTarihi <  @bugun then 2 -- Uygulamalı dersler planlandı, Mebbise aktarılacak
             end ) as UygulamaliDersTipiId 
         From MtskAdayTakip as takip
         Where takip.FirmId = @FirmId
		 and   takip.IsUygulamaliDersPlanli = 1 -- Uygulamalı ders planı yapıldıysa
   ) as x
   Where a.Id = x.TakipId		 


   --Arti4DersTipiId
   -- 0,   Tanımsız
   -- 1,   2. +4 hak dersleri planlanacak
   -- 2,   2. +4 hak dersleri planlandı, Mebbise aktarılacak
   -- 3,   2. +4 hak dersleri Mebbise aktarıldı
   -- 4,   2. +4 hak dersleri başladı
   -- 5,   2. +4 hak dersleri tamamlandı

   Update dbo.MtskAdayTakip set
       Arti4DersTipiId = x.Arti4DersTipiId
   From dbo.MtskAdayTakip a, 
   ( 
         Select takip.Id as TakipId
		 , ( case
			 when takip.Arti4DersTipiId < 5 and takip.IsArti4DersMebbis = 1 and takip.Arti4BaslamaTarihi <= @bugun and takip.Arti4BitisTarihi < @bugun then 5 -- 2. +4 hak dersleri tamamlandı
			 when takip.Arti4DersTipiId < 4 and takip.IsArti4DersMebbis = 1 and takip.Arti4BaslamaTarihi <= @bugun and takip.Arti4BitisTarihi > @bugun then 4 -- 2. +4 hak dersleri başladı
			 when takip.Arti4DersTipiId < 3 and takip.IsArti4DersMebbis = 1 and takip.Arti4BaslamaTarihi <  @bugun then 3 -- 2. +4 hak dersleri Mebbise aktarıldı
		     when takip.Arti4DersTipiId = 1 and takip.IsArti4DersMebbis = 0 and takip.Arti4BaslamaTarihi <  @bugun then 2 -- 2. +4 hak dersleri planlandı, Mebbise aktarılacak
             end ) as Arti4DersTipiId 
         From MtskAdayTakip as takip
         Where takip.FirmId = @FirmId
		 and   takip.IsArti4DersPlanli = 1 -- 2. +4 hak derslerin planı yapıldıysa
   ) as x
   Where a.Id = x.TakipId		 

   -- BasarisizDersTipiId
   -- 0,  ''
   -- 1,  2 saat başarısız aday eğitimi planlanacak
   -- 2,  2 saat başarısız aday eğitimi planlandı, Mebbise aktarılacak
   -- 3,  2 saat başarısız aday eğitimi Mebbise aktarıldı
   -- 4,  2 saat başarısız aday eğitimi alıyor
   -- 5,  2 saat başarısız aday eğitimi tamamlandı
   -- 6,  Eğitime gerek yok (Sınava girmedi)

   Update dbo.MtskAdayTakip set
       BasarisizDersTipiId = x.BasarisizDersTipiId
   From dbo.MtskAdayTakip a, 
   ( 
         Select takip.Id as TakipId
		 , ( case
			 when takip.BasarisizDersTipiId < 5 and takip.IsBasarisizDersMebbis = 1 and takip.BasarisizBaslamaTarihi < @bugun then 5 -- 2 saat başarısız aday eğitimi tamamlandı
			 when takip.BasarisizDersTipiId < 4 and takip.IsBasarisizDersMebbis = 1 and takip.BasarisizBaslamaTarihi = @bugun then 4 -- 2 saat başarısız aday eğitimi alıyor
			 when takip.BasarisizDersTipiId < 3 and takip.IsBasarisizDersMebbis = 1 and takip.BasarisizBaslamaTarihi < @bugun then 3 -- 2 saat başarısız aday eğitimi Mebbise aktarıldı
		     when takip.BasarisizDersTipiId = 1 and takip.IsBasarisizDersMebbis = 0 and takip.BasarisizBaslamaTarihi < @bugun then 2 -- 2 saat başarısız aday eğitimi planlandı, Mebbise aktarılacak
             end ) as BasarisizDersTipiId 
         From MtskAdayTakip as takip
         Where takip.FirmId = @FirmId
		 and   takip.IsBasarisizDersPlanli = 1 -- 2 saat başarısız aday eğitimi planı yapıldıysa
   ) as x
   Where a.Id = x.TakipId		 


   -- UygulamaDersTipiId 
   -- 5,    Uygulamalı dersleri tamamladı
   --
   -- Arti4DersTipiId
   -- 4,    İkinci +4 için uygulamalı ders tamamlandı
   --
   -- BasarisizDersTipiId
   -- 5,    2 saat başarısız aday eğitimi tamamlandı
   -- 6,    Eğitime gerek yok (Sınava girmedi)

   update MtskAdayTakip set
       uSinavDurumTipiId = 1 -- Henüz sınav aşamasında değil
   from MtskAdayTakip
   Where FirmId = @FirmId
   and   UygulamaliDersTipiId <> 5 
   and   Arti4DersTipiId <> 4
   and   BasarisizDersTipiId < 5 


   -- 2,  Uygulama sınav için usta öğretici onayı isteniyor
   Update dbo.MtskAdayTakip set
       uSinavDurumTipiId = x.uSinavDurumTipiId
   From dbo.MtskAdayTakip a, 
   ( 
         Select takip.Id as TakipId
		 , ( case
			 when takip.UygulamaliDersTipiId = 5 and takip.UygulamaBitisTarihi    < @bugun then 2  -- Uygulama sınav için usta öğretici onayı isteniyor 
			 when takip.Arti4DersTipiId      = 5 and takip.Arti4BitisTarihi       < @bugun then 2  -- Uygulama sınav için usta öğretici onayı isteniyor
			 when takip.BasarisizDersTipiId  = 5 and takip.BasarisizBaslamaTarihi < @bugun then 2  -- Uygulama sınav için usta öğretici onayı isteniyor
             end ) as uSinavDurumTipiId 
         From MtskAdayTakip as takip
         Where takip.FirmId = @FirmId
		 and   takip.uSinavDurumTipiId = 1 -- Henüz sınav aşamasında değil
   ) as x
   Where a.Id = x.TakipId		 


   -- UstaOgreticiOnayTipiId   /* 1. Onay, 2. Sınav için hazır değil  */
   -- Kullanıcı onaylayınca
   --
   Update dbo.MtskAdayTakip set
       uSinavDurumTipiId = x.uSinavDurumTipiId
   From dbo.MtskAdayTakip a, 
   ( 
         Select takip.Id as TakipId
		 , ( case
			 when takip.uSinavaHazirmiTipiId = 1 then 4  -- Onaylı  ise >  Uygulama sınavı için MEBBİS de onaylanacak
			 when takip.uSinavaHazirmiTipiId = 2 then 3  -- Onaysız ise >  Uygulama sınavı için hazır değil
             end ) as uSinavDurumTipiId 
         From MtskAdayTakip as takip
         Where takip.FirmId = @FirmId
		 and   takip.uSinavDurumTipiId = 2 -- Uygulama sınav için usta öğretici onayı isteniyor
   ) as x
   Where a.Id = x.TakipId		 

   -- Uygulama sınavı için mebbisden onay verildikten sonra
   -- Uygulama sınav randevusu planlanacak  aşamasına geçilecek
   --
   update MtskAdayTakip set
       uSinavDurumTipiId = 5 -- Uygulama sınav randevusu planlanacak
   From MtskAdayTakip as takip
   Where takip.FirmId = @FirmId
   and   takip.IsUygSinavMebbisOnayi = 1 -- Uygulama sınavı için mebbisden onay verilince
   and   takip.uSinavDurumTipiId = 4       -- Uygulama sınavı için MEBBİS de onaylanacak


  -- -----------------------------------------------------------------
  -- Uygulama sınav sonuclarını değerlendir
  -- -----------------------------------------------------------------

  -- MtskAdayTakipuSinavDurumTipi
  -- 0,    'Tanımsız
  -- 1,    'Henüz sınav aşamasında değil
  -- 2,    'Uygulama sınavı için usta öğretici onayı isteniyor
  -- 3,    'Uygulama sınavı için hazır değil
  -- 4,    'Uygulama sınavı için MEBBİS de onaylanacak
  -- 5,    'Uygulama sınav randevusu planlanacak
  -- 6,    'Uygulama sınav randevusu MEBBİSe aktarılacak
  -- 7,    'Uygulama sınavına girecek
  -- 8,    'Uygulama sınav sonucu okunacak
  -- 9,    'Uygulama sınav sonucu okundu

  -- MtskSinavUygulamaPuanTipi
  --  -2  Durumu Girilmemiş
  --  -1  Girmedi
  --   0	
  --   1  Başarısız
  -- 100  Başarılı

  -- MtskSinavUygulama.DurumuTipiId
  -- 0,    ''
  -- 1,    'Uygulama Sınav Aşamasında'
  -- 2,    '2.Direksiyon Aşamasında'
  -- 3,    'Sertifika Almaya Hak Kazandı'
  -- 4,    'Uygulama Sınav Hakkı Doldu'
  -- 5,    'Sertifikası İptal Edildi'
  -- 6,	 'Durumu Girilmemiş'

    update MtskAdayTakip set
      uSinavNo = x.SinavNo
    , uSinavDurumTipiId = x.uSinavDurumTipiId
    , uSinavSonucTipiId = x.uSinavSonucTipiId
    , uSinavSonrasiTipiId = x.uSinavSonrasiTipiId
	, uSinavDetayId = x.sinavId
	, uSinavBasariTarihi = x.uSinavBasariTarihi
    from MtskAdayTakip a, 
    (
         Select 
	       uSinav.Id as sinavId
	     , uSinav.FirmId
         , uSinav.TalepId
	     , uSinav.AdayId 
	     , uSinav.SinavNo
         , uSinav.DurumuTipiId
		 , convert(date, uSinav.SinavTarihi, 103) as SinavTarihi
	     , ( case
             when (uSinav.PuanTipiId = 0 and convert(date, @bugun,103) <  convert(date, uSinav.SinavTarihi, 103)) then 7 -- Uygulama sınavına girecek
             when (uSinav.PuanTipiId = 0 and convert(date, @bugun,103) >= convert(date, uSinav.SinavTarihi, 103)) then 8 -- Uygulama sınav sonucu okunacak
	         when (uSinav.PuanTipiId > 0) then 9  -- 'Uygulama sınav sonucu okundu
             end ) as uSinavDurumTipiId
	     , ( case
			 when uSinav.PuanTipiId = 100 then 1 -- Başarılı
             when uSinav.PuanTipiId =   1 then 2 -- Başarısız
             when uSinav.PuanTipiId =  -1 then 3 -- Girmedi 
			 else 0 end ) as uSinavSonucTipiId
         , ( case
	         when (uSinav.PuanTipiId = 100) then 2    -- Sertifika aşamasına geçti
             when (uSinav.PuanTipiId = 1) and (uSinav.SinavNo  < 4 ) then 1  -- Tekrar sınava girecek
             when (uSinav.PuanTipiId > 1) and (uSinav.SinavNo >= 4 ) then 3  -- Tüm uygulamalı sınav hakkı bitti
             end ) as uSinavSonrasiTipiId
         , ( case 
	         when uSinav.PuanTipiId = 100 then uSinav.SinavTarihi 
             else null end ) as uSinavBasariTarihi
         from MtskSinavUygulama as uSinav,
	     (     -- Adayların son sınavlarını buluyor
	           Select TalepId, AdayId
			   , max(convert(smallDatetime,SinavTarihi,103)) as SinavTarihi
               from MtskSinavUygulama
		       Where FirmId = @FirmId
			   and IsActive = 1
               group by TalepId, AdayId
         ) as aday
	     Where uSinav.TalepId = aday.TalepId
		 and   uSinav.AdayId = aday.AdayId
	     and   convert(smallDatetime,uSinav.SinavTarihi,103) = aday.SinavTarihi
    ) as x
    Where a.FirmId  = x.FirmId
    and   a.TalepId = x.TalepId
	and   a.AdayId  = x.AdayId 




----***** eskiler

/*


	-- uSinavDurumTipiId = 1. Uygulama sınav için hazır değil
    update MtskAdayTakip set
    uSinavDurumTipiId = 1
    from MtskAdayTakip
    Where FirmId = @FirmId
	and  (UygulamaliDersTipiId = 2  -- ders başlamadı
    or    UygulamaliDersTipiId = 3) -- ders devam 

    -- uSinavDurumTipiId = 2. Uygulama sınav randevusu planlanacak
    update MtskAdayTakip set
    uSinavDurumTipiId = 2
    from MtskAdayTakip
    Where FirmId = @FirmId
	and   uSinavDurumTipiId <= 1 -- Uygulama sınav için hazır değil
	and  (UygulamaliDersTipiId = 4 -- ders tamamlandı
	or    Arti4DersTipiId = 4
	or    BasarisizDersTipiId = 4
	or    BasarisizDersTipiId = 5)

	-- uSinavDurumTipiId = 3. Uygulama sınav randevusu MEBBİSe aktarılacak
	Update MtskAdayTakip set 
    uSinavDurumTipiId = 3	  
    from MtskAdayTakip as mat,
    (
	    -- planlanan randevu listesindeki adaylar
	    Select randevu.AdayId
		From MtskSinavRandevu as randevu 
		Where randevu.Tarih > GETDATE()
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId
	and (mat.uSinavDurumTipiId = 2 
	 or  mat.uSinavDurumTipiId = 12)

*/

/*	
	-- uSinavDurumTipiId = 4. Uygulama sınav randevusu MEBBİSe aktarılacak
	Update MtskAdayTakip set 
    uSinavDurumTipiId = 4	  
    from MtskAdayTakip as mat,
    (
	    Select takip.AdayId
		From MtskAdayTakip as takip 
		  Left outer join MtskSinavRandevu as randevu on (
		      takip.AdayId = randevu.AdayId
		  and randevu.Tarih > GETDATE()
		  )
		Where takip.FirmId = @FirmId 
		and   takip.uSinavDurumTipiId >= 1
		and   takip.uSinavDurumTipiId <= 3
		and   isnull(takip.uRandevuMebbisAktarildi,0) = 0
		and   randevu.Id is not null
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId
	
	-- uSinavDurumTipiId = 5. Uygulama sınavına girecek
	Update MtskAdayTakip set 
      uSinavDurumTipiId = 5
	, uSinavBasariTarihi = z.Tarih
    from MtskAdayTakip as mat,
    (
		Select randevu.AdayId, randevu.Tarih
        From MtskSinavRandevu as randevu
		  Left  outer join MtskSinavUygulama as sinav on ( 
		      randevu.FirmId = sinav.FirmId
		  and randevu.AdayId = sinav.AdayId 
		  and randevu.Tarih = sinav.SinavTarihi
		  )
		  Left outer join MtskAdayTakip as takip on (
		      randevu.AdayId = takip.AdayId
		  )
		Where takip.uRandevuMebbisAktarildi = 1
		and   takip.uSinavDurumTipiId >= 1
		and   takip.uSinavDurumTipiId <= 4
		and   sinav.Id is not null
		and   sinav.PuanTipiId = 0
		and   sinav.SinavTarihi > GETDATE()
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId

	-- uSinavDurumTipiId = 6. Uygulama sınav sonucu okunacak
	Update MtskAdayTakip set 
    uSinavDurumTipiId = 6	  
    from MtskAdayTakip as mat,
    (
		Select randevu.AdayId
        From MtskSinavRandevu as randevu
		  Left  outer join MtskSinavUygulama as sinav on ( 
		      randevu.FirmId = sinav.FirmId
		  and randevu.AdayId = sinav.AdayId 
		  and randevu.Tarih = sinav.SinavTarihi
		  )
		  Left outer join MtskAdayTakip as takip on (
		      randevu.AdayId = takip.AdayId
		  )
		Where takip.uRandevuMebbisAktarildi = 1
		and   takip.uSinavDurumTipiId >= 1
		and   takip.uSinavDurumTipiId <= 5
		and   sinav.Id is not null
		and   sinav.PuanTipiId = 0
		and   sinav.SinavTarihi <= GETDATE()
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId
	
	-- uSinavDurumTipiId = 7. Uygulama sınav sonucu okundu
	Update MtskAdayTakip set 
    uSinavDurumTipiId = 7	  
    from MtskAdayTakip as mat,
    (
		Select randevu.AdayId
        From MtskSinavRandevu as randevu
		  Left  outer join MtskSinavUygulama as sinav on ( 
		      randevu.FirmId = sinav.FirmId
		  and randevu.AdayId = sinav.AdayId 
		  and randevu.Tarih = sinav.SinavTarihi
		  )
		  Left outer join MtskAdayTakip as takip on (
		      randevu.AdayId = takip.AdayId
		  )
		Where takip.uRandevuMebbisAktarildi = 1
		and   takip.uSinavDurumTipiId >= 1
		and   takip.uSinavDurumTipiId <= 6
		and   sinav.Id is not null
		and   sinav.PuanTipiId <> 0
		and   sinav.SinavTarihi <= GETDATE()
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId
	
*/	
	
/*
	-- +4 Sınav hakları -------------------------------------- 

	-- uSinavDurumTipiId = 11. +4 Uygulama sınav için hazır değil
    update MtskAdayTakip set
    uSinavDurumTipiId = 11
    from MtskAdayTakip
    Where FirmId = @FirmId
	and  (Arti4DersTipiId = 2  -- ders başlamadı
    or    Arti4DersTipiId = 3) -- ders devam 

    -- uSinavDurumTipiId = 12. +4 Uygulama sınavına katılabilir
    update MtskAdayTakip set
    uSinavDurumTipiId = 12
    from MtskAdayTakip
    Where FirmId = @FirmId
	and   Arti4DersTipiId = 4 -- ders tamamlandı
    and   uSinavNo = 4 
	and   uSinavDurumTipiId = 11 -- +4 Uygulama sınav için hazır değil

	-- uSinavDurumTipiId = 13. +4 Uygulama sınav randevusu planlanacak
	Update MtskAdayTakip set 
    uSinavDurumTipiId = 13	  
    from MtskAdayTakip as mat,
    (
	    Select takip.AdayId
		From MtskAdayTakip as takip 
		  Left outer join MtskSinavRandevu as randevu on (
		      takip.AdayId = randevu.AdayId
		  and randevu.Tarih > GETDATE()
		  )
		Where takip.FirmId = @FirmId 
		and   takip.uSinavDurumTipiId >= 11
		and   takip.uSinavDurumTipiId <= 12
		and   randevu.Id is null
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId

	-- uSinavDurumTipiId = 14. +4 Uygulama sınav randevusu MEBBİSe aktarılacak
	Update MtskAdayTakip set 
    uSinavDurumTipiId = 14	  
    from MtskAdayTakip as mat,
    (
	    Select takip.AdayId
		From MtskAdayTakip as takip 
		  Left outer join MtskSinavRandevu as randevu on (
		      takip.AdayId = randevu.AdayId
		  and randevu.Tarih > GETDATE()
		  )
		Where takip.FirmId = @FirmId 
		and   takip.uSinavDurumTipiId >= 11
		and   takip.uSinavDurumTipiId <= 13
		and   isnull(takip.uRandevuMebbisAktarildi,0) = 0
		and   randevu.Id is not null
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId

	-- uSinavDurumTipiId = 15. +4 Uygulama sınavına girecek
	Update MtskAdayTakip set 
      uSinavDurumTipiId = 15	  
    , uSinavBasariTarihi = z.Tarih
	from MtskAdayTakip as mat,
    (
		Select randevu.AdayId, randevu.Tarih
        From MtskSinavRandevu as randevu
		  Left  outer join MtskSinavUygulama as sinav on ( 
		      randevu.FirmId = sinav.FirmId
		  and randevu.AdayId = sinav.AdayId 
		  and randevu.Tarih = sinav.SinavTarihi
		  )
		  Left outer join MtskAdayTakip as takip on (
		      randevu.AdayId = takip.AdayId
		  )
		Where takip.uRandevuMebbisAktarildi = 1
		and   takip.uSinavDurumTipiId >= 11
		and   takip.uSinavDurumTipiId <= 14
		and   sinav.Id is not null
		and   sinav.PuanTipiId = 0
		and   sinav.SinavTarihi > GETDATE()
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId

	-- uSinavDurumTipiId = 16. +4 Uygulama sınav sonucu okunacak
	Update MtskAdayTakip set 
    uSinavDurumTipiId = 16	  
    from MtskAdayTakip as mat,
    (
		Select randevu.AdayId
        From MtskSinavRandevu as randevu
		  Left  outer join MtskSinavUygulama as sinav on ( 
		      randevu.FirmId = sinav.FirmId
		  and randevu.AdayId = sinav.AdayId 
		  and randevu.Tarih = sinav.SinavTarihi
		  )
		  Left outer join MtskAdayTakip as takip on (
		      randevu.AdayId = takip.AdayId
		  )
		Where takip.uRandevuMebbisAktarildi = 1
		and   takip.uSinavDurumTipiId >= 11
		and   takip.uSinavDurumTipiId <= 15
		and   sinav.Id is not null
		and   sinav.PuanTipiId = 0
		and   sinav.SinavTarihi <= GETDATE()
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId

	-- uSinavDurumTipiId = 17. +4 Uygulama sınav sonucu okundu
	Update MtskAdayTakip set 
    uSinavDurumTipiId = 17	  
    from MtskAdayTakip as mat,
    (
		Select randevu.AdayId
        From MtskSinavRandevu as randevu
		  Left  outer join MtskSinavUygulama as sinav on ( 
		      randevu.FirmId = sinav.FirmId
		  and randevu.AdayId = sinav.AdayId 
		  and randevu.Tarih = sinav.SinavTarihi
		  )
		  Left outer join MtskAdayTakip as takip on (
		      randevu.AdayId = takip.AdayId
		  )
		Where takip.uRandevuMebbisAktarildi = 1
		and   takip.uSinavDurumTipiId >= 11
		and   takip.uSinavDurumTipiId <= 16
		and   sinav.Id is not null
		and   sinav.PuanTipiId <> 0
		and   sinav.SinavTarihi <= GETDATE()
    ) as z 
	Where mat.FirmId = @FirmId
	and mat.AdayId = z.AdayId
*/	

/*

    update MtskAdayTakip set
      uSinavNo = x.SinavNo
    , uSinavDurumTipiId = x.uSinavDurumTipiId
    , uSinavSonucTipiId = x.uSinavSonucTipiId
    , uSinavSonrasiTipiId = x.uSinavSonrasiTipiId
	, uSinavDetayId = x.sinavId
	, uSinavBasariTarihi = x.SinavTarihi
	, BasarisizDersTipiId = x.BasarisizDersTipiId
	, DosyaYakti = x.DosyaYakti
    
	from MtskAdayTakip a, 
    (
         Select 
		   uSinav.Id as sinavId
         , uSinav.FirmId
         , uSinav.AdayId
         , uSinav.SinavNo
         , uSinav.SinavTarihi
		 , case 
             when ( uSinav.SinavNo < 5 and ( uSinav.PuanTipiId = -2 or isnull(uSinav.PuanTipiId,0) = 0)) then 5 
             when ( uSinav.SinavNo > 4 and ( uSinav.PuanTipiId = -2 or isnull(uSinav.PuanTipiId,0) = 0)) then 15 
             when ( uSinav.SinavNo < 5 and ( uSinav.PuanTipiId = -1 or uSinav.PuanTipiId > 0)) then 6 
             when ( uSinav.SinavNo > 4 and ( uSinav.PuanTipiId = -1 or uSinav.PuanTipiId > 0)) then 16 
   	         end as uSinavDurumTipiId
         , case 
             when ( uSinav.PuanTipiId = -2 )  then 0  -- Durumu Girilmemiş
			 when ( uSinav.PuanTipiId = -1 )  then 3  -- Girmedi
             when ( uSinav.PuanTipiId = 1 )   then 2  -- Başarısız
             when ( uSinav.PuanTipiId = 100 ) then 1  -- Başarılı 
             end as uSinavSonucTipiId 
         , case 
		     when ( uSinav.PuanTipiId = -2 )   then 0   -- ''
             when ( uSinav.PuanTipiId = 100 )  then 2   -- Sertifika aşamasına geçti
             when ( uSinav.PuanTipiId <> 100 and uSinav.SinavNo <> 4 and uSinav.SinavNo <> 8 )  then 1  -- Sınava tekrar girecek
             when ( uSinav.PuanTipiId <> 100 and uSinav.SinavNo = 4 ) then 3 --  Tüm uygulamalı sınav hakkı bitti, +4 sınav hakkını kullanacak mı ?
             when ( uSinav.PuanTipiId <> 100 and uSinav.SinavNo = 8 ) then 4 --  +4 sınav hakkı bitti
             end as uSinavSonrasiTipiId
         , case 
             when ( uSinav.PuanTipiId <> 100 and uSinav.SinavNo = 8 ) then 1 --  Dosya yaktı
			 else 0 
             end as DosyaYakti
         , case
             when ( uSinav.PuanTipiId = 100 ) then 0  -- ''
             when ( uSinav.PuanTipiId = 1  and uSinav.SinavNo <> 4 and uSinav.SinavNo <> 8 )  then 1  --  2 saat başarısız aday eğitimi planlanacak
             when ( uSinav.PuanTipiId = -1 and uSinav.SinavNo <> 4 and uSinav.SinavNo <> 8 )  then 5  --  Eğitime gerek yok (Sınava girmedi)
             when ( uSinav.PuanTipiId <> 100 and (uSinav.SinavNo = 4 or uSinav.SinavNo = 8))  then 0  -- ''
			 end as BasarisizDersTipiId		 
         From MtskSinavUygulama as uSinav,
		 (
	           Select AdayId
			   , max(SinavTarihi) as SinavTarihi
               from MtskSinavUygulama
		       Where FirmId = @FirmId
			   and IsActive = 1
			   Group by AdayId
	     ) as aday
		 Where uSinav.AdayId = aday.AdayId
		 and   uSinav.SinavTarihi = aday.SinavTarihi
    ) as x
    Where a.FirmId = x.FirmId
	and   a.AdayId = x.AdayId    


    -- MtskAdayTakipSertifikaTipi (Id, SertifikaTipi)
    -- 0,    ''
    -- 1,    'Sertifikası hazırlanacak (Seri No verilecek)
    -- 2,    'Sertifikası forma basılacak'
    -- 3,    'Sertifikası hazır'
    -- 4,    'Sertifikası teslim edildi'	

	-- MtskAdayTakipuSinavSonrasiTipi (Id, uSinavSonrasiTipi)
    -- 0,    ''
    -- 1,    'Sınava tekrar girecek'
    -- 2,    'Sertifika aşamasına geçti'
    -- 3,    'Tüm uygulamalı sınav hakkı bitti, 2.Uygulama (+4) hakkını kullanacak mı ? '
    -- 4,    '2.Uygulama (+4) sınav hakkı bitti'

	-- SertifikaTipiId = 0. ''
    -- sertifika aşamasına geçmemiş ise sertifika durumlarını sıfırla
	update MtskAdayTakip set
      SertifikaDurumTipiId = 0
    from MtskAdayTakip
    Where FirmId = @FirmId
	and   uSinavSonrasiTipiId <> 2

	-- uSinavSonrasiTipiId sertifika aşamsına geçince
	--  1, 'Sertifikası hazırlanacak (Seri No verilecek)'  durumuna geç
    update MtskAdayTakip set
      SertifikaDurumTipiId = 1
    from MtskAdayTakip
    Where FirmId = @FirmId
	and   uSinavSonrasiTipiId = 2
	and   SertifikaDurumTipiId = 0

	-- sertifika no veriliyor
	-- sonra kullanıcı vazgeçerse tekrar durumu başa alıyor
    update MtskAdayTakip set
      SertifikaDurumTipiId = 1
    from MtskAdayTakip as takip,  
	     MtskAdaySertifika as sertifika
    Where takip.FirmId = @FirmId
	and   takip.uSinavSonrasiTipiId = 2
	and   takip.SertifikaDurumTipiId > 1
    and   sertifika.SertifikaNo is null
	and   sertifika.DuzenlemeTarihi is null


	-- sertifika No verilmiş ise 
	-- 2,  'Sertifikası forma basılacak' durumuna geç 
    update MtskAdayTakip set
      SertifikaDurumTipiId = 2
    from MtskAdayTakip as takip
	   left outer join MtskAdaySertifika as sertifika on (takip.AdayId = sertifika.AdayId)
    Where takip.FirmId = @FirmId
	and   takip.uSinavSonrasiTipiId = 2
	and   takip.SertifikaDurumTipiId = 1
	and   isnull(sertifika.SertifikaNo,'') <> ''

	-- sertifika baskısı yapılmış ise 
	-- 3,  'Sertifikası hazır' durumuna geç 
    update MtskAdayTakip set
      SertifikaDurumTipiId = 3
    from MtskAdayTakip as takip
	   left outer join MtskAdaySertifika as sertifika on (takip.AdayId = sertifika.AdayId)
    Where takip.FirmId = @FirmId
	and   takip.uSinavSonrasiTipiId = 2
	and   takip.SertifikaDurumTipiId = 2
	and   isnull(sertifika.SertifikaNo,'') <> ''
	and   isnull(sertifika.SertifikaBaskiAdedi,0) > 0

	-- sertifika teslim tarihi girilince 
	-- 4,  'Sertifikası teslim edildi'
    update MtskAdayTakip set
      SertifikaDurumTipiId = 4
	from MtskAdayTakip as takip
	   left outer join MtskAdaySertifika as sertifika on (takip.AdayId = sertifika.AdayId)
    Where takip.FirmId = 2 -- @FirmId
	and   takip.uSinavSonrasiTipiId = 2
	and   takip.SertifikaDurumTipiId = 3
	and   isnull(sertifika.SertifikaNo,'') <> ''
	and   isnull(sertifika.SertifikaBaskiAdedi,0) > 0
	and   isnull(sertifika.SertifikaTeslimTarihi, convert(date, '01.01.1900',103)) > convert(date, '01.01.1990',103)
*/	

END -- procedure

/*CreateProcedureEnd*/