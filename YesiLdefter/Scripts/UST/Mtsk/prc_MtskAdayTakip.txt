/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayTakip]
    @FirmId INT
   ,@TalepId INT
   ,@DonemTipiId INT
   ,@Kim VARCHAR(100)
AS
BEGIN

  SET NOCOUNT ON;

  --declare @FirmId int = 11 
  --declare @TalepId int = 3390
  --declare @DonemTipiId int = 0--202507
  --declare @Kim varchar(100) = N''

  print 'prc_MtskAdayTakip start'
  print ''
  print 'Kim başlattı = ' + @Kim
  -- DbUpdate aktif olsun ki trigger ve bu procedure birbirini tetiklmesin
  print 'Execute [dbo].[prc_setIsDbUpdateActive] 13, 1'
  Execute [dbo].[prc_setIsDbUpdateActive] 13, 1

  declare @AdayId int
  declare @Sql nvarchar(Max) = N'';
  declare @SqlHeader nvarchar(500) = N'';
  declare @SqlDonemler nvarchar(500) = N'';
  declare @SqlBugun nvarchar(500) = N'';
  declare @SqlSettings nvarchar(500) = N'';
  declare @Enter varchar(4) = CHAR(13) + CHAR(10)

  if (@TalepId > 0)
  begin
      Select @AdayId = AdayId From dbo.MtskAdayTalep
      Where Id = @TalepId
  end

  --declare @BugunDonemTipiId int = 0
  --declare @GelecekDonemTipiId int = 0
  --set @BugunDonemTipiId = dbo.fnc_getDonemTipiId('BUGUN')
  --set @GelecekDonemTipiId = dbo.fnc_getDonemTipiId('GELECEK')

  -- Example
  /*
  set @Kim = 'MtskAdayTakipFull'
  set @Kim = 'MtskAdayTakipKayit'
  set @Kim = 'MtskAdayTakipEveryDay'
  set @Kim = 'MtskAdayTakipTeorikDers'
  set @Kim = 'MtskAdayTakipESinav'
  set @Kim = 'MtskAdayTakipUygDers'
  set @Kim = 'MtskAdayTakipUygSinav'
  */
  Set @SqlHeader = 
     N' declare @FirmId int = ' + CONVERT(varchar(20),@FirmId) + ' ' + @Enter; 

  if (@TalepId > 0)
  Set @SqlHeader = @SqlHeader
  +  N' declare @TalepId int = ' + CONVERT(varchar(20),@TalepId) + ' ' + @Enter;

  if (@DonemTipiId > 0)
  Set @SqlHeader = @SqlHeader
  +  N' declare @DonemTipiId int = ' + CONVERT(varchar(20),@DonemTipiId) + ' ' + @Enter;

  if (@AdayId > 0)
  Set @SqlHeader = @SqlHeader
  +  N' declare @AdayId int = ' + CONVERT(varchar(20),@AdayId) + ' ' + @Enter;

  Set @SqlDonemler = 
    N' declare @BugunDonemTipiId int = 0 ' + @Enter 
  + N' declare @GelecekDonemTipiId int = 0 ' + @Enter 
  + N' set @BugunDonemTipiId = dbo.fnc_getDonemTipiId(''BUGUN'') ' + @Enter 
  + N' set @GelecekDonemTipiId = dbo.fnc_getDonemTipiId(''GELECEK'') ' + @Enter;

  --declare @bugun smalldatetime = getdate()
  set @SqlBugun = ' declare @bugun smalldatetime = getdate() ' + @Enter;

  --declare @settingsAdayHazirMi bit 
  --set @settingsAdayHazirMi = dbo.fnc_getSettingsBool(11, 1130, 101)
  Set @SqlSettings = 
    N' declare @settingsAdayHazirMi bit ' + @Enter 
  + N' set @settingsAdayHazirMi = dbo.fnc_getSettingsBool(11, 1130, 101) ' + @Enter

  -- -----------------------------------------------------------------
  -- Kayıt - Adayın durumu hakkında bilgi toplama aşaması
  -- -----------------------------------------------------------------

  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit 
  --
  -- BelgelerGeldi mi ( dbo.MtskAdayTalep tablosu için )

  Set @Sql = '
--@Header
  ;With BelgelerGeldimi as (
    Select
        t.FirmId
      , t.Id as TalepId
      , yeniBelgelerGeldi = ( case 
            When t.BiyometrikGeldi = 1
            and  t.OgrenimGeldi = 1
            and  t.SaglikGeldi = 1
            and  t.AdliSicilGeldi = 1
            and  t.ImzaAlindi = 1
            and  t.SozlesmeYapildi = 1
            and  t.AdresAlindi = 1 then 1 else 0 end)
    from dbo.MtskAdayTalep as t 
    where 0 = 0
    and @FirmId = t.FirmId 
    --and @TalepId = t.Id 
	and (( case 
            When t.BiyometrikGeldi = 1
            and  t.OgrenimGeldi = 1
            and  t.SaglikGeldi = 1
            and  t.AdliSicilGeldi = 1
            and  t.ImzaAlindi = 1
            and  t.SozlesmeYapildi = 1
            and  t.AdresAlindi = 1 then 1 else 0 end) <> t.BelgelerGeldi 
	or t.BelgelerGeldi is null
    )
  ) -- with
  Update a set 
    a.BelgelerGeldi = x.yeniBelgelerGeldi
  FROM dbo.MtskAdayTalep as a
  JOIN BelgelerGeldimi x ON ( a.FirmId = x.FirmId AND a.Id = x.TalepId )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  )
  begin
      print 'BelgelerGeldimi'
      EXEC sp_executesql @Sql
  end

  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit 
  --
  -- AracTipiId, Saglik Durumu

  Set @Sql = '
--@Header
  ;With TalepAracTipleriSaglikDurumuUcretTipi as (
    Select
        t.FirmId
      , t.Id as TalepId
      , t.IsActive
      , yeniAracTipiId = ( Case
            When t.IsOtomatik = 1 and t.IsEngelli = 0 then 1
            When t.IsOtomatik = 0 and t.IsEngelli = 1 then 2
            When t.IsOtomatik = 1 and t.IsEngelli = 1 then 3
            When t.Is125ccAlti = 1 then 4
            else 0 end )
      , isnull(s.OzurDurumuTipiId,0) as OzurDurumuTipiId
      , isnull(s.OkutmanTalebi,0) as OkutmanTalebi
      , isnull(s.TercumanTalebi,0) as TercumanTalebi 
      , isnull(s.YabanciDilTipiId,0) as YabanciDilTipiId
      , (case when isnull(u.KontejanTipiId,0) > 0 then 1 else 0 end) as IsKontejan
      , isnull(u.ESinavUcretTipiId,0) as  ESinavUcretTipiId 
      , isnull(u.USinavUcretTipiId,0) as  USinavUcretTipiId

    from dbo.MtskAdayTalep  as t 
    join dbo.MtskAdaySaglik as s on (t.Id = s.TalepId) 
    join dbo.MtskAdayUcret  as u on (t.Id = u.TalepId) 
	join dbo.MtskAdayTakip  as p on (t.Id = p.TalepId) 
    where 0 = 0
    and @FirmId = t.FirmId 
    --and @TalepId = t.Id 
	and (( Case
            When t.IsOtomatik = 1 and t.IsEngelli = 0 then 1
            When t.IsOtomatik = 0 and t.IsEngelli = 1 then 2
            When t.IsOtomatik = 1 and t.IsEngelli = 1 then 3
            When t.Is125ccAlti = 1 then 4
            else 0 end ) <> p.AracTipiId
	or p.AracTipiId is null
    or isnull(s.OzurDurumuTipiId,0) <> p.OzurDurumuTipiId
	or isnull(s.OkutmanTalebi,0) <> p.OkutmanTalebi
	or isnull(s.TercumanTalebi,0) <> p.TercumanTalebi
	or isnull(s.YabanciDilTipiId,0) <> p.YabanciDilTipiId
	or p.OzurDurumuTipiId is null
	or p.OkutmanTalebi is null
	or p.TercumanTalebi is null
	or p.YabanciDilTipiId is null
    or (case when isnull(u.KontejanTipiId,0) > 0 then 1 else 0 end) <> p.IsKontejan
	or isnull(u.ESinavUcretTipiId,0) <> p.ESinavUcretTipiId 
    or isnull(u.USinavUcretTipiId,0) <> p.USinavUcretTipiId
	or p.IsKontejan is null
	or p.ESinavUcretTipiId is null
	or p.USinavUcretTipiId is null
    )
  ) -- with
  Update a set 
    a.IsActive = t.IsActive,
    a.AracTipiId = t.yeniAracTipiId,
    a.OzurDurumuTipiId = t.OzurDurumuTipiId,
    a.OkutmanTalebi = t.OkutmanTalebi,
    a.TercumanTalebi = t.TercumanTalebi,
    a.YabanciDilTipiId = t.YabanciDilTipiId,
    a.IsKontejan = t.IsKontejan,
    a.ESinavUcretTipiId = t.ESinavUcretTipiId, 
    a.USinavUcretTipiId = t.USinavUcretTipiId
  from MtskAdayTakip as a
  JOIN TalepAracTipleriSaglikDurumuUcretTipi t on ( a.FirmId = t.FirmId and a.TalepId = t.TalepId )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  )
  begin
      print 'TalepAracTipleriSaglikDurumuUcretTipi'
      EXEC sp_executesql @Sql
  end

  -- MtskAdayTakipEveryDay
  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit 
  --
  -- ZamanlamaTipiId 

  Set @Sql = '
--@Header
--@Donemler

  ;With Zamanlama as (
    Select
        t.FirmId
      , t.Id as TalepId
      , yeniZamanlamaTipiId = ( Case 
            When t.DonemTipiId = @BugunDonemTipiId then 2
            When t.DonemTipiId = @GelecekDonemTipiId and ISNULL(t.KayitTipiId, 0) < 4 then 3
            When t.DonemTipiId > @GelecekDonemTipiId and ISNULL(t.KayitTipiId, 0) < 4 then 4
            When t.DonemTipiId < @BugunDonemTipiId and ISNULL(t.KayitTipiId, 0) IN (2, 3) then 1
            When t.DonemTipiId < @BugunDonemTipiId and ISNULL(t.KayitTipiId, 0) = 4 then 5
            else 0 end )
    from dbo.MtskAdayTalep as t, 
         dbo.MtskAdayTakip as p    
    where 0 = 0
	and t.Id = p.TalepId
    and @FirmId = t.FirmId
    --and @TalepId = t.Id
	and (( Case 
            When t.DonemTipiId = @BugunDonemTipiId then 2
            When t.DonemTipiId = @GelecekDonemTipiId and ISNULL(t.KayitTipiId, 0) < 4 then 3
            When t.DonemTipiId > @GelecekDonemTipiId and ISNULL(t.KayitTipiId, 0) < 4 then 4
            When t.DonemTipiId < @BugunDonemTipiId and ISNULL(t.KayitTipiId, 0) IN (2, 3) then 1
            When t.DonemTipiId < @BugunDonemTipiId and ISNULL(t.KayitTipiId, 0) = 4 then 5
            else 0 end ) <> p.ZamanlamaTipiId
    or p.ZamanlamaTipiId is null )
  ) -- With
  Update a set
  a.ZamanlamaTipiId = z.yeniZamanlamaTipiId
  from dbo.MtskAdayTakip as a
  join Zamanlama z on ( a.FirmId = z.FirmId and a.TalepId = z.TalepId )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)
  Set @Sql = REPLACE(@Sql, '--@Donemler', @SqlDonemler)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipEveryDay'
  or  @Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  )
  begin
      print 'Zamanlama'
      EXEC sp_executesql @Sql
  end


  -- -----------------------------------------------------------------
  -- Kayıt - Belgeler aşaması
  -- Belgeler geldi ve tarandı diye işaretle
  -- -----------------------------------------------------------------

  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit 
  --
  -- 'Adayın biyometrik geldi mi? kontrol ediliyor' 

  Set @Sql = '
--@Header
  ;WITH BiyometrikGelenAdaylar AS (
    SELECT t.FirmId, t.Id as TalepId
	, (case when a.BiyometrikResim IS NOT NULL then 1 else 0 end) as Geldi
	, t.BiyometrikGeldi
    FROM dbo.MtskAdayTalep as t
    INNER JOIN dbo.MtskAday as a ON ( 
	    a.Id = t.AdayId 
	and a.FirmId = t.FirmId 
	)
    WHERE 0 = 0
    and @FirmId = t.FirmId
    --and @TalepId = t.Id
    and ( t.BiyometrikGeldi <> (case when a.BiyometrikResim IS NOT NULL then 1 else 0 end) 
    or    t.BiyometrikGeldi is null )
  )
  UPDATE t
  SET t.BiyometrikGeldi = x.Geldi
  FROM dbo.MtskAdayTalep as t
  JOIN BiyometrikGelenAdaylar as x ON ( t.FirmId = x.FirmId and t.Id = x.TalepId )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  )
  begin
      print 'BiyometrikGelenAdaylar'
      EXEC sp_executesql @Sql
  end




  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit 
  --
  -- 'Adayın biyometrik tarandı mı? kontrol ediliyor'

  Set @Sql = '
--@Header
  ;WITH BiyometrikTaranmamis AS (
    SELECT b.FirmId, t.Id as TalepId
	, (case when a.BiyometrikResim IS NOT NULL then 1 else 0 end) as yeniTarama
    FROM  dbo.MtskAdayTalep as t,
	      dbo.MtskAdayBelgeler as b 
    INNER JOIN dbo.MtskAday as a ON ( 
        b.FirmId = a.FirmId
	and b.AdayId = a.Id 
    and @FirmId = a.FirmId
    --and @AdayId = a.Id 
	)
    WHERE 0 = 0
    and @FirmId = t.FirmId
    --and @TalepId = t.Id
    --and @AdayId = a.Id
	and t.Id = b.TalepId
	and ( b.BiyometrikTarandi <> (case when a.BiyometrikResim IS NOT NULL then 1 else 0 end) 
	or    b.BiyometrikTarandi is null )
  )
  UPDATE b
  SET b.BiyometrikTarandi = x.yeniTarama
  FROM dbo.MtskAdayBelgeler b
  JOIN BiyometrikTaranmamis as x ON ( b.FirmId = x.FirmId and b.TalepId = x.TalepId )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')
  if (@AdayId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @AdayId', 'and @AdayId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  )
  begin
      print 'BiyometrikTaranmamis'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit 
  --
  -- Detaylı belgeler geldi mi?  kontrolü

  Set @Sql = '
--@Header
  ;WITH BelgelerGeldimi AS (
    SELECT t.FirmId, t.Id as TalepId
    , (case when og.OgrenimBelgesiResimSmall IS NOT NULL then 1 else 0 end) as yeniOgrenimGeldi
	, t.OgrenimGeldi
	, (case when sg.SaglikRaporuResimSmall IS NOT NULL then 1 
	        when sg.IsRaporReferansNo = 1 then 1 else 0 end) as yeniSaglikGeldi
	, t.SaglikGeldi
    , (case when ad.SavcilikBelgesiResimSmall IS NOT NULL then 1 else 0 end) as yeniAdliSicilGeldi
	, t.AdliSicilGeldi
    , (case when s1.Sozlesme1ResimSmall IS NOT NULL then 1 
	        when s2.Sozlesme2ResimSmall IS NOT NULL then 1 
	        else 0 end) as yeniSozlesmeYapildi
	, t.SozlesmeYapildi
    , (case when im.ImzaResimSmall IS NOT NULL then 1 else 0 end) as yeniImzaAlindi
	, t.ImzaAlindi
    , (case when ar.SozluAdresBeyani IS NOT NULL then 1 
	        when LEN(ar.SozluAdresBeyani) > 0 then 1  
	        else 0 end) as yeniAdresAlindi
	, t.AdresAlindi

    FROM dbo.MtskAdayTalep as t
    INNER JOIN dbo.MtskAdayOgrenim   as og ON ( t.FirmId = og.FirmId and t.Id = og.TalepId )
    INNER JOIN dbo.MtskAdaySaglik    as sg ON ( t.FirmId = sg.FirmId and t.Id = sg.TalepId )
    INNER JOIN dbo.MtskAdayAdliSicil as ad ON ( t.FirmId = ad.FirmId and t.Id = ad.TalepId )
    INNER JOIN dbo.MtskAdaySozlesme  as s1 ON ( t.FirmId = s1.FirmId and t.Id = s1.TalepId )
    INNER JOIN dbo.MtskAdaySozlesme  as s2 ON ( t.FirmId = s2.FirmId and t.Id = s2.TalepId )
    INNER JOIN dbo.MtskAdayImza      as im ON ( t.FirmId = im.FirmId and t.Id = im.TalepId )
    INNER JOIN dbo.MtskAdayAdres     as ar ON ( t.FirmId = ar.FirmId and t.Id = ar.TalepId )
    
	WHERE 0 = 0
	and @FirmId = t.FirmId
	--and @TalepId = t.Id    
    and ( (case when og.OgrenimBelgesiResimSmall IS NOT NULL then 1 else 0 end) <> t.OgrenimGeldi
	or    (case when sg.SaglikRaporuResimSmall IS NOT NULL then 1 
	            when sg.IsRaporReferansNo = 1 then 1 else 0 end) <> t.SaglikGeldi
    or    (case when ad.SavcilikBelgesiResimSmall IS NOT NULL then 1 else 0 end) <> t.AdliSicilGeldi
    or    (case when s1.Sozlesme1ResimSmall IS NOT NULL then 1 
                when s2.Sozlesme2ResimSmall IS NOT NULL then 1 else 0 end) <> t.SozlesmeYapildi
    or    (case when im.ImzaResimSmall IS NOT NULL then 1 else 0 end) <> t.ImzaAlindi
	or    (case when ar.SozluAdresBeyani IS NOT NULL then 1 
	            when LEN(ar.SozluAdresBeyani) > 0 then 1  
	            else 0 end) <> t.AdresAlindi

    or t.OgrenimGeldi is null
	or t.SaglikGeldi is null
    or t.AdliSicilGeldi is null
    or t.SozlesmeYapildi is null
    or t.ImzaAlindi is null
    or t.AdresAlindi is null
	)
  ) -- With
  UPDATE tl
  SET tl.OgrenimGeldi = x.yeniOgrenimGeldi,
      tl.SaglikGeldi = x.yeniSaglikGeldi,
	  tl.AdliSicilGeldi = x.yeniAdliSicilGeldi,
	  tl.SozlesmeYapildi = x.yeniSozlesmeYapildi,
	  tl.ImzaAlindi = x.yeniImzaAlindi,
	  tl.AdresAlindi = x.yeniAdresAlindi
  FROM dbo.MtskAdayTalep as tl
  JOIN BelgelerGeldimi x ON ( tl.FirmId = x.FirmId AND tl.Id = x.TalepId )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  )
  begin
      print 'BelgelerGeldimi'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit 
  --
  -- Detaylı belgeler tarandimi kontrolü

  Set @Sql = '
--@Header
  ;WITH BelgeTaramalari AS (
    SELECT b.FirmId, b.TalepId
    , (case when og.OgrenimBelgesiResimSmall IS NOT NULL then 1 else 0 end) as yeniOgrenimTarandi
	, b.OgrenimTarandi
	, (case when sg.SaglikRaporuResimSmall IS NOT NULL then 1 
	        when sg.IsRaporReferansNo = 1 then 1 else 0 end) as yeniSaglikTarandi
	, b.SaglikTarandi
    , (case when ad.SavcilikBelgesiResimSmall IS NOT NULL then 1 else 0 end) as yeniAdliSicilTarandi
	, b.AdliSicilTarandi
    , (case when s1.Sozlesme1ResimSmall IS NOT NULL then 1 else 0 end) as yeniSozlesme1Tarandi
	, b.Sozlesme1Tarandi
    , (case when s2.Sozlesme2ResimSmall IS NOT NULL then 1 else 0 end) as yeniSozlesme2Tarandi
	, b.Sozlesme2Tarandi
    , (case when im.ImzaResimSmall IS NOT NULL then 1 else 0 end) as yeniImzaTarandi
	, b.ImzaTarandi

    FROM dbo.MtskAdayBelgeler b
    INNER JOIN dbo.MtskAdayOgrenim   as og ON ( b.FirmId = og.FirmId and b.TalepId = og.TalepId )
    INNER JOIN dbo.MtskAdaySaglik    as sg ON ( b.FirmId = sg.FirmId and b.TalepId = sg.TalepId )
    INNER JOIN dbo.MtskAdayAdliSicil as ad ON ( b.FirmId = ad.FirmId and b.TalepId = ad.TalepId )
    INNER JOIN dbo.MtskAdaySozlesme  as s1 ON ( b.FirmId = s1.FirmId and b.TalepId = s1.TalepId )
    INNER JOIN dbo.MtskAdaySozlesme  as s2 ON ( b.FirmId = s2.FirmId and b.TalepId = s2.TalepId )
    INNER JOIN dbo.MtskAdayImza      as im ON ( b.FirmId = im.FirmId and b.TalepId = im.TalepId )
    
	WHERE 0 = 0
	and @FirmId = b.FirmId
	--and @TalepId = b.TalepId    
    and ( (case when og.OgrenimBelgesiResimSmall IS NOT NULL then 1 else 0 end) <> b.OgrenimTarandi 
	or    (case when sg.SaglikRaporuResimSmall IS NOT NULL then 1 
	            when sg.IsRaporReferansNo = 1 then 1 else 0 end) <> b.SaglikTarandi
    or    (case when ad.SavcilikBelgesiResimSmall IS NOT NULL then 1 else 0 end) <> b.AdliSicilTarandi
    or    (case when s1.Sozlesme1ResimSmall IS NOT NULL then 1 else 0 end) <> b.Sozlesme1Tarandi
    or    (case when s2.Sozlesme2ResimSmall IS NOT NULL then 1 else 0 end) <> b.Sozlesme2Tarandi
    or    (case when im.ImzaResimSmall IS NOT NULL then 1 else 0 end) <> b.ImzaTarandi

    or b.OgrenimTarandi is null
	or b.SaglikTarandi is null
    or b.AdliSicilTarandi is null
    or b.Sozlesme1Tarandi is null
	or b.Sozlesme2Tarandi is null
    or b.ImzaTarandi is null
	)
  ) -- With
  UPDATE b
  SET b.OgrenimTarandi = x.yeniOgrenimTarandi,
      b.SaglikTarandi = x.yeniSaglikTarandi,
	  b.AdliSicilTarandi = x.yeniAdliSicilTarandi,
	  b.Sozlesme1Tarandi = x.yeniSozlesme1Tarandi,
	  b.Sozlesme2Tarandi = x.yeniSozlesme2Tarandi,
	  b.ImzaTarandi = x.yeniImzaTarandi
  FROM dbo.MtskAdayBelgeler as b
  JOIN BelgeTaramalari x ON ( b.FirmId = x.FirmId AND b.TalepId = x.TalepId )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  )
  begin
      print 'BelgeTaramalari'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit 
  --
  -- Tüme BelgelerGeldi, Tüm BelgelerTarandi, Tüm BelgelerYüklendi

  Set @Sql = '
--@Header
  ;With Belgeler as (
    Select 
        t.FirmId
      , t.Id as TalepId
      , yeniBelgelerGeldi = ( case 
            When t.BiyometrikGeldi = 1
            and  t.OgrenimGeldi = 1
            and  t.SaglikGeldi = 1
            and  t.AdliSicilGeldi = 1
            and  t.ImzaAlindi = 1
            and  t.SozlesmeYapildi = 1
            and  t.AdresAlindi = 1 then 1 else 0 end)
      , yeniBelgelerTarandi = ( case 
            When b.BiyometrikTarandi = 1
            and  b.OgrenimTarandi = 1
            and  b.SaglikTarandi = 1
            and  b.AdliSicilTarandi = 1
            and  b.ImzaTarandi = 1
            and  b.Sozlesme1Tarandi = 1
            and  b.Sozlesme2Tarandi = 1
            --and  b.BasvuruFotoTarandi = 1
            --and  b.AdresKodlandi = 1
            then 1 else 0 end )
      , yeniBelgelerYuklendi = ( case 
            When b.AdayKaydiYapildi = 1 
            and  b.BiyometrikYuklendi = 1 
            and  b.OgrenimYuklendi = 1 
            and  b.SaglikYuklendi = 1 
            and  b.AdliSicilYuklendi = 1 
            and  b.ImzaYuklendi = 1 
            and  b.Sozlesme1Yuklendi = 1 
            and  b.Sozlesme2Yuklendi = 1 
            and  b.AdresYuklendi = 1
            --and b.BasvuruFotoYuklendi = 1
            then 1 else 0 end )
      , p.BelgelerGeldi
      , p.BelgelerTarandi
	  , p.BelgelerYuklendi
    from dbo.MtskAdayTalep as t, 
	     dbo.MtskAdayBelgeler as b, 
         dbo.MtskAdayTakip as p
    where 0 = 0
    and t.Id = b.TalepId      
    and t.Id = p.TalepId      
    and @FirmId = t.FirmId
    --and @TalepId = t.Id 
	and ( ( case 
            When t.BiyometrikGeldi = 1
            and  t.OgrenimGeldi = 1
            and  t.SaglikGeldi = 1
            and  t.AdliSicilGeldi = 1
            and  t.ImzaAlindi = 1
            and  t.SozlesmeYapildi = 1
            and  t.AdresAlindi = 1 then 1 else 0 end) <> p.BelgelerGeldi
    or ( case 
            When b.BiyometrikTarandi = 1
            and b.OgrenimTarandi = 1
            and b.SaglikTarandi = 1
            and b.AdliSicilTarandi = 1
            and b.ImzaTarandi = 1
            and b.Sozlesme1Tarandi = 1
            and b.Sozlesme2Tarandi = 1
            then 1 else 0 end ) <> p.BelgelerTarandi
    or ( case 
            When b.AdayKaydiYapildi = 1 
            and  b.BiyometrikYuklendi = 1 
            and  b.OgrenimYuklendi = 1 
            and  b.SaglikYuklendi = 1 
            and  b.AdliSicilYuklendi = 1 
            and  b.ImzaYuklendi = 1 
            and  b.Sozlesme1Yuklendi = 1 
            and  b.Sozlesme2Yuklendi = 1 
            and  b.AdresYuklendi = 1
            then 1 else 0 end ) <> p.BelgelerYuklendi
    or p.BelgelerGeldi is null
    or p.BelgelerTarandi is null
	or p.BelgelerYuklendi is null
    )
  ) -- With
  Update a
  set a.BelgelerGeldi = b.yeniBelgelerGeldi, 
      a.BelgelerTarandi = b.yeniBelgelerTarandi,
      a.BelgelerYuklendi = b.yeniBelgelerYuklendi
  from dbo.MtskAdayTakip as a
  JOIN Belgeler as b on ( a.FirmId = b.FirmId and a.TalepId = b.TalepId )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  )
  begin
      print 'Belgeler'
      EXEC sp_executesql @Sql
  end


  -- -------------------------------------------------------------------
  -- Teorik dersler aşaması
  -- TeorikDersTipiId
  -- -------------------------------------------------------------------

  -- MtskAdayTakipEveryDay
  -- MtskAdayTakipTeorikDers
  --
  -- TeorikDersPlanlama 

  Set @Sql = '
--@Header
  ;WITH TeorikPlan as (
    Select 
        t.TalepId,
        gs.GrupBaslamaTarihi,
        gs.GrupBitisTarihi,
        TeorikDersTipiId = ( Case 
            when talep.TalepTipiId = 1 
                 and isnull(gs.GrupBitisTarihi, gs.GrupBaslamaTarihi) >= GETDATE()
                 and isnull(talep.MevcutSertifikaTipiId, 0) = 0
                 then gs.TakipTipiId
            when talep.TalepTipiId = 1 
                 and isnull(gs.GrupBitisTarihi, gs.GrupBaslamaTarihi)  < GETDATE()
                 and isnull(talep.MevcutSertifikaTipiId, 0) = 0
                 then 17   -- Teorik dersler tamamlandı
            when talep.TalepTipiId = 1 
			     and isnull(talep.MevcutSertifikaTipiId, 0) > 0
				 then 6    -- Muaf
            when talep.TalepTipiId <> 1 -- Sertifika talebi değilse
				 then 6    -- Muaf
            else 0 end )   -- Tanımsız
    From dbo.MtskAdayTakip as t
    INNER JOIN dbo.MtskAdayTalep as talep ON t.TalepId = talep.Id
    INNER JOIN dbo.MtskGrupSubesi as gs ON (
        t.FirmId      = gs.FirmId AND
        t.DonemTipiId = gs.DonemTipiId AND
        t.GrupTipiId  = gs.GrupTipiId AND
        t.SubeTipiId  = gs.SubeTipiId )
    Where 0 = 0
    and @FirmId = gs.FirmId
    --and @TalepId = t.TalepId
    --and @DonemTipiId = t.DonemTipiId
    and  t.DonemTipiId = gs.DonemTipiId	
    and  t.GrupTipiId  = gs.GrupTipiId	
  ) -- With
  UPDATE takip
  SET 
    TeorikBaslamaTarihi = tplan.GrupBaslamaTarihi
  , TeorikBitisTarihi   = tplan.GrupBitisTarihi
  , TeorikDersTipiId    = tplan.TeorikDersTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN TeorikPlan as tplan ON ( takip.TalepId = tplan.TalepId )
  Where 0 = 0
  and ( isnull(takip.TeorikBaslamaTarihi,''19000101'') <> tplan.GrupBaslamaTarihi
  or    isnull(takip.TeorikBitisTarihi,''19000101'')   <> tplan.GrupBitisTarihi
  or    isnull(takip.TeorikDersTipiId,-1)              <> tplan.TeorikDersTipiId
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@DonemTipiId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @DonemTipiId', 'and @DonemTipiId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipEveryDay'
  or  @Kim = 'MtskAdayTakipKayit'
  or  @Kim = 'MtskAdayTakipTeorikDers'
  )
  begin
      print 'TeorikPlan'
      EXEC sp_executesql @Sql
  end
  
  -- -------------------------------------------------------------------
  -- e - Sınav başvuru ve sonuç aşaması
  -- -------------------------------------------------------------------
  -- MtskAdayTakip.eSinavDurumTipiId
  -- 0,    'Tanımsız'
  -- 1,    'Hazır değil'
  -- 2,    'Başvuru yapılacak'
  -- 3,    'Belgesi hazırlanacak'
  -- 4,    'Belgesi teslim edilecek'
  -- 5,    'Sınava girecek'
  -- 6,    'Muaf'  
  -- MtskAdayTakip.eSinavSonrasiTipiId
  -- 1,  Tekrar sınava girecek
  -- 2,  Uygulama aşamasına geçti
  -- 3,  Tüm e-Sınav hakkı bitti

  -- MtskAdayTakipFull
  -- MtskAdayTakipESinav
  --

  Set @Sql = '
--@Header
  ;WITH ESinav_Sonuclari AS (
    SELECT t.FirmId, t.TalepId
  -- Başvuru bilgileri
  , ( case when isnull(sonuc.Id,0) = 0 then dbo.fnc_getEUSinavNo(t.TalepId, ''YeniESinavNo'') -- yeni sinav 
           when isnull(sonuc.DurumuTipiId,0) > 1 and isnull(sonuc.SinavNo,0) < 4  then sonuc.SinavNo + 1
           when isnull(sonuc.DurumuTipiId,0) > 1 and isnull(sonuc.SinavNo,0) = 4  then 0
           when isnull(sonuc.DurumuTipiId,0) = 1 then 0
           end ) as yeniGirecegiSinavNo 

  , ( case when t.eSinavDurumTipiId = 1 then 1 -- e-Sınav için hazır değil
           when t.eSinavDurumTipiId = 6 then 6 -- muaf 

		   when dbo.fnc_getEUSinavNo(t.TalepId, ''YeniESinavNo'') > 0 
               and isnull(t.eSinavDurumTipiId,0) != 1 
               and isnull(t.eSinavDurumTipiId,0) != 6 
               and isnull(basvu.Id,0) = 0 
               and isnull(sonuc.Id,0) = 0 
               and isnull(t.TeorikDersTipiId,0) = 17 then 2 -- e-Sınav başvurusu yapılacak   17 : Teork dersler tamamlandı

		   when dbo.fnc_getEUSinavNo(t.TalepId, ''YeniESinavNo'') > 0 
               and isnull(t.eSinavDurumTipiId,0) != 1 
               and isnull(t.eSinavDurumTipiId,0) != 6 
               and isnull(basvu.Id,0) = 0 
               and isnull(sonuc.Id,0) = 0 
               and isnull(t.TeorikDersTipiId,0) < 17 then 0 -- 0 tanımsız   17 : Teork dersler tamamlandı

           when isnull(sonuc.Id,0) > 0 and isnull(sonuc.DurumuTipiId,0) = 1 then 0 -- tanımsız
           when isnull(basvu.Id,0) > 0 and isnull(basvu.IsGBelgesiHazir,0) = 0 and isnull(basvu.IsGBelgesiTeslimEdildi,0) = 0  then 3 -- e-Sınav belgesi hazırlanacak
           when isnull(basvu.Id,0) > 0 and isnull(basvu.IsGBelgesiHazir,0) = 1 and isnull(basvu.IsGBelgesiTeslimEdildi,0) = 0  then 4 -- e-Sınav belgesi teslim edilecek
           when isnull(basvu.Id,0) > 0 and isnull(basvu.IsGBelgesiHazir,0) = 1 and isnull(basvu.IsGBelgesiTeslimEdildi,0) = 1  then 5 -- e-Sınava girecek
           when isnull(sonuc.Id,0) > 0 and isnull(sonuc.DurumuTipiId,0) > 1 and (isnull(sonuc.SinavNo,0) < 4 ) then 2 -- e-Sınav başvurusu yapılacak
           when isnull(sonuc.Id,0) > 0 and isnull(sonuc.DurumuTipiId,0) > 1 and (isnull(sonuc.SinavNo,0) = 4 ) then 0 -- tanımsız sınav hakkı bitti
           end ) as yenieSinavDurumTipiId

  , ( case when isnull(basvu.Id,0) > 0 and (basvu.SinavTarihi is not null) and isnull(sonuc.Id,0) = 0 then basvu.SinavTarihi 
           when isnull(basvu.Id,0) > 0 and isnull(sonuc.Id,0) > 0 then null
           when isnull(basvu.Id,0) = 0 and isnull(sonuc.Id,0) > 0 then null
           when isnull(basvu.Id,0) = 0 and isnull(sonuc.Id,0) = 0 then null
           else t.eSinavPlanTarihi end ) as yenieSinavPlanTarihi
		   
  , ( case when (isnull(sonuc.DurumuTipiId,0) > 1) and (isnull(sonuc.SinavNo,0) < 4 ) then (
      case when DAY(sonuc.SinavTarihi) >= 1 and DAY(sonuc.SinavTarihi) <= 15 then 
                DATEADD(DAY, 16 - DAY(sonuc.SinavTarihi), sonuc.SinavTarihi)
                else DATEADD(DAY, 1, EOMONTH(sonuc.SinavTarihi)) end )
           else null end ) as yenieSinavMuracatTarihi

  , ( case when isnull(basvu.Id,0) > 0 and isnull(basvu.IsGBelgesiTeslimEdildi,0) = 1 and isnull(sonuc.Id,0) = 0 then 1 -- başvuru belgesi teslim edildi
           else 0 end ) as yeniIseSinavBTeslimEdildi

  -- e-Sınav sonuç bilgileri
  , ( case when isnull(sonuc.Id,0) > 0 then isnull(sonuc.SinavNo,0) end ) as yenieSinavNoGirdigi
  , ( case when isnull(sonuc.Id,0) > 0 then isnull(sonuc.DurumuTipiId,0) 
           when isnull(sonuc.Id,0) = 0 then 0
      end ) as yenieSinavSonucTipiId
  , ( case when (sonuc.DurumuTipiId = 1) then 2 -- Uygulama aşamasına geçti
           when (sonuc.DurumuTipiId > 1) and (sonuc.SinavNo <  4 ) then 1  -- Tekrar sınava girecek
           when (sonuc.DurumuTipiId > 1) and (sonuc.SinavNo >= 4 ) then 3 -- Tüm e-Sınav hakkı bitti
           end ) as yenieSinavSonrasiTipiId
  , ( case when isnull(sonuc.Id,0) > 0 then sonuc.Id end ) as yenieSinavDetayId
  , ( case when isnull(sonuc.Id,0) > 0 then sonuc.SinavTarihi end ) as yenieSinavBasariTarihi

    FROM dbo.MtskAdayTakip as t
    left outer join MtskSinavETeorik as sonuc on ( t.TalepId = sonuc.TalepId and sonuc.LineTypeId = 2 and sonuc.SinavNo = dbo.fnc_getEUSinavNo(t.TalepId, ''GirdigiESinavNo'') )
    left outer join MtskSinavETeorik as basvu on ( t.TalepId = basvu.TalepId and basvu.LineTypeId = 1 and basvu.SinavNo = dbo.fnc_getEUSinavNo(t.TalepId, ''YeniESinavNo'') )

    WHERE 0 = 0
	and @FirmId = t.FirmId
    --and @TalepId = t.TalepId
  ) -- With
  Update takip
  Set eSinavNo = x.yeniGirecegiSinavNo
    , eSinavDurumTipiId = isnull(x.yenieSinavDurumTipiId,0)    
    , eSinavPlanTarihi = x.yenieSinavPlanTarihi
    , eSinavMuracatTarihi = x.yenieSinavMuracatTarihi
    , IseSinavBTeslimEdildi = x.yeniIseSinavBTeslimEdildi

    , eSinavNoGirdigi = x.yenieSinavNoGirdigi
    , eSinavSonucTipiId = x.yenieSinavSonucTipiId
    , eSinavSonrasiTipiId = x.yenieSinavSonrasiTipiId
    , eSinavDetayId = x.yenieSinavDetayId
    , eSinavBasariTarihi = x.yenieSinavBasariTarihi

  FROM dbo.MtskAdayTakip as takip
  JOIN ESinav_Sonuclari as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and (
      eSinavNo <> x.yeniGirecegiSinavNo
  or  eSinavDurumTipiId <> x.yenieSinavDurumTipiId    
  or  eSinavPlanTarihi <> x.yenieSinavPlanTarihi
  or  eSinavMuracatTarihi <> x.yenieSinavMuracatTarihi
  or  IseSinavBTeslimEdildi <> x.yeniIseSinavBTeslimEdildi

  or  eSinavNoGirdigi <> x.yenieSinavNoGirdigi
  or  eSinavSonucTipiId <> x.yenieSinavSonucTipiId
  or  eSinavSonrasiTipiId <> x.yenieSinavSonrasiTipiId
  or  eSinavDetayId <> x.yenieSinavDetayId
  or  eSinavBasariTarihi <> x.yenieSinavBasariTarihi
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print LEN(@Sql)

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipESinav'
  )
  begin
      print 'ESinav_Sonuclari'
      EXEC sp_executesql @Sql
  end


  -- -------------------------------------------------------------------
  -- Uygulamalı ders aşaması
  -- -------------------------------------------------------------------

  -- -------------------------------------------------------------------
  -- Uygulamalı ders kredileri aşaması
  -- -------------------------------------------------------------------
  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --

  Set @Sql = '
--@Header
  ;WITH UygulamaliDersKredileri AS (
    Select 
      talep.Id as TalepId
    , ( case 
        when talep.TalepTipiId > 1 then 0
	    when isnull(saatMevcut.UygulamaToplamSaat,0) > 0 and isnull(talep.IsMevcut2016Oncesi,0) = 1 then saatMevcut.UygulamaSaati2016Oncesi
	    when isnull(saatMevcut.UygulamaToplamSaat,0) > 0 and isnull(talep.IsMevcut2016Oncesi,0) = 0 then saatMevcut.UygulamaToplamSaat
	    when isnull(saatMevcut.UygulamaToplamSaat,0) = 0 and isnull(talep.IsMevcut2016Oncesi,0) = 1 then isnull(saatIstenen.UygulamaSaati2016Oncesi,0)
	    when isnull(saatMevcut.UygulamaToplamSaat,0) = 0 and isnull(talep.IsMevcut2016Oncesi,0) = 0 then isnull(saatIstenen.UygulamaToplamSaat,0)
		end) as yeniUygulamaEgitimSaati
    , ( case 
        when ( talep.TalepTipiId = 1 or talep.TalepTipiId > 3 )then 0
	    when isnull(saatMevcut.Arti4HakUygulamaSaati,0) > 0 and isnull(talep.IsMevcut2016Oncesi,0) = 1 then saatMevcut.UygulamaSaati2016Oncesi
	    when isnull(saatMevcut.Arti4HakUygulamaSaati,0) > 0 and isnull(talep.IsMevcut2016Oncesi,0) = 0 then saatMevcut.Arti4HakUygulamaSaati
	    when isnull(saatMevcut.Arti4HakUygulamaSaati,0) = 0 and isnull(talep.IsMevcut2016Oncesi,0) = 1 then isnull(saatIstenen.UygulamaSaati2016Oncesi,0)
	    when isnull(saatMevcut.Arti4HakUygulamaSaati,0) = 0 and isnull(talep.IsMevcut2016Oncesi,0) = 0 then isnull(saatIstenen.Arti4HakUygulamaSaati,0)
		end) as yeniArti4HakEgitimSaati
    , ( case 
        when talep.TalepTipiId > 3 then 0
	    when isnull(saatMevcut.TelafiEgitimSaati,0) > 0 then saatMevcut.TelafiEgitimSaati
	    when isnull(saatMevcut.TelafiEgitimSaati,0) = 0 then isnull(saatIstenen.TelafiEgitimSaati,0)
		end) as yeniTelafiEgitimSaati
    , ( case 
        when talep.TalepTipiId > 3 then 0
	    when isnull(saatMevcut.BasarisizEgitimSaati,0) > 0 then saatMevcut.BasarisizEgitimSaati
	    when isnull(saatMevcut.TelafiEgitimSaati,0) = 0 then isnull(saatIstenen.BasarisizEgitimSaati,0)
		end) as yeniBasarisizEgitimSaati
    From dbo.MtskAdayTalep as talep
        left outer join dbo.MtskSaatUygulama as saatIstenen on (
	         talep.IstenenSertifikaTipiId = saatIstenen.IstenenSertifikaTipiId
         and saatIstenen.MevcutSertifikaTipiId = 0 
        )
        left outer join dbo.MtskSaatUygulama as saatMevcut on (
	         talep.IstenenSertifikaTipiId = saatMevcut.IstenenSertifikaTipiId
         and talep.MevcutSertifikaTipiId  = saatMevcut.MevcutSertifikaTipiId
        )
    Where talep.FirmId = @FirmId  
    and ( talep.KayitTipiId = 2 or talep.KayitTipiId = 3 ) 
    --and @TalepId = talep.Id 
    and   saatIstenen.GecerlilikTarihiId = dbo.fnc_getGecerlilikTarihiId(talep.FirmId, 21102, talep.TalepKayitTarihi)
    and   saatMevcut.GecerlilikTarihiId = dbo.fnc_getGecerlilikTarihiId(talep.FirmId, 21102, talep.TalepKayitTarihi)
  ) -- With
  Update takip
  Set UygulamaliDersKredisi = x.yeniUygulamaEgitimSaati
    , Arti4DersKredisi = x.yeniArti4HakEgitimSaati    
    , TelafiDersKredisi = x.yeniTelafiEgitimSaati
    , BasarisizDersKredisi = x.yeniBasarisizEgitimSaati
  FROM dbo.MtskAdayTakip as takip
  JOIN UygulamaliDersKredileri as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and ( isnull(takip.UygulamaliDersKredisi,0) <> isnull(x.yeniUygulamaEgitimSaati,0)
  or    isnull(takip.Arti4DersKredisi,0)      <> isnull(x.yeniArti4HakEgitimSaati,0)
  or    isnull(takip.TelafiDersKredisi,0)     <> isnull(x.yeniTelafiEgitimSaati,0)
  or    isnull(takip.BasarisizDersKredisi,0)  <> isnull(x.yeniBasarisizEgitimSaati,0) 
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipESinav'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'UygulamaliDersKredileri'
      EXEC sp_executesql @Sql
  end




  -- -------------------------------------------------------------------
  -- Uygulamalı ders toplamları aşaması
  -- -------------------------------------------------------------------
  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --

  Set @Sql = '
--@Header
  ;WITH UygulamaliDersToplami AS (
    Select 
        y.TalepId 
      , sum(y.EgitimAlaniDersToplami) as EgitimAlaniDersToplami
      , sum(y.AkanTrafikDersToplami) as AkanTrafikDersToplami
      , sum(y.SimulatorDersToplami) as SimulatorDersToplami
      , sum(y.UygulamaliDersToplami) as UygulamaliDersToplami
      , min(y.UygulamaBaslamaTarihi) as UygulamaBaslamaTarihi
      , max(y.UygulamaBitisTarihi) as UygulamaBitisTarihi
    from  (
	      Select 
              talep.Id as TalepId 
            , ( case when uDers.EgitimYeriTipiId = 1 then count(uDers.Id) else 0 end) as EgitimAlaniDersToplami
            , ( case when uDers.EgitimYeriTipiId = 2 then count(uDers.Id) else 0 end) as AkanTrafikDersToplami
            , ( case when uDers.EgitimYeriTipiId = 3 then count(uDers.Id) else 0 end) as SimulatorDersToplami
            , count(uDers.Id) as UygulamaliDersToplami
            , min(uDers.DersTarihi) as UygulamaBaslamaTarihi
            , max(uDers.DersTarihi) as UygulamaBitisTarihi
          From dbo.MtskAdayTalep as talep 
	         left outer join dbo.MtskUygulamaliDers as uDers on ( talep.Id = uDers.TalepId 
                 and @FirmId = uDers.FirmId
				 --and @TalepId = uDers.TalepId  
                 and   uDers.IsActive = 1
                 and   talep.Id = uDers.TalepId
                 and   talep.AdayId = uDers.AdayId
                 and   uDers.EgitimTipiId = 1 -- Normal eğitim tüm dersler
		     )
          where 0 = 0
          and @FirmId = talep.FirmId 
          --and @TalepId = talep.Id
          and ( talep.KayitTipiId = 2 or talep.KayitTipiId = 3 ) 
          and talep.TalepTipiId = 1
          Group by  uDers.EgitimYeriTipiId, talep.Id 
    ) as y -- select
    Group by y.TalepId
  ) -- With
  Update takip
  Set UygulamaBaslamaTarihi  = x.UygulamaBaslamaTarihi 
    , UygulamaBitisTarihi    = x.UygulamaBitisTarihi
    , SimulatorDersToplami   = x.SimulatorDersToplami
    , EgitimAlaniDersToplami = x.EgitimAlaniDersToplami
	, AkanTrafikDersToplami  = x.AkanTrafikDersToplami 
    , UygulamaliDersToplami  = x.UygulamaliDersToplami
  FROM dbo.MtskAdayTakip as takip
  JOIN UygulamaliDersToplami as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and ( isnull(takip.UygulamaBaslamaTarihi,''19000101'') <> x.UygulamaBaslamaTarihi
  or    isnull(takip.UygulamaBitisTarihi,''19000101'')   <> x.UygulamaBitisTarihi
  or    takip.SimulatorDersToplami   <> x.SimulatorDersToplami
  or    takip.EgitimAlaniDersToplami <> x.EgitimAlaniDersToplami
  or    takip.AkanTrafikDersToplami  <> x.AkanTrafikDersToplami 
  or    takip.UygulamaliDersToplami  <> x.UygulamaliDersToplami
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipESinav'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'UygulamaliDersToplami'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --

  Set @Sql = '
--@Header
  ;WITH Uygulamali24HakDersToplami AS (
    Select 
        y.TalepId 
      , sum(y.EgitimAlaniDersToplami) as EgitimAlaniDersToplami
      , sum(y.AkanTrafikDersToplami) as AkanTrafikDersToplami
      , sum(y.UygulamaliDersToplami) as UygulamaliDersToplami
      , min(y.UygulamaBaslamaTarihi) as UygulamaBaslamaTarihi
      , max(y.UygulamaBitisTarihi) as UygulamaBitisTarihi
    from  (
	      Select 
              talep.Id as TalepId 
            , ( case when uDers.EgitimYeriTipiId = 1 then count(uDers.Id) else 0 end) as EgitimAlaniDersToplami
            , ( case when uDers.EgitimYeriTipiId = 2 then count(uDers.Id) else 0 end) as AkanTrafikDersToplami
            , count(uDers.Id) as UygulamaliDersToplami
            , min(uDers.DersTarihi) as UygulamaBaslamaTarihi
            , max(uDers.DersTarihi) as UygulamaBitisTarihi
          From dbo.MtskAdayTalep as talep 
	         left outer join dbo.MtskUygulamaliDers as uDers on ( talep.Id = uDers.TalepId 
                 and @FirmId = uDers.FirmId
				 --and @TalepId = uDers.TalepId  
                 and   uDers.IsActive = 1
                 and   talep.Id = uDers.TalepId
                 and   talep.AdayId = uDers.AdayId
                 and   uDers.EgitimTipiId = 3 -- 2.Direksiyon Eğitimi
		     )
          where 0 = 0
          and @FirmId = talep.FirmId 
          --and @TalepId = talep.Id
          and ( talep.KayitTipiId = 2 or talep.KayitTipiId = 3 ) 
          and ( talep.TalepTipiId = 2 or talep.TalepTipiId = 3 ) 
          Group by  uDers.EgitimYeriTipiId, talep.Id 
    ) as y -- select
    Group by y.TalepId
  ) -- With
  --select * from Uygulamali24HakDersToplami
  Update takip
  Set Arti4BaslamaTarihi          = x.UygulamaBaslamaTarihi 
    , Arti4BitisTarihi            = x.UygulamaBitisTarihi
    , Arti4EgitimAlaniDersToplami = x.EgitimAlaniDersToplami
	, Arti4AkanTrafikDersToplami  = x.AkanTrafikDersToplami 
    , Arti4DersToplami            = x.UygulamaliDersToplami
  FROM dbo.MtskAdayTakip as takip
  JOIN Uygulamali24HakDersToplami as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and ( isnull(takip.Arti4BaslamaTarihi,''19000101'')  <> isnull(x.UygulamaBaslamaTarihi,''19000101'') 
  or    isnull(takip.Arti4BitisTarihi,''19000101'')    <> isnull(x.UygulamaBitisTarihi,''19000101'')
  or    takip.Arti4EgitimAlaniDersToplami <> x.EgitimAlaniDersToplami
  or    takip.Arti4AkanTrafikDersToplami  <> x.AkanTrafikDersToplami 
  or    takip.Arti4DersToplami  <> x.UygulamaliDersToplami
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipESinav'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'Uygulamali24HakDersToplami'
      EXEC sp_executesql @Sql
  end



  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --

  Set @Sql = '
--@Header
  ;WITH TelafiDersToplami AS (
    Select --TOP 1
        y.TalepId 
	  , y.DersNo
      , sum(y.DersToplami) as UygulamaliDersToplami
      , min(y.BaslamaTarihi) as UygulamaBaslamaTarihi
      , max(y.BitisTarihi) as UygulamaBitisTarihi
    from  (
	      Select 
              talep.Id as TalepId 
            , count(uDers.Id) as DersToplami
            , max(uDers.DersTarihi) as BaslamaTarihi
            , max(uDers.DersTarihi) as BitisTarihi
			, ROW_NUMBER() OVER(PARTITION BY talep.Id ORDER BY uDers.DersTarihi ASC) AS DersNo
          From dbo.MtskAdayTalep as talep 
	         left outer join dbo.MtskUygulamaliDers as uDers on ( talep.Id = uDers.TalepId 
                 and @FirmId = uDers.FirmId
				 --and @TalepId = uDers.TalepId  
                 and   uDers.IsActive = 1
                 and   talep.Id = uDers.TalepId
                 and   talep.AdayId = uDers.AdayId
                 and   uDers.EgitimTipiId = 2 -- Telafi Eğitim(Ön Sınav )
		     )
          where 0 = 0
          and @FirmId = talep.FirmId 
          --and @TalepId = talep.Id
          and ( talep.KayitTipiId = 2 or talep.KayitTipiId = 3 ) 
          and ( talep.TalepTipiId = 1 or talep.TalepTipiId = 2 or talep.TalepTipiId = 3 ) 
          Group by  uDers.EgitimYeriTipiId, talep.Id, uDers.DersTarihi 

    ) as y -- select
    Group by y.TalepId, y.DersNo
	--Order by y.DersNo desc
  ) -- With
  --select * from TelafiDersToplami where UygulamaliDersToplami > 0
  Update takip
  Set TelafiDersNo        = x.DersNo 
    , TelafiBaslamaTarihi = x.UygulamaBaslamaTarihi
    , TelafiBitisTarihi   = x.UygulamaBitisTarihi
	, TelafiDersToplami   = x.UygulamaliDersToplami 
  FROM dbo.MtskAdayTakip as takip
  JOIN TelafiDersToplami as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and ( isnull(takip.TelafiBaslamaTarihi,''19000101'') <> isnull(x.UygulamaBaslamaTarihi,''19000101'') 
  or    isnull(takip.TelafiBitisTarihi,''19000101'')   <> isnull(x.UygulamaBitisTarihi,''19000101'')
  or  ( isnull(takip.TelafiDersNo,0) <> isnull(x.DersNo,0))-- and isnull(takip.TelafiDersNo,0) < isnull(x.DersNo,0) )
  or    isnull(takip.TelafiDersToplami,0) <> isnull(x.UygulamaliDersToplami,0)
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'TelafiDersToplami'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  -- Birden fazla DersNo yüzünden muhakkak kayıtlar tekrarlanıyor, 
  -- bu nedenle update sayısı hiç bir zaman sıfırlamıyor

  Set @Sql = '
--@Header
  ;WITH BasarisizDersToplami AS (
    Select --TOP 1
        y.TalepId 
	  , y.DersNo
      , sum(y.DersToplami) as UygulamaliDersToplami
      , min(y.BaslamaTarihi) as UygulamaBaslamaTarihi
      , max(y.BitisTarihi) as UygulamaBitisTarihi
    from  (
	      Select 
              talep.Id as TalepId 
            , count(uDers.Id) as DersToplami
            , max(uDers.DersTarihi) as BaslamaTarihi
            , max(uDers.DersTarihi) as BitisTarihi
			, ROW_NUMBER() OVER(PARTITION BY talep.Id ORDER BY uDers.DersTarihi ASC) AS DersNo
          From dbo.MtskAdayTalep as talep 
	         left outer join dbo.MtskUygulamaliDers as uDers on ( talep.Id = uDers.TalepId 
                 and @FirmId = uDers.FirmId
				 --and @TalepId = uDers.TalepId  
                 and   uDers.IsActive = 1
                 and   talep.Id = uDers.TalepId
                 and   talep.AdayId = uDers.AdayId
                 and   uDers.EgitimTipiId = 4 -- Başarısız Aday Eğitimi
		     )
          where 0 = 0
          and @FirmId = talep.FirmId 
          --and @TalepId = talep.Id
          and ( talep.KayitTipiId = 2 or talep.KayitTipiId = 3 ) 
          and ( talep.TalepTipiId = 1 or talep.TalepTipiId = 2 or talep.TalepTipiId = 3 ) 
          Group by  uDers.EgitimYeriTipiId, talep.Id, uDers.DersTarihi 

    ) as y -- select
    Group by y.TalepId, y.DersNo
	--Order by y.DersNo desc
  ) -- With
  --select * from BasarisizDersToplami where UygulamaliDersToplami > 0
  Update takip
  Set BasarisizDersNo        = x.DersNo 
    , BasarisizBaslamaTarihi = x.UygulamaBaslamaTarihi
    , BasarisizBitisTarihi   = x.UygulamaBitisTarihi
	, BasarisizDersToplami   = x.UygulamaliDersToplami 
  FROM dbo.MtskAdayTakip as takip
  JOIN BasarisizDersToplami as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and ( isnull(takip.BasarisizBaslamaTarihi,''19000101'') <> isnull(x.UygulamaBaslamaTarihi,''19000101'') 
  or    isnull(takip.BasarisizBitisTarihi,''19000101'')   <> isnull(x.UygulamaBitisTarihi,''19000101'')
  or   ( isnull(takip.BasarisizDersNo,0) <> isnull(x.DersNo,0) )--and isnull(takip.BasarisizDersNo,0) < isnull(x.DersNo,0) )
  or    isnull(takip.BasarisizDersToplami,0) <> isnull(x.UygulamaliDersToplami,0)
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipUygDers'
  or  @Kim = 'MtskAdayTakipUygSinav'
  )
  begin
      print 'BasarisizDersToplami'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --

  Set @Sql = '
--@Header
  ;WITH DersKredileriVeMebbis AS (
      Select 
	    u.TalepId 
	  , (case when sum(u.UygulamaDersMebbisToplami) > 0 and sum(u.UygulamaDersMebbisToplami) = u.UygulamaliDersKredisi then 1 else 0 end) as IsUygulamaliDersMebbis
	  , (case when sum(u.UygulamaliDersToplami) > 0 and sum(u.UygulamaliDersToplami) = u.UygulamaliDersKredisi then 1 else 0 end) as IsUygulamaliDersPlanli
	  , (case when sum(u.Arti4DersMebbisToplami) > 0 and sum(u.Arti4DersMebbisToplami) = u.Arti4DersKredisi then 1 else 0 end) as IsArti4DersMebbis
	  , (case when sum(u.Arti4DersToplami) > 0 and sum(u.Arti4DersToplami) = u.Arti4DersKredisi then 1 else 0 end) as IsArti4DersPlanli
	  , (case when sum(u.TelafiDersMebbisToplami) > 0 and sum(u.TelafiDersMebbisToplami) = u.TelafiDersKredisi then 1 else 0 end) as IsTelafiDersMebbis
	  , (case when sum(u.TelafiDersToplami) > 0 and sum(u.TelafiDersToplami) = u.TelafiDersKredisi then 1 else 0 end) as IsTelafiDersPlanli
	  , (case when sum(u.BasarisizDersMebbisToplami) > 0 and sum(u.BasarisizDersMebbisToplami) = u.BasarisizDersKredisi then 1 else 0 end) as IsBasarisizDersMebbis
	  , (case when sum(u.BasarisizDersToplami) > 0 and sum(u.BasarisizDersToplami) = u.BasarisizDersKredisi then 1 else 0 end) as IsBasarisizDersPlanli
      From (
          -- -----------------------------------------------------------------
          -- IsUygulamaliDersMebbis
          -- -----------------------------------------------------------------
	      -- Normal uygulama eğitimi : Başlama, bitiş ve toplam ders sayısı
          Select takip.TalepId 
          , count(uDers.Id) as UygulamaliDersToplami
          , 0 as UygulamaDersMebbisToplami  
		  , takip.UygulamaliDersKredisi
          , 0 as Arti4DersToplami
          , 0 as Arti4DersMebbisToplami  
		  , takip.Arti4DersKredisi
          , 0 as TelafiDersToplami
          , 0 as TelafiDersMebbisToplami  
		  , takip.TelafiDersKredisi
          , 0 as BasarisizDersToplami
          , 0 as BasarisizDersMebbisToplami  
		  , takip.BasarisizDersKredisi
          From dbo.MtskAdayTakip as takip 
		     left outer join dbo.MtskUygulamaliDers as uDers on (
                        takip.TalepId = uDers.TalepId
		          and   uDers.FirmId = @FirmId   
                  --and @TalepId = takip.TalepId
                  and   uDers.IsActive = 1
                  and   uDers.DersSaatiTipiId >= 0 -- tüm saatler planlanmış olsun
                  and   uDers.DersSaatiTipiId <= 15-- tüm saatler planlanmış olsun
                  and   uDers.EgitimTipiId = 1     -- Normal eğitim
          )
          where @FirmId = takip.FirmId   
          --and @TalepId = takip.TalepId
          and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
          and takip.TalepTipiId = 1 
    	  Group by
              takip.TalepId
             ,takip.UygulamaliDersKredisi
             ,takip.Arti4DersKredisi
             ,takip.TelafiDersKredisi
             ,takip.BasarisizDersKredisi

          union all 

          Select takip.TalepId 
          , 0 as UygulamaliDersToplami
          , count(uDers.Id) as UygulamaDersMebbisToplami  
		  , takip.UygulamaliDersKredisi
          , 0 as Arti4DersToplami
          , 0 as Arti4DersMebbisToplami  
		  , takip.Arti4DersKredisi
          , 0 as TelafiDersToplami
          , 0 as TelafiDersMebbisToplami  
		  , takip.TelafiDersKredisi
          , 0 as BasarisizDersToplami
          , 0 as BasarisizDersMebbisToplami  
		  , takip.BasarisizDersKredisi
          From dbo.MtskAdayTakip as takip
		     left outer join dbo.MtskUygulamaliDers as uDers on (
                        takip.TalepId = uDers.TalepId
                  and   uDers.FirmId = @FirmId   
                  --and @TalepId = takip.TalepId
                  and   uDers.IsActive = 1
                  and   uDers.UDersIsUploaded = 1  -- Mebbise yüklenmiş
                  and   uDers.EgitimTipiId = 1     -- Normal eğitim
             ) 
          where @FirmId = takip.FirmId   
          --and @TalepId = takip.TalepId
          and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
          and takip.TalepTipiId = 1 
    	  Group by
              takip.TalepId
             ,takip.UygulamaliDersKredisi
             ,takip.Arti4DersKredisi
             ,takip.TelafiDersKredisi
             ,takip.BasarisizDersKredisi
			 
          union all
          -- -----------------------------------------------------------------
          -- IsArti4DersMebbis
          -- -----------------------------------------------------------------
	      -- 2. +4 hak eğitimi : Başlama, bitiş ve toplam ders sayısı
          Select takip.TalepId 
          , 0 as UygulamaliDersToplami
          , 0 as UygulamaDersMebbisToplami  
		  , takip.UygulamaliDersKredisi
          , count(uDers.Id) as Arti4DersToplami
          , 0 as Arti4DersMebbisToplami  
		  , takip.Arti4DersKredisi
          , 0 as TelafiDersToplami
          , 0 as TelafiDersMebbisToplami  
		  , takip.TelafiDersKredisi
          , 0 as BasarisizDersToplami
          , 0 as BasarisizDersMebbisToplami  
		  , takip.BasarisizDersKredisi
          From dbo.MtskAdayTakip as takip 
		     left outer join dbo.MtskUygulamaliDers as uDers on (
                        takip.TalepId = uDers.TalepId
		          and   uDers.FirmId = @FirmId   
                  --and @TalepId = takip.TalepId
                  and   uDers.IsActive = 1
                  and   uDers.DersSaatiTipiId >= 0 -- tüm saatler planlanmış olsun
                  and   uDers.DersSaatiTipiId <= 15-- tüm saatler planlanmış olsun
                  and   uDers.EgitimTipiId = 3     -- 2. 4 hak eğitim
          )
          where @FirmId = takip.FirmId   
          --and @TalepId = takip.TalepId
          and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
          and ( takip.TalepTipiId = 2 or takip.TalepTipiId = 3 )
    	  Group by
              takip.TalepId
             ,takip.UygulamaliDersKredisi
             ,takip.Arti4DersKredisi
             ,takip.TelafiDersKredisi
             ,takip.BasarisizDersKredisi

          union all 

          Select takip.TalepId 
          , 0 as UygulamaliDersToplami
          , 0 as UygulamaDersMebbisToplami  
		  , takip.UygulamaliDersKredisi
          , 0 as Arti4DersToplami
          , count(uDers.Id) as Arti4DersMebbisToplami  
		  , takip.Arti4DersKredisi
          , 0 as TelafiDersToplami
          , 0 as TelafiDersMebbisToplami  
		  , takip.TelafiDersKredisi
          , 0 as BasarisizDersToplami
          , 0 as BasarisizDersMebbisToplami  
		  , takip.BasarisizDersKredisi
          From dbo.MtskAdayTakip as takip
		     left outer join dbo.MtskUygulamaliDers as uDers on (
                        takip.TalepId = uDers.TalepId
                  and   uDers.FirmId = @FirmId   
                  --and @TalepId = takip.TalepId
                  and   uDers.IsActive = 1
                  and   uDers.UDersIsUploaded = 1  -- Mebbise yüklenmiş
                  and   uDers.EgitimTipiId = 3     -- 2. +4 hak eğitim
             ) 
          where @FirmId = takip.FirmId   
          --and @TalepId = takip.TalepId
          and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
          and ( takip.TalepTipiId = 2 or takip.TalepTipiId = 3 )
    	  Group by
              takip.TalepId
             ,takip.UygulamaliDersKredisi
             ,takip.Arti4DersKredisi
             ,takip.TelafiDersKredisi
             ,takip.BasarisizDersKredisi

          union all 
          -- -----------------------------------------------------------------
          -- IsTelafiDersMebbis
          -- -----------------------------------------------------------------
          -- Telafi dersleri planlandı mı?, Mebbise yüklendi mi?
          Select takip.TalepId 
          , 0 as UygulamaliDersToplami
          , 0 as UygulamaDersMebbisToplami  
		  , takip.UygulamaliDersKredisi
          , 0 as Arti4DersToplami
          , 0 as Arti4DersMebbisToplami  
		  , takip.Arti4DersKredisi
          , count(uDers.Id) as TelafiDersToplami
          , 0 as TelafiDersMebbisToplami  
		  , takip.TelafiDersKredisi
          , 0 as BasarisizDersToplami
          , 0 as BasarisizDersMebbisToplami  
		  , takip.BasarisizDersKredisi
          From dbo.MtskAdayTakip as takip 
		     left outer join dbo.MtskUygulamaliDers as uDers on (
                        takip.TalepId = uDers.TalepId
		          and   uDers.FirmId = @FirmId   
                  --and @TalepId = takip.TalepId
                  and   uDers.IsActive = 1
                  and   uDers.DersSaatiTipiId >= 0 -- tüm saatler planlanmış olsun
                  and   uDers.DersSaatiTipiId <= 15-- tüm saatler planlanmış olsun
                  and   uDers.EgitimTipiId = 2     -- Telafi Eğitim(Ön Sınav )
          )
          where @FirmId = takip.FirmId   
          --and @TalepId = takip.TalepId
          and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
          and takip.TalepTipiId < 4
    	  Group by
              takip.TalepId
             ,takip.UygulamaliDersKredisi
             ,takip.Arti4DersKredisi
             ,takip.TelafiDersKredisi
             ,takip.BasarisizDersKredisi

          union all 

          Select takip.TalepId 
          , 0 as UygulamaliDersToplami
          , 0 as UygulamaDersMebbisToplami  
		  , takip.UygulamaliDersKredisi
          , 0 as Arti4DersToplami
          , 0 as Arti4DersMebbisToplami  
		  , takip.Arti4DersKredisi
          , 0 as TelafiDersToplami
          , count(uDers.Id) as TelafiDersMebbisToplami  
		  , takip.TelafiDersKredisi
          , 0 as BasarisizDersToplami
          , 0 as BasarisizDersMebbisToplami  
		  , takip.BasarisizDersKredisi
          From dbo.MtskAdayTakip as takip
		     left outer join dbo.MtskUygulamaliDers as uDers on (
                        takip.TalepId = uDers.TalepId
                  and   uDers.FirmId = @FirmId   
                  --and @TalepId = takip.TalepId
                  and   uDers.IsActive = 1
                  and   uDers.UDersIsUploaded = 1  -- Mebbise yüklenmiş
                  and   uDers.EgitimTipiId = 2     -- Telafi Eğitim(Ön Sınav )
             ) 
          where @FirmId = takip.FirmId   
          --and @TalepId = takip.TalepId
          and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
          and takip.TalepTipiId < 4
    	  Group by
              takip.TalepId
             ,takip.UygulamaliDersKredisi
             ,takip.Arti4DersKredisi
             ,takip.TelafiDersKredisi
             ,takip.BasarisizDersKredisi

          union all 
          -- -----------------------------------------------------------------
          -- IsBasarisizDersMebbis
          -- -----------------------------------------------------------------
          -- Başarısız aday dersleri planlandı mı?, Mebbise yüklendi mi?
          Select takip.TalepId 
          , 0 as UygulamaliDersToplami
          , 0 as UygulamaDersMebbisToplami  
		  , takip.UygulamaliDersKredisi
          , 0 as Arti4DersToplami
          , 0 as Arti4DersMebbisToplami  
		  , takip.Arti4DersKredisi
          , 0 as TelafiDersToplami
          , 0 as TelafiDersMebbisToplami  
		  , takip.TelafiDersKredisi
          , count(uDers.Id) as BasarisizDersToplami
          , 0 as BasarisizDersMebbisToplami  
		  , takip.BasarisizDersKredisi
          From dbo.MtskAdayTakip as takip 
		     left outer join dbo.MtskUygulamaliDers as uDers on (
                        takip.TalepId = uDers.TalepId
		          and   uDers.FirmId = @FirmId   
                  --and @TalepId = takip.TalepId
                  and   uDers.IsActive = 1
                  and   uDers.DersSaatiTipiId >= 0 -- tüm saatler planlanmış olsun
                  and   uDers.DersSaatiTipiId <= 15-- tüm saatler planlanmış olsun
                  and   uDers.EgitimTipiId = 4     -- Başarısız Aday Eğitimi
          )
          where @FirmId = takip.FirmId   
          --and @TalepId = takip.TalepId
          and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
          and takip.TalepTipiId < 4
    	  Group by
              takip.TalepId
             ,takip.UygulamaliDersKredisi
             ,takip.Arti4DersKredisi
             ,takip.TelafiDersKredisi
             ,takip.BasarisizDersKredisi

          union all 

          Select takip.TalepId 
          , 0 as UygulamaliDersToplami
          , 0 as UygulamaDersMebbisToplami  
		  , takip.UygulamaliDersKredisi
          , 0 as Arti4DersToplami
          , 0 as Arti4DersMebbisToplami  
		  , takip.Arti4DersKredisi
          , 0 as TelafiDersToplami
          , 0 as TelafiDersMebbisToplami  
		  , takip.TelafiDersKredisi
          , 0 as BasarisizDersToplami
          , count(uDers.Id) as BasarisizDersMebbisToplami  
		  , takip.BasarisizDersKredisi
          From dbo.MtskAdayTakip as takip
		     left outer join dbo.MtskUygulamaliDers as uDers on (
                        takip.TalepId = uDers.TalepId
                  and   uDers.FirmId = @FirmId   
                  --and @TalepId = takip.TalepId
                  and   uDers.IsActive = 1
                  and   uDers.UDersIsUploaded = 1  -- Mebbise yüklenmiş
                  and   uDers.EgitimTipiId = 4     -- Başarısız Aday Eğitimi
             ) 
          where @FirmId = takip.FirmId   
          --and @TalepId = takip.TalepId
          and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
          and takip.TalepTipiId < 4
    	  Group by
              takip.TalepId
             ,takip.UygulamaliDersKredisi
             ,takip.Arti4DersKredisi
             ,takip.TelafiDersKredisi
             ,takip.BasarisizDersKredisi

   ) as u
   group by u.TalepId
   , u.UygulamaliDersKredisi
   , u.Arti4DersKredisi
   , u.TelafiDersKredisi
   , u.BasarisizDersKredisi

  ) -- With
  Update takip
  Set IsUygulamaliDersMebbis = x.IsUygulamaliDersMebbis
    , IsUygulamaliDersPlanli = x.IsUygulamaliDersPlanli
    , IsArti4DersMebbis = x.IsArti4DersMebbis
    , IsArti4DersPlanli = x.IsArti4DersPlanli
    , IsTelafiDersMebbis = x.IsTelafiDersMebbis
    , IsTelafiDersPlanli = x.IsTelafiDersPlanli
    , IsBasarisizDersMebbis = x.IsBasarisizDersMebbis
    , IsBasarisizDersPlanli = x.IsBasarisizDersPlanli
  FROM dbo.MtskAdayTakip as takip
  JOIN DersKredileriVeMebbis as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and takip.TalepId = x.TalepId
  and ( isnull(takip.IsUygulamaliDersMebbis,0) <> isnull(x.IsUygulamaliDersMebbis,0) 
  or    isnull(takip.IsUygulamaliDersPlanli,0) <> isnull(x.IsUygulamaliDersPlanli,0)
  or    isnull(takip.IsArti4DersMebbis,0) <> isnull(x.IsArti4DersMebbis,0) 
  or    isnull(takip.IsArti4DersPlanli,0) <> isnull(x.IsArti4DersPlanli,0)
  or    isnull(takip.IsTelafiDersMebbis,0) <> isnull(x.IsTelafiDersMebbis,0) 
  or    isnull(takip.IsTelafiDersPlanli,0) <> isnull(x.IsTelafiDersPlanli,0)
  or    isnull(takip.IsBasarisizDersMebbis,0) <> isnull(x.IsBasarisizDersMebbis,0) 
  or    isnull(takip.IsBasarisizDersPlanli,0) <> isnull(x.IsBasarisizDersPlanli,0)
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print LEN(@Sql)

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'DersKredileriVeMebbis'
      EXEC sp_executesql @Sql
  end



  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.UygulamaDersTipiId 
  -- -----------------------------------------------------------------
  -- 0,    Tanımsız
  -- 1,    Uygulamalı dersler planlanacak
  -- 2,    Uygulamalı dersler planlandı, Mebbise aktarılacak
  -- 3,    Uygulamalı dersler Mebbise aktarıldı
  -- 4,    Uygulamalı dersleri başladı 
  -- 5,    Uygulamalı dersleri tamamladı 
  -- 6, 	Uyg. planı yok. Sınav aşamasına geçmiş
  -- 'Uygulamalı derslerin durumları nedir ?'

  Set @Sql = '
--@Header
  ;WITH UygulamaliDersTipi AS (
           Select takip.TalepId as TalepId
		 , ( case
			 when takip.UygulamaBaslamaTarihi <= @bugun and takip.UygulamaBitisTarihi < @bugun then 5 -- Uygulamalı dersleri tamamladı
			 when takip.UygulamaBaslamaTarihi <= @bugun and takip.UygulamaBitisTarihi > @bugun then 4 -- Uygulamalı dersleri başladı
			 when takip.IsUygulamaliDersMebbis = 1 and takip.UygulamaBaslamaTarihi >  @bugun then 3 -- Uygulamalı dersler Mebbise aktarıldı, ders başlamadı
		     when takip.IsUygulamaliDersMebbis = 0 and takip.IsUygulamaliDersPlanli = 1 then 2 -- Uygulamalı dersler planlandı, Mebbise aktarılacak

		     when ( takip.eSinavDurumTipiId = 6     -- Muaf
			     or takip.eSinavSonrasiTipiId = 2 ) -- Uygulama aşamasına geçti
			 and isnull(takip.IsUygulamaliDersMebbis,0) = 0 
			 and isnull(takip.IsUygulamaliDersPlanli,0) = 0 then 1 -- Uygulamalı dersler planlanacak 

		     when ( takip.eSinavDurumTipiId <> 6     -- Muaf
                and takip.eSinavSonrasiTipiId <> 2 ) -- Uygulama aşamasına geçti

			 then 0 -- Tanımsız
			 when takip.IsUygulamaliDersPlanli = 0 and isnull(takip.uSinavSonrasiTipiId,0) > 0 then 6 -- Uyg. ders yok. sınav aşamasına geçmiş 
             else isnull(takip.UygulamaliDersTipiId,0) end ) as UygulamaliDersTipiId -- null sa 0 yazıyor
         From MtskAdayTakip as takip
         Where @FirmId = takip.FirmId 
		 --and @TalepId = takip.TalepId
         --and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
         and   takip.KayitTipiId < 4 
         and takip.TalepTipiId = 1
  ) -- With
  Update takip
  Set UygulamaliDersTipiId = x.UygulamaliDersTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN UygulamaliDersTipi as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and isnull(takip.UygulamaliDersTipiId,-1) <> isnull(x.UygulamaliDersTipiId,0) 
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader + @SqlBugun)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipESinav'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'UygulamaliDersTipi'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.Arti4DersTipiId 
  -- -----------------------------------------------------------------
  -- 0,   Tanımsız
  -- 1,   2. +4 hak dersleri planlanacak
  -- 2,   2. +4 hak dersleri planlandı, Mebbise aktarılacak
  -- 3,   2. +4 hak dersleri Mebbise aktarıldı
  -- 4,   2. +4 hak dersleri başladı
  -- 5,   2. +4 hak dersleri tamamlandı
  -- 6,   2. +4 planı yok. Sınav aşamasına geçmiş
  -- '2. +4 hak uygulamalı derslerin durumları nedir ?'

  Set @Sql = '
--@Header
  ;WITH Arti4DersTipi AS (
           Select takip.TalepId as TalepId
		 , ( case
			 when takip.Arti4BaslamaTarihi <= @bugun and takip.Arti4BitisTarihi < @bugun then 5 -- 2. +4 dersleri tamamladı
			 when takip.Arti4BaslamaTarihi <= @bugun and takip.Arti4BitisTarihi > @bugun then 4 -- 2. +4 dersleri başladı
			 when takip.IsArti4DersMebbis = 1 and takip.Arti4BaslamaTarihi >  @bugun then 3 -- 2. +4 dersler Mebbise aktarıldı, ders başlamadı
		     when takip.IsArti4DersMebbis = 0 and takip.IsArti4DersPlanli = 1 then 2 -- 2. +4 dersler planlandı, Mebbise aktarılacak
		     when ( takip.eSinavDurumTipiId = 6     -- Muaf
			     or takip.eSinavSonrasiTipiId = 2 ) -- Uygulama aşamasına geçti
			 and takip.IsArti4DersMebbis = 0 
			 and takip.IsArti4DersPlanli = 0 then 1 -- 2. +4 dersler planlanacak 
			 when takip.IsArti4DersPlanli = 0 and isnull(takip.uSinavSonrasiTipiId,0) > 0 then 6 -- 2. +4 ders yok. sınav aşamasına geçmiş 
             else isnull(takip.Arti4DersTipiId,0) end ) as Arti4DersTipiId -- null sa 0 yazıyor
         From MtskAdayTakip as takip
         Where @FirmId = takip.FirmId 
		 --and @TalepId = takip.TalepId
         --and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
         and   takip.KayitTipiId < 4
         and ( takip.TalepTipiId = 2 or takip.TalepTipiId = 3 )
  ) -- With
  Update takip
  Set Arti4DersTipiId = x.Arti4DersTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN Arti4DersTipi as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and isnull(takip.Arti4DersTipiId,-1) <> isnull(x.Arti4DersTipiId,0) 
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader + @SqlBugun)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'Arti4DersTipi'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.TelafiDersTipiId 
  -- -----------------------------------------------------------------
  -- 0,  ''
  -- 1,  2 saat telafi eğitimi planlanacak
  -- 2,  2 saat telafi eğitimi planlandı, Mebbise aktarılacak
  -- 3,  2 saat telafi eğitimi Mebbise aktarıldı
  -- 4,  2 saat telafi eğitimi alıyor
  -- 5,  2 saat telafi aday eğitimi tamamlandı
  -- 'Telafi derslerin durumları nedir ?'

  Set @Sql = '
--@Header
  ;WITH TelafiDersTipi AS (
           Select takip.TalepId as TalepId
		 , ( case
			 when takip.TelafiBaslamaTarihi <= @bugun and takip.TelafiBitisTarihi < @bugun then 5 -- telafi dersleri tamamladı
			 when takip.TelafiBaslamaTarihi <= @bugun and takip.TelafiBitisTarihi > @bugun then 4 -- telafi dersleri başladı
			 when takip.IsTelafiDersMebbis = 1 and takip.TelafiBaslamaTarihi >  @bugun then 3 -- telafi dersler Mebbise aktarıldı, ders başlamadı
		     when takip.IsTelafiDersMebbis = 0 and takip.IsTelafiDersPlanli = 1 then 2 -- telafi dersler planlandı, Mebbise aktarılacak
		     when ( takip.eSinavDurumTipiId = 6     -- Muaf
			     or takip.eSinavSonrasiTipiId = 2 ) -- Uygulama aşamasına geçti
			 and takip.IsTelafiDersMebbis = 0 
			 and takip.IsTelafiDersPlanli = 0 then 0 -- şimdilik sıfır aslında başka bir şartla telafi alacak fakat hangi şartla ?, başarısızdaki şart uygulama sınavından kalınca
			 --and takip.IsTelafiDersPlanli = 0 then 1 -- telafi dersler planlanacak 
             else isnull(takip.TelafiDersTipiId,0) end ) as TelafiDersTipiId -- null sa 0 yazıyor
         From MtskAdayTakip as takip
         Where @FirmId = takip.FirmId 
		 --and @TalepId = takip.TalepId
         --and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
         and   takip.KayitTipiId < 4
         and takip.TalepTipiId < 4
  ) -- With
  Update takip
  Set TelafiDersTipiId = x.TelafiDersTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN TelafiDersTipi as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and isnull(takip.TelafiDersTipiId,-1) <> isnull(x.TelafiDersTipiId,0) 
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader + @SqlBugun)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'TelafiDersTipi'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.BasarisizDersTipiId 
  -- -----------------------------------------------------------------
  -- 0,  ''
  -- 1,  2 saat başarısız aday eğitimi planlanacak
  -- 2,  2 saat başarısız aday eğitimi planlandı, Mebbise aktarılacak
  -- 3,  2 saat başarısız aday eğitimi Mebbise aktarıldı
  -- 4,  2 saat başarısız aday eğitimi alıyor
  -- 5,  2 saat başarısız aday eğitimi tamamlandı
  -- 6,  Eğitime gerek yok (Sınava girmedi)
  -- 'Başarısız adayların uygulamalı derslerin durumları nedir ?'

  Set @Sql = '
--@Header
  ;WITH BasarisizDersTipi AS (
           Select takip.TalepId as TalepId
		 , ( case
			 when takip.BasarisizBaslamaTarihi <= @bugun and takip.BasarisizBitisTarihi < @bugun then 5 -- başarısız dersleri tamamladı
			 when takip.BasarisizBaslamaTarihi <= @bugun and takip.BasarisizBitisTarihi > @bugun then 4 -- başarısız dersleri başladı
			 when takip.IsBasarisizDersMebbis = 1 and takip.BasarisizBaslamaTarihi >  @bugun then 3 -- başarısız dersler Mebbise aktarıldı, ders başlamadı
		     when takip.IsBasarisizDersMebbis = 0 and takip.IsBasarisizDersPlanli = 1 then 2 -- başarısız dersler planlandı, Mebbise aktarılacak

		     when ( takip.eSinavDurumTipiId = 6     -- Muaf
			     or takip.eSinavSonrasiTipiId = 2 ) -- Uygulama aşamasına geçti
			 and takip.IsBasarisizDersMebbis = 0 
			 and takip.IsBasarisizDersPlanli = 0 
			 and takip.BasarisizDersTipiId <> 1
			 and takip.BasarisizDersTipiId <> 6
			 then 0 -- başarısızdaki şart uygulama sınavından kalınca ya 1 , yada 6 atanıyor
             else isnull(takip.BasarisizDersTipiId,0) end ) as BasarisizDersTipiId -- null sa 0 yazıyor

         From MtskAdayTakip as takip
         Where @FirmId = takip.FirmId 
		 --and @TalepId = takip.TalepId
         --and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
         and   takip.KayitTipiId < 4
         and takip.TalepTipiId < 4
  ) -- With
  --select * from BasarisizDersTipi --where TelafiDersTipiId > 0 
  Update takip
  Set BasarisizDersTipiId = x.BasarisizDersTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN BasarisizDersTipi as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and isnull(takip.BasarisizDersTipiId,-1) <> isnull(x.BasarisizDersTipiId,0) 
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader + @SqlBugun)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'BasarisizDersTipi'
      EXEC sp_executesql @Sql
  end



  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.uSinavaHazirmiTipiId
  -- MtskAdayTakip.IsUygSinavMebbisOnayi
  -- -----------------------------------------------------------------

  Set @Sql = '
--@Header
  ;WITH uSinavaHazirmiTipi AS (
    Select takip.TalepId as TalepId
    , ( case
         when @settingsAdayHazirMi = 0 then 1 -- Evet hazır
         when @settingsAdayHazirMi = 1 and takip.TalepTipiId <> 1 then 1 -- Evet hazır (2. +4hak veya Nakil 2.+4hak ise)
         when @settingsAdayHazirMi = 1 and takip.TalepTipiId = 1 and takip.uSinavaHazirmiTipiId is null then 0
         else takip.uSinavaHazirmiTipiId end ) as yeniuSinavaHazirmiTipiId 
    , ( case
         when @settingsAdayHazirMi = 0 then 1 -- onayla
         when @settingsAdayHazirMi = 1 and takip.TalepTipiId <> 1 then 1 -- onayla (2. +4hak veya Nakil 2.+4hak ise)
         else takip.IsUygSinavMebbisOnayi end ) as yeniIsUygSinavMebbisOnayi 

    From MtskAdayTakip as takip
    Where @FirmId = takip.FirmId 
	--and @TalepId = takip.TalepId
    and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
    and takip.TalepTipiId < 4
  ) -- With
  Update takip
  Set uSinavaHazirmiTipiId = x.yeniuSinavaHazirmiTipiId
  ,   IsUygSinavMebbisOnayi = x.yeniIsUygSinavMebbisOnayi
  FROM dbo.MtskAdayTakip as takip
  JOIN uSinavaHazirmiTipi as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and ( isnull(takip.uSinavaHazirmiTipiId,0) <> x.yeniuSinavaHazirmiTipiId
  or    isnull(takip.IsUygSinavMebbisOnayi,0) <> x.yeniIsUygSinavMebbisOnayi  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader + @SqlSettings)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipUygDers'
  )
  begin
      print 'uSinavaHazirmiTipi' 
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipRandevu
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.Randevu
  -- -----------------------------------------------------------------

  Set @Sql = '
--@Header
  ;WITH uSinavRandevular AS (
    Select t.FirmId, t.TalepId
    , isnull(rande.Id,0) as yeniRandevuId  
    , (case 
	   when isnull(rande.Id,0) > 0 and LEN(rande.EgitimAraciId) > 0 then 1 else 0 end ) yeniIsRandevuPlanlandi
    , isnull(rande.IsMebbisUploaded,0) as yeniIsRandevuMebbis 
    , rande.Tarih as yeniRandevuTarihi
    , rande.SaatTipiId as yeniRandevuSaatTipiId
    , rande.EgitimAraciId as yeniRandevuEgitimAraciId
    , rande.PersonelId1 as yeniRandevuPersonelId
    , dbo.fnc_getEUSinavNo(t.TalepId , ''YeniUSinavNo'') as yeniSinavNo

	From dbo.MtskAdayTakip as t 
    left join dbo.MtskSinavRandevu  as rande on ( t.TalepId = rande.TalepId and rande.SinavNo = dbo.fnc_getEUSinavNo(t.TalepId , ''YeniUSinavNo'') )
    Where @FirmId = t.FirmId
	--and @TalepId = t.TalepId
    --and ( t.KayitTipiId = 2 or t.KayitTipiId = 3 )
    and   t.KayitTipiId < 4
  ) -- With
  --Select * from uSinavRandevular
  Update t
  Set  uSinavNo = x.yeniSinavNo
      ,IsRandevuPlanlandi = x.yeniIsRandevuPlanlandi
      ,IsRandevuMebbis = x.yeniIsRandevuMebbis
      ,RandevuTarihi = x.yeniRandevuTarihi
      ,RandevuSaatTipiId = x.yeniRandevuSaatTipiId
      ,RandevuEgitimAraciId = x.yeniRandevuEgitimAraciId
      ,RandevuPersonelId = x.yeniRandevuPersonelId

  FROM dbo.MtskAdayTakip as t
  JOIN uSinavRandevular as x ON ( t.TalepId = x.TalepId )
  Where 0 = 0
  and (
      t.uSinavNo <> x.yeniSinavNo
  or  t.IsRandevuPlanlandi <> x.yeniIsRandevuPlanlandi
  or  t.IsRandevuMebbis <> x.yeniIsRandevuMebbis
  or  t.RandevuTarihi <> x.yeniRandevuTarihi
  or  t.RandevuSaatTipiId <> x.yeniRandevuSaatTipiId
  or  t.RandevuEgitimAraciId <> x.yeniRandevuEgitimAraciId
  or  t.RandevuPersonelId <> x.yeniRandevuPersonelId
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipRandevu'
  or  @Kim = 'MtskAdayTakipUygSinav'
  )
  begin
      print 'uSinavRandevular'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygSinav
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.uSinavSonucTipiId
  -- -----------------------------------------------------------------

  Set @Sql = '
--@Header
  ;WITH UygulamaliSinavlar AS (
    Select t.FirmId, t.TalepId
    , isnull(uSinav.SinavNo,0) as yeniuSinavNoGirdigi
    , (case 
	   when uSinav.PuanTipiId =  -2 then 0
	   when uSinav.PuanTipiId =  -1 then 3
	   when uSinav.PuanTipiId =   0 then 0
	   when uSinav.PuanTipiId =   1 then 2
	   when uSinav.PuanTipiId = 100 then 1
	   else 0 end ) as yeniuSinavSonucTipiId

    , (case 
       when isnull(uSinav.Id,0) = 0 then 0 -- tanımsız
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = 100) then 2 -- Sertifika aşamasına geçti
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) =  1) and (uSinav.SinavNo  < 4) then 1 -- başarısız, Tekrar sınava girecek
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = -1) and (uSinav.SinavNo  < 4) then 1 -- sınava girmedi, Tekrar sınava girecek
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = -2) and (uSinav.SinavNo  < 4) then 0 -- sonuç girilmedi, tanımsız
       -- başarısız
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) =  1) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 1) then 3 -- Tüm uygulamalı sınav hakkı bitti
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) =  1) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 2) then 4 -- 2. +4 sınav hakkı bitti
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) =  1) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 3) then 4 -- 2. +4 sınav hakkı bitti
       -- sınava girmedi
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = -1) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 1) then 3 -- Tüm uygulamalı sınav hakkı bitti
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = -1) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 2) then 4 -- 2. +4 sınav hakkı bitti
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = -1) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 3) then 4 -- 2. +4 sınav hakkı bitti
       -- sonuç girilmedi
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = -2) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 1) then 0 -- tanımsız
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = -2) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 2) then 0 -- tanımsız
       when isnull(uSinav.Id,0) > 0 and (isnull(uSinav.PuanTipiId,0) = -2) and (uSinav.SinavNo >= 4) and (t.TalepTipiId = 3) then 0 -- tanımsız
	   end ) as yeniuSinavSonrasiTipiId

    , ( case when isnull(uSinav.Id,0) > 0 then uSinav.Id else 0 end ) as yeniuSinavDetayId
    , ( case when isnull(uSinav.Id,0) > 0 then uSinav.SinavTarihi end ) as yeniuSinavBasariTarihi

	From dbo.MtskAdayTakip as t 
    left join dbo.MtskSinavUygulama as uSinav on ( t.TalepId = uSinav.TalepId and uSinav.SinavNo = dbo.fnc_getEUSinavNo(t.TalepId , ''GirdigiUSinavNo'') )

    Where @FirmId = t.FirmId
	--and @TalepId = t.TalepId
    --and ( t.KayitTipiId = 2 or t.KayitTipiId = 3  or t.KayitTipiId = 4 )
    and   t.KayitTipiId <= 4
  ) -- With
  --Select * from UygulamaliSinavlar
  Update t
  Set  uSinavNoGirdigi = x.yeniuSinavNoGirdigi
      ,uSinavSonucTipiId = x.yeniuSinavSonucTipiId
      ,uSinavSonrasiTipiId = x.yeniuSinavSonrasiTipiId
      ,uSinavDetayId = x.yeniuSinavDetayId
      ,uSinavBasariTarihi = x.yeniuSinavBasariTarihi
  FROM dbo.MtskAdayTakip as t
  JOIN UygulamaliSinavlar as x ON ( t.TalepId = x.TalepId )
  Where 0 = 0
  and (
      isnull(t.uSinavNoGirdigi,-1) <> x.yeniuSinavNoGirdigi
  or  isnull(t.uSinavSonucTipiId,-1) <> x.yeniuSinavSonucTipiId
  or  isnull(t.uSinavSonrasiTipiId,-1) <> x.yeniuSinavSonrasiTipiId
  or  isnull(t.uSinavDetayId,-1) <> x.yeniuSinavDetayId
  or  isnull(t.uSinavBasariTarihi,''19000101'') <> x.yeniuSinavBasariTarihi
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipUygSinav'
  )
  begin
      print 'UygulamaliSinavlar'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygSinav
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.uSinavDurumTipiId
  -- -----------------------------------------------------------------

  Set @Sql = '
--@Header
  ;WITH uSinavDurumTipi AS (
    Select 
        y.TalepId
      , y.yeniuSinavaHazirmiTipiId
      , y.yeniIsUygSinavMebbisOnayi
      , ( case 
    
	      /* sınav sonuçları */  
		  when t.uSinavSonucTipiId = 1 then 9 -- Başarılı, Sertifika aşamasına geçti
		  when t.uSinavSonucTipiId = 2 and t.uSinavSonrasiTipiId = 1 then 8   -- başarısız > Başarısız aday eğitimi alacak
		  when t.uSinavSonucTipiId = 3 and t.uSinavSonrasiTipiId = 1 and t.IsRandevuPlanlandi = 0 then 5   -- girmedi   > Uyg. sınav randevusu planlanacak
		  when ( t.uSinavSonucTipiId = 2 or t.uSinavSonucTipiId = 3 ) and t.uSinavSonrasiTipiId = 3 then 10  -- Uyg. sınav hakkı doldu
		  when ( t.uSinavSonucTipiId = 2 or t.uSinavSonucTipiId = 3 ) and t.uSinavSonrasiTipiId = 4 then 10  -- Uyg. sınav hakkı doldu

          /* Randevular */
          when (t.uSinavSonucTipiId = 0 or t.uSinavSonrasiTipiId = 1) and t.IsRandevuPlanlandi = 1 and t.IsRandevuMebbis = 0 then 6  -- Uyg. sınav randevusu MEBBİSe aktarılacak
		  when (t.uSinavSonucTipiId = 0 or t.uSinavSonrasiTipiId = 1) and t.IsRandevuPlanlandi = 1 and t.IsRandevuMebbis = 1 then 7  -- Uyg. sınavına girecek
		  when (t.uSinavSonucTipiId = 0 or t.uSinavSonrasiTipiId = 1) and t.IsRandevuPlanlandi = 0 and t.IsRandevuMebbis = 1 then 5  -- Uyg. sınav randevusu planlanacak
		  when (t.uSinavSonucTipiId = 0 or t.uSinavSonrasiTipiId = 1) and t.IsRandevuPlanlandi = 0 and t.IsRandevuMebbis = 0 and (t.uSinavDurumTipiId = 6 or t.uSinavDurumTipiId = 7 or t.uSinavDurumTipiId = 8) then 5  -- Uyg. sınav randevusu planlanacak ( Randevu silinmişse )
          
          /* Adayın sınava girişi usta öğreticiye sorulacaksa */
          /* UygulamaliDersTipiId = 0, 1, 2, 3, 4, 5  */
	      when @settingsAdayHazirMi = 1 and y.yeniuSinavaHazirmiTipiId = 0 and isnull(t.UygulamaliDersTipiId,-1) <  2 then 0 -- Tanımsız
	      when @settingsAdayHazirMi = 1 and y.yeniuSinavaHazirmiTipiId = 0 and t.UygulamaliDersTipiId >= 2 and t.UygulamaliDersTipiId <= 4 then 1 -- Henüz sınava aşamasında değil
	      when @settingsAdayHazirMi = 1 and y.yeniuSinavaHazirmiTipiId = 0 and t.UygulamaliDersTipiId = 5 then 2 -- Uyg. sınavı için usta öğretici onayı isteniyor
	      when @settingsAdayHazirMi = 1 and y.yeniuSinavaHazirmiTipiId = 2 and t.UygulamaliDersTipiId = 5 then 3 -- Uyg. sınavı için hazır değil
	      when @settingsAdayHazirMi = 1 and y.yeniuSinavaHazirmiTipiId = 1 and y.yeniIsUygSinavMebbisOnayi = 0 and t.UygulamaliDersTipiId = 5 then 4 -- Uyg. sınavı için MEBBİS de onaylanacak
	      when @settingsAdayHazirMi = 1 and y.yeniuSinavaHazirmiTipiId = 3 and y.yeniIsUygSinavMebbisOnayi = 0 and t.UygulamaliDersTipiId = 5 then 4 -- Uyg. sınavı için MEBBİS de onaylanacak
	      when @settingsAdayHazirMi = 1 and y.yeniuSinavaHazirmiTipiId = 1 and y.yeniIsUygSinavMebbisOnayi = 1 and t.UygulamaliDersTipiId = 5 and t.uSinavDurumTipiId < 5 then 5 -- Uyg. sınav randevusu planlanacak
	      when @settingsAdayHazirMi = 1 and y.yeniuSinavaHazirmiTipiId = 3 and y.yeniIsUygSinavMebbisOnayi = 1 and t.UygulamaliDersTipiId = 5 and t.uSinavDurumTipiId < 5 then 5 -- Uyg. sınav randevusu planlanacak

          --- Usta öğreticiye sorulmadan default Sınava hazır kabul edilecek 
	      when @settingsAdayHazirMi = 0 and y.yeniuSinavaHazirmiTipiId = 1 and isnull(t.UygulamaliDersTipiId,-1) <  2 then 0 -- Tanımsız
	      when @settingsAdayHazirMi = 0 and y.yeniuSinavaHazirmiTipiId = 1 and t.UygulamaliDersTipiId >= 2 and t.UygulamaliDersTipiId <= 4 then 1 -- Henüz sınava aşamasında değil
	      when @settingsAdayHazirMi = 0 and y.yeniuSinavaHazirmiTipiId = 1 and t.UygulamaliDersTipiId =  5 and t.uSinavDurumTipiId < 5 then 5 -- Uyg. sınav randevusu planlanacak
	      else t.uSinavDurumTipiId end
	  ) as yeniuSinavDurumTipiId
     , ( case 
		 when t.uSinavSonucTipiId = 0 and t.BasarisizDersTipiId =  1 then 0 -- bilgi girilmemiş
		 when t.uSinavSonucTipiId = 1 and t.BasarisizDersTipiId <> 0 then 0 -- başarılı ise
	     when t.uSinavSonucTipiId = 2 and t.BasarisizDersTipiId =  0 then 1 -- başarısız ise
		 when t.uSinavSonucTipiId = 3 and t.BasarisizDersTipiId <> 0 then 0 -- sınava girmediyse
		 else t.BasarisizDersTipiId end 
	  ) as yeniBasarisizDersTipiId

     , t.TalepTipiId
	 , dbo.fnc_getEUSinavNo(t.TalepId , ''YeniUSinavNo'') as YeniUSinavNo
	 --, dbo.fnc_getEUSinavNo(t.TalepId , ''GirdigiUSinavNo'') as GirdigiUSinavNo
	 --, t.KayitTipiId
	 --, t.UygulamaliDersTipiId
	 --, t.IsRandevuPlanlandi
	 --, t.IsRandevuMebbis
	 --, t.uSinavSonucTipiId
	 --, t.uSinavSonrasiTipiId
	From dbo.MtskAdayTakip as t 
	left join (
        /* uSinavaHazirmiTipiId : @settingsAdayHazirMi = 1 ise kullanıcı Id nin 1, 2 veya 3 olmasına karar verecek  */
        Select takip.TalepId as TalepId
        , ( case
             when @settingsAdayHazirMi = 0 then 1 -- Evet hazır
             when @settingsAdayHazirMi = 1 and takip.TalepTipiId <> 1 then 1 -- Evet hazır (2. +4hak veya Nakil 2.+4hak ise)
             when @settingsAdayHazirMi = 1 and takip.TalepTipiId = 1 and takip.uSinavaHazirmiTipiId is null then 0
             else takip.uSinavaHazirmiTipiId end ) as yeniuSinavaHazirmiTipiId 
        , ( case
             when @settingsAdayHazirMi = 0 then 1 -- onayla
             when @settingsAdayHazirMi = 1 and takip.TalepTipiId <> 1 then 1 -- onayla (2. +4hak veya Nakil 2.+4hak ise)
             else takip.IsUygSinavMebbisOnayi end ) as yeniIsUygSinavMebbisOnayi 
        From MtskAdayTakip as takip
        Where @FirmId = takip.FirmId 
        --and @TalepId = takip.TalepId
        --and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 or takip.KayitTipiId = 4) 
        and   takip.KayitTipiId <= 4
        and takip.TalepTipiId < 4
	) as y on ( t.TalepId = y.TalepId )
	Where y.TalepId is not null

  ) -- With
  --select * from uSinavDurumTipi
  Update takip
  Set uSinavDurumTipiId = x.yeniuSinavDurumTipiId
  ,   uSinavNo = x.YeniUSinavNo
  ,   BasarisizDersTipiId = x.yeniBasarisizDersTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN uSinavDurumTipi as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and ( isnull(takip.uSinavDurumTipiId,-1) <> x.yeniuSinavDurumTipiId
  or    isnull(takip.uSinavNo,-1) <> x.YeniUSinavNo  
  or    isnull(takip.BasarisizDersTipiId,0) <> x.yeniBasarisizDersTipiId 
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader + @SqlSettings)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipRandevu'
  or  @Kim = 'MtskAdayTakipUygSinav'
  )
  begin
      print 'uSinavDurumTipi'
      EXEC sp_executesql @Sql
  end


  -- MtskAdayTakipFull
  -- MtskAdayTakipUygDers
  -- MtskAdayTakipUygSinav
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.PlanlanacakEgitimTipi
  -- -----------------------------------------------------------------

  Set @Sql = '
--@Header
  ;WITH PlanlanacakEgitimTipi AS (
    Select takip.TalepId as TalepId
    , ( case
		 when takip.BasarisizDersTipiId = 1 then 4
         when takip.TelafiDersTipiId = 1 then 2
         when takip.Arti4DersTipiId = 1 then 3
         when takip.UygulamaliDersTipiId = 1 then 1 
         else 0 end ) as yeniPlanlanacakEgitimTipiId

    From MtskAdayTakip as takip
    Where @FirmId = takip.FirmId 
	--and @TalepId = takip.TalepId
    --and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 ) 
    and   takip.KayitTipiId <= 4
    and takip.TalepTipiId < 4
  ) -- With
  --Select * from PlanlanacakEgitimTipi
  Update takip
  Set PlanlanacakEgitimTipiId = x.yeniPlanlanacakEgitimTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN PlanlanacakEgitimTipi as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and isnull(takip.PlanlanacakEgitimTipiId,-1) <> x.yeniPlanlanacakEgitimTipiId
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipESinav'
  or  @Kim = 'MtskAdayTakipUygDers'
  or  @Kim = 'MtskAdayTakipUygSinav'
  )
  begin
      print 'PlanlanacakEgitimTipi'
      EXEC sp_executesql @Sql
  end


  --0  Tanımsız
  --1  Ön kayıt
  --2  Kayıt aşamasında
  --3  Kesin kayıt
  --4  Sertifika almaya hak kazandı
  --5  Tüm e-Sınav hakkı bitti. Dosya yandı
  --6  Tüm uygulamalı sınav hakkı bitti
  --7  2. +4 sınav hakkı bitti. Dosya yandı
  --8  Diğer sebeplerden dolayı dosya kapandı

  -- MtskAdayTakipFull
  -- MtskAdayTakipKayit ( Belgelerden dolayı )
  -- MtskAdayTakipESinav 
  -- MtskAdayTakipUygSinav
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.KayitTipiId
  -- -----------------------------------------------------------------

  Set @Sql = '
--@Header
  ;WITH KayitTipi AS (
    Select t.TalepId as TalepId
    , ( case
         when t.KayitTipiId = 8 then 8 -- Manuel dosya kapanmışsa hiç elleme 
	     when t.uSinavSonrasiTipiId = 4 then 7 -- 2.+4 hakkı bitti
	     when t.uSinavSonrasiTipiId = 3 then 6 -- uyg  hakkı bitti
	     when t.eSinavSonrasiTipiId = 3 then 5 -- e-sınav hakkı bitti
		 when ( t.uSinavSonrasiTipiId = 2 or isnull(s.SertifikaAlmayiHakKazandi,0) = 1 )   then 4 -- sertifika hakkı
		 when ( t.uSinavDurumTipiId > 1 
		 or     t.UygulamaliDersTipiId > 0 
		 or     t.eSinavSonrasiTipiId > 1
		 or     t.BelgelerYuklendi = 1 ) then 3 -- Kesin kayıt
		 when ( t.BelgelerGeldi = 1 
		 or     t.BelgelerTarandi = 1 ) then 2 -- Kayıt aşamasında
		 when ( t.BelgelerGeldi = 0
		 or     t.BelgelerTarandi = 0 ) then 1 -- Ön kayıt 
         else t.KayitTipiId end ) as yeniKayitTipiId
    From dbo.MtskAdayTakip as t
	left join dbo.MtskAdaySertifika as s on ( t.TalepId = s.TalepId ) 
    Where @FirmId = t.FirmId 
	--and @TalepId = t.TalepId
    and t.TalepTipiId < 5
  ) -- With
  --Select * from KayitTipi
  Update takip
  Set KayitTipiId = x.yeniKayitTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN KayitTipi as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and isnull(takip.KayitTipiId,-1) <> x.yeniKayitTipiId
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  or  @Kim = 'MtskAdayTakipESinav'
  or  @Kim = 'MtskAdayTakipUygSinav'
  )
  begin
      print 'KayitTipi'
      EXEC sp_executesql @Sql
  end
   

  -- MtskAdayTakip All Hepsinde çalışacak
  --
  -- -----------------------------------------------------------------
  -- MtskAdayTakip.Asama1TipiId
  -- MtskAdayTakip.Asama2TipiId
  -- -----------------------------------------------------------------
  /*
  100 |      |  Kayıt aşamasında	           |
  200 |      |  Teorik ders aşamasında	       |
  300 | 400  |  E-Sınav durum aşaması,         | E-Sınav sonuç aşaması
  500 |      |  Uygulamalı dersler aşamasında  |  
  600 | 700  |  Uygulamalı sınav aşaması,      | Uygulamalı sınav sonuç aşaması
  */

  Set @Sql = '
--@Header
  ;WITH Asamalar AS (
    Select t.TalepId as TalepId
    -- Aşamalar 
    , ( case
        when t.uSinavDurumTipiId > 1 then 600
        when t.TalepTipiId = 1 and t.BasarisizDersTipiId > 0 then 540
        when ( t.TalepTipiId = 2 or t.TalepTipiId = 3) and t.Arti4DersTipiId > 0 then 530
        when t.TalepTipiId < 4 and t.TelafiDersTipiId > 0 then 520
        when t.TalepTipiId = 1 and t.UygulamaliDersTipiId > 0 then 510
        when ( t.TalepTipiId = 1 or t.TalepTipiId = 4) and t.eSinavSonucTipiId > 0 and eSinavSonrasiTipiId > 0 then 300
        when ( t.TalepTipiId = 1 or t.TalepTipiId = 4) and t.TeorikDersTipiId > 14 then 200
        when t.KayitTipiId < 4 then 100 -- Sertifika almamış ise 
        else 0 end 
      ) as yeniAsama1TipiId
    , ( case 
        when t.uSinavSonrasiTipiId > 0 then 700
        when t.TalepTipiId = 1 and t.BasarisizDersTipiId > 0 then 0
        when ( t.TalepTipiId = 2 or t.TalepTipiId = 3) and t.Arti4DersTipiId > 0 then 0
        when t.TalepTipiId < 4 and t.TelafiDersTipiId > 0 then 0
        when t.TalepTipiId = 1 and t.UygulamaliDersTipiId > 0 then 0
        when ( t.TalepTipiId = 1 or t.TalepTipiId = 4) and t.eSinavSonrasiTipiId > 0 then 400
        when ( t.TalepTipiId = 1 or t.TalepTipiId = 4) and t.TeorikDersTipiId > 14 then 0
        when t.KayitTipiId < 4 then 0 -- Sertifika almamış ise 
        else 0 end 
      ) as yeniAsama2TipiId
    -- Aşama Detayları
    , ( case
        when t.uSinavDurumTipiId > 1 then 600 + t.uSinavDurumTipiId
        when t.TalepTipiId = 1 and t.BasarisizDersTipiId > 0 then 540 + t.BasarisizDersTipiId
        when ( t.TalepTipiId = 2 or t.TalepTipiId = 3) and t.Arti4DersTipiId > 0 then 530 + t.Arti4DersTipiId
        when t.TalepTipiId < 4 and t.TelafiDersTipiId > 0 then 520 + t.TelafiDersTipiId
        when t.TalepTipiId = 1 and t.UygulamaliDersTipiId > 0 then 510 + t.UygulamaliDersTipiId
        when ( t.TalepTipiId = 1 or t.TalepTipiId = 4) and t.eSinavSonucTipiId > 0 and eSinavSonrasiTipiId > 0 then 300 + t.eSinavDurumTipiId
        when ( t.TalepTipiId = 1 or t.TalepTipiId = 4) and t.TeorikDersTipiId > 14 then 200 + t.TeorikDersTipiId
     -- Belgeler
        when t.KayitTipiId < 4 and t.BelgelerGeldi = 1 and t.BelgelerTarandi = 1 and t.BelgelerYuklendi = 1 then 104
        when t.KayitTipiId < 4 and t.BelgelerGeldi = 1 and t.BelgelerTarandi = 1 and t.BelgelerYuklendi = 0 then 103
        when t.KayitTipiId < 4 and t.BelgelerGeldi = 1 and t.BelgelerTarandi = 0 and t.BelgelerYuklendi = 0 then 102
        when t.KayitTipiId < 4 and t.BelgelerGeldi = 0 and t.BelgelerTarandi = 0 and t.BelgelerYuklendi = 0 then 101
        else 0 end 
      ) as yeniAsama1DetayTipiId
    , ( case 
        when t.uSinavSonrasiTipiId > 0 then 700 + t.uSinavSonrasiTipiId
        when t.TalepTipiId = 1 and t.BasarisizDersTipiId > 0 then 0
        when ( t.TalepTipiId = 2 or t.TalepTipiId = 3) and t.Arti4DersTipiId > 0 then 0
        when t.TalepTipiId < 4 and t.TelafiDersTipiId > 0 then 0
        when t.TalepTipiId = 1 and t.UygulamaliDersTipiId > 0 then 0
        when ( t.TalepTipiId = 1 or t.TalepTipiId = 4) and t.eSinavSonrasiTipiId > 0 then 400 + t.eSinavSonrasiTipiId
        when ( t.TalepTipiId = 1 or t.TalepTipiId = 4) and t.TeorikDersTipiId > 14 then 0
        when t.KayitTipiId < 4 then 0 -- Sertifika almamış ise 
        else 0 end 
      ) as yeniAsama2DetayTipiId

    From dbo.MtskAdayTakip as t
    Where @FirmId = t.FirmId 
	--and @TalepId = t.TalepId
    and t.TalepTipiId < 5
  ) -- With
  --Select * from Asamalar
  Update takip
  Set Asama1TipiId = x.yeniAsama1TipiId
  ,   Asama2TipiId = x.yeniAsama2TipiId
  ,   Asama1DetayTipiId = x.yeniAsama1DetayTipiId
  ,   Asama2DetayTipiId = x.yeniAsama2DetayTipiId
  FROM dbo.MtskAdayTakip as takip
  JOIN Asamalar as x ON ( takip.TalepId = x.TalepId )
  Where 0 = 0
  and ( isnull(takip.Asama1TipiId,-1) <> x.yeniAsama1TipiId
  or    isnull(takip.Asama2TipiId,-1) <> x.yeniAsama2TipiId
  or    isnull(takip.Asama1DetayTipiId,-1) <> x.yeniAsama1DetayTipiId
  or    isnull(takip.Asama1DetayTipiId,-1) <> x.yeniAsama1DetayTipiId
  )
  ';

  Set @Sql = REPLACE(@Sql, '--@Header', @SqlHeader)

  if (@TalepId > 0) 
      Set @Sql = REPLACE(@Sql, '--and @TalepId', 'and @TalepId')

  --print @Kim
  --print @Sql

  if (@Kim = 'MtskAdayTakipFull'
  or  @Kim = 'MtskAdayTakipKayit'
  or  @Kim = 'MtskAdayTakipTeorikDers'
  or  @Kim = 'MtskAdayTakipESinav'
  or  @Kim = 'MtskAdayTakipUygDers'
  or  @Kim = 'MtskAdayTakipRandevu'
  or  @Kim = 'MtskAdayTakipUygSinav'
  )
  begin
      print 'Aşamalar'
      EXEC sp_executesql @Sql
  end
  

  print 'Execute [dbo].[prc_setIsDbUpdateActive] 13, 0'
  Execute [dbo].[prc_setIsDbUpdateActive] 13, 0	
  print ''
  print 'prc_MtskAdayTakip end'


END --



/*CreateProcedureEnd*/