/*CreateProcedure*/

CREATE PROCEDURE [dbo].[prc_MtskAdayTakipESinavToplamlari] (@FirmId int, @DonemTipiId int)  
AS BEGIN

--declare @FirmId int = 11
--declare @DonemTipiId int = 202411

-- TeorikDersTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.TeorikDersTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join dbo.MtskGrupSubesi as sube on ( takip.DonemTipiId = sube.DonemTipiId )     
     left outer join Lkp.MtskAdayTakipTeorikDersTipi as tip on ( takip.TeorikDersTipiId = tip.Id )
Where takip.FirmId = @FirmId
and   takip.GrupTipiId  = sube.GrupTipiId
and   takip.SubeTipiId  = sube.SubeTipiId 
and   takip.KayitTipiId < 4
and   takip.TeorikDersTipiId > 14
and   takip.Asama1TipiId <= 300

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.TeorikDersTipi
 , tip.FormCaption 

union all

-- eSinavDurumTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.eSinavDurumTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipeSinavDurumTipi as tip on 
	   ( takip.eSinavDurumTipiId = tip.Id )
Where takip.FirmId = @FirmId
--and   takip.DonemTipiId > 0
--and   takip.GrupTipiId  > 0
and   takip.SubeTipiId  > 0
and   takip.KayitTipiId < 4
and ((takip.eSinavDurumTipiId = 1 and takip.Asama1TipiId <= 200 ) 
  or (takip.eSinavDurumTipiId = 2 and takip.Asama1TipiId  = 300 )   
  or (takip.eSinavDurumTipiId = 3 and takip.Asama1TipiId  = 300 )   
  or (takip.eSinavDurumTipiId = 4 and takip.Asama1TipiId <= 300 )   
  or (takip.eSinavDurumTipiId = 5 and takip.Asama1TipiId  = 300 )   
  or (takip.eSinavDurumTipiId = 6 and takip.Asama1TipiId <= 800 )   
)

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.eSinavDurumTipi
 , tip.FormCaption 

union all

-- eSinavSonucTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.eSinavSonucTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipeSinavSonucTipi as tip on 
	   ( takip.eSinavSonucTipiId = tip.Id )
Where takip.FirmId = @FirmId
and   takip.eSinavSonucTipiId > 0
and   takip.KayitTipiId < 4
and (( takip.eSinavSonucTipiId > 1 and takip.Asama1TipiId = 300)
  or ( takip.eSinavSonucTipiId = 1 and takip.Asama1TipiId >= 510 and takip.Asama1TipiId <= 540)
  )
Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.eSinavSonucTipi
 , tip.FormCaption 

union all

-- eSinavSonrasiTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.eSinavSonrasiTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipeSinavSonrasiTipi as tip on 
	   ( takip.eSinavSonrasiTipiId = tip.Id )
Where takip.FirmId = @FirmId
and   takip.eSinavSonrasiTipiId > 0
and   takip.KayitTipiId < 4
and (( takip.eSinavSonrasiTipiId <> 2 and takip.Asama1TipiId = 300)
  or ( takip.eSinavSonrasiTipiId = 2 and takip.Asama1TipiId >= 510 and takip.Asama1TipiId <= 540)
  )
Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.eSinavSonrasiTipi
 , tip.FormCaption 
/*
union all

-- eSinavUcretTipi
Select 
   tip.KonuId
 , tip.KonuCaption   
 , tip.eSinavUcretTipi as KonuAciklama
 , tip.FormCaption as Islem
 , count(takip.Id) as AdaySayisi 

From MtskAdayTakip as takip
     left outer join Lkp.MtskAdayTakipeSinavUcretTipi as tip on 
	   ( takip.eSinavUcretTipiId = tip.Id )
Where takip.FirmId = @FirmId
and ( takip.KayitTipiId = 2 or takip.KayitTipiId = 3 )

Group by 
   tip.KonuId
 , tip.KonuCaption   
 , tip.eSinavUcretTipi
 , tip.FormCaption 
*/

END -- procedure

/*CreateProcedureEnd*/