/*CreateTable*/

begin transaction

 create table SrcSinavETeorik
 (
   Id                    Int IDENTITY(1,1) not null, 
   FirmId                Int       not null,
   IsActive              Bit       not null, /* default : 1 = active, 0 = not active */  
   TalepId               Int       not null, 
   AdayId                Int       not null, /* default 0 */
   TcNo                  Varchar(11)   null,
   TamAdiSoyadi          nVarchar(100) null,
   AdayDonemTipiId       Int           null, /* bu mebbisde e-sınav listelerinde yok, uyg. sınav listelerinde var */ 

   --10
   SinavDonemTipiId        Int           null, /* sınavın yapıldığı dönem */
   SinavNo                 SmallInt      null,  
   SinavTarihSaat          Varchar(20)   null,
   SinavTarihi             Date          null,
   SinavSaati              Time          null,
   TeorikPuani             Numeric(5,2)  null, --SmallInt      null, küsüratlı puan var mış!!!!
   DurumuTipiId            SmallInt      null, /* mebbiste okunuyor*/
   MebbisESinavTarihValue  Varchar(20)   null, /* mebbis valuesi */ 

   --20
   SinavUcreti           Numeric(22,5) null,
   TahsilEdildi          Bit           null, /* sonradan kursiyerden makbuzla tahsil edildi */
   DekontId              Int           null, /* tahsil dekont ıd */
   --30
   /* mebbis bilgileri */
   UcretDurumuTipiId     SmallInt      null, /* mebbisten okunuyor : Sınav Ücreti Yatırılmamış ,  */
   YatanToplamUcret      Numeric(22,5) null,
   UcretSayisi           SmallInt      null, 
   TestMerkeziBilgisi    Varchar(50)   null,
   --40
   IsGBelgesiHazir         Bit         null,
   IsGBelgesiTeslimEdildi  Bit         null,
   GBKimeTeslimEdildi      Varchar(50) null,
   --50
   LineTypeId              SmallInt    null, /* 1. Başvuru satırı, 2. sınav sonuç satırı */
   --60
   VeriKaynakTipiId        SmallInt       null, /* 1. Kullanıcı Manuel, 2. Mebbis Dönem Aday Onaylama, 3. Mebbis Uygulama Sınav Listesi, 4. Mebbis Aday Durum Bilgileri, 11. Tabim veritabanı  */
   VeriKaynakId            Int            null, /* Veri transferi edildiği tablodaki Id . Sorun olduğunda bilginin nereden geldiğine referans olsun */


   constraint		pk_SrcSinavETeorik primary key (Id)
 )
  
 grant select, insert, update, delete on SrcSinavETeorik to public

 create index X_SrcSinavETeorik01 on SrcSinavETeorik (TalepId)
 create index X_SrcSinavETeorik02 on SrcSinavETeorik (AdayId)
 create index X_SrcSinavETeorik03 on SrcSinavETeorik (TcNo)
  
commit transaction

/*CreateTableEnd*/

/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_SrcSinavETeorik] on [dbo].[SrcSinavETeorik] 
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE eSinavCursor cursor local for select Id from Inserted
    DECLARE @curId bigint

    OPEN eSinavCursor
    FETCH NEXT FROM eSinavCursor INTO @curId
    
	declare @yFirmId int = 0
	declare @yTalepId int = 0
    declare @TalepTipiId smallInt = 0
	declare @yAdayId int = 0
	declare @yTcNo varchar(11)
	declare @yTamAdiSoyadi nVarchar(100)
	declare @yAdayDonemTipiId int = 0
	declare @SinavDonemTipiId int = 0
	declare @ySinavNo int = 0
	declare @ySinavTarihSaat varchar(20) = ''
	declare @xSinavTarihSaat varchar(20) = ''
	declare @ySinavTarihi date = null
	declare @ySinavTarihi2 varchar(10)
	declare @ySinavSaati varchar(10) = ''
	declare @xSinavSaati varchar(10) = ''
	declare @yTeorikPuani int = 0
	declare @yMebbisESinavTarihValue varchar(20) = ''
	declare @SinavSonucTipiId smallInt = 0
	declare @yLineTypeId smallInt = 0

    -- Veri Transferi başladımı
    declare @DbUpdatesIsActive Bit = 0
    set @DbUpdatesIsActive = [dbo].[fnc_getIsDbUpdate] (0)

    WHILE @@FETCH_STATUS = 0
    BEGIN
	    set @ySinavNo = 0 
	    set @ySinavTarihi = null
	    set @ySinavSaati = ''
				
        select 
         @yFirmId = ins.FirmId
        ,@yTalepId = isnull(ins.TalepId,0)
        ,@yAdayId = isnull(ins.AdayId,0)
		,@yTcNo = isnull(ins.TcNo,'')
		,@yTamAdiSoyadi = isnull(ins.TamAdiSoyadi,'')
        ,@yAdayDonemTipiId = isnull(ins.AdayDonemTipiId,0)
		,@ySinavNo = isnull(ins.SinavNo,0)
		,@ySinavTarihSaat = isnull(ins.SinavTarihSaat, '0')
        ,@ySinavTarihi = ins.SinavTarihi 
        ,@ySinavSaati = isnull(ins.SinavSaati,'')
		,@yTeorikPuani = isnull(ins.TeorikPuani, 0)
		,@SinavSonucTipiId = isnull(ins.DurumuTipiId, 0)
		,@yMebbisESinavTarihValue = isnull(ins.MebbisESinavTarihValue,'')
        ,@yLineTypeId = isnull(ins.LineTypeId,0) 
		from inserted ins
    	where ins.Id = @curId

        Select @TalepTipiId = TalepTipiId 
        From dbo.SrcAdayTalep
        Where FirmId = @yFirmId
        and   Id = @yTalepId

		set @xSinavSaati = Convert(varchar(10), Convert(time, @xSinavTarihSaat, 104))
			    
		-- @xSinavSaati ile @ySinavTarihSaat üzerindeki saat boyutuna bakarak manuel mi yoksa mebbisden mi alındığı belli oluyor
		-- @ySinavTarihSaat insert veya update olmuşsa @ySinavTarihi ve @ySinavSaati buna göre değiştiriliyor
		-- Kullnıcı @ySinavTarihi ve @ySinavSaati manuel girmişse @ySinavTarihSaat ona göre ayarlanıyor

        -- LEN(@xSinavSaati) > 5 olması bu bilginin mebbisden girildiğini işaret ediyor
		if (@ySinavTarihSaat <> '0' and LEN(@xSinavSaati) > 5) 
		begin
		  set @xSinavTarihSaat = replace(@ySinavTarihSaat, '/E-Sınav', '') 
		  set @ySinavTarihi = convert(date, @xSinavTarihSaat, 103)
		  set @ySinavSaati = convert(time, @xSinavTarihSaat, 103)
		end

       -- aa.gg.yyyy formatına dönüyor
	   -- böylece try_cast da doğruysa sonuç dönüyor değilse null dönüyor
	   set @ySinavTarihi2 = convert(varchar(10), @ySinavTarihi, 102 )

       -- LEN(@ySinavSaati) = 5 olması bilginin kullanıcı tarafından manuel girldiğini anlatıyor
	   if (LEN(@ySinavSaati) = 5) and
	      (TRY_CAST(@ySinavSaati as TIME) is not null) and  
          (TRY_CAST(@ySinavTarihi2 as datetime) is not null) 
	       Set @ySinavTarihSaat = FORMAT(
		           TRY_CAST(
                   TRY_CAST(@ySinavTarihi2 AS VARCHAR(10)) + ' ' + 
                   TRY_CAST(@ySinavSaati AS VARCHAR(5)) AS datetime),
				   'dd.MM.yyyy HH:mm', 'tr-TR')
				   
		-- Sınavın hangi dönemde yapıldığı tespit ediliyor
        if (@ySinavTarihSaat <> '0')
        begin
            if (MONTH(@ySinavTarihSaat) < 10)
                 set @SinavDonemTipiId = convert(int, convert(varchar(5), YEAR(@ySinavTarihSaat)) + '0' + convert(varchar(3), MONTH(@ySinavTarihSaat)))
            else set @SinavDonemTipiId = convert(int, convert(varchar(5), YEAR(@ySinavTarihSaat)) + convert(varchar(3), MONTH(@ySinavTarihSaat)))
        end

        if (@SinavDonemTipiId = 0)
            set @SinavDonemTipiId = [dbo].[fnc_getDonemTipiId] ('BUGUN', @ySinavTarihi)


		if (@yTalepId = 0 and @yAdayId = 0 and @yTcNo <> '')
		begin
            -- Talepleri kontrol et
            Select top 1 @yAdayId = AdayId, @yTalepId = Id, @yAdayDonemTipiId = DonemTipiId 
            From dbo.SrcAdayTalep
            Where TcNo = @yTcNo
            and   isnull(DonemTipiId,0) <= @SinavDonemTipiId
            order by DonemTipiId desc, Id desc
		end
		
		if (@yAdayDonemTipiId = 0 and @yTcNo <> '')
		begin
            -- Talepleri kontrol et
            Select top 1 @yAdayId = AdayId, @yTalepId = Id, @yAdayDonemTipiId = DonemTipiId 
            From dbo.SrcAdayTalep
            Where TcNo = @yTcNo
            and   isnull(DonemTipiId,0) <= @SinavDonemTipiId
            order by DonemTipiId desc, Id desc
		end

		if (@yTeorikPuani >= 70 and @yTeorikPuani <= 100) 
		   set @SinavSonucTipiId = 1 -- Başarılı
		
		if (@yTeorikPuani > 0 and @yTeorikPuani < 70) 
		   set @SinavSonucTipiId = 2 -- Başarısız
		
		if (@yTeorikPuani < 0 or @yTeorikPuani > 100) 
		   set @SinavSonucTipiId = 0 -- Tanımsız

		if (@yTeorikPuani = 0 and @SinavSonucTipiId < 3)
		   set @SinavSonucTipiId = 0 -- Tanımsız

        if (@yMebbisESinavTarihValue <> '')-- and (@ySinavTarihSaat = '' or @ySinavTarihSaat = '0'))        
        begin 
            Select Top 1
                 @SinavDonemTipiId = SinavDonemTipiId
               , @ySinavTarihSaat = SinavTarihSaat
               , @ySinavTarihi = SinavTarihi
               , @ySinavSaati = SinavSaati
            from dbo.SrcSinavTarihi as tarihler
            Where tarihler.MebbisESinavTarihValue = @yMebbisESinavTarihValue
        end -- if (@yMebbisESinavTarihValue <> ''

		-- Dört gün öncesi tarihindekileri say
		Select @ySinavNo = (count(Id) + 1) From SrcSinavETeorik
		Where IsActive = 1
		and FirmId = @yFirmId
		and TalepId = @yTalepId
        and LineTypeId = @yLineTypeId 
		and SinavTarihi < @ySinavTarihi  

		update SrcSinavETeorik set
           TalepId = @yTalepId
         , AdayId = @yAdayId
		 , AdayDonemTipiId = @yAdayDonemTipiId
		 , SinavDonemTipiId = @SinavDonemTipiId
		 , SinavNo = @ySinavNo
		 , SinavTarihSaat = @ySinavTarihSaat
		 , SinavTarihi = @ySinavTarihi
         , SinavSaati = @ySinavSaati
		 , DurumuTipiId = @SinavSonucTipiId
		Where Id = @curId
		    
		/* SinavNo ayarlanıyor */
        Update dbo.SrcSinavETeorik set 
           SinavNo = x.yeniSinavNo
        From dbo.SrcSinavETeorik as a,
        (
            Select sinav.Id 
            , ROW_NUMBER() OVER(ORDER BY sinav.SinavTarihi) AS yeniSinavNo 
            From dbo.SrcSinavETeorik as sinav
            where sinav.FirmId = @yFirmId
            and   sinav.IsActive = 1
            and   sinav.LineTypeId = 2 -- sınav sonucu
            and   sinav.TalepId = @yTalepId
        ) as x
        Where a.Id = x.Id
        and   a.SinavNo <> x.yeniSinavNo

        -- Aday ken kayıt durumuna halen geçmemişse
		Update dbo.SrcAdayTalep set KayitTipiId = 3
        Where Id = @yTalepId
        and   KayitTipiId < 3 -- Kesin Kayıt değilse ? kesin kayıt durumuna getir
		
        -- Veri transferi yapılmıyorsa 
        if (@DbUpdatesIsActive = 0)
        begin
        
            EXECUTE [dbo].[prc_SrcAdayTakip] @yFirmId, @yTalepId, 0, 'SrcAdayTakipESinav'

            if (@TalepTipiId = 1 or @TalepTipiId = 2) -- Src1234, Src5
            begin
                if (@SinavSonucTipiId = 1) -- Başarılı)         
                begin
                    Execute dbo.prc_SrcSinavSatiriOlustur @yFirmId, @yTalepId, @ySinavTarihi
                end
                if (@SinavSonucTipiId <> 1) -- Başarılı)         
                begin
                    --- kullanıcı önce başarılı sınav notu girer yeni SrcSinavUygulama satırı oluşur
                    --- daha sonra başarısız notunu girebilir
                    --- bu nedenle bu uygulama satırına eğer not girilmemişse sil
                    Delete From dbo.SrcSinavUygulama 
                    Where FirmId = @yFirmId
                    and   TalepId = @yTalepId
                    and   SinavTarihi = @ySinavTarihi 
                    and   isnull(PuanTipiId,0) = 0  
                end
            end
        end

        FETCH NEXT FROM eSinavCursor INTO @curId
    END

    CLOSE eSinavCursor
    DEALLOCATE eSinavCursor   

END -- trigger

/*CreateTriggerEnd*/



/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_SrcSinavETeorikDelete] on [dbo].[SrcSinavETeorik]
AFTER DELETE
AS BEGIN

    declare eSinavCursorDlt cursor local for select Id from deleted
	declare @curId bigint

	OPEN eSinavCursorDlt
    FETCH NEXT FROM eSinavCursorDlt INTO @curId

    declare @FirmId int
    declare @TalepId int

    -- Veri Transferi başladımı
    declare @DbUpdatesIsActive Bit = 0
    set @DbUpdatesIsActive = [dbo].[fnc_getIsDbUpdate] (0)

    WHILE @@FETCH_STATUS = 0
    BEGIN
	    Select 
          @FirmId = dlt.FirmId
        , @TalepId = dlt.TalepId
	    From deleted dlt
	    Where dlt.Id = @curId
	  
        -- Veri transferi yapılmıyorsa 
        if (@DbUpdatesIsActive = 0)
        begin
            EXECUTE [dbo].[prc_SrcAdayTakip] @FirmId, @TalepId, 0, 'SrcAdayTakipESinav'
        end

        FETCH NEXT FROM eSinavCursorDlt INTO @curId
    END

    CLOSE eSinavCursorDlt
    DEALLOCATE eSinavCursorDlt

END

/*CreateTriggerEnd*/





/*CreateLkpTable*/

begin transaction

-- ------------------------------------------------------- 
-- DurumuTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'SrcSinavETeorikDurumuTipi')
drop table [Lkp].[SrcSinavETeorikDurumuTipi]

create table [Lkp].[SrcSinavETeorikDurumuTipi]
(
   Id               Int Unique not null, 
   DurumuTipi       nVarchar(50)   null
   
   constraint  pk_SrcSinavETeorikDurumuTipi primary key (Id)
)

Delete from [Lkp].[SrcSinavETeorikDurumuTipi]
INSERT INTO [Lkp].[SrcSinavETeorikDurumuTipi] (Id, DurumuTipi)
 VALUES 
  ( 0,    N''),
  ( 1,    N'Başarılı'),
  ( 2,    N'Başarısız'),
  ( 3,    N'Girmedi'),
  ( 4,    N'Raporlu'),
  ( 5,    N'İptal Edildi'),
  ( 6,    N'İptal Edildi(Sınav Yasaklı)'),
  ( 7,    N'Girmeyecek')

-- ------------------------------------------------------- 
-- UcretDurumuTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'SrcSinavETeorikUcretDurumuTipi')
drop table [Lkp].[SrcSinavETeorikUcretDurumuTipi]

create table [Lkp].[SrcSinavETeorikUcretDurumuTipi]
(
   Id               Int Unique not null, 
   UcretDurumuTipi  nVarchar(30)   null
   
   constraint  pk_SrcSinavETeorikUcretDurumuTipi primary key (Id)
)

Delete from [Lkp].[SrcSinavETeorikUcretDurumuTipi]
INSERT INTO [Lkp].[SrcSinavETeorikUcretDurumuTipi] (Id, UcretDurumuTipi)
 VALUES 
  ( 0,    N''),
  ( 1,    N'Sınav Ücreti Yatırılmış'),
  ( 2,    N'Sınav Ücreti Yatırılmamış')




-- ------------------------------------------------------- 
-- LineTypeId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'SrcSinavETeorikLineType')
drop table [Lkp].[SrcSinavETeorikLineType]

create table [Lkp].[SrcSinavETeorikLineType]
(
   Id               Int Unique not null, 
   LineType         nVarchar(30)   null
   
   constraint  pk_SrcSinavETeorikLineType primary key (Id)
)

Delete from [Lkp].[SrcSinavETeorikLineType]
INSERT INTO [Lkp].[SrcSinavETeorikLineType] (Id, LineType)
 VALUES 
  ( 0,    N''),
  ( 1,    N'Başvuru satırı'),
  ( 2,    N'Sınav sonuç satırı')


commit transaction

/*CreateLkpTableEnd*/
