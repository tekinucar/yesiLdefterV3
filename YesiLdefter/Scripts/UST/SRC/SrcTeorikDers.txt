/*CreateTable*/

begin transaction

 create table SrcTeorikDers
 (
   Id                   Int IDENTITY(1,1) not null, 
   FirmId               Int       not null,
   IsActive             Bit       not null, /* default : 1 = active, 0 = not active */  

   DonemTipiId          Int           null,
   GrupTipiId           SmallInt      null,
   SubeTipiId           SmallInt      null,
   
   DersGrubu            Varchar(1)    null, /* A, B, C veya D : Mebbisden doğrudan ders programı okunduğunda gerekiyor */  
   DersTipiId           Int           null, /* Detayı : Lkp.SrcDersler tablosunda */
   DersSiraNo           SmallInt      null, /* örnek : 3 saatlik bir dersin, 1. saati, 2. saati, 3. saati şeklindeki işareti */
   DerslikAdiTipiId     SmallInt      null, /* Derslik-1, -2 ... -10 */
   DersTarihi           Date          null,
   DersSaatiTipiId      SmallInt      null,
   PersonelId           Varchar(20)   null,
   EgitimTipiId         SmallInt      null, /* 1. Normal, 2. Telafi, 9. Şablon kayıt  */

   BaslamaSaati         Datetime      null, /* Calender and Scheduling için gerekli */
   BitisSaati           Datetime      null, /* Calender and Scheduling için gerekli */
   TDersIsUploaded      Bit           null,
   SablonTeorikBId      Int           null, 
   OzelGunlerId         Int           null, /* OnmOzelGunler.Id */
   DersHaftasiId        SmallInt      null, /* yılın hangi haftasına denk geldi, bu sayede o haftadaki tüm dersler listeleniyor */  

   constraint		pk_SrcTeorikDers primary key (Id)
 )
  
 grant select, insert, update, delete on SrcTeorikDers to public

commit transaction

/*CreateTableEnd*/

/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_SrcTeorikDers] on [dbo].[SrcTeorikDers] 
AFTER INSERT, UPDATE
AS BEGIN

    DECLARE myCursor cursor local for select Id from Inserted
    DECLARE @curId bigint

    OPEN myCursor
    FETCH NEXT FROM myCursor INTO @curId

    declare @eDersTarihi date = null
    declare @eDersSaatiTipiId smallInt = -1
	declare @eBaslamaSaati datetime
	declare @eBitisSaati datetime

    declare @yFirmId int = 0
    declare @yDonemTipiId int = 0
    declare @yGrupTipiId smallInt = 0
    declare @ySubeTipiId smallInt = 0
    declare @yDersTarihi date = null
    declare @yDersSaatiTipiId smallInt = -1
    declare @yPersonelId varchar(20) = ''
	declare @yBaslamaSaati datetime
	declare @yBitisSaati datetime
    declare @yBaslamaSaatiChechked varchar(20)
    declare @eSaat varchar(20) = null
    declare @TcNoCalismaIzniNo varchar(20) = null
    declare @TDersIsUploaded bit = 0

	declare @insId int = 0
    declare @mvcId int = 0

    WHILE @@FETCH_STATUS = 0
    BEGIN
    	
      Select
       @eDersTarihi = dlt.DersTarihi
      ,@eDersSaatiTipiId = dlt.DersSaatiTipiId
      ,@eBaslamaSaati = dlt.BaslamaSaati
      ,@eBitisSaati = dlt.BitisSaati	  
      From deleted dlt
      Where dlt.Id = @curId

      Select
	   @yFirmId = ins.FirmId
      ,@yDonemTipiId = ins.DonemTipiId
      ,@yGrupTipiId = ins.GrupTipiId
      ,@ySubeTipiId = ins.SubeTipiId
      ,@yDersTarihi = ins.DersTarihi
      ,@yDersSaatiTipiId = ins.DersSaatiTipiId
      ,@yPersonelId = isnull(ins.PersonelId,'')
      ,@TDersIsUploaded = isnull(ins.TDersIsUploaded,0)
      ,@yBaslamaSaati = ins.BaslamaSaati
      ,@yBitisSaati = ins.BitisSaati	  
      ,@yBaslamaSaatiChechked = Convert(varchar(20), ins.BaslamaSaati, 108) -- saati al
      ,@eSaat = isnull(saat.DersSaatiTipi,'00:00 - 00:00')
      From inserted ins
	    left outer join Lkp.SrcTeorikDersDersSaatiTipi saat on (ins.DersSaatiTipiId = saat.Id)
      Where ins.Id = @curId
      
      if (@TDersIsUploaded = 1) -- yani Mebbise yüklenmişse, değşişklik olamaz
      begin
          update dbo.SrcSablonTeorikS set 
			    DersTarihi = @eDersTarihi
              , DersSaatiTipiId = @eDersSaatiTipiId
              , BaslamaSaati = @eBaslamaSaati
              , BitisSaati   = @eBitisSaati
          Where Id = @curId
          return
      end

      -- personelId kontrolu
      Select @TcNoCalismaIzniNo = isnull(TcNoCalismaIzniNo,'')
      From dbo.SrcPersoneli
      Where TamAdiSoyadi like @yPersonelId+'%'
      
      -- tabloda grünen : 2025-12-05 08:00:11.000
      -- @eBaslamaSaatiChechked atanan : 08:00:11
      if (CHARINDEX(':00:11', @yBaslamaSaatiChechked) > 0)
      begin
          Set @eDersTarihi = Convert(date, @yBaslamaSaati, 103)
          Set @eSaat = SUBSTRING(@yBaslamaSaatiChechked,1,5);

          Select @yDersSaatiTipiId = Id, @eSaat = DersSaatiTipi  
          From Lkp.SrcTeorikDersDersSaatiTipi
          Where DersSaatiTipi like @eSaat+'%'
          and Id < 100
          order by Id

          update dbo.SrcTeorikDers set 
			    DersTarihi = @eDersTarihi
              , DersSaatiTipiId = @yDersSaatiTipiId
              , BaslamaSaati = CONVERT(smalldatetime, CONVERT(varchar(10), @eDersTarihi) + ' ' + SUBSTRING(@eSaat,1,5))
              , BitisSaati   = CONVERT(smalldatetime, CONVERT(varchar(10), @eDersTarihi) + ' ' + SUBSTRING(@eSaat,9,5))
          Where Id = @curId

      end else 
      begin        
          Set @eDersTarihi = Convert(date, @yDersTarihi, 103)

          Select @eSaat = DersSaatiTipi  
          From Lkp.SrcTeorikDersDersSaatiTipi
          Where Id = @yDersSaatiTipiId

          -- BaslangicSaat ve BitisSaat 
          update dbo.SrcTeorikDers set
              DersTarihi = @eDersTarihi
            , BaslamaSaati = CONVERT(smalldatetime, CONVERT(varchar(10), @eDersTarihi) + ' ' + SUBSTRING(@eSaat,1,5))
            , BitisSaati   = CONVERT(smalldatetime, CONVERT(varchar(10), @eDersTarihi) + ' ' + SUBSTRING(@eSaat,9,5))
          Where Id = @curId
      end

      -- Mebbisten okuma yapınca alınan ismi alınıyor
      -- alınan bu ismi TcNoIzinNo ya çeviriyor
      if (@TcNoCalismaIzniNo <> '')
      begin
        update dbo.SrcTeorikDers set 
        PersonelId = @TcNoCalismaIzniNo
        Where Id = @curId
        and isnull(PersonelId,'') <> @TcNoCalismaIzniNo
        and @TcNoCalismaIzniNo <> ''
      end
	  
      --Execute [dbo].[prc_SrcTeorikDersIhlalleriSaatler] @eFirmId, @eDonemTipiId
      --Execute [dbo].[prc_SrcTeorikDersIhlalleriCakismalar] @eFirmId, @eDonemTipiId
      --Execute [dbo].[prc_SrcDersIhlalleriPersonel] @curId, @eFirmId, @eDonemTipiId, @ePersonelId

      FETCH NEXT FROM myCursor INTO @curId
    END

    --Execute [dbo].[prc_SrcGrupSubesiTeorikDersToplami] @eFirmId, @eDonemTipiId, @eGrupTipiId, @eSubeTipiId
    --Execute [dbo].[prc_SrcGrupSubesiTakipSet] @eFirmId, @eDonemTipiId, @eGrupTipiId, @eSubeTipiId

    CLOSE myCursor
    DEALLOCATE myCursor   

END -- create trigger

/*CreateTriggerEnd*/


/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_SrcTeorikDersDelete] on [dbo].[SrcTeorikDers]
AFTER DELETE
AS BEGIN

    declare teoCursorDlt cursor local for select Id from deleted
	declare @curId bigint

	OPEN teoCursorDlt
    FETCH NEXT FROM teoCursorDlt INTO @curId

    WHILE @@FETCH_STATUS = 0
    BEGIN

	    Delete From dbo.SrcKIhlalTeorikD 
		Where InsertedId = @curId 
		or    MevcutId   = @curId

      FETCH NEXT FROM teoCursorDlt INTO @curId
    END

    CLOSE teoCursorDlt
    DEALLOCATE teoCursorDlt

END

 /*CreateTriggerEnd*/


/*CreateTrigger*/

CREATE TRIGGER [dbo].[trg_SrcTeorikDersDeleteIsLock] on [dbo].[SrcTeorikDers]
INSTEAD of DELETE
AS BEGIN

    declare isLockCursorDlt cursor local for select Id from deleted
    declare @curId bigint

	declare @FirmId int
	declare @DonemTipiId int
	declare @GrupTipiId int
	declare @SubeTipiId int
	declare @PersonelId varchar(30)

    OPEN isLockCursorDlt

    FETCH NEXT FROM isLockCursorDlt INTO @curId
	   
    WHILE @@FETCH_STATUS = 0
    BEGIN
	    IF EXISTS (SELECT 1 FROM deleted WHERE isnull(TDersIsUploaded,0) = 1 and Id = @curId)
        BEGIN
            PRINT 'Bu kayıt silinemez!'
            RETURN
        END

        Select @FirmId = FirmId
		, @DonemTipiId = DonemTipiId 
		, @GrupTipiId = GrupTipiId 
		, @SubeTipiId = SubeTipiId 
        , @PersonelId = PersonelId
		from dbo.SrcTeorikDers Where Id = @curId

        Delete from dbo.SrcTeorikDers  Where Id = @curId and isnull(TDersIsUploaded,0) = 0

        --Execute [dbo].[prc_SrcTeorikDersIhlalleriSaatler] @FirmId, @DonemTipiId
        --Execute [dbo].[prc_SrcTeorikDersIhlalleriCakismalar] @FirmId, @DonemTipiId
        --Execute [dbo].[prc_SrcDersIhlalleriPersonel] @curId, @FirmId, @DonemTipiId, @PersonelId

      FETCH NEXT FROM isLockCursorDlt INTO @curId
    END

    --Execute [dbo].[prc_SrcGrupSubesiTeorikDersToplami] @FirmId, @DonemTipiId, @GrupTipiId, @SubeTipiId
    --Execute [dbo].[prc_SrcGrupSubesiTakipSet] @FirmId, @DonemTipiId, @GrupTipiId, @SubeTipiId

    CLOSE isLockCursorDlt
    DEALLOCATE isLockCursorDlt

END

 /*CreateTriggerEnd*/


/*CreateLkpTable*/

begin transaction


-- ------------------------------------------------------- 
-- DersTipiId  /* Detayı : Lkp.SrcDersler tablosunda */
-- ------------------------------------------------------- 

-- ------------------------------------------------------- 
-- DerslikAdiTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'SrcTeorikDersDerslikAdiTipi')
drop table [Lkp].[SrcTeorikDersDerslikAdiTipi]

create table Lkp.SrcTeorikDersDerslikAdiTipi
(
   Id             Int Unique Not Null,
   DerslikAdiTipi nVarchar(50)   null
   
   constraint  pk_SrcTeorikDersDerslikAdiTipi primary key (Id)
)

INSERT INTO Lkp.SrcTeorikDersDerslikAdiTipi (Id, DerslikAdiTipi)
 VALUES 
  ( 0, N'Tanımsız'),
  ( 1, N'Derslik-1'),
  ( 2, N'Derslik-2'),
  ( 3, N'Derslik-3'),
  ( 4, N'Derslik-4'),
  ( 5, N'Derslik-5'),
  ( 6, N'Derslik-6'),
  ( 7, N'Derslik-7'),
  ( 8, N'Derslik-8'),
  ( 9, N'Derslik-9'),
  (10, N'Derslik-10')
 

-- ------------------------------------------------------- 
-- DersSaatiTipiId
-- ------------------------------------------------------- 
IF EXISTS (Select * From sys.objects WHERE name = 'SrcTeorikDersDersSaatiTipi')
drop table [Lkp].[SrcTeorikDersDersSaatiTipi]

create table Lkp.SrcTeorikDersDersSaatiTipi
(
   Id              Int Unique Not Null,
   DersSaatiTipi   nVarchar(50)   null

   constraint  pk_SrcTeorikDersDersSaatiTipi primary key (Id)
)

Delete From Lkp.SrcTeorikDersDersSaatiTipi
INSERT INTO Lkp.SrcTeorikDersDersSaatiTipi (Id, DersSaatiTipi)
 VALUES 
  (-7, N'00:00 - 00:50'),
  (-6, N'01:00 - 01:50'),
  (-5, N'02:00 - 02:50'),
  (-4, N'03:00 - 03:50'),
  (-3, N'04:00 - 04:50'),
  (-2, N'05:00 - 05:50'),
  (-1, N'06:00 - 06:50'),
  ( 0, N'07:00 - 07:50'),
  ( 1, N'08:00 - 08:50'),
  ( 2, N'09:00 - 09:50'),
  ( 3, N'10:00 - 10:50'),
  ( 4, N'11:00 - 11:50'),
  ( 5, N'12:00 - 12:50'),
  ( 6, N'13:00 - 13:50'),
  ( 7, N'14:00 - 14:50'),
  ( 8, N'15:00 - 15:50'),
  ( 9, N'16:00 - 16:50'),
  (10, N'17:00 - 17:50'),
  (11, N'18:00 - 18:50'),
  (12, N'19:00 - 19:50'),
  (13, N'20:00 - 20:50'),
  (14, N'21:00 - 21:50'),
  (15, N'22:00 - 22:50'),
  (100,N'00:00 - 23:59'), -- TAM GÜN İZİN
  (113,N'13:00 - 23:59')  -- YARIM GÜN İZİN - AREFE GÜNÜ

commit transaction
 
/*CreateLkpTableEnd*/

/*CreateData*/



/*CreateDataEnd*/


/*
<option selected="selected" value="1">09:00-09:50</option>
		<option value="2">10:00-10:50</option>
		<option value="3">11:00-11:50</option>
		<option value="4">12:00-12:50</option>
		<option value="5">13:00-13:50</option>
		<option value="6">14:00-14:50</option>
		<option value="7">15:00-15:50</option>
		<option value="8">16:00-16:50</option>
		<option value="9">17:00-17:50</option>
		<option value="10">18:00-18:50</option>
		<option value="11">19:00-19:50</option>
		<option value="12">20:00-20:50</option>
		<option value="13">21:00-21:50</option>
	</select>
*/




